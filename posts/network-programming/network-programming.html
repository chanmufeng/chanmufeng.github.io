<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.49" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://www.chanmufeng.com/posts/network-programming/network-programming.html"><meta property="og:site_name" content="蝉沐风"><meta property="og:title" content="简明socket编程"><meta property="og:description" content="这是一本socket编程的入门小册。学习编程，你肯定听过"socket"，或许你也想搞明白这到底是个什么东西，那就点进来看看吧。"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-11-02T01:18:52.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:tag" content="socket编程"><meta property="article:published_time" content="2022-10-05T00:00:00.000Z"><meta property="article:modified_time" content="2022-11-02T01:18:52.000Z"><script>
                var _hmt = _hmt || [];
                (function() {
                  var hm = document.createElement("script");
                  hm.src = "https://hm.baidu.com/hm.js?dfa689801ccd10bd283b50ea146430f3";
                  var s = document.getElementsByTagName("script")[0]; 
                  s.parentNode.insertBefore(hm, s);
                })();
            </script><title>简明socket编程 | 蝉沐风</title><meta name="description" content="这是一本socket编程的入门小册。学习编程，你肯定听过"socket"，或许你也想搞明白这到底是个什么东西，那就点进来看看吧。">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.ef97199c.css">
    <link rel="modulepreload" href="/assets/app.ec803d45.js"><link rel="modulepreload" href="/assets/network-programming.html.ad789019.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/assets/network-programming.html.287d3b4f.js"><link rel="prefetch" href="/assets/index.html.f40aab20.js"><link rel="prefetch" href="/assets/home.html.4311fb4f.js"><link rel="prefetch" href="/assets/update.html.72163859.js"><link rel="prefetch" href="/assets/index.html.bc679553.js"><link rel="prefetch" href="/assets/index.html.42b16337.js"><link rel="prefetch" href="/assets/disable.html.a298796c.js"><link rel="prefetch" href="/assets/encrypt.html.04234872.js"><link rel="prefetch" href="/assets/markdown.html.c40cf8e1.js"><link rel="prefetch" href="/assets/JVM到底该学习些什么.html.37a1cd31.js"><link rel="prefetch" href="/assets/index.html.bdb8aaf2.js"><link rel="prefetch" href="/assets/我是一个垃圾.html.396cd500.js"><link rel="prefetch" href="/assets/CPU流水线与指令重排序.html.da7853a1.js"><link rel="prefetch" href="/assets/index.html.9cfc822d.js"><link rel="prefetch" href="/assets/用「闪电侠」解释一下进程和线程.html.9c93b056.js"><link rel="prefetch" href="/assets/缓存一致性与内存屏障.html.51552874.js"><link rel="prefetch" href="/assets/index.html.67e2e3d9.js"><link rel="prefetch" href="/assets/index.html.0a6236b7.js"><link rel="prefetch" href="/assets/什么是文件描述符.html.804cd066.js"><link rel="prefetch" href="/assets/index.html.1f5ae493.js"><link rel="prefetch" href="/assets/动态代理模式.html.90a17679.js"><link rel="prefetch" href="/assets/单例模式.html.c3742e12.js"><link rel="prefetch" href="/assets/工厂模式.html.f8c7f9d6.js"><link rel="prefetch" href="/assets/静态代理模式.html.7bbcf6f5.js"><link rel="prefetch" href="/assets/依赖倒置原则.html.56bde280.js"><link rel="prefetch" href="/assets/开闭原则.html.d45ce1b8.js"><link rel="prefetch" href="/assets/Google搜索为什么不能无限分页？.html.5b88d232.js"><link rel="prefetch" href="/assets/index.html.abd3d401.js"><link rel="prefetch" href="/assets/m1芯片电脑安装cerebro.html.0120f768.js"><link rel="prefetch" href="/assets/MySQL与Redis的数据一致性.html.5ba6736f.js"><link rel="prefetch" href="/assets/MySQL优化的5个维度.html.4362df81.js"><link rel="prefetch" href="/assets/MySQL索引的正确使用姿势.html.d51dd9cb.js"><link rel="prefetch" href="/assets/MySQL锁开篇.html.36ef8a4c.js"><link rel="prefetch" href="/assets/index.html.c8eb6a41.js"><link rel="prefetch" href="/assets/一条SELECT语句是如何执行的.html.2ace0b89.js"><link rel="prefetch" href="/assets/一条Update语句是如何执行的.html.8736dea8.js"><link rel="prefetch" href="/assets/为什么MySQL的主键查询这么快.html.69305ec3.js"><link rel="prefetch" href="/assets/为什么不建议你使用SELECT_.html.ee5e1bb5.js"><link rel="prefetch" href="/assets/事务的隔离性与MVCC.html.a4ad4ac5.js"><link rel="prefetch" href="/assets/从根儿上理解索引.html.c7e89f33.js"><link rel="prefetch" href="/assets/BIO与非阻塞IO.html.56cc747b.js"><link rel="prefetch" href="/assets/index.html.9d93e6d0.js"><link rel="prefetch" href="/assets/Redis持久化——AOF.html.3ef66ec5.js"><link rel="prefetch" href="/assets/Redis持久化——RDB.html.956f2216.js"><link rel="prefetch" href="/assets/鸡肋的Redis事务.html.bf1172f2.js"><link rel="prefetch" href="/assets/index.html.ccdcd4de.js"><link rel="prefetch" href="/assets/从0到1编写一款插件.html.5f51ccf3.js"><link rel="prefetch" href="/assets/index.html.530ae07a.js"><link rel="prefetch" href="/assets/如何同步配置.html.21989554.js"><link rel="prefetch" href="/assets/404.html.4285bac5.js"><link rel="prefetch" href="/assets/index.html.6717b2b6.js"><link rel="prefetch" href="/assets/index.html.5eae9e3f.js"><link rel="prefetch" href="/assets/index.html.85231e1c.js"><link rel="prefetch" href="/assets/index.html.07ef0efd.js"><link rel="prefetch" href="/assets/index.html.e5d6f701.js"><link rel="prefetch" href="/assets/index.html.accaa64c.js"><link rel="prefetch" href="/assets/index.html.9a9f30d6.js"><link rel="prefetch" href="/assets/index.html.68e6d714.js"><link rel="prefetch" href="/assets/index.html.b032f382.js"><link rel="prefetch" href="/assets/index.html.bc540566.js"><link rel="prefetch" href="/assets/index.html.4fa328ce.js"><link rel="prefetch" href="/assets/index.html.2c9f8626.js"><link rel="prefetch" href="/assets/index.html.6c184523.js"><link rel="prefetch" href="/assets/index.html.2309c271.js"><link rel="prefetch" href="/assets/index.html.94d1334e.js"><link rel="prefetch" href="/assets/index.html.3e9b5a53.js"><link rel="prefetch" href="/assets/index.html.da976a01.js"><link rel="prefetch" href="/assets/index.html.843e0dc5.js"><link rel="prefetch" href="/assets/index.html.e6adfc22.js"><link rel="prefetch" href="/assets/index.html.a46272a6.js"><link rel="prefetch" href="/assets/index.html.e68eec84.js"><link rel="prefetch" href="/assets/index.html.c3c92e66.js"><link rel="prefetch" href="/assets/index.html.a1ffa21c.js"><link rel="prefetch" href="/assets/index.html.5c810edd.js"><link rel="prefetch" href="/assets/index.html.7b661157.js"><link rel="prefetch" href="/assets/index.html.a61ab275.js"><link rel="prefetch" href="/assets/index.html.cd04393b.js"><link rel="prefetch" href="/assets/index.html.6ea94130.js"><link rel="prefetch" href="/assets/index.html.938c47df.js"><link rel="prefetch" href="/assets/index.html.b6e53603.js"><link rel="prefetch" href="/assets/index.html.abfe5d6e.js"><link rel="prefetch" href="/assets/index.html.799762a8.js"><link rel="prefetch" href="/assets/index.html.6a1f2c2a.js"><link rel="prefetch" href="/assets/index.html.91d708f1.js"><link rel="prefetch" href="/assets/index.html.2b208795.js"><link rel="prefetch" href="/assets/index.html.970ad9a6.js"><link rel="prefetch" href="/assets/index.html.18750c91.js"><link rel="prefetch" href="/assets/index.html.5832ab43.js"><link rel="prefetch" href="/assets/index.html.46963a2e.js"><link rel="prefetch" href="/assets/index.html.d8d0f261.js"><link rel="prefetch" href="/assets/index.html.656424fd.js"><link rel="prefetch" href="/assets/index.html.740f6c3e.js"><link rel="prefetch" href="/assets/index.html.75361b30.js"><link rel="prefetch" href="/assets/index.html.77d7aba9.js"><link rel="prefetch" href="/assets/index.html.c6475c4b.js"><link rel="prefetch" href="/assets/index.html.4f4df111.js"><link rel="prefetch" href="/assets/index.html.2ef7b821.js"><link rel="prefetch" href="/assets/index.html.0dc0a64e.js"><link rel="prefetch" href="/assets/index.html.8bde1faf.js"><link rel="prefetch" href="/assets/index.html.a8e5dab4.js"><link rel="prefetch" href="/assets/index.html.8dbe4bd2.js"><link rel="prefetch" href="/assets/index.html.72d090a7.js"><link rel="prefetch" href="/assets/index.html.f0f01938.js"><link rel="prefetch" href="/assets/index.html.899ba14c.js"><link rel="prefetch" href="/assets/index.html.1aac5a85.js"><link rel="prefetch" href="/assets/index.html.00e1e5ed.js"><link rel="prefetch" href="/assets/index.html.79aed47e.js"><link rel="prefetch" href="/assets/index.html.d40b22a3.js"><link rel="prefetch" href="/assets/index.html.50661535.js"><link rel="prefetch" href="/assets/index.html.47d81d31.js"><link rel="prefetch" href="/assets/index.html.3bf9cde9.js"><link rel="prefetch" href="/assets/index.html.e74f3868.js"><link rel="prefetch" href="/assets/home.html.0a39e1ac.js"><link rel="prefetch" href="/assets/update.html.d41a36d3.js"><link rel="prefetch" href="/assets/index.html.8ce6c1a4.js"><link rel="prefetch" href="/assets/index.html.d892d4ca.js"><link rel="prefetch" href="/assets/disable.html.feca1227.js"><link rel="prefetch" href="/assets/encrypt.html.6dd1693a.js"><link rel="prefetch" href="/assets/markdown.html.90c57cc5.js"><link rel="prefetch" href="/assets/JVM到底该学习些什么.html.748dcca7.js"><link rel="prefetch" href="/assets/index.html.0f2c8809.js"><link rel="prefetch" href="/assets/我是一个垃圾.html.c2dedb53.js"><link rel="prefetch" href="/assets/CPU流水线与指令重排序.html.d6501987.js"><link rel="prefetch" href="/assets/index.html.cc293dbb.js"><link rel="prefetch" href="/assets/用「闪电侠」解释一下进程和线程.html.ff47218f.js"><link rel="prefetch" href="/assets/缓存一致性与内存屏障.html.7cb837f2.js"><link rel="prefetch" href="/assets/index.html.b6c692db.js"><link rel="prefetch" href="/assets/index.html.36d79926.js"><link rel="prefetch" href="/assets/什么是文件描述符.html.03a9134e.js"><link rel="prefetch" href="/assets/index.html.403eaf64.js"><link rel="prefetch" href="/assets/动态代理模式.html.3382a4fc.js"><link rel="prefetch" href="/assets/单例模式.html.e398af04.js"><link rel="prefetch" href="/assets/工厂模式.html.1c29f15f.js"><link rel="prefetch" href="/assets/静态代理模式.html.e9a9e65e.js"><link rel="prefetch" href="/assets/依赖倒置原则.html.cfed4972.js"><link rel="prefetch" href="/assets/开闭原则.html.07c917ad.js"><link rel="prefetch" href="/assets/Google搜索为什么不能无限分页？.html.5218b4cb.js"><link rel="prefetch" href="/assets/index.html.3bef9268.js"><link rel="prefetch" href="/assets/m1芯片电脑安装cerebro.html.c79f4590.js"><link rel="prefetch" href="/assets/MySQL与Redis的数据一致性.html.650683c4.js"><link rel="prefetch" href="/assets/MySQL优化的5个维度.html.dd276592.js"><link rel="prefetch" href="/assets/MySQL索引的正确使用姿势.html.e43a936b.js"><link rel="prefetch" href="/assets/MySQL锁开篇.html.4312417c.js"><link rel="prefetch" href="/assets/index.html.52fbf30e.js"><link rel="prefetch" href="/assets/一条SELECT语句是如何执行的.html.e56c6d3a.js"><link rel="prefetch" href="/assets/一条Update语句是如何执行的.html.2b765326.js"><link rel="prefetch" href="/assets/为什么MySQL的主键查询这么快.html.03d68e34.js"><link rel="prefetch" href="/assets/为什么不建议你使用SELECT_.html.ebd9fc69.js"><link rel="prefetch" href="/assets/事务的隔离性与MVCC.html.68831001.js"><link rel="prefetch" href="/assets/从根儿上理解索引.html.4762ba49.js"><link rel="prefetch" href="/assets/BIO与非阻塞IO.html.823dc552.js"><link rel="prefetch" href="/assets/index.html.8baf2f95.js"><link rel="prefetch" href="/assets/Redis持久化——AOF.html.8c06f00f.js"><link rel="prefetch" href="/assets/Redis持久化——RDB.html.cd286dc6.js"><link rel="prefetch" href="/assets/鸡肋的Redis事务.html.a67a50d1.js"><link rel="prefetch" href="/assets/index.html.12b16d58.js"><link rel="prefetch" href="/assets/从0到1编写一款插件.html.eb3c5add.js"><link rel="prefetch" href="/assets/index.html.6b7245a5.js"><link rel="prefetch" href="/assets/如何同步配置.html.4cf3e6c5.js"><link rel="prefetch" href="/assets/404.html.4e4be11b.js"><link rel="prefetch" href="/assets/index.html.45b7f9f7.js"><link rel="prefetch" href="/assets/index.html.d093923a.js"><link rel="prefetch" href="/assets/index.html.8b820911.js"><link rel="prefetch" href="/assets/index.html.e7ad23bc.js"><link rel="prefetch" href="/assets/index.html.fe1df11a.js"><link rel="prefetch" href="/assets/index.html.7352c99f.js"><link rel="prefetch" href="/assets/index.html.c435077f.js"><link rel="prefetch" href="/assets/index.html.104d0f5c.js"><link rel="prefetch" href="/assets/index.html.f5585f62.js"><link rel="prefetch" href="/assets/index.html.ebbb496f.js"><link rel="prefetch" href="/assets/index.html.9050dd8e.js"><link rel="prefetch" href="/assets/index.html.66f49414.js"><link rel="prefetch" href="/assets/index.html.e930f19a.js"><link rel="prefetch" href="/assets/index.html.42c7bbbe.js"><link rel="prefetch" href="/assets/index.html.7285c2eb.js"><link rel="prefetch" href="/assets/index.html.bbaf227e.js"><link rel="prefetch" href="/assets/index.html.e3fde442.js"><link rel="prefetch" href="/assets/index.html.7c50d84e.js"><link rel="prefetch" href="/assets/index.html.b3cbffcd.js"><link rel="prefetch" href="/assets/index.html.62ee9702.js"><link rel="prefetch" href="/assets/index.html.2debbaa4.js"><link rel="prefetch" href="/assets/index.html.9dc8f507.js"><link rel="prefetch" href="/assets/index.html.09e7e8c2.js"><link rel="prefetch" href="/assets/index.html.5f069056.js"><link rel="prefetch" href="/assets/index.html.a7f1ae4f.js"><link rel="prefetch" href="/assets/index.html.30f1d7b9.js"><link rel="prefetch" href="/assets/index.html.1de98967.js"><link rel="prefetch" href="/assets/index.html.548d90ad.js"><link rel="prefetch" href="/assets/index.html.651110c2.js"><link rel="prefetch" href="/assets/index.html.45b71406.js"><link rel="prefetch" href="/assets/index.html.4f90b041.js"><link rel="prefetch" href="/assets/index.html.30234545.js"><link rel="prefetch" href="/assets/index.html.d2d34d0a.js"><link rel="prefetch" href="/assets/index.html.a9d78eed.js"><link rel="prefetch" href="/assets/index.html.0b7066f1.js"><link rel="prefetch" href="/assets/index.html.fa43fb4d.js"><link rel="prefetch" href="/assets/index.html.ddc062c2.js"><link rel="prefetch" href="/assets/index.html.8ba1f500.js"><link rel="prefetch" href="/assets/index.html.984619d2.js"><link rel="prefetch" href="/assets/index.html.23417bb8.js"><link rel="prefetch" href="/assets/index.html.2288b8be.js"><link rel="prefetch" href="/assets/index.html.4f7f5c89.js"><link rel="prefetch" href="/assets/index.html.588b3b32.js"><link rel="prefetch" href="/assets/index.html.13296de3.js"><link rel="prefetch" href="/assets/index.html.57925638.js"><link rel="prefetch" href="/assets/index.html.ba85260b.js"><link rel="prefetch" href="/assets/index.html.64083fff.js"><link rel="prefetch" href="/assets/index.html.004e7946.js"><link rel="prefetch" href="/assets/index.html.1e6478b4.js"><link rel="prefetch" href="/assets/index.html.c83a65ff.js"><link rel="prefetch" href="/assets/index.html.716585f3.js"><link rel="prefetch" href="/assets/index.html.4198b78d.js"><link rel="prefetch" href="/assets/index.html.76594791.js"><link rel="prefetch" href="/assets/index.html.902bd2bd.js"><link rel="prefetch" href="/assets/index.html.7f3fb562.js"><link rel="prefetch" href="/assets/index.html.c684ef10.js"><link rel="prefetch" href="/assets/index.html.75c631cf.js"><link rel="prefetch" href="/assets/index.html.def6ee32.js"><link rel="prefetch" href="/assets/index.html.3a471deb.js"><link rel="prefetch" href="/assets/index.html.9785d007.js"><link rel="prefetch" href="/assets/index.html.b25dc0cb.js"><link rel="prefetch" href="/assets/404.cb0b2bad.js"><link rel="prefetch" href="/assets/Layout.74ccbd97.js"><link rel="prefetch" href="/assets/Slide.d30de832.js"><link rel="prefetch" href="/assets/Blog.ae7c67e2.js"><link rel="prefetch" href="/assets/giscus.8fe73ced.js"><link rel="prefetch" href="/assets/auto.esm.2565cd3a.js"><link rel="prefetch" href="/assets/index.d8a59108.js"><link rel="prefetch" href="/assets/index.1842ee54.js"><link rel="prefetch" href="/assets/mermaid.esm.min.ee1e0284.js"><link rel="prefetch" href="/assets/highlight.esm.d982e650.js"><link rel="prefetch" href="/assets/markdown.esm.832a189d.js"><link rel="prefetch" href="/assets/math.esm.a3f84b6f.js"><link rel="prefetch" href="/assets/notes.esm.3c361cb7.js"><link rel="prefetch" href="/assets/reveal.esm.b96f05d8.js"><link rel="prefetch" href="/assets/search.esm.80da4a02.js"><link rel="prefetch" href="/assets/zoom.esm.8514a202.js"><link rel="prefetch" href="/assets/photoswipe.esm.218074cd.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/" class="brand"><img class="logo" src="https://img-blog.csdnimg.cn/d16e11af2edb4972833f88083d2f0375.png" alt="蝉沐风"><!----><span class="site-name hide-in-pad">蝉沐风</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="主页"><span class="icon iconfont icon-home"></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="技术博文"><span class="title"><span class="icon iconfont icon-xieboke"></span>技术博文</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>内功心法</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/basic/design-pattern/" class="nav-link" aria-label="设计模式"><span class="icon iconfont icon-design"></span>设计模式<!----></a></li><li class="dropdown-subitem"><a href="/posts/basic/design-principle/%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99.html" class="nav-link" aria-label="设计原则"><span class="icon iconfont icon-design"></span>设计原则<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>存储篇</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/storage/MySQL" class="nav-link" aria-label="MySQL"><span class="icon iconfont icon-mysql"></span>MySQL<!----></a></li><li class="dropdown-subitem"><a href="/posts/storage/Redis" class="nav-link" aria-label="Redis"><span class="icon iconfont icon-redis"></span>Redis<!----></a></li><li class="dropdown-subitem"><a href="/posts/storage/ElasticSearch" class="nav-link" aria-label="ElasticSearch"><span class="icon iconfont icon-elasticsearch-Elasticsearch"></span>ElasticSearch<!----></a></li></ul></li><li class="dropdown-item"><a href="/posts/concurrency" class="nav-link" aria-label="并发篇"><span class="icon iconfont icon-CPU"></span>并发篇<!----></a></li><li class="dropdown-item"><a href="/posts/JVM" class="nav-link" aria-label="JVM"><span class="icon iconfont icon-PCxuniji"></span>JVM<!----></a></li><li class="dropdown-item"><a href="/posts/os" class="nav-link" aria-label="Linux"><span class="icon iconfont icon-linux"></span>Linux<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="开发工具"><span class="title"><span class="icon iconfont icon-keyboard"></span>开发工具</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/posts/tools/IDEA" class="nav-link" aria-label="IDEA"><span class="icon iconfont icon-jetbrains"></span>IDEA<!----></a></li><li class="dropdown-item"><a href="/posts/tools/VSCode" class="nav-link" aria-label="VSCode"><span class="icon iconfont icon-VsCode"></span>VSCode<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="/posts/network-programming" class="nav-link active" aria-label="socket编程"><span class="icon iconfont icon-wangluojiekou"></span>socket编程<!----></a></div><div class="nav-item hide-in-mobile"><a href="/update.html" class="nav-link" aria-label="最近更新"><span class="icon iconfont icon-Update"></span>最近更新<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://space.bilibili.com/519360358" rel="noopener noreferrer" target="_blank" aria-label class="nav-link"><span class="icon iconfont icon-bilibili"></span><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!----></div><div class="navbar-right"><!----><!----><div class="nav-item"><a class="repo-link" href="https://github.com/chanmufeng/chanmufeng.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><div id="docsearch-container"></div><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->简明socket编程</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down" localizeddate="2022年10月5日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://www.chanmufeng.com" target="_blank" rel="noopener noreferrer">蝉沐风</a></span><span property="author" content="蝉沐风"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022年10月5日</span><meta property="datePublished" content="2022-10-05T00:00:00.000Z"></span><span class="category-info" aria-label="分类🌈" data-balloon-pos="down" localizeddate="2022年10月5日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><ul class="categories-wrapper"><li class="category category1 clickable" role="navigation">socket</li><meta property="articleSection" content="socket"></ul></span><span aria-label="标签🏷" data-balloon-pos="down" localizeddate="2022年10月5日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><ul class="tags-wrapper"><li class="tag tag7 clickable" role="navigation">socket编程</li></ul><meta property="keywords" content="socket编程"></span><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down" localizeddate="2022年10月5日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 107 分钟</span><meta property="timeRequired" content="PT107M"></span><!----><span class="words-info" aria-label="字数🔠" data-balloon-pos="down" localizeddate="2022年10月5日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 31968 字</span><meta property="wordCount" content="31968"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_1-简介" class="router-link-active router-link-exact-active toc-link level2">1. 简介</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_2-导读" class="router-link-active router-link-exact-active toc-link level2">2. 导读</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_3-什么是socket" class="router-link-active router-link-exact-active toc-link level2">3. 什么是socket</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_3-1-两种internet-socket" class="router-link-active router-link-exact-active toc-link level3">3.1. 两种Internet Socket</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_3-2-漫谈网络" class="router-link-active router-link-exact-active toc-link level3">3.2. 漫谈网络</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_4-ip地址、struct以及地址转换" class="router-link-active router-link-exact-active toc-link level2">4. IP地址、struct以及地址转换</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_4-1-ipv4与ipv6" class="router-link-active router-link-exact-active toc-link level3">4.1. IPv4与IPv6</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_4-2-字节序" class="router-link-active router-link-exact-active toc-link level3">4.2. 字节序</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_4-3-socket相关的数据结构" class="router-link-active router-link-exact-active toc-link level3">4.3. socket相关的数据结构</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_4-4-ip的二进制转换" class="router-link-active router-link-exact-active toc-link level3">4.4. IP的二进制转换</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_5-从ipv4迁移到ipv6" class="router-link-active router-link-exact-active toc-link level2">5. 从IPv4迁移到IPv6</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-socket编程相关函数" class="router-link-active router-link-exact-active toc-link level2">6. socket编程相关函数</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-1-getaddrinfo-—准备开始" class="router-link-active router-link-exact-active toc-link level3">6.1. getaddrinfo()—准备开始！</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-2-socket-—拿到套接字描述符" class="router-link-active router-link-exact-active toc-link level3">6.2. socket()—拿到套接字描述符！</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-3-bind-—我在监听哪个端口" class="router-link-active router-link-exact-active toc-link level3">6.3. bind()—我在监听哪个端口?</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-4-connect-—嘿-你好啊" class="router-link-active router-link-exact-active toc-link level3">6.4. connect()—嘿，你好啊！</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-5-listen-—会有人联系我吗" class="router-link-active router-link-exact-active toc-link level3">6.5. listen()—会有人联系我吗?</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-6-accept-—感谢呼叫3490端口" class="router-link-active router-link-exact-active toc-link level3">6.6. accept()—感谢呼叫3490端口</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-7-send-and-recv-—跟我唠唠吧-宝儿" class="router-link-active router-link-exact-active toc-link level3">6.7. send() and recv()—跟我唠唠吧，宝儿!</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-8-sendto-and-recvfrom-—用dgram风格跟我说话" class="router-link-active router-link-exact-active toc-link level3">6.8. sendto() and recvfrom()—用DGRAM风格跟我说话</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-9-close-and-shutdown-—滚犊子" class="router-link-active router-link-exact-active toc-link level3">6.9. close() and shutdown()—滚犊子！</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-10-getpeername-—你哪位" class="router-link-active router-link-exact-active toc-link level3">6.10. getpeername()—你哪位?</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-11-gethostname-—我是谁" class="router-link-active router-link-exact-active toc-link level3">6.11. gethostname()—我是谁?</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_7-client-server基础" class="router-link-active router-link-exact-active toc-link level2">7. Client-Server基础</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_7-1-一个简单的stream-server" class="router-link-active router-link-exact-active toc-link level3">7.1. 一个简单的stream server</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_7-2-一个简单的stream-client" class="router-link-active router-link-exact-active toc-link level3">7.2. 一个简单的stream client</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_7-3-datagram-sockets" class="router-link-active router-link-exact-active toc-link level3">7.3. Datagram Sockets</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-技术进阶" class="router-link-active router-link-exact-active toc-link level2">8. 技术进阶</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-1-blocking—何谓阻塞" class="router-link-active router-link-exact-active toc-link level3">8.1. Blocking—何谓阻塞？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-2-poll-—同步的i-o多路复用" class="router-link-active router-link-exact-active toc-link level3">8.2. poll()—同步的I/O多路复用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-3-select-—老古董的同步i-o多路复用" class="router-link-active router-link-exact-active toc-link level3">8.3. select()—老古董的同步I/O多路复用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-4-数据只传了一部分怎么办" class="router-link-active router-link-exact-active toc-link level3">8.4. 数据只传了一部分怎么办？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-5-serialization-如何封装数据" class="router-link-active router-link-exact-active toc-link level3">8.5. Serialization-如何封装数据？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-6-数据封装" class="router-link-active router-link-exact-active toc-link level3">8.6. 数据封装</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-7-广播数据包-大声说「hello-world」" class="router-link-active router-link-exact-active toc-link level3">8.7. 广播数据包-大声说「Hello，World」</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_9-常见问题" class="router-link-active router-link-exact-active toc-link level2">9. 常见问题</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-man手册" class="router-link-active router-link-exact-active toc-link level2">10. man手册</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-1-accept" class="router-link-active router-link-exact-active toc-link level3">10.1. accept()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-2-bind" class="router-link-active router-link-exact-active toc-link level3">10.2. bind()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-3-connect" class="router-link-active router-link-exact-active toc-link level3">10.3. connect()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-4-close" class="router-link-active router-link-exact-active toc-link level3">10.4. close()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-5-getaddrinfo-freeaddrinfo-gai-strerror" class="router-link-active router-link-exact-active toc-link level3">10.5. getaddrinfo(), freeaddrinfo(), gai_strerror()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-6-gethostname" class="router-link-active router-link-exact-active toc-link level3">10.6. gethostname()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-7-gethostbyname-gethostbyaddr" class="router-link-active router-link-exact-active toc-link level3">10.7. gethostbyname(), gethostbyaddr()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-8-getnameinfo" class="router-link-active router-link-exact-active toc-link level3">10.8. getnameinfo()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-9-shutdown" class="router-link-active router-link-exact-active toc-link level3">10.9. shutdown()</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_11-更多资料" class="router-link-active router-link-exact-active toc-link level2">11. 更多资料</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_12-后记" class="router-link-active router-link-exact-active toc-link level2">12. 后记</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h2 id="_1-简介" tabindex="-1"><a class="header-anchor" href="#_1-简介" aria-hidden="true">#</a> 1. 简介</h2><h2 id="_2-导读" tabindex="-1"><a class="header-anchor" href="#_2-导读" aria-hidden="true">#</a> 2. 导读</h2><h2 id="_3-什么是socket" tabindex="-1"><a class="header-anchor" href="#_3-什么是socket" aria-hidden="true">#</a> 3. 什么是socket</h2><p>你一直在听别人谈论&quot;<code>sockets</code>&quot;，或许你也想搞明白这到底是个什么东西。</p><p>好吧，它们其实就是：「使用标准的<code>Unix file descriptors</code>（Unix文件描述符）与其他程序进行沟通的一种方式」。</p><p>啥玩意儿？</p><p>如果接触过Unix，你一定听说过「Unix一切皆文件」的说法。</p><p>一定意义上来说，这个说法并没有什么错。因为Unix程序做任何I/O操作，都是通过对<code>file descriptor</code>（文件描述符）进行读写来实现的。</p><p>文件描述符其实就是一个整数罢了，只是这个整数关联了一个打开的文件。这里的文件可以是一个<code>网络连接</code>、<code>FIFO</code>、<code>pipe</code>（管道）、<code>terminal</code>（终端）、磁盘中的实际文件等等。</p><blockquote><p>我之前写过一篇《<a href="https://www.chanmufeng.com/posts/os/%E4%BB%80%E4%B9%88%E6%98%AF%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6.html" target="_blank" rel="noopener noreferrer">什么是文件描述符<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>》的文章，感兴趣的话大家可以看一下</p></blockquote><p>所以「Unix一切皆文件」的说法并非是夸大其词。</p><p>不管你信不信，当你想通过网络和另一个程序进行通讯时，你必须通过<code>file descriptor</code>来实现。</p><p>那么怎么获取到和网络通信相关的这个<code>file descriptor</code>呢？</p><p>我们可以使用<code>socket()</code>函数，这个函数会返回一个<code>socket descriptor</code>（<code>socket</code>都是一个文件，<code>socket descriptor</code>自然就是一个<code>file descriptor</code>了）。然后你就可以通过这个<code>socket descriptor</code>，使用<code>send()</code>和<code>recv()</code>这两个函数与其他程序进行通信了。</p><p>如果你用C语言对文件进行过读写操作，你就知道<code>read()/write()</code>这一组函数同样可以作用于<code>file descriptor</code>，为什么不用这一套函数呢？</p><p>当然完全可以用！只不过<code>send()/recv()</code>在数据传输方面比<code>read/write()</code>提供了更多可选项罢了。</p><p>其实<code>sockets</code>的种类有很多，比如：</p><ul><li>DARPA Internet addresses，简称<code>Internet Sockets </code></li></ul><p>Internet Sockets是我们接下来讲解的重点，因为它是我们目前进行网络通信时使用最多的一种Socket.</p><blockquote><p>DARPA表示国防部高级研究计划局</p></blockquote><ul><li>path names on a local node，简称<code>Unix Sockets</code></li></ul><p>这个英文翻译成中文也不是很直观，所以干脆不翻译了，<code>Unix Sockets</code>有时候被称为<code>Unix域套接字</code>。简而言之，<code>Unix Sockets</code>是用于同一台主机中进程间通讯的一种方式。</p><p>使用过MySQL的朋友很可能见过下面这个错误：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>ERROR <span class="token number">2002</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: 
Can<span class="token string">&#39;t connect to local MySQL server through socket &#39;</span>/var/lib/mysql/mysql.sock&#39; <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这个错误说明MySQL Client和MySQL Server运行在同一台主机上，并且两个进程通过<code>/var/lib/mysql/mysql.sock</code>这个文件进行通信，这个文件就是Unix域套接字文件，不需要经过网络协议栈，不需要打包拆包、计算校验和、维护序列号应答等等网络通信细节。</p><p>你可能会问，MySQL Client和MySQL Server之间为什么不通过本地网络进行通信呢？</p><p>这和你对MySQL的配置有关系。</p><p>如果你指定的MySQL主机名为<code>localhost</code>，或者你指定了<code>--protocl=socket</code>的启动参数，那么Client和Server之间就会通过<code>Unix域套接字</code>进行通信了。</p><p>相反，如果你指定的MySQL主机名是<code>127.0.0.1</code>，那么Client和Server之间就会通过<code>Internet Sockets</code>进行通信了。</p><h3 id="_3-1-两种internet-socket" tabindex="-1"><a class="header-anchor" href="#_3-1-两种internet-socket" aria-hidden="true">#</a> 3.1. 两种Internet Socket</h3><p>啥？只有两种<code>Internet Socket</code>吗？</p><p>开玩笑的啦，当然远不止两种喽。但是为了怕吓到你，这里主要介绍<code>Stream Sockets</code>以及<code>Datagram Sockets</code>。除此之外，<code>Raw Sockets</code>（原始套接字）也是一种功能更加强大的Socket，如果感兴趣，你可以查一查资料了解一下。</p><p><img src="http://qiniu.chanmufeng.com/2022-09-30-074116.png" alt="image-20220930154115557" loading="lazy"></p><p>如果要进行网络通信，我们要做的第一件事肯定是调用<code>socket()</code>函数，并指定想使用的套接字类型，比如<code>SOCK_STREAM</code>、<code>SOCK_DGRAM</code>、<code>SOCK_RAW</code>等类型，他们分别表示<code>Stream Sockets</code>、<code>Datagram Sockets</code>以及<code>Raw Sockets</code>。</p><p>我们先从<code>Stream Sockets</code>说起。</p><h4 id="_3-1-1-stream-sockets" tabindex="-1"><a class="header-anchor" href="#_3-1-1-stream-sockets" aria-hidden="true">#</a> 3.1.1. Stream Sockets</h4><p><code>Stream sockets</code>是一种可靠的、支持双向连接的通信流。</p><p>如果你以“1，2”的顺序将这串数字发送到socket中，那么在接收端就会以同样的顺序接受到“1，2”，肯定不会出错。</p><p>哪里会用到<code>Stream sockets</code>呢？</p><p>或许你听说过<code>telnet</code>程序？<code>telnet</code>用的就是<code>Stream sockets</code>，你输入的每个字符都必须按照你的输入顺序依次抵达，要不然指令肯定就错乱了不是？</p><p>同样，浏览器使用的<code>HTTP</code>协议底层也使用了<code>Stream sockets</code>来获取网页信息。如果你通过80端口<code>telnet</code>到一个网站，并输入 &quot;<code>GET / HTTP/1.0</code>&quot;，然后按两下Enter，你就会收到网站发送给你的 HTML ！</p><p><code>Stream sockets</code> 是怎么做到如此高质量地传输数据的呢？</p><p><code>Stream sockets </code>底层使用了 &quot;The Transmission Control Protocol&quot;（传输控制协议），就是大名鼎鼎的 &quot;<code>TCP</code>&quot;（TCP 的全部细节可以参考<a href="https://tools.ietf.org/html/rfc793" target="_blank" rel="noopener noreferrer">RFC 793<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>）。</p><p><code>TCP </code>会确保你的数据可以按照顺序抵达而且不会出错。你之前可能是从&quot;<code>TCP/IP</code>&quot;这个专业名词中听说的<code>TCP</code>，其中的<code>IP</code> 是指 &quot;Internet Protocol&quot;（网络协议，详见 <a href="https://tools.ietf.org/html/rfc791" target="_blank" rel="noopener noreferrer">RFC 791<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>）。<code>IP</code> 主要处理数据在各个节点之间的Internet routing（网络路由），通常不保障数据的完整性。</p><h4 id="_3-1-2-datagram-sockets" tabindex="-1"><a class="header-anchor" href="#_3-1-2-datagram-sockets" aria-hidden="true">#</a> 3.1.2. Datagram Sockets</h4><p><code>Datagram sockets</code> 有时候被叫做 “connectionless sockets”（无连接的sockets），而且，这玩意通常也不怎么可靠！</p><p>为啥？</p><p>因为<code>Datagram Sockets</code>底层用的是“User Datagram Protocol”（用户数据报协议，详见<a href="https://tools.ietf.org/html/rfc768" target="_blank" rel="noopener noreferrer">RFC 768<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>），也就是“<code>UDP</code>”。</p><p><code>UDP</code>并不像<code>TCP</code>那样会直接在传输层将数据量过大的消息分片（TCP segments），而是会在IP层被动进行分包，将一个IP packet分包成多个IP fragments。这样一来，接收端就必须做IP fragments的重组，合并为原来的IP packet，这无疑增加了数据包丢失的概率。（其实分包倒还好，主要是UDP没有TCP那么强大的纠错能力）</p><p>如果你发送了一个 <code>datagram</code>（UDP的数据报），它可能会顺利抵达、但可能不会按照发送顺序抵达。</p><blockquote><p>译者注：下文将称UDP发送的数据为datagram，之后提到这个词就意味着使用的是UDP协议</p></blockquote><p>那为什么又会被称为“无连接的sockets”呢？</p><p>因为<code>Datagram Sockets</code>不用像<code>Stream Sockets</code>一样维持双方的连接，我们只需要把需要发送的数据打包，给它一个目的地信息，然后发送出去就行了。</p><p>因此当<code>TCP</code>协议不可用，或者你很确定丢几个数据包不至于惹什么大乱子的情况下，不妨使用<code>datagram socket</code>。这样的使用场景有很多，比如<code>tftp</code>（trivial file transfer protocol，简易文件传输协议，是 <code>FTP</code> 协议的小兄弟），多人游戏以及视频会议等。</p><p>事情有点不太对劲！<code>tftp</code>可是进行文件传输的协议啊，如果传输过程中丢包了，客户根本没法正常使用啊。</p><p>没错！<code>UDP</code>是不可靠的，但是我们可以在<code>UDP</code>的上层使用可靠的应用层协议，就比如<code>tftp</code>协议。<code>tftp </code>协议会死死盯着自己发送的每个数据包，要求接受方必须回复一个数据包来表示＂我收到了！＂（一个＂<code>ACK</code>＂回复数据包）。如果发送方在5秒内沒有收到<code>ACK</code>，表示它该重传这个数据包，直到收到 <code>ACK </code>为止。在不可靠的<code>UDP</code>上构建可靠的<code>SOCK_DGRAM</code>应用程序，这种<code>ACK</code>机制非常值得借鉴。</p><p>既然有了<code>TCP</code>这种可靠的传输，<code>UDP</code>有存在的必要吗？</p><p>这里有两个原因来说明<code>UDP</code>的必要性，第一个原因是速度，第二个原因还是速度。（鲁迅既视感）</p><p>相比于跟踪数据包的抵达状况并确保数据包的顺序性这种累活儿，“数据包丢了就丢了”这种处理态度可能更高效。如果你是要发送聊天信息，<code>TCP</code>是个好的选择。但是如果你想为全世界的游戏玩家每秒送出40个位置更新信息，并且丢一两个数据包也无足轻重的话，<code>UDP</code>肯定是不二之选。</p><h3 id="_3-2-漫谈网络" tabindex="-1"><a class="header-anchor" href="#_3-2-漫谈网络" aria-hidden="true">#</a> 3.2. 漫谈网络</h3><p>学习计算机怎么能不谈网络分层呢。下面我们就简单了解一下网络是怎样工作的，并且举一些如何<code>SOCK_DGRAM</code> 封包的例子。</p><p>实际上，如果你可以跳过这一节内容，不过，这一节能帮你很好的了解网络背景，有一定的参考意义。</p><p><img src="http://qiniu.chanmufeng.com/2022-10-01-012138.png" alt="数据封装" loading="lazy"></p><p>现在是时候了解一下<code>*Data Encapsulation*</code>（数据封装）了，它实在实在是非常重要！即便如此，在大部分的网络课程的学习中，所占的笔墨并不算多。</p><p>一般情况下，我们会这么讲：</p><p>你发送的数据构成了最初始的数据包，然后将数据包封装到应用层协议（比如<code>TFTP</code>协议）的<code>header</code>中，然后将封装之后的包再次封装到下一个协议（<code>UDP</code>）中，再接着被封装到下一个协议（<code>IP</code>协议），最终被硬件层面的通讯协议（以太网协议）封装。</p><p>接收方接收到数据后，硬件层会拆掉<code>以太网header</code>和<code>footer</code>，操作系统内核会拆开 <code>IP</code> 与<code> UDP header</code>，最后由应用层程序<code> TFTP</code> 解开<code> TFTP header</code>，最终获取到用户数据。</p><p><img src="http://qiniu.chanmufeng.com/2022-10-01-080343.png" alt="image-20221001160343286" loading="lazy"></p><p>接下来终于可以聊一聊声名狼藉的网络分层模型（Layered Network Model），也就是 &quot;<strong>ISO/OSI</strong>&quot;了。</p><p>说它声名狼藉，是因为所有入门计算机网络的人首先学习的便是这个分层模型，而对刚接触网络的小白而言很难对分层有很深的理解和感悟，只能是死记硬背，最终的结果就是应付考试而已。</p><p>20世界70年代后期，国际标准化组织（ISO）提出计算机网络应该组织为大概7层，并称之为开放系统互连（OSI）模型。事实上，OSI模型的创建者提出这个模型的时候并没有联想到如今使用的因特网，但并不妨碍OSI模型到如今依然适用，这便是抽象的能力。</p><p>OSI模型将网络分层为：</p><ul><li>应用层</li><li>表示层</li><li>会话层</li><li>传输层</li><li>网络层</li><li>链路层</li><li>物理层</li></ul><p>但是这种分层实在是过于繁琐，因此现在介绍网络分层，一般都是拿<code>TCP/IP</code>协议栈来进行说明。</p><ul><li>应用层（比如<code>telnet</code>、<code>ftp</code>等）</li><li>传输层（<code>TCP</code>、<code>UDP</code>等）</li><li>网络层（<code>IP</code>、<code>ICMP</code>以及<code>IGMP</code>）</li><li>网络接口层（<code>以太网</code>、<code>wi-fi</code>等）</li></ul><p>每一层分别负责不同的通信功能：</p><ol><li>应用层负责处理特定应用程序的细节。比如对用户消息的加密解密操作、按照特定格式对数据进行组装或解析等。</li><li>传输层主要为两台主机上的应用程序提供端到端的通信。所谓的端到端，就是能找到真正处理数据包的两个进程。举个例子就是快递能够保证送货上门，而不只是送到小区驿站。</li><li>网络层，用于主机之间的路由，就是只负责找到对应的主机。</li><li>网络接口层，有时候也被称为数据链路层或链路层，通常包括操作系统中的设备驱动程序和计算机的网卡设备，它们一起处理与物理传输媒介的通信细节。</li></ol><h2 id="_4-ip地址、struct以及地址转换" tabindex="-1"><a class="header-anchor" href="#_4-ip地址、struct以及地址转换" aria-hidden="true">#</a> 4. IP地址、struct以及地址转换</h2><p>终于要讲点好玩儿的东西了，这一章我们要开始写一点代码了。</p><p>但是首先，我们还得再聊一些与代码无关的东西。</p><p>先稍微介绍一点IP address（IP地址）和port（端口）的知识，入个门；然后我们会讨论socket API是如何存储和操作IP address以及其他数据的。</p><h3 id="_4-1-ipv4与ipv6" tabindex="-1"><a class="header-anchor" href="#_4-1-ipv4与ipv6" aria-hidden="true">#</a> 4.1. IPv4与IPv6</h3><p>远在「卧龙凤雏」成为贬义词之前，就有一个很棒的网络路由系统（ network routing system）了，称为<strong>互联网通信协议第四版</strong>（ Internet Protocol Version 4），又称为 IPv4。它的地址由4个字节组成，通常被写作<strong>点分十进制</strong>的形式，即四个字节被分开用十进制写出，中间用点分隔，比如：<code>192.0.2.111</code>。</p><p>你大概率见过不少IPv4的地址了。</p><p>实际上，在撰写本文之前，几乎整个互联网的各个网站都还用的是IPv4。</p><p>人们用IPv4用的很开心，一切都是如此美好。直到一个叫 Vint Cerf 的老头儿提出了警告，说是IPv4的地址即将耗尽。</p><blockquote><p>除了警告每个人即将到来的IPv4危机，<a href="https://en.wikipedia.org/wiki/Vint_Cerf" target="_blank" rel="noopener noreferrer">Vint Cerf<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 本身还是鼎鼎大名的“Internet之父”，我实在是没有什么资格评判他的判断。</p></blockquote><p>IPv4地址耗尽？这怎么可能呢？32-bit的IPv4有几十亿个IP地址呢，我们真的有几十亿台电脑在用吗？</p><p>是的。</p><p>一开始在电脑数量还不多的时候，大家也是认为这个数量已经足够了，几十亿已经算是一个天文数字了。甚至当时还很慷慨地分给某些大型组织几百万个IP地址给他们使用（比如Xerox、MIT、Ford、HP、IBM、GE、AT&amp;T 及某个名为 Apple 的小公司，等等）。</p><p>事实上，要不是我们用了一些小手段（NAT转换等），IPv4早就被用尽了。</p><p>我们现在生活于每个人、每台电脑、每部计算器、每个电话、每部停车计时收费器，甚至是每个玩具小狗（没什么不可能的）都有一个IP地址的时代。</p><p>于是乎，128-bit的IPv6诞生了。</p><p>Vint Cerf 或许是不朽的，可是谁也架不住在每次地址不够用而研发下一代Internet协议的时候，他老人家出来嘟囔一句：“我早就说过了吧...。。。”</p><p>所以，我们应该怎么堵住他的嘴？</p><p>我们需要更多的地址，不只是需要两倍以上的地址、也不止几十亿倍、更不止于千兆倍，而是需要79✖️百万✖️十亿✖️兆倍以上的可用地址！我们终将见识到。</p><p>你可能会说：“真的吗？这个数字大的让我有点不可置信。”</p><p>32-bit和128-bit听起来差得并不算太多，只是多了96个bit而已。但是需要注意的是，这里说的可是等比数列，32 bits可以表示<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup></mrow><annotation encoding="application/x-tex">2^{32}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span></span></span></span></span></span></span></span></span> 个数字，128 bits可以表示<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>128</mn></msup></mrow><annotation encoding="application/x-tex">2^{128}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">128</span></span></span></span></span></span></span></span></span></span></span></span>（大约340个兆兆兆）个数字，大到我都不知道怎么读。。。。。。这么说吧，这个数字相当于宇宙中的每颗星星都能拥有一百万个 IPv4 地址。</p><p>忘记点分十进制的IPv4的写法吧，现在我们有了16进制表示法，每两个字节之间用<code>:</code>分隔，类似这样：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>2001:0db8:c9d2:aee5:73e3:934a:a5ae:9551
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>还没完呢！大多时候，IP地址里边会有很多个0，你可以将它们压缩到两个冒号之间，而且可以省略每个字节对开头的0。例如，这些地址对中的每一对都是等价的：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>2001:0db8:c9d2:0012:0000:0000:0000:0051
2001:db8:c9d2:12::51
    
2001:0db8:ab00:0000:0000:0000:0000:0000
2001:db8:ab00::
    
0000:0000:0000:0000:0000:0000:0000:0001
::1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>地址 <code>::1</code> 是個 loopback（本地回环）地址，相当于 IPv4 中的<code>127.0.0.1</code>。</p><p>最后，你可能会碰到 IPv6 与 IPv4 兼容的模式。你如果愿意，你可以将 IPv4地址 <code>192.0.2.33</code> 用 IPv6 形式表示：<code>::ffff:192.0.2.33</code>。</p><p>事实上，IPv6的创建者们已经肆无忌惮地保留了万亿计的地址以供备用，这真是太有趣了，但坦白地讲，我们有这么多地址，谁在意呢？</p><h4 id="_4-1-1-子网" tabindex="-1"><a class="header-anchor" href="#_4-1-1-子网" aria-hidden="true">#</a> 4.1.1. 子网</h4><p>现代的互联网是基于<code>TCP/IP</code>的思路来设计的，说得通俗点就是互联网由许许多多的小子网组成，子网中的设备用集线器进行连接，子网之间通过路由器进行互联，如下图：</p><p><img src="http://qiniu.chanmufeng.com/2022-10-03-040038.png" alt="image-20221003120038276" loading="lazy"></p><p>为了更好地管理IP地址（其实也是践行上面这个思路），IP地址本身被分成了两部分，分别是网络号和主机号。</p><p>更具体地，互联网诞生之初，IP地址曾经被分成了<code>A</code>、<code>B</code>、<code>C</code>、<code>D</code>、<code>E</code> 5类，很多计算机网络的书介绍IP地址的时候也是以这个分类开始的。</p><p>但是这个划分依然是一个历史概念，实际使用中已经没有任何意义！因此关于这部分知识的讲述都可以直接忽略。</p><p>取而代之的是在1993年，因特网工程任务组IETF又提出了<strong>无分类编址</strong>（CIDR）的方法来解决IPv4地址紧缺的问题，当然了，同时启动的还有彻底解决IP地址耗尽问题的IPv6项目。</p><p>在互联网中，每个设备都会被分配一个IP地址（其实被分配IP地址的是设备上的网卡，如果一台设备有多个网卡，自然就会有多个IP地址），这个地址就相当于“XX路XX号”，其中“路”就相当于网络号，“号”就相当于主机号，两者合起来就是IP地址啦！</p><p>因此，理论上我们应该能通过IP地址识别出主机处于的子网号，以及子网下的主机号。</p><p>IPv4的IP地址由<code>32</code>个bit组成，按照每<code>8</code>个比特（1字节）为一组分成4组，但是仅凭这一串数字根本无法区分哪部分是网络号，哪部分是主机号。</p><p>因此需要某些附加信息。这个附加信息就是<strong>子网掩码</strong>。</p><p>子网掩码的格式是一串与IP地址长度相同的<code>32</code>比特数字，左边是一串连续的<code>1</code>，右边剩下的都是<code>0</code>。其中为<code>1</code>的那一部分表示的是网络号，剩下为<code>0</code>的一部分表示的是主机号。子网掩码表示网络号与主机号之间的边界，正规的表示方式如下所示：</p><p><img src="http://qiniu.chanmufeng.com/2022-10-03-130009.png" alt="image-20221003210009224" loading="lazy"></p><p>一种最简单的表示方法是，把<code>1</code>的部分的比特数用十进制的方式写在IP地址的右侧，比如：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>182.92.193.45/24
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_4-1-2-端口号" tabindex="-1"><a class="header-anchor" href="#_4-1-2-端口号" aria-hidden="true">#</a> 4.1.2. 端口号</h4><p>如果你還記得我之前跟你說過的分層網路模型（Layered Network Model），它將網路層（IP）與主機到主機間的傳輸層［TCP 與 UDP］分開。</p><p>我們要加快腳步了。</p><p>除了 IP address 之外［IP 層］，有另一個 TCP［stream socket］使用的位址，剛好 UDP［datagram socket］也用這個，就是 port number，這是一個 16-bit 的數字，就像是連線的本地端位址一樣。</p><p>將 IP address 想成飯店的地址，而 port number 就是飯店的房間號碼。這是貼切的比喻；或許以後我會用汽車工業來比喻。</p><p>你說想要有一台電腦能處理收到的電子郵件與網頁服務－你要如何在一台只有一個 IP address 的電腦上分辨這些封包呢？</p><p>好，Internet 上不同的服務都有已知的（well-known）port numbers。你可以在 Big IANA Port 清單 [12] 中找到，如果你用的是 Unix 系統，你可以參考檔案 /etc/services。HTTP（網站）是 port 80、telnet 是 port 23、SMTP 是 port 25，而 DOOM 遊戲 [13] 使用 port 666 等，諸如此類。Port 1024 以下通常是有特地用途的，而且要有作業系統管理員權限才能使用。</p><p>摁，這就是 port number 的介紹。</p><h3 id="_4-2-字节序" tabindex="-1"><a class="header-anchor" href="#_4-2-字节序" aria-hidden="true">#</a> 4.2. 字节序</h3><h4 id="_4-2-1-什么是字节序" tabindex="-1"><a class="header-anchor" href="#_4-2-1-什么是字节序" aria-hidden="true">#</a> 4.2.1. 什么是字节序</h4><p>字节是内存读写的最小单位，一个字节能够表示的数据范围是0～255，也就是说如果你要保存一个在此范围区间的数字，一个字节足矣。</p><p>但是像占4个字节的<code>int</code>，8个字节的<code>double</code>，该怎么存储呢？多个字节该用怎样的顺序来进行排列？举个例子，<code>0xb3f4</code>，数值的高位<code>b3</code>是存储在了内存的高地址处，还是内存的低地址处呢？</p><p>这种字节的排列顺序就叫做字节序，字节序有两种：</p><ol><li>大端字节序</li></ol><p>数值的低字节放在内存的低地址处，数值的高字节放在内存的高地址。</p><ol start="2"><li>小端字节序</li></ol><p>数值的低字节放在内存的高地址处，数值的高字节放在内存的低地址。</p><h4 id="_4-2-2-主机字节序" tabindex="-1"><a class="header-anchor" href="#_4-2-2-主机字节序" aria-hidden="true">#</a> 4.2.2. 主机字节序</h4><p>当我们谈论字节序，大部分时候对应的都是CPU访问内存时的概念，比如对下图而言：</p><p><img src="http://qiniu.chanmufeng.com/2022-10-06-030645.png" alt="image-20221006110645258" loading="lazy"></p><p>内存低位存储的字节是<code>0xb3</code>，高位存储的是<code>0xf4</code>，至于CPU读取这个2字节数据的时候，是将其解释为<code>0xb3f4</code>（小端）还是<code>0xf4b3</code>（大端）就取决于CPU采用的是哪一种字节序了。</p><p>常用的CPU字节序如下：</p><ul><li><p>大端字节序：IBM、PowerPC</p></li><li><p>小端字节序：x86</p></li></ul><p>这种CPU字节序也被称为<strong>主机字节序（Host Byte Order）</strong>。翻译一下就是，IBM的主机序是大端，x86的主机序是小端。</p><p>问题来了。</p><p>世界上的主机这么多，每台主机的CPU类型还不一样，A主机按照A的主机字节序发信息给B主机，B主机如果直接按照B的主机字节序来解析信息，那么极有可能会产生错误。</p><p>要想解决这个问题，还必须引出一些其他情况下的字节序。</p><blockquote><p>为了避免引起混淆，我在这里强调一下，字节序就分为2种，大端和小端。而所谓的主机字节序以及下面我将提到的两种，都只是字节序作用在不同的场景中取得特定名称罢了。</p></blockquote><h4 id="_4-2-3-文件存储字节序" tabindex="-1"><a class="header-anchor" href="#_4-2-3-文件存储字节序" aria-hidden="true">#</a> 4.2.3. 文件存储字节序</h4><p>顾名思义，就是存储文件信息的时候用的是大端还是小端。</p><p>bmp格式的图片属于小端字节序，jpeg格式的图片就是大端字节序。</p><p>这里提及文件存储字节序主要是为了让大家理解一个事实：<strong>采用什么字节序完全是开发者设计产品时的一种技术选型罢了</strong>。但是这种选型一定要成为一种标准，让其他开发者解析的时候明白应该用哪种字节序，否则jpeg的图片也就没办法在所有的电脑上正常显示了，你说对吗？</p><p>现在好了，所有jpeg软件的开发者都知道应该用大端字节序来保存jpeg图片，但是对于从其他主机传过来的jpeg数据流，开发者又怎么知道这个数据流用的是大端还是小端呢？</p><p>这就是<strong>网络字节序（Network Byte Order）</strong> 的问题了。</p><h4 id="_4-2-4-网络字节序" tabindex="-1"><a class="header-anchor" href="#_4-2-4-网络字节序" aria-hidden="true">#</a> 4.2.4. 网络字节序</h4><p>我想你应该能想明白了，网络字节序不是大端就是小端，不可能存在「可能是大端也可能是小端」这种情况，否则网络传递的消息全都乱套了！</p><p>TCP/IP既然是一种标准，那标准自然就有自己的字节序规定。</p><p><strong>TCP/IP网络采用的是大端，是规定好的一种数据表示格式，它与具体的CPU类型、操作系统等无关，从而可以保证数据在不同主机之间传输时能够被正确解释。</strong></p><p>也就是说，如果你想让你的消息能在其他设备正常解析，就必须按照大端字节序进行处理。比如，网络传输的是<code>0x12345678</code>这个整形变量，首先被发送的应该是<code>0x12</code>，接着是<code>0x34</code>，然后是<code>0x56</code>，最后是<code>0x78</code>。</p><h4 id="_4-2-5-字节序在socket中的例子" tabindex="-1"><a class="header-anchor" href="#_4-2-5-字节序在socket中的例子" aria-hidden="true">#</a> 4.2.5. 字节序在socket中的例子</h4><p>当你在网络封包或者在填充数据的时候，你需要确定你的端口号（port number）和ip地址都是符合网络字节序的。但是你并不知道你的主机字节序是大端还是小端，你自然也就搞不清你到底需不需要进行转换。</p><p>其实不必如此费神，不用在意主机序，直接调用函数强行将主机序转换为网络字节序即可。下面举一个C语言编写服务器代码绑定端口的例子。</p><p><img src="http://qiniu.chanmufeng.com/2022-10-06-053355.png" alt="image-20221006133355026" loading="lazy"></p><p>代码中被红色标记的部分就是分别将端口号<code>33000</code>由主机序转换为网络字节序，将ip地址由主机序转换为网络字节序的函数。</p><p>乍眼一看，函数名非常古怪，不好记忆，下面稍微解释一下，各位就豁然开朗了。</p><p><code>Socket函数库</code>提供了这种字节序转换的函数，函数的作用对象有两种，分别是<code>short</code>（2字节）和<code>long</code>（4字节），这就是函数最后的「<code>s</code>」和「<code>l</code>」的含义。</p><p>还有，主机字节序的英文是<code>Host Byte Order</code>，简写为「<code>h</code>」，网络字节序的英文是<code>Network Byte Order</code>，简写为「<code>n</code>」，「<code>to</code>」表示转换，所以，如果你想将<code>short</code>数据从主机字节序转换为网络字节序，那就应该是<code>h-to-n-s</code>，表示<code>Host to Network Short</code>。是不是很简单？</p><p>所以理论上，你可以用「<code>h</code>」、「<code>to</code>」、「<code>n</code>」、「<code>s/l</code>」这几个字母灵活组合，组成你想要的api，但是也别瞎搞，stolh()［&quot;Short to Long Host&quot;］这种组合压根都不存在。</p><p>基本上你需要的也就是以下四种罢了：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>htons() // host to network short
htonl() // host to network long
ntohs() // network to host short
ntohl() // network to host long
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>基本上，我们在进行socket编程时，在发送数据之前都需要把数据转换为网络字节序，并在收到数据之后再转换成主机字节序。</p><blockquote><p>更多关于浮点数的处理，会在之后专门的章节提及。</p></blockquote><blockquote><p>如无特殊说明，本小册的数值预设都视为主机字节序。</p></blockquote><h3 id="_4-3-socket相关的数据结构" tabindex="-1"><a class="header-anchor" href="#_4-3-socket相关的数据结构" aria-hidden="true">#</a> 4.3. socket相关的数据结构</h3><p>终于讲到这里了，现在该聊一聊和编程直接相关的一些内容了，本节会介绍多种Socket库使用的数据结构。</p><h4 id="_4-3-1-socket描述符" tabindex="-1"><a class="header-anchor" href="#_4-3-1-socket描述符" aria-hidden="true">#</a> 4.3.1. socket描述符</h4><p>首先介绍一个最简单的：socket描述符。它的类型是：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>没错，就只是个普普通通的<code>int</code>而已。</p><p>第一个介绍完了。。。。。。简单吧。</p><p>但是从这儿开始就稍微有点不好理解了，大家跟上车速，慢慢来。</p><h4 id="_4-3-2-struct—addrinfo" tabindex="-1"><a class="header-anchor" href="#_4-3-2-struct—addrinfo" aria-hidden="true">#</a> 4.3.2. struct—addrinfo</h4><p>第一个要介绍的<code>struct</code>结构是<code>addrinfo</code>，这个数据结构的发明时间还不算很久，是用来准备<code>socket地址</code>等信息以供后续使用的。它也会被用在<strong>域名查找</strong>（host name lookups）以及<strong>服务查找</strong>（service name lookups）等方面。</p><p>这么听起来感觉很抽象，等之后我们实际使用的时候就好理解了，现在我们需要知道的就是：我们在建立网络连接的时候会用到<code>addrinfo</code>这个数据结构。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span>              ai_flags<span class="token punctuation">;</span>     <span class="token comment">// AI_PASSIVE, AI_CANONNAME, etc.</span>
    <span class="token keyword">int</span>              ai_family<span class="token punctuation">;</span>    <span class="token comment">// AF_INET, AF_INET6, AF_UNSPEC</span>
    <span class="token keyword">int</span>              ai_socktype<span class="token punctuation">;</span>  <span class="token comment">// SOCK_STREAM, SOCK_DGRAM</span>
    <span class="token keyword">int</span>              ai_protocol<span class="token punctuation">;</span>  <span class="token comment">// use 0 for &quot;any&quot;</span>
    <span class="token class-name">size_t</span>           ai_addrlen<span class="token punctuation">;</span>   <span class="token comment">// size of ai_addr in bytes</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>ai_addr<span class="token punctuation">;</span>      <span class="token comment">// struct sockaddr_in or _in6</span>
    <span class="token keyword">char</span>            <span class="token operator">*</span>ai_canonname<span class="token punctuation">;</span> <span class="token comment">// full canonical hostname</span>

    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>ai_next<span class="token punctuation">;</span>      <span class="token comment">// 链表结构，指向下一个节点</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来我们用域名查找来做个例子，帮助大家理解。</p><h5 id="_4-3-2-1-使用ip建立连接" tabindex="-1"><a class="header-anchor" href="#_4-3-2-1-使用ip建立连接" aria-hidden="true">#</a> 4.3.2.1. 使用ip建立连接</h5><p>通常情况下，我们都是直接利用IP和端口向服务器发起连接，像这样</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> si<span class="token punctuation">;</span>

<span class="token comment">//这一行你可能还不知道什么意思，别急，下文会解释</span>
<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>si<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

si<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
si<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">&quot;182.25.23.123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
si<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">connect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>si<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果没接触过C的socket编程，你可能已经开始打退堂鼓了。我懂你这种感觉，我都已经放弃好几次了。。。。。。</p><p>但是后来硬着头皮看其实也没什么，虽然写法怪异，但都是C语言上的套路而已，看多了也就那么回事儿！</p><p>上面的代码的意思就是对<code>182.25.23.123</code>的<code>80</code>端口发起了一个连接。前提是我们已经知道了主机的IP了，如果只有域名该怎么办呢？</p><p>那我们就得利用<code>DNS</code>，用另一种方式来构建客户端套接字了，而这种方式就会用到<code>addrinfo</code>。</p><h5 id="_4-3-2-2-使用域名建立连接" tabindex="-1"><a class="header-anchor" href="#_4-3-2-2-使用域名建立连接" aria-hidden="true">#</a> 4.3.2.2. 使用域名建立连接</h5><p>直接上代码！</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// 为了使用getaddrinfo()函数，需要这个头文件</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>hints<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">&quot;www.chanmufeng.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;80&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>getaddrinfo()</code>函数会创建一个叫做<strong>名字资源</strong>的新数据结构（也就是代码中的<code>res</code>），给定<code>域名</code>和<code>端口号</code>以及<code>hints</code>信息，该函数就会将名字资源的数据保存在了一个叫做<code>res</code>的<code>addrinfo</code>数据结构中，<code>res</code>就包含了服务器的IP等下一步所需的信息。</p><blockquote><p>在发明<code>struct addrinfo</code>之前，我们都需要手动填写<code>res</code>中的每一个字段的，远不如现在<code>getaddrinfo()</code>帮我们处理地这么好。</p></blockquote><p>还没完呢，这只是获取到了服务器的IP信息而已，我们还得创建客户端<code>socket</code>，然后进行<code>connect()</code>，但是再进一步讲解之前，我想先稍微解释一下代码中<code>hints</code>的信息分别是什么意思，毕竟让某些读者带着疑问往下读也是有些于心不忍。</p><p><code>hints.ai_family</code>有3种选择，</p><ul><li><code>AF_INET</code>，表示强制使用IPv4</li><li><code>AF_INET6</code>，表示强制使用IPv6</li><li><code>AF_UNSPEC</code>，随便，IPv4或者IPv6都行</li></ul><p><code>hints.ai_socktype</code>有2种选择，</p><ul><li><code>SOCK_STREAM</code>，表示使用TCP协议</li><li><code>SOCK_DGRAM</code>，表示使用UDP协议</li></ul><p>解释完了，然后我们用<code>res</code>中的数据继续我们的连接过程。从下面的代码中你可以看到，创建<code>socket</code>套接字以及<code>connect</code>所需要的所有信息我们都可以从<code>res</code>中直接获取到了。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">connect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有一点需要需要我们特别注意，在使用ip建立连接时，<code>connect()</code>的第二个参数我们采用了类型强转的方式，将<code>struct sockraddr_in *</code>强转成了<code>struct sockaddr *</code>。但是在使用域名<code>connect()</code>时，直接从<code>res</code>这个<code>addrinfo</code>结构中使用了<code>struct sockaddr *ai_addr</code>这个字段（不清楚的话再看一看<code>addrinfo</code>的数据结构）。</p><p>所以，<code>sockaddr</code>就是我们要学习的下一个数据结构了。</p><blockquote><p>注：有些数据结构属于 IPv4，而有些是 IPv6，有些两者皆可，我会特別注明它们属于哪一种。</p></blockquote><h4 id="_4-3-3-struct—sockaddr" tabindex="-1"><a class="header-anchor" href="#_4-3-3-struct—sockaddr" aria-hidden="true">#</a> 4.3.3. struct—sockaddr</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span>    sa_family<span class="token punctuation">;</span>    <span class="token comment">// address family, AF_xxx</span>
    <span class="token keyword">char</span>              sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 14 bytes of protocol address</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sa_family</code>的可选值有很多，但是本小册中只会使用<code>AF_INET</code>（IPv4）或 <code>AF_INET6</code>（IPv6）。</p><p><code>sa_data</code>包含了socket需要的目的地址以及端口号，但是这样实在是很不方便，因为你需要手动把ip地址和端口号打包到14字节的数组中。</p><p>为了解决这个问题，大佬们又创造了两个替代品，<code>sockaddr_in</code>和<code>sockaddr_in6</code>。</p><h4 id="_4-3-4-struct—sockaddr-in" tabindex="-1"><a class="header-anchor" href="#_4-3-4-struct—sockaddr-in" aria-hidden="true">#</a> 4.3.4. struct—sockaddr_in</h4><p>后缀<code>in</code>表示<code>internet</code>，而且这个数据结构只能用在<code>IPv4</code>！</p><p>非常重要的一点（其实上文已经提到过），<code>struct sockaddr_in *</code>类型可以和 <code>struct sockaddr *</code>相互进行类型转换。这就是为什么<code>connect()</code>函数需要一个<code>struct sockaddr *</code>参数，我们却可以通过使用<code>struct sockaddr_in *</code>进行强转传入的原因。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// (IPv4专用--IPv6见下文的 sockaddr_in6)</span>
    
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token punctuation">{</span>
    <span class="token keyword">short</span> <span class="token keyword">int</span>          sin_family<span class="token punctuation">;</span>  <span class="token comment">// Address family, AF_INET</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> sin_port<span class="token punctuation">;</span>    <span class="token comment">// Port number</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span>     sin_addr<span class="token punctuation">;</span>    <span class="token comment">// Internet address</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      sin_zero<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Same size as struct sockaddr</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sockaddr_in</code>中的每个字段看起来就比<code>sockaddr</code>要清晰很多了。</p><p><code>sin_zero</code>是为了让<code>sockaddr</code>与<code>sockaddr_in</code>两个数据结构保持大小相同而保留的空字节，使用之前应该使用<code>memset()</code>将所有数据置为0。</p><p><code>sin_family</code>对应的就是<code>sockaddr</code>中的<code>sa_family</code>，应该设置为<code>AF_INET</code>。<code>sin_port</code>必须使用<code>htons()</code>使其符合<a href="https://www.chanmufeng.com/posts/network-programming/%E5%AD%97%E8%8A%82%E5%BA%8F.html" target="_blank" rel="noopener noreferrer">网络字节序<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><p>再继续挖得深一点！<code>sockaddr_in</code>的<code>sin_addr</code>字段是<code>struct in_addr</code>结构：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// (IPv4 专用--IPv6见下文的in6_addr)</span>
    
<span class="token comment">// Internet address (由于历史原因而保留的一个数据结构)</span>
<span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token punctuation">{</span>
  	<span class="token class-name">uint32_t</span> s_addr<span class="token punctuation">;</span> <span class="token comment">// that&#39;s a 32-bit int (4 bytes)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用起来很简单，如果你声明了一个<code>sockaddr_in</code>的变量<code>sin</code>，那么<code>sin.sin_addr.s_addr</code>表示的就是一个4字节的IP地址（符合网络字节序）。</p><p>IPv4的说完了，对应着，我们再看看IPv6的。</p><h4 id="_4-3-5-struct—sockaddr-in6" tabindex="-1"><a class="header-anchor" href="#_4-3-5-struct—sockaddr-in6" aria-hidden="true">#</a> 4.3.5. struct—sockaddr_in6</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// (IPv6 专用--IPv4见上文的sockaddr_in)</span>
    
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token punctuation">{</span>
    <span class="token class-name">u_int16_t</span>       sin6_family<span class="token punctuation">;</span>   <span class="token comment">// address family, AF_INET6</span>
    <span class="token class-name">u_int16_t</span>       sin6_port<span class="token punctuation">;</span>     <span class="token comment">// port number, Network Byte Order</span>
    <span class="token class-name">u_int32_t</span>       sin6_flowinfo<span class="token punctuation">;</span> <span class="token comment">// IPv6 flow information</span>
    <span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> sin6_addr<span class="token punctuation">;</span>     <span class="token comment">// IPv6 address</span>
    <span class="token class-name">u_int32_t</span>       sin6_scope_id<span class="token punctuation">;</span> <span class="token comment">// Scope ID</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
    
<span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>   s6_addr<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// IPv6 address</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sin6_family</code>对应的是<code>sockaddr_in</code>的<code>sin_family</code>字段，<code>sin6_port</code>对应的是<code>sockaddr_in</code>的<code>sin_port</code>字段，<code>sin6_addr</code>对应的是<code>sockaddr_in</code>的<code>sin_addr</code>字段。</p><p>至于<code>sin6_flowinfo</code>和<code>sin6_scope_id</code>本小册就不会涉及了，毕竟我们是简明教程嘛。</p><p>hold on～hold on～</p><p>还没结束，最后再介绍一个数据结构，那句英文怎么说来着？Last but not least，虽然它排在最后，但是也不容忽视。</p><h4 id="_4-3-6-struct—sockaddr-storage" tabindex="-1"><a class="header-anchor" href="#_4-3-6-struct—sockaddr-storage" aria-hidden="true">#</a> 4.3.6. struct—sockaddr_storage</h4><p><code>sockaddr_storage</code>是一个与<code>sockaddr</code>同一级别的数据结构，用来保存IPv4地址和IPv6地址。</p><p>不是已经有了<code>sockaddr_in</code>来保存IPv4，<code>sockaddr_in6</code>来保存IPv6了嘛？甚至<code>sockaddr</code>还通用，为什么还需要<code>sockaddr_storage</code>呢？</p><p>因为有些时候你可能无法提前确定你要使用IPv4还是IPv6！</p><p>你可能会问，这有什么关系呢？我们还有<code>sockaddr</code>啊，它可是通吃啊。</p><p>对，通吃！但只是名义上的。我们来分析一下。</p><p><code>sockaddr</code>身为一个通用的地址数据结构，理论上的大小就应该是所有具体协议地址结构大小的最大值。但是<code>sizeof(struct sockaddr) = 16</code>, 而<code>sizeof(struct sockaddr_in6) = 28</code>，<code>sockaddr</code>没有能力保存IPv6啊。</p><p>于是<code>sockaddr_storage</code>就诞生了。它的大小为128字节，应该能装得下目前所以协议的地址结构了。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> <span class="token punctuation">{</span>
  <span class="token class-name">sa_family_t</span>  ss_family<span class="token punctuation">;</span>     <span class="token comment">// address family</span>

  <span class="token comment">// all this is padding, implementation specific, ignore it:</span>
  <span class="token keyword">char</span>      __ss_pad1<span class="token punctuation">[</span>_SS_PAD1SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token class-name">int64_t</span>   __ss_align<span class="token punctuation">;</span>
  <span class="token keyword">char</span>      __ss_pad2<span class="token punctuation">[</span>_SS_PAD2SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>举个栗子吧：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> addr<span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isIPv6 <span class="token operator">==</span> TRUE<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token operator">*</span>addr_v6 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">;</span>
    addr_v6<span class="token operator">-&gt;</span>sin6_family <span class="token operator">=</span> AF_INET6<span class="token punctuation">;</span>
    addr_v6<span class="token operator">-&gt;</span>sin6_port <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> “<span class="token number">2201</span><span class="token operator">:</span><span class="token number">3212</span><span class="token operator">::</span><span class="token number">1</span>”<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>addr_v6<span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span>addr_v4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">;</span>
    addr_v4<span class="token operator">-&gt;</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    addr_v4<span class="token operator">-&gt;</span>sin_port <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token function">inet_aton</span><span class="token punctuation">(</span>“<span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.45</span>”<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>addr_v4<span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">sendto</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>总结一下你也就明白了，对于存储地址的数据结构，一共有4种，并且每种之间都可以进行转换</p><ul><li><code>sockaddr</code>（最原始的数据结构，但是装不下IPv6）</li><li><code>sockaddr_in</code>（专用于IPv4）</li><li><code>sockaddr_in6</code>（专用于IPv6）</li><li><code>sockaddr_storage</code>（相当于<code>sockaddr</code>的补丁，能装不下IPv6）</li></ul><p>在大多数情况下，后3种结构都需要强转为<code>sockaddr</code>，你可能会问为什么不直接传入<code>sockaddr_storage</code>呢？这也是没办法的事情，因为api从一开始的时候就已经确定好了，变了的话旧代码也就不能运行了。我们能做的就是打补丁。</p><p>很多奇奇怪怪数据结构的出现，就是由于最开始没想到会发展到现在这种情况而导致的。包括现在也一样，我们很难预测未来的全部变化，能想到最好，想不全或是低估未来才是常态。</p><h3 id="_4-4-ip的二进制转换" tabindex="-1"><a class="header-anchor" href="#_4-4-ip的二进制转换" aria-hidden="true">#</a> 4.4. IP的二进制转换</h3><p>不得不说，我们真的很幸运，如今已经有了很多函数可以让我们操作IP地址，而不需要我们自己用<code>long</code>类型数据以及<code>&lt;&lt;</code>运算符来处理它们。</p><p>假如你声明了一个数据结构<code>struct sockaddr_in ina</code>，你还有一个“<code>10.12.110.57</code>”或“<code>2001:db8:63b3:1::3490</code>”这样的IP地址，该怎么把IP地址存入<code>ina</code>呢。</p><h4 id="_4-4-1-ip转二进制" tabindex="-1"><a class="header-anchor" href="#_4-4-1-ip转二进制" aria-hidden="true">#</a> 4.4.1. IP转二进制</h4><p>你可以使用<code>inet_pton()</code>将点分十进制形式的IPv4地址保存在<code>ina</code>中，但如果要保存IPv6地址的话，我们就需要<code>struct sockaddr_in6 ina6</code>了。</p><blockquote><p>“<code>pton</code>”的全称是“presentation to network”，也可以是“printable to network”，选一个能帮助你记忆的就行。</p></blockquote><p>具体的转换如下代码所示：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> sa<span class="token punctuation">;</span> <span class="token comment">// IPv4</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> sa6<span class="token punctuation">;</span> <span class="token comment">// IPv6</span>
    
<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">&quot;10.12.110.57&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>sa<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// IPv4</span>
<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> <span class="token string">&quot;2001:db8:63b3:1::3490&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>sa6<span class="token punctuation">.</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// IPv6</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>小记：原本的老方法是使用名为<code>inet_addr()</code>或是 <code>inet_aton() </code>的函数；这些函数已经过时了，而且不适用于 IPv6</p></blockquote><p>上面的程序写的比较简单，而且不够健壮，因为没有进行错误检查。<code>inet_pton() </code>在发生错误时会返回<code>-1</code>，而若地址无效则返回<code>0</code>。所以在使用之前要检查返回值，并保证返回结果是大于 0 的。</p><p>现在我们可以将字符串格式的IP地址转换为二进制形式了。那么反过来需要怎么做？</p><h4 id="_4-4-2-二进制转ip" tabindex="-1"><a class="header-anchor" href="#_4-4-2-二进制转ip" aria-hidden="true">#</a> 4.4.2. 二进制转IP</h4><p>如果我们已经有了<code>struct in_addr</code>，怎么将点分十进制的IP打印出来？（或者我们有<code>struct in6_addr</code>，怎么打印字符串类型的IPv6地址呢？）</p><p>我们可以使用<code>inet_ntop()</code>函数，看代码：</p><blockquote><p>“<code>ntop</code>”的全称是“network to presentation”，也可以是“network to printable”，选一个能帮助你记忆的就行。</p></blockquote><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// IPv4:</span>
<span class="token keyword">char</span> ip4<span class="token punctuation">[</span>INET_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// space to hold the IPv4 string</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> sa<span class="token punctuation">;</span>      <span class="token comment">// 假设sa中保存了ip信息</span>
<span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>sa<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> ip4<span class="token punctuation">,</span> INET_ADDRSTRLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;The IPv4 address is: %s\n&quot;</span><span class="token punctuation">,</span> ip4<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// IPv6:</span>
<span class="token keyword">char</span> ip6<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// space to hold the IPv6 string</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> sa6<span class="token punctuation">;</span>    <span class="token comment">// 假设sa6种保存了ip信息</span>
<span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>sa6<span class="token punctuation">.</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> ip6<span class="token punctuation">,</span> INET6_ADDRSTRLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;The address is: %s\n&quot;</span><span class="token punctuation">,</span> ip6<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当我们调用<code>inet_ntop()</code>，你需要传递IP地址类型（IPv4 或者 IPv6），一个指向保存字符串结果的指针以及该字符串的最大长度。有两个宏（可以理解为常量）可以很方便地帮助我们表示要存储的IPv4或者IPv6地址字符串的最大长度，分别是<code>INET_ADDRSTRLEN</code> 和 <code>INET6_ADDRSTRLEN</code>。</p><blockquote><p>小记：原本的老方法是使用名为<code>inet_ntoa()</code>的函数，这个函数已经过时了，而且不适用于 IPv6</p></blockquote><p>最后，本文讲到的函数只能用于数值型的IP地址上，它们不会用DNS做域名解析，所以你传入“<a href="http://www.chanmufeng.com" target="_blank" rel="noopener noreferrer">www.chanmufeng.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>”这样的域名是没有用的。</p><p>关于域名查询，我们将会使用<code>getaddrinfo()</code>函数，之前的文章提过一嘴，后文将会详细讲述，敬请期待。</p><h2 id="_5-从ipv4迁移到ipv6" tabindex="-1"><a class="header-anchor" href="#_5-从ipv4迁移到ipv6" aria-hidden="true">#</a> 5. 从IPv4迁移到IPv6</h2><p>未来一定属于IPv6，但可能还不是现在。</p><p>虽然嘴上嚷嚷着IPv4不够用了，但是不管国内还是国外，IPv6始终没有预想中的那么普及。</p><p><img src="http://qiniu.chanmufeng.com/2022-10-08-101452.png" alt="image-20221008181452021" loading="lazy"></p><p>图中颜色越深的地区，表示其 IPv6 部署程度越高，相应的 IPv6 部署率数值越大。所谓的部署率是根据各个国家地区的网络（IPv6 Prefix/Transit IPv6 AS），IPv6 网站及 IPv6 用户等数据按照一定权值并计算得出的。</p><p>看起来全球大部分地区都是绿的，但是就全球的IPv6覆盖率而言，还达不到40%。</p><p>但是总归需要对未来做出一点准备嘛，所以本文用12个步骤教你如何在socket编程中从IPv4迁移到IPv6。</p><ol><li><p>首先，尝试使用<a href="https://www.chanmufeng.com/posts/network-programming/6%E7%A7%8Dsocket%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.html#struct%E2%80%94addrinfo" target="_blank" rel="noopener noreferrer"><code>getaddrinfo()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>来获取<code>struct sockaddr</code>的信息，不要再手动填充这个数据结构了。这样就可以屏蔽IP的版本影响，省去后续很多麻烦；</p></li><li><p>找出所有对IP版本硬编码的代码，试着把它们封装起来；</p></li><li><p>将<code>AF_INET</code> 修改为 <code>AF_INET6</code>；</p></li><li><p>将 <code>PF_INET</code> 修改为 <code>PF_INET6</code>；</p></li><li><p>将 <code>INADDR_ANY</code> 修改为 <code>in6addr_any</code> ，给你个例子：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> sa<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> sa6<span class="token punctuation">;</span>

sa<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>  <span class="token comment">// 使用IPv4</span>
sa6<span class="token punctuation">.</span>sin6_addr <span class="token operator">=</span> in6addr_any<span class="token punctuation">;</span> <span class="token comment">// 使用IPv6</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>使用 <code>struct sockaddr_in6</code>代替 <code>struct sockaddr_in</code> ，千万要注意，“6”可不要乱加哦，如果你忘记那些字段有“6”了，参考之前讲过的<a href="https://www.chanmufeng.com/posts/network-programming/6%E7%A7%8Dsocket%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.html" target="_blank" rel="noopener noreferrer"><code>struct</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。比如，压根儿不存在<code>sin6_zero</code>这个字段；</p></li><li><p>使用<code>struct in6_addr</code> 代替<code>struct in_addr</code> ，关于“6”的细节，参考第6条；</p></li><li><p>使用<code>inet_pton()</code>代替<code>inet_aton()</code> 以及 <code>inet_addr()</code>；</p></li><li><p>使用<code>inet_ntop()</code>，不要使用<code>inet_ntoa()</code>；</p></li><li><p>使用更高级的<code>getaddrinfo()</code>代替<code>gethostbyname()</code>了；</p></li><li><p>用更高级的<code>getnameinfo()</code>代替<code>gethostbyaddr()</code>（虽然<code>gethostbyaddr</code>在IPv6中也能正常使用）；</p></li><li><p>不要用 <code>INADDR_BROADCAST </code>了，请使用 <code>IPv6 multicast</code> 來代替。</p></li></ol><p>以上！</p><h2 id="_6-socket编程相关函数" tabindex="-1"><a class="header-anchor" href="#_6-socket编程相关函数" aria-hidden="true">#</a> 6. socket编程相关函数</h2><p>这一章，我们将走进<strong>系统调用</strong>（System Call），这些系统调用允许我们访问Linux设备或其他任何支持Socket API设备（比如BSD、Windows、Linux、Mac等）的网络功能。当你调用某个系统调用时，内核将接管一切，自动为你处理接下来的一切任务。</p><p>多数人觉得网络编程很难是因为不知道什么时候该调用什么函数，这个问题在<strong>man</strong>手册里是找不到解决方案的。为了带大家走出困境，接下来我就按照一般的调用顺序来给大家讲解每一个系统调用，你在写程序的时候就按照这个顺序调用就行了。</p><p>要想看懂接下来散落各处的代码片段，你需要备点牛奶和饼干了，还多少需要备点决心和勇气，然后你就能将socket编程玩儿得风生水起了，不知道的还以为你得了Jon Postel真传呢！</p><blockquote><p>Jon Postel是互联网的巨擘，他的发明作品包括但不限于<code>SMTP协议</code>、<code>FTP协议</code>、<code>UDP协议</code>。</p></blockquote><p>需要说明的是，为了简洁，很多代码片段并没有包含必要的错误检查。比如文章会始终假设<code>getaddrinfo()</code> 会调用成功。在编写生产环境代码时尤其需要注意这一点。</p><h3 id="_6-1-getaddrinfo-—准备开始" tabindex="-1"><a class="header-anchor" href="#_6-1-getaddrinfo-—准备开始" aria-hidden="true">#</a> 6.1. getaddrinfo()—准备开始！</h3><p>这是socket编程中非常重要的一个函数，它有非常多的参数，但是别害怕，用起来其实非常简单。这个函数的作用是帮你设置之后需要的struct。</p><p>稍微提一嘴它的历史：它的前身是用来做DNS查询的<code>gethostbyname()</code>，当时还需要你手动把数据设置到<code>struct sockaddr_in</code>中呢。谢天谢地，现在不用了。</p><p>使用<code>getaddrinfo()</code>可以帮助你写出兼容IPv4和IPv6的代码，甚至在帮你进行DNS查询和service name查询之后，还会自动将你需要的信息填充到<code>struct</code>中，咱就说多牛！</p><p>看一眼长啥样先。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>node<span class="token punctuation">,</span>     <span class="token comment">// e.g. &quot;www.example.com&quot; or IP</span>
                <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">,</span>  <span class="token comment">// e.g. &quot;http&quot; or port number</span>
                <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>hints<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你传给它3个参数（其实是4个，但是第4个只是个声明的变量而已），它给你返回一个指向链表的指针<code>res</code>。</p><p>其中，<code>node</code>参数是你想进行连接的服务器的域名，或者IP地址。</p><p><code>service</code>参数可以是个端口号，比如“<code>80</code>”，或者是一个特定服务的名称，比如“<code>http</code>”、“<code>ftp</code>”、“<code>telnet</code>”、“<code>smtp</code>” 等。</p><p>最后，<code>hints</code>参数指向了一个需要你设置相关参数的<code>struct addrinfo</code>。</p><blockquote><p>常用端口号以及服务名可以参见 <a href="https://www.iana.org/assignments/port-numbers" target="_blank" rel="noopener noreferrer">The IANA Port List<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>或者Unix设备上的<code>/etc/services</code>文件</p></blockquote><p>接下来给一个服务端程序监听本机IP地址和<code>3490</code>端口的例子。需要注意的是，代码示例中并没有做监听（listen）和任何网络设置的工作，只是简单设置了之后会用到数据结构而已。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> status<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>servinfo<span class="token punctuation">;</span>  <span class="token comment">// will point to the results</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// make sure the struct is empty</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>     <span class="token comment">// don&#39;t care IPv4 or IPv6</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span> <span class="token comment">// TCP stream sockets</span>
hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span>     <span class="token comment">// fill in my IP for me</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>status <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;3490&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo error: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// servinfo 现在指向了包含1个或多个addrinfo结构的链表</span>

<span class="token comment">// ... do everything until you don&#39;t need servinfo anymore ....</span>

<span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// free the linked-list</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意，我将<code>ai_family</code>设置成了<code>AF_UNSPEC</code>，也就意味着我压根不在意我们用IPv4还是IPv6。如果你想精确指定IPv4或者IPv6的话请使用<code>AF_INET</code>或<code>AF_INET6</code>。</p><p>你可能注意到了，我把<code>ai_flags</code>设置为了<code>AI_PASSIVE</code>，意思是告诉<code>getaddrinfo()</code>函数把我本机的IP设置到<code>servinfo</code>中，这样我就不用将<code>getaddrinfo()</code>的第一个参数（如果忘了是啥意思，看看上文）硬编码了，直接设置成<code>NULL</code>就行了。</p><p>然后我们就调用<code>getaddrinfo()</code>了。如果函数报错（返回值不为0），我们会使用<code>gai_strerror() </code>函数将错误打印出来。如果程序正常运行，那么<code>servinfo</code>最终就会指向一个由<code>struct addrinfo</code>链接形成的链表，链表中每一个元素都会包含一个我们之后会用到的<code>struct sockaddr</code>。</p><p>最后，<code>getaddrinfo()</code>会在堆内存中创建<code>servinfo</code>指向的链表，使用完之后一定要使用<code>freeaddrinfo()</code>进行内存释放。</p><p>再给一个客户端代码的例子，我们假设客户端想连接到域名为“<a href="http://www.chanmufeng.com" target="_blank" rel="noopener noreferrer">www.chanmufeng.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>”，端口为<code>3490</code>的服务器。再次强调，代码片段中省略了实际进行链接的部分，只是简单设置了之后会用到数据结构而已。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> status<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>servinfo<span class="token punctuation">;</span>  <span class="token comment">// will point to the results</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// make sure the struct is empty</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>     <span class="token comment">// don&#39;t care IPv4 or IPv6</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span> <span class="token comment">// TCP stream sockets</span>

<span class="token comment">// get ready to connect</span>
status <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">&quot;www.chanmufeng.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3490&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// servinfo now points to a linked list of 1 or more struct addrinfos</span>

<span class="token comment">// etc.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这段代码比server端的代码还简单，就不过多解释了。</p><p>接着我们综合使用一下我们学过的知识，写一段稍微长一丢丢的demo，这个demo的作用是打印你在命令行上指定的任何主机的IP地址。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** showip.c -- show IP addresses for a host given on the command line
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">int</span> status<span class="token punctuation">;</span>
    <span class="token keyword">char</span> ipstr<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;usage: showip hostname\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span> <span class="token comment">// AF_INET or AF_INET6 to force version</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>status <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;IP addresses for %s:\n\n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> res<span class="token punctuation">;</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>ipver<span class="token punctuation">;</span>

        <span class="token comment">// get the pointer to the address itself,</span>
        <span class="token comment">// different fields in IPv4 and IPv6:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family <span class="token operator">==</span> AF_INET<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// IPv4</span>
            <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span>ipv4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">;</span>
            addr <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>ipv4<span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipver <span class="token operator">=</span> <span class="token string">&quot;IPv4&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// IPv6</span>
            <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token operator">*</span>ipv6 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">;</span>
            addr <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>ipv6<span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipver <span class="token operator">=</span> <span class="token string">&quot;IPv6&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// convert the IP to a string and print it:</span>
        <span class="token function">inet_ntop</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> ipstr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> ipstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;  %s: %s\n&quot;</span><span class="token punctuation">,</span> ipver<span class="token punctuation">,</span> ipstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// free the linked list</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>程序使用你在命令行中输入的参数来调用<code>getaddrinfo()</code>，然后我们就得到了<code>res</code>指向的链表，遍历链表每个节点我们就能得到全部的IP信息。</p><p>运行方式如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ showip www.example.net
IP addresses <span class="token keyword">for</span> www.example.net:

	IPv4: <span class="token number">192.0</span>.2.88

$ showip ipv6.example.com
IP addresses <span class="token keyword">for</span> ipv6.example.com:

	IPv4: <span class="token number">192.0</span>.2.101
	IPv6: <span class="token number">2001</span>:db8:8c00:22::171
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在一切尽在我们掌握之中了，我们可以将<code>getaddrinfo()</code>自动为我们填充好的数据传递给其他的socket函数，这就是把<code>getaddrinfo()</code>函数放在第一位进行介绍的原因了。</p><p>更多socket系统调用，请期待下篇。</p><h3 id="_6-2-socket-—拿到套接字描述符" tabindex="-1"><a class="header-anchor" href="#_6-2-socket-—拿到套接字描述符" aria-hidden="true">#</a> 6.2. socket()—拿到套接字描述符！</h3><p>现在来详细介绍一下<code>socket()</code>这个系统调用。</p><p>先看一些用法和参数：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可是这个函数的参数是干什么的呢？刚开始用这个函数可能会一脸懵，别怕，我慢慢介绍。</p><p>函数参数是用来指定你想要的socket类型（IPv4还是IPv6，数据流（stream）还是数据报（datagram），<code>TCP</code>还是<code>UDP</code>）。</p><p><code>domain</code>参数指的是协议族，你可以设置为<code>PF_INET</code>或者<code>PF_INET6</code>，也可以是下表（只列举了一部分）中的某个常值。</p><table><thead><tr><th style="text-align:center;">family</th><th style="text-align:center;">说明</th></tr></thead><tbody><tr><td style="text-align:center;">AF_INET</td><td style="text-align:center;">IPv4协议</td></tr><tr><td style="text-align:center;">AF_INET6</td><td style="text-align:center;">IPv6协议</td></tr><tr><td style="text-align:center;">AF_LOCAL</td><td style="text-align:center;">Unix域协议</td></tr><tr><td style="text-align:center;">AF_ROUTE</td><td style="text-align:center;">路由套接字</td></tr><tr><td style="text-align:center;">AF_KEY</td><td style="text-align:center;">密钥套接字</td></tr></tbody></table><p><code>type</code>表示socket的类型，可以是下表中的某个常值。</p><table><thead><tr><th style="text-align:center;">type</th><th style="text-align:center;">说明</th></tr></thead><tbody><tr><td style="text-align:center;">SOCK_STREAM</td><td style="text-align:center;">字节流socket</td></tr><tr><td style="text-align:center;">SOCK_DGRAM</td><td style="text-align:center;">数据报socket</td></tr><tr><td style="text-align:center;">SOCK_SEQPACKET</td><td style="text-align:center;">有序分组socket</td></tr><tr><td style="text-align:center;">SOCK_RAW</td><td style="text-align:center;">原始socket</td></tr></tbody></table><p>至于<code>protocol</code>，你可以简单地将<code>protocol</code>设置为<code>0</code>，会自动选择<code>domain</code>和<code>type</code>字段组合的系统默认值。当然喽，如果你想亲力亲为，你也可以调用 <code>getprotobyname()</code> 来查找你想要的协议，参数可以是“<code>tcp</code>”、“<code>udp</code>”等，还可以直接使用下表中的常值。</p><table><thead><tr><th style="text-align:center;">protocol</th><th style="text-align:center;">说明</th></tr></thead><tbody><tr><td style="text-align:center;">IPPROTO_TCP</td><td style="text-align:center;">TCP传输协议</td></tr><tr><td style="text-align:center;">IPPROTO_UDP</td><td style="text-align:center;">UDP传输协议</td></tr><tr><td style="text-align:center;">IPPROTO_SCTP</td><td style="text-align:center;">SCTP传输协议</td></tr></tbody></table><p>可能你已经注意到了，<code>domain</code>字段的候选值中既有<code>AF_INET</code>又有<code>PF_INET</code>，<code>AF_XXX</code> 和 <code>PF_XXX</code>有什么区别呢？</p><p><code>AF_</code>前缀表示地址族（<code>AF</code>表示<code>Address Family</code>），<code>PF_</code> 前缀表示协议族（<code>PF</code>表示<code>Protocol Family</code>）。你可能发现有些资料的<code>socket()</code>第一个参数使用<code>AF_XXX</code>，有些资料却使用<code>PF_XXX</code>，这确实有点让人头疼。</p><p>追根溯源，这其实是有历史原因的。很久很久之前，人们设想单个协议族可以支持多个地址族，但是这个想法就从来没有实现过。而且<code>&lt;sys/socket.h&gt;</code>这个头文件中为某个给定协议定义的<code>PF_</code>值总是和此协议的<code>AF_</code>值相等，这就直接造成了<code>AF_</code>和<code>PF_</code>滥用的乱象。</p><p>相比<code>PF_XXX</code>，很多程序员更喜欢将<code>AF_XXX</code>作为第一个参数传入socket，甚至包括《Unix网络编程》的作者Stevens也在书中直接用<code>AF_XXX</code>作为参数（这其实只是作者想与大部分代码保持一致罢了，算是一种妥协）。但大多数人做的未必就是对的。</p><p>我们最推崇的一种做法是遵守POSIX规范，将<code>socket()</code>函数的第一个参数设置为<code>PF_</code>值，而在<code>struct sockaddr_in</code>结构中使用<code>AF_</code>。</p><p>说这么多已经够用了。结合之前讲过的<code>getaddrinfo()</code>，我们需要做的就是将<code>getaddrinfo()</code>调用得到结果直接喂给<code>socket()</code>，像这样：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> s<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>

<span class="token comment">// do the lookup</span>
<span class="token comment">// [pretend we already filled out the &quot;hints&quot; struct]</span>
<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">&quot;www.example.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// again, you should do error-checking on getaddrinfo(), and walk</span>
<span class="token comment">// the &quot;res&quot; linked list looking for valid entries instead of just</span>
<span class="token comment">// assuming the first one is good (like many of these examples do).</span>
<span class="token comment">// See the section on client/server for real examples.</span>

s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>socket()</code>函数在返回成功时会返回一个套接字描述符（socket descriptor）,它是一个非负整数，在后续的其他函数调用中，我们将使用它来表示这个socket。</p><p>如果发生错误，<code>socket()</code>会返回<code>-1</code>，此时<code>errno</code>这个全局变量会被设置为该错误的值。</p><blockquote><p>只要一个Unix函数发生错误，Unix的全局变量<code>errno</code>就会被设置为一个指明该错误类型的某个正数，而函数本身通常返回<code>-1</code>。</p><p>下面展示了<code>&lt;sys/errno.h&gt;</code>头文件中定义的<code>errno</code>的部分候选值：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">/*
 * Error codes
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPERM</span>           <span class="token expression"><span class="token number">1</span>               </span><span class="token comment">/* Operation not permitted */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENOENT</span>          <span class="token expression"><span class="token number">2</span>               </span><span class="token comment">/* No such file or directory */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESRCH</span>           <span class="token expression"><span class="token number">3</span>               </span><span class="token comment">/* No such process */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EINTR</span>           <span class="token expression"><span class="token number">4</span>               </span><span class="token comment">/* Interrupted system call */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EIO</span>             <span class="token expression"><span class="token number">5</span>               </span><span class="token comment">/* Input/output error */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENXIO</span>           <span class="token expression"><span class="token number">6</span>               </span><span class="token comment">/* Device not configured */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">E2BIG</span>           <span class="token expression"><span class="token number">7</span>               </span><span class="token comment">/* Argument list too long */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENOEXEC</span>         <span class="token expression"><span class="token number">8</span>               </span><span class="token comment">/* Exec format error */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EBADF</span>           <span class="token expression"><span class="token number">9</span>               </span><span class="token comment">/* Bad file descriptor */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ECHILD</span>          <span class="token expression"><span class="token number">10</span>              </span><span class="token comment">/* No child processes */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EDEADLK</span>         <span class="token expression"><span class="token number">11</span>              </span><span class="token comment">/* Resource deadlock avoided */</span></span>
                                        <span class="token comment">/* 11 was EAGAIN */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENOMEM</span>          <span class="token expression"><span class="token number">12</span>              </span><span class="token comment">/* Cannot allocate memory */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EACCES</span>          <span class="token expression"><span class="token number">13</span>              </span><span class="token comment">/* Permission denied */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EFAULT</span>          <span class="token expression"><span class="token number">14</span>              </span><span class="token comment">/* Bad address */</span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h3 id="_6-3-bind-—我在监听哪个端口" tabindex="-1"><a class="header-anchor" href="#_6-3-bind-—我在监听哪个端口" aria-hidden="true">#</a> 6.3. bind()—我在监听哪个端口?</h3><p>当你创建了socket之后，你会想要把这个socket和你本机上的某个端口号（port）进行关联。</p><p>端口号是内核用来确认将收到的数据包交给哪个具体进程的<code>socket descriptor</code>的依据。</p><blockquote><p>通常在写服务端程序的时候我们才需要进行关联，客户端程序不需要我们手动绑定端口，直接<code>connect()</code>就好了。</p></blockquote><p>来看看端口号具体是怎么绑定的吧：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>my_addr<span class="token punctuation">,</span> <span class="token keyword">int</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sockfd</code>是<code>socket()</code>返回的一个<code>socket file descriptor</code>；<code>my_addr</code>是一个指向包含了你的端口号和IP地址信息的<code>struct sockaddr</code>指针；<code>addrlen</code>是以字节为单位的地址长度。</p><p>接下来，我们给出一个例子，它将socket和我本机的<code>3490</code>端口进行绑定：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>

<span class="token comment">// first, load up address structs with getaddrinfo():</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>  <span class="token comment">// use IPv4 or IPv6, whichever</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span>     <span class="token comment">// fill in my IP for me</span>

<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;3490&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make a socket:</span>

sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// bind it to the port we passed in to getaddrinfo():</span>

<span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过使用<code>AI_PASSIVE</code>标识，程序会自动绑定它所在的程序的IP。如果你想精确绑定到本机的某一个IP地址，你就不能用<code>AI_PASSIVE</code>了，而且你还得把<code>getaddrinfo()</code>的第一个参数从<code>NULL</code>改为你想绑定的那个IP地址。</p><p><code>bind()</code>和其他系统调用一样，发生错误的时候返回<code>-1</code>，并且会设置全局变量<code>errno</code>的值。</p><p>很多老代码都会在调用<code>bind()</code>之前手动封装 <code>struct sockaddr_in</code> 。当然，这里绑定的肯定是IPv4的地址，如果你想使用IPv6，你照样可以手动封装<code>struct sockaddr_in6</code> ，但是极力不推荐你这么做。你还是应该老老实实用 <code>getaddrinfo()</code> ，这样更优雅、更简单。</p><p>给你看看老代码长什么样子吧：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// !!! THIS IS THE OLD WAY !!!</span>

<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> my_addr<span class="token punctuation">;</span>

sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

my_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
my_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>MYPORT<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// short, network byte order</span>
my_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">&quot;10.12.110.57&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span>my_addr<span class="token punctuation">.</span>sin_zero<span class="token punctuation">,</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> my_addr<span class="token punctuation">.</span>sin_zero<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>my_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> my_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面这个代码中，你依然可以把<code>my_addr.sin_addr.s_addr</code>设置为 <code>INADDR_ANY</code> ，它的作用上文提到的<code>AI_PASSIVE</code>一样，都会让代码自动绑定到本机IP。 <code>INADDR_ANY</code> 的IPv6版本是一个全局变量，叫<code>in6addr_any</code>，这个变量会被指定给你的 <code>struct sockaddr_in6</code> 的<code>sin6_addr</code>字段。</p><blockquote><p>你也可以使用<code>IN6ADDR_ANY_INIT</code>这个宏来初始化变量</p></blockquote><p>调用<code>bind()</code>时有一件事需要你特别注意：不要使用<code>1024</code>以下的端口号，因为这些端口号是被保留使用的，除非你是超级管理员。除了<code>1024</code>以下的，<code>1025～65535</code>之间的随便用（其他程序占用的除外）。</p><p>有时候，你明明重新运行了你的服务端程序，但是<code>bind()</code>报错了，提示你“Address already in use”。这是为什么？理论上重启之后端口就会被释放啊！好吧，这是因为有一些连接到socket的连接还悬在内核中，就是它们占用了这个端口号。你可以等一分钟左右让它们自行消失，或者在你的代码加这么几行：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> yes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//char yes=&#39;1&#39;; // Solaris people use this</span>

<span class="token comment">// lose the pesky &quot;Address already in use&quot; error message</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token operator">&amp;</span>yes<span class="token punctuation">,</span><span class="token keyword">sizeof</span> yes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;setsockopt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样就不会再出现端口被占用的问题了。</p><h3 id="_6-4-connect-—嘿-你好啊" tabindex="-1"><a class="header-anchor" href="#_6-4-connect-—嘿-你好啊" aria-hidden="true">#</a> 6.4. connect()—嘿，你好啊！</h3><p>客户端就是用<code>connect()</code>函数来建立与服务器之间的连接的。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>serv_addr<span class="token punctuation">,</span> <span class="token keyword">int</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sockfd</code>是我们的老朋友了，是由<code>socket()</code>函数返回的套接字描述符，<code>serv_addr</code>是一个执行套接字地址结构 <code>struct sockaddr</code> 的指针， <code>struct sockaddr</code> 中存储了目标IP地址和端口号信息，<code>addrlen</code>是<code>serv_addr</code>指向的<code>struct sockaddr</code> 大小。</p><p>再次强调一下 <code>getaddrinfo()</code> 的妙处，所有你需要的连接信息都可以从这个函数的返回结果中获取。</p><p>客户端在调用<code>connect()</code>之前不必非得调用<code>bind()</code>函数，因为如果有必要，内核会确定源IP地址，并选择一个临时端口号作为源端口。</p><p>举一个使用<code>connect()</code>连接到&quot;<a href="http://www.chanmufeng.com" target="_blank" rel="noopener noreferrer">www.chanmufeng.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>&quot; 的<code>3490</code>端口的例子：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>

<span class="token comment">// first, load up address structs with getaddrinfo():</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>

<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">&quot;www.example.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3490&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make a socket:</span>

sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// connect!</span>

<span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>和上一节讲的<code>bind()</code>一样，有些老代码在调用<code>connect()</code>之前会手动封装 <code>struct sockaddr_in</code>，然后传给<code>connect()</code>作为参数。你现在仍然可以这么做，但是没必要！</p><p>如果你使用的是TCP套接字，调用<code>connect</code>函数会触发TCP的三次握手过程，而且仅在连接成功或者失败时才会返回，失败返回<code>-1</code>，并且会设置全局变量<code>errno</code>的值。</p><h3 id="_6-5-listen-—会有人联系我吗" tabindex="-1"><a class="header-anchor" href="#_6-5-listen-—会有人联系我吗" aria-hidden="true">#</a> 6.5. listen()—会有人联系我吗?</h3><p>之前讲的函数服务端和客户端都可以使用，让我们换换口味，这次讲一个仅用于服务端的函数，不仅如此，它还只能用于TCP服务端。</p><p>身为服务端，肯定是需要等待随时可能到来的客户端连接，并采用某种方式处理连接。整个过程可以分为两步：先调用<code>listen()</code>，然后调用<code>accept()</code>（这是下一小节的内容）。</p><p><code>listen</code>的调用非常简单，如下：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sock.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>虽然只有两个参数，但是其中有一些细节值得玩味。</p><p><code>sockfd</code>就是通过<code>socket()</code>返回的一个<strong>普通</strong><code>socket file descriptor</code>而已，系统默认这个socket只是一个等待进行主动连接的客户端socket。而<code>listen</code>函数会把这个客户端socket转换为服务端socket，告诉内核需要接受指向该socket的连接请求，并且该socket的TCP状态从<code>CLOSED</code>转换为<code>LISTEN</code>。</p><p><code>backlog</code>参数表示内核应该为该套接字排队的最大连接个数。这是啥意思？所有客户端与该socket建立的连接都会在一个队列中排队等待，直到你<code>accept()</code>（见下节）它们，这个参数就表示最多有多少个连接有资格排队。大多数系统将这个值预设为20，你可以初始化为5或者10。</p><p>还有老生常谈的，<code>listen() </code>在错误的时候会返回<code> -1</code>，并设置 <code>errno</code>。</p><p>联系之前讲过的3个系统调用，创建服务端代码需要调用的函数依次为：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* accept() 将被写在这里 */</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我只是列出了函数的调用顺序而已，这几个步骤都比较简单，稍微需要点处理技巧的是下一节的<code>accept()</code>。</p><h3 id="_6-6-accept-—感谢呼叫3490端口" tabindex="-1"><a class="header-anchor" href="#_6-6-accept-—感谢呼叫3490端口" aria-hidden="true">#</a> 6.6. accept()—感谢呼叫3490端口</h3><p>系好安全带，<code>accept()</code>之旅开始了。</p><p>一个远程用户试图调用<code>connect()</code>来连接到你使用<code>listen()</code>进行监听的端口上，这个连接会被放到队列中等着被你<code>accept()</code>。这句话要是你看不懂你需要回去看看前文哦。</p><p>然后你调用<code>accept()</code>，从队列中取出一个等候已久的连接，<code>accept()</code>会返回给你一个专属于这个连接的一个<strong>全新的</strong><code>socket file descriptor</code>！</p><p>没错，你现在有<strong>2个</strong><code>socket file descriptor</code>了！原来的<code>socket file descriptor</code>仍在处于被<code>listen()</code>的状态等待客户端的连接，而你刚刚得到的<code>socket file descriptor</code>则是准备给<code>send()</code>和<code>recv()</code>使用的，通过这俩函数，就可以实现和客户端之间的通信了。</p><p><code>accept()</code>使用如下：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sockfd</code>就是正在被<code>listen()</code>的那个<code>socket descriptor</code>，这个没啥难度。</p><p><code>addr</code>就是一个指向 <code>struct sockaddr_storage</code>的指针，这里边会自动保存客户端的一些信息，你能从中得知客户端是从哪个IP、哪个端口对你发起的连接。</p><p><code>addrlen</code>是一个整数变量，你应该在将它的地址传给<code>accept()</code>之前，把它设置为 <code>sizeof(struct sockaddr_storage)</code> 。<code>accept()</code>保存在<code>addr</code>指向的对象中的数据大小只会小于等于<code>addrlen</code>，如果小于的话，<code>accept()</code>会通过改变<code>addrlen</code>的值来告诉你，所以你应该知道为什么这个字段是个指针变量了吧。</p><p>猜猜我要说啥，一句我快说吐了的话。<code>accept() </code>在错误的时候会返回<code> -1</code>，并设置 <code>errno</code>。</p><p>和之前一样，show you the code可能会更好吸收，看一段代码：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MYPORT</span> <span class="token string">&quot;3490&quot;</span>  <span class="token comment">// the port users will be connecting to</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BACKLOG</span> <span class="token expression"><span class="token number">10</span>     </span><span class="token comment">// how many pending connections queue will hold</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> their_addr<span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span> addr_size<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> new_fd<span class="token punctuation">;</span>

    <span class="token comment">// !! don&#39;t forget your error checking for these calls !!</span>

    <span class="token comment">// first, load up address structs with getaddrinfo():</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>  <span class="token comment">// use IPv4 or IPv6, whichever</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span>     <span class="token comment">// fill in my IP for me</span>

    <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> MYPORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// make a socket, bind it, and listen on it:</span>

    sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> BACKLOG<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// now accept an incoming connection:</span>

    addr_size <span class="token operator">=</span> <span class="token keyword">sizeof</span> their_addr<span class="token punctuation">;</span>
    new_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>their_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ready to communicate on socket descriptor new_fd!</span>
    <span class="token punctuation">.</span>
    <span class="token punctuation">.</span>
    <span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来我们就会用得到的<code>new_fd</code>这个<code>socket descriptor</code>进行<code>send()</code>和<code>recv()</code>。</p><p>如果你只是想获取这一个连接，你可以使用<code>close()</code>来关闭处于<code>LISTEN</code>状态的<code>sockfd</code>，这样就可以避免有更多的客户端连接到<code>3490</code>这个端口上了。</p><h3 id="_6-7-send-and-recv-—跟我唠唠吧-宝儿" tabindex="-1"><a class="header-anchor" href="#_6-7-send-and-recv-—跟我唠唠吧-宝儿" aria-hidden="true">#</a> 6.7. send() and recv()—跟我唠唠吧，宝儿!</h3><p><code>send()</code>和<code>recv()</code>两个函数是服务端和客户端通过<code>stream socket</code>或者是<code>connected datagram socket</code>用来通信的。如果你想使用常规的<code>unconnected datagram socket</code>，你需要参考下文的<code>sendto()</code>和<code>recvfrom()</code>一节了。</p><p><code>send()</code>的声明长这样儿：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>sockfd</code>是一个你想发送数据过去的<code>socket descriptor</code>，这个<code>socket descriptor</code>可能是<code>socket()</code>返回的，也可能是通过<code>accept()</code>得到的。</p><p><code>msg</code>是指向发想发送的数据的指针，<code>len</code>是数据的字节长度。至于<code>flags</code>，你就直接设置成<code>0</code>就完了（更多的细节参见后文的<code>send()</code>手册，PS：还没翻译到那里）。</p><p>上例子：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">char</span> <span class="token operator">*</span>msg <span class="token operator">=</span> <span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> len<span class="token punctuation">,</span> bytes_sent<span class="token punctuation">;</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
bytes_sent <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>send()</code>的返回值表示实际发送数据的字节数，这个数可能比你设置的想发送的数据长度<code>len</code>要小。事情就是这么奇怪，明明你想让函数发送所有的数据，它却做不到，它只能尽力把能发送的数据都发送出去，但是它不会自动发送剩下的数据。</p><p>因此，如果<code>send()</code>返回的值小于<code>len</code>的话，就需要由你来决定是不是要发送剩下的数据了。也并非每次都这样，如果数据包很小（小于<code>1K</code>或更小），<code>send()</code><strong>可能</strong>会一下子把所有数据都发出去。</p><p>再强调一遍，<code>send()</code>异常的话会返回<code>-1</code>，并且修改<code>errno</code>这个全局变量。</p><p><code>recv()</code>这个函数在很多方面和<code>send()</code>类似：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">recv</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>sockfd</code>是你想从中读取数据的<code>socket descriptor</code>，<code>buf</code>是存储你读取的数据的缓冲区，<code>len</code>是缓冲区的最大长度，<code>flags</code>还是直接设置成<code>0</code>就行（更多的细节参见之后的<code>recv()</code>手册，PS：还没翻译到那里）。</p><p><code>recv()</code>的返回值表示实际读到缓冲区的字节数，异常的话会返回<code>-1</code>，并且修改<code>errno</code>这个全局变量。</p><p>注意！<code>recv()</code>的返回值可以是<code>0</code>，是<code>0</code>意味着对面关闭了与你的连接，返回<code>0</code>是为了让你知道这回事儿。</p><p>到这就结束了，很简单对吧。你现在可以通过<code>stream socket</code>进行往返数据处理了。</p><p>恭喜你，正式成为一名UNIX网络编程设计师！</p><h3 id="_6-8-sendto-and-recvfrom-—用dgram风格跟我说话" tabindex="-1"><a class="header-anchor" href="#_6-8-sendto-and-recvfrom-—用dgram风格跟我说话" aria-hidden="true">#</a> 6.8. sendto() and recvfrom()—用DGRAM风格跟我说话</h3><p><code>datagram socket</code>在发送数据数据之前不需要建立和对方的连接，但是在发送数据之前我们起码得把目的地址给准备好。</p><p>看一下<code>sendto()</code>这个函数：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">sendto</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
           <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>to<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> tolen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>除了后边两个参数，剩下的参数和<code>send()</code>函数基本保持一致，就不再介绍了。</p><p><code>to</code>是一个指向 <code>struct sockaddr</code>（也可能是被强制类型转换成的 <code>struct sockaddr_in</code> 、 <code>struct sockaddr_in6</code> 或者 <code>struct sockaddr_storage</code>结构 ）的指针，这个struct中包含了目的IP地址和端口号。<code>tolen</code>是一个<code>int</code>变量，可以简单地设置为<code>sizeof *to</code>或<code>sizeof(struct sockaddr_storage)</code>。</p><p>想得到包含目的地址的这个数据结构，你需要通过调用 <code>getaddrinfo()</code>或者下文的 <code>recvfrom()</code>，你也可以手动封装。</p><p>类似<code>send()</code>，<code>sendto()</code>的返回值表示的也是实际发送字节数，而且这个数可能比你想发送的大小要小。执行异常就返回<code>-1</code>。</p><p><code>recvfrom()</code>和<code>recv()</code>差不多，<code>recvfrom()</code>语法如下：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
             <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>fromlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>你看，是不是除了最后两个参数之外其他差不多啊。<code>from</code>是一个指向本地的<code>struct sockaddr_storage</code>结构的指针，其中保存了数据包来源主机的IP地址和端口。<code>fromlen</code>是一个整数类型指针，这个整数应该被初始化为 <code>sizeof *from</code> 或者 <code>sizeof(struct sockaddr_storage)</code>。<code>recvfrom()</code>函数调用完成之后，<code>fromlen</code>保存的是实际存储在<code>from</code>结构中的地址长度。</p><p><code>recvfrom()</code>的返回值表示实际读取到的数据字节数，异常返回<code>-1</code>，并设置<code>errno</code>值。</p><p>有个问题啊，为什么我上文说<code>from</code>是一个指向<code>struct sockaddr_storage</code>的结构啊，为什么不是 <code>struct sockaddr_in</code>？因为我们不想在IPv4或者IPv6一棵树上吊死，而<code>sockaddr_storage</code>有足够的存储空间让我们来自由选择IPv4还是IPv6地址。</p><p>你可能又会提出一个问题，为什么不把 <code>struct sockaddr</code> 设计的足够容纳任何地址呢，这样不就不用来回强转了嘛。这都是历史原因了，当时也没想到IPv4的地址不够用，所以只能新设计一个<code>struct sockaddr_storage</code> 了。</p><p>谨记，如果你对<code>datagram socket</code>使用<code>connect()</code>，你可以直接使用<code>send()</code>和<code>recv()</code>。<code>socket</code>本身仍然是<code>datagram socket</code>，并且协议用的也是<code>UDP</code>，只不过<code>socket</code>接口会自动帮你添加目的和来源信息。</p><h3 id="_6-9-close-and-shutdown-—滚犊子" tabindex="-1"><a class="header-anchor" href="#_6-9-close-and-shutdown-—滚犊子" aria-hidden="true">#</a> 6.9. close() and shutdown()—滚犊子！</h3><p>当你玩儿够了<code>send()</code>和<code>recv()</code>，你可能想关闭你的<code>socket descriptor</code>连接了，这个操作很简单，只需要调用<code>close()</code>函数就可以了：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这将避免<code>sockfd</code>进行更多的读写操作，任何想要对这个<code>socket</code>进行读写的操作都会报错。</p><p>如果你想对<code>socket</code>关闭的姿势多一点控制，那你应该使用的是<code>shutdown()</code>函数，它允许选择性地切断单向连接或者双向连接（这一点和<code>close()</code>一样）。语法如下：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> how<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>sockfd</code>表示你想关闭的<code>socket file descriptor</code>，<code>how</code>的参数以及含义见下表：</p><table><thead><tr><th style="text-align:center;">how的值</th><th style="text-align:center;">含义</th></tr></thead><tbody><tr><td style="text-align:center;">0</td><td style="text-align:center;">禁止接收数据</td></tr><tr><td style="text-align:center;">1</td><td style="text-align:center;">禁止发送数据</td></tr><tr><td style="text-align:center;">2</td><td style="text-align:center;">禁止接收、发送数据（和<code>close()</code>相同）</td></tr></tbody></table><p><code>shutdown()</code>成功时返回<code>0</code>，失败时返回<code>-1</code>，并且设置全局变量<code>errno</code>。</p><p>如果你在<code>unconnected datagram socket</code>上使用<code>shutdown()</code>，它只会单纯地让<code>socket</code>无法继续进行<code>send()</code>和<code>recv()</code>调用。如果你想让<code>shutdown()</code>发挥原本的作用，那么你应该把它用在使用了<code>connect()</code>函数的<code>datagram socket</code>身上。</p><p>需要强调的是，<code>shutdown()</code>并不会实际关闭<code>file descriptor</code>，只是改变了可用状态而已。想要真正释放<code>file descriptor</code>，你还是得调用<code>close()</code>。</p><p>没了。</p><p>「对了，如果你用的是<code>Windows</code>和<code>Winsock</code>，你需要用的是<code>closesocket()</code>，而不是<code>close()</code>，谨记！」</p><h3 id="_6-10-getpeername-—你哪位" tabindex="-1"><a class="header-anchor" href="#_6-10-getpeername-—你哪位" aria-hidden="true">#</a> 6.10. getpeername()—你哪位?</h3><p>这个函数有点简单。</p><p>简单到我都不想单独把它列出来，但是我还是列出来了。</p><p><code>getpeername()</code>会告诉你另一端连接的<code>stream socket</code>是谁。语法如下：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
    
<span class="token keyword">int</span> <span class="token function">getpeername</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sockfd</code>是一个已连接的<code>stream socket</code>；<code>addr</code>是一个指向<code>struct sockaddr</code> (或者 <code>struct sockaddr_in</code>) 结构的指针，结构中存储了连接的另一头儿的信息；<code>addrlen</code>是一个<code>int</code>型指针，这个int变量应该被初始化为 <code>sizeof *addr</code> 或者 <code>sizeof(struct sockaddr)</code>。</p><p>函数异常时会返回<code>-1</code>，并且设置全局变量<code>errno</code>。</p><p>一旦你获取了对面的地址，你就可以使用 <code>inet_ntop()</code>, <code>getnameinfo()</code>, 或者 <code>gethostbyaddr()</code> 打印出来或者获取更多信息（但是别妄想能获取到别人的登录名哦～）。</p><h3 id="_6-11-gethostname-—我是谁" tabindex="-1"><a class="header-anchor" href="#_6-11-gethostname-—我是谁" aria-hidden="true">#</a> 6.11. gethostname()—我是谁?</h3><p>这货比 <code>getpeername()</code> 还简单。</p><p><code>gethostname()</code>会返回程序所有的主机名称，这个主机名称可以继续用在 <code>gethostbyname()</code>中来确定主机的IP地址。</p><p>还能玩得更花一点儿吗？</p><p>当然有，不过这就和socket编程关系不大了，还是简单介绍一下使用方法吧：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">gethostname</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>参数很简单：<code>hostname</code>是一个字符指针，将存储返回的主机名称（hostname）；<code>size</code>是返回的主机名称的字节长度。</p><p>函数在执行成功是返回<code>0</code>，错误时返回<code>-1</code>，并一样会设置<code>errno</code>。</p><h2 id="_7-client-server基础" tabindex="-1"><a class="header-anchor" href="#_7-client-server基础" aria-hidden="true">#</a> 7. Client-Server基础</h2><p>宝儿，你得承认，这是个<code>Client-Server</code>的世界。</p><p>网络上几乎所有的内容本质上都是Client进程与`erver进程之间的会话，反之亦然。</p><p>拿telnet举个例子。当你使用<code>telnet</code>（Client端）连接上远程主机的<code>23</code>端口，远程主机上监听该端口的程序（叫<code>telnetd</code>，就是<code>telnet</code>的Server端）就动了起来。它会处理到来的<code>telnet</code>连接，并为你设置好登陆提示信息等。</p><p><img src="http://qiniu.chanmufeng.com/2022-10-15-130214.png" alt="Client-Server交互" loading="lazy"></p><p>上图很形象地表达了Client和Server之间的信息交互。</p><p>需要注意的是，<code>Client-Server</code>这一组搭档可以使用 <code>SOCK_STREAM</code>、 <code>SOCK_DGRAM</code>或其他任何协议（只要双方使用的协议一致即可）。</p><p><code>telnet</code>/<code>telnetd</code>, <code>ftp</code>/<code>ftpd</code>, 以及 <code>Firefox</code>/<code>Apache</code>等都是<code>Client-Server</code>模式非常好的范例。比如，每次你使用<code>ftp</code>的时候，在远程都会一个<code>ftpd</code>程序为你服务。</p><p>通常情况下，一台主机只会有一个Server程序（这里指的是处理同一功能的服务端），该程序会使用<code>fork()</code>来处理多个Client。基本的流程是这样的：Server会等待客户端连接，然后<code>accept()</code>该连接，再<code>fork()</code>出一个子进程来处理该连接。</p><p>这就是我们下一节的Server端程序做的事情。</p><h3 id="_7-1-一个简单的stream-server" tabindex="-1"><a class="header-anchor" href="#_7-1-一个简单的stream-server" aria-hidden="true">#</a> 7.1. 一个简单的stream server</h3><p>这个Server端程序做的工作就是把 “<code>Hello, world!</code>”字符串通过<code>stream connection</code> 发送给Client。</p><p>你如果要测试这个Server程序，你需要在一起命令行窗口中运行这个Server程序，然后在另一个命令行窗口中运行以下命令：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ telnet remotehostname <span class="token number">3490</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>remotehostname</code>指的是运行程序的主机名，也可以是一个IP地址。</p><p>Server端程序来喽：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** server.c -- a stream socket server demo
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PORT</span> <span class="token string">&quot;3490&quot;</span>  <span class="token comment">// the port users will be connecting to</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BACKLOG</span> <span class="token expression"><span class="token number">10</span>   </span><span class="token comment">// how many pending connections queue will hold</span></span>

<span class="token keyword">void</span> <span class="token function">sigchld_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// waitpid() might overwrite errno, so we save and restore it:</span>
    <span class="token keyword">int</span> saved_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    errno <span class="token operator">=</span> saved_errno<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// get sockaddr, IPv4 or IPv6:</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>sa<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token operator">-&gt;</span>sa_family <span class="token operator">==</span> AF_INET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> new_fd<span class="token punctuation">;</span>  <span class="token comment">// listen on sock_fd, new connection on new_fd</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>servinfo<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> their_addr<span class="token punctuation">;</span> <span class="token comment">// connector&#39;s address information</span>
    <span class="token class-name">socklen_t</span> sin_size<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sa<span class="token punctuation">;</span>
    <span class="token keyword">int</span> yes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> s<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> rv<span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span> <span class="token comment">// use my IP</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rv <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// loop through all the results and bind to the first we can</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> servinfo<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span>
                p<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;server: socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>yes<span class="token punctuation">,</span>
                <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;setsockopt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;server: bind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// all done with this structure</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;server: failed to bind\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> BACKLOG<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;listen&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> sigchld_handler<span class="token punctuation">;</span> <span class="token comment">// reap all dead processes</span>
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> SA_RESTART<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;sigaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;server: waiting for connections...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// main accept() loop</span>
        sin_size <span class="token operator">=</span> <span class="token keyword">sizeof</span> their_addr<span class="token punctuation">;</span>
        new_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>their_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sin_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>new_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;accept&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">inet_ntop</span><span class="token punctuation">(</span>their_addr<span class="token punctuation">.</span>ss_family<span class="token punctuation">,</span>
            <span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>their_addr<span class="token punctuation">)</span><span class="token punctuation">,</span>
            s<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;server: got connection from %s\n&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// this is the child process</span>
            <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// child doesn&#39;t need the listener</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">send</span><span class="token punctuation">(</span>new_fd<span class="token punctuation">,</span> <span class="token string">&quot;Hello, world!&quot;</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;send&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">close</span><span class="token punctuation">(</span>new_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">close</span><span class="token punctuation">(</span>new_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// parent doesn&#39;t need this</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了让代码看来起更清晰（起码我是这么认为的），我把所有代码都放在了一个<code>main()</code>函数中。如果你想把它分成多个更小的函数，尽管分就好了。</p><p>另外，你可能对 <code>sigaction()</code> 这个函数有点陌生，这个函数是用来处理僵尸进程（zombie processes）的。</p><p>你可以使用下节讲到的Client端代码来获取这个程序发送的消息。</p><h3 id="_7-2-一个简单的stream-client" tabindex="-1"><a class="header-anchor" href="#_7-2-一个简单的stream-client" aria-hidden="true">#</a> 7.2. 一个简单的stream client</h3><p>Client代码比Server代码还要简单。</p><p>这段代码的功能就是连接你在命令行中指定的主机上的<code>3490</code>端口，获取Server端发送的数据。</p><p>上代码：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** client.c -- a stream socket client demo
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PORT</span> <span class="token string">&quot;3490&quot;</span> <span class="token comment">// the port client will be connecting to </span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXDATASIZE</span> <span class="token expression"><span class="token number">100</span> </span><span class="token comment">// max number of bytes we can get at once </span></span>

<span class="token comment">// get sockaddr, IPv4 or IPv6:</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>sa<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token operator">-&gt;</span>sa_family <span class="token operator">==</span> AF_INET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> numbytes<span class="token punctuation">;</span>  
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXDATASIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>servinfo<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rv<span class="token punctuation">;</span>
    <span class="token keyword">char</span> s<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;usage: client hostname\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rv <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// loop through all the results and connect to the first we can</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> servinfo<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span>
                p<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;client: socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;client: connect&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;client: failed to connect\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">inet_ntop</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> <span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">)</span><span class="token punctuation">,</span>
            s<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;client: connecting to %s\n&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// all done with this structure</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numbytes <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXDATASIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;recv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    buf<span class="token punctuation">[</span>numbytes<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;client: received &#39;%s&#39;\n&quot;</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行Client程序之前，你需要先运行Server程序，否则的话你可能会收到 “Connection refused” 的错误提示。</p><h3 id="_7-3-datagram-sockets" tabindex="-1"><a class="header-anchor" href="#_7-3-datagram-sockets" aria-hidden="true">#</a> 7.3. Datagram Sockets</h3><p><code>UDP datagram socket</code> 的基础我们在<code>sendto()</code>和<code>recvfrom()</code>那一节的已经讲过了。本节，我将给出两段程序： <code>talker.c</code> 和 <code>listener.c</code>。</p><p><code>listener.c</code>运行在主机上一直等待着去往<code>4950</code>端口的数据包。<code>talker</code>将用户在命令行输入的数据从指定的主机发往<code>4950</code>端口。</p><p>因为<code>datagram sockets</code>是无连接的，因此只需要把数据包通过以太网发送出去就行，甭管成功失败。</p><p>此外，程序中我们令Client和Server都使用IPv6。这样以来就避免了Server段使用IPv6，而Client使用IPv4导致数据不会被接收的这种情况。</p><blockquote><p>实际上，在使用<code>TCP stream sockets</code>的情况下，我们依然可能会碰到地址族不匹配的情况，但是由于我们会使用<code>connect()</code>函数，如果因为地址族的问题导致<code>connect()</code>报错，就等于显式提醒我们需要换另一个地址族了。</p></blockquote><p>下面给出 <code>listener.c</code>的代码：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** listener.c -- a datagram sockets &quot;server&quot; demo
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MYPORT</span> <span class="token string">&quot;4950&quot;</span>    <span class="token comment">// the port users will be connecting to</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXBUFLEN</span> <span class="token expression"><span class="token number">100</span></span></span>

<span class="token comment">// get sockaddr, IPv4 or IPv6:</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>sa<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token operator">-&gt;</span>sa_family <span class="token operator">==</span> AF_INET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>servinfo<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> numbytes<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> their_addr<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXBUFLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span> addr_len<span class="token punctuation">;</span>
    <span class="token keyword">char</span> s<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_INET6<span class="token punctuation">;</span> <span class="token comment">// set to AF_INET to use IPv4</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_DGRAM<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span> <span class="token comment">// use my IP</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rv <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> MYPORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// loop through all the results and bind to the first we can</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> servinfo<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span>
                p<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;listener: socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;listener: bind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;listener: failed to bind socket\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;listener: waiting to recvfrom...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    addr_len <span class="token operator">=</span> <span class="token keyword">sizeof</span> their_addr<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numbytes <span class="token operator">=</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXBUFLEN<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>their_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;recvfrom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;listener: got packet from %s\n&quot;</span><span class="token punctuation">,</span>
        <span class="token function">inet_ntop</span><span class="token punctuation">(</span>their_addr<span class="token punctuation">.</span>ss_family<span class="token punctuation">,</span>
            <span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>their_addr<span class="token punctuation">)</span><span class="token punctuation">,</span>
            s<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;listener: packet is %d bytes long\n&quot;</span><span class="token punctuation">,</span> numbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span>numbytes<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;listener: packet contains \&quot;%s\&quot;\n&quot;</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>需要注意的是，我们在 <code>getaddrinfo()</code> 时，使用了 <code>SOCK_DGRAM</code>。而且我们没有使用 <code>listen()</code> 或者 <code>accept()</code>函数，这是使用<code>unconnected datagram sockets</code>的好处之一。</p><p>接下来看一下<code>talker</code>的代码：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** talker.c -- a datagram &quot;client&quot; demo
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SERVERPORT</span> <span class="token string">&quot;4950&quot;</span>    <span class="token comment">// the port users will be connecting to</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>servinfo<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> numbytes<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;usage: talker hostname message\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_INET6<span class="token punctuation">;</span> <span class="token comment">// set to AF_INET to use IPv4</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_DGRAM<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rv <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> SERVERPORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// loop through all the results and make a socket</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> servinfo<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span>
                p<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;talker: socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;talker: failed to create socket\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numbytes <span class="token operator">=</span> <span class="token function">sendto</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
             p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;talker: sendto&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;talker: sent %d bytes to %s\n&quot;</span><span class="token punctuation">,</span> numbytes<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这些就是全部了。你在某台主机上执行<code>listener</code>，然后在另一台主机上执行<code>talker</code>，观察它们之间的通信，你会发现这很有趣。</p><p>你甚至都可以不先执行Server！可以只执行<code>talker</code>，<code>talker</code>会很开心地将数据包扔到网络上，如果另一段没有人负责用<code>recvfrom()</code>接收，大不了就是数据包丢了而已。</p><blockquote><p>谨记：<code>UDP</code>发送数据并不会保证数据一定会送达对方。</p></blockquote><p>这里提一下之前提过很多次的一个小细节：<code>connected datagram sockets</code>，毕竟我们这节讲的就是<code>datagram socket</code>嘛。</p><p>如果<code>talker</code>调用了<code>connect()</code>并且指定了<code>listener</code>的地址，这样一来，<code>talker</code>只能和<code>connect()</code>指定的地址进行数据发送与接收。这就是<code>connected datagram socket</code>，你也可以不必局限于<code>sendto()</code>和<code>recvfrom()</code>，直接使用<code>send()</code>和<code>recv()</code>就可以了。</p><h2 id="_8-技术进阶" tabindex="-1"><a class="header-anchor" href="#_8-技术进阶" aria-hidden="true">#</a> 8. 技术进阶</h2><p>这并不是特别高阶的知识，但是可以让你跳脱出你已经掌握的基础知识了。如果你一步一步学习到这里了，你可以认为你已经相当精通Unix网络编程的<strong>基础知识</strong>了，恭喜你。</p><p>现在我们将进入一个新的世界，学习一下关于socket更深奥的知识。</p><h3 id="_8-1-blocking—何谓阻塞" tabindex="-1"><a class="header-anchor" href="#_8-1-blocking—何谓阻塞" aria-hidden="true">#</a> 8.1. Blocking—何谓阻塞？</h3><p>你可能听说过<strong>阻塞</strong>（Blocking）这个词，那么它到底是个什么鬼东西？简而言之，“block”是“sleep”的一种更具有科技感的叫法。</p><blockquote><p>下文中，「blocking」、「block」和「阻塞」会混用，都是一个意思，悉知</p></blockquote><p>当你运行前文的<code>listener</code>程序时，你可能发现它一直在“block”，直到数据包到达才会动起来。产生这个现象的原因是它调用了<code>recvfrom()</code>，如果没有数据，<code>recvfrom()</code>就会被“block”（你可以理解为“sleep”），直到有数据到达。</p><p>很多函数都会block。<code>accept()</code>会block，所有的<code>recv()</code>会block，它们之所以可以block，是因为它们被内核赋予了这个能力。当你使用<code>socket()</code>函数创建出一个<code>socket descriptor</code>时，内核就会将其设置为<code>blocking</code>。如果你不想要blocking socket，你需要调用<code>fcntl()</code>进行设置：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fcntl</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将socket设置为non-blocking（非阻塞），你就可以<code>poll</code>（轮询）socket来获取数据了。如果你对一个non-blocking socket进行读取，而socket没有数据的时候，它并不会阻塞，而是会返回<code>-1</code>，并且将<code>errno</code>设置为 <code>EAGAIN</code> 或 <code>EWOULDBLOCK</code>。</p><p>啥？ <code>EAGAIN</code> <strong>或</strong> <code>EWOULDBLOCK</code>吗？那我到底应该检查哪一个？实际上，不同操作系统返回哪个值是不确定的，因此为了兼容性，你最好把这两个值都检查一下。</p><p>但是老实说，你要是时时刻刻进行数据轮询并不是个好主意，因为会空耗CPU时间片，做的大部分都是无用功。协下一节的<code>poll()</code>提供了一个更优雅的解决方案，用于检查是否有等待读取的数据。</p><h3 id="_8-2-poll-—同步的i-o多路复用" tabindex="-1"><a class="header-anchor" href="#_8-2-poll-—同步的i-o多路复用" aria-hidden="true">#</a> 8.2. poll()—同步的I/O多路复用</h3><p>你可能在想，有没有一种办法，可以同时监听多个socket，然后只处理其中已经有数据的socket呢？这样的话我们就不用傻乎乎地不停轮询，来检查哪些socket已经有数据了。</p><p>那怎么避免poll（轮询）呢？说起来有点搞笑，你可以使用<code>poll()</code>这个系统调用来避免poll（轮询）。本质上，我们都是让内核来替我们做各种脏活累活，然后告诉我们哪些socket有数据可读了。没有数据可读的时候我们的进程可以处于休眠状态，不会占用CPU。</p><blockquote><p>警告：随着连接数变得巨大，poll()函数会变得巨慢！这种情况下，推荐你使用<a href="https://libevent.org/" target="_blank" rel="noopener noreferrer">libevent<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>这样的事件库。它会尝试使用你系统上可用的最快方法，获得更好的性能。</p></blockquote><p>一般的做法是维护一个 <code>struct pollfd</code>的数组，其中包含我们想要监听的<code>socket descriptor</code>以及我们想要监听的事件类型的信息。内核会阻塞在<code>poll()</code>这个调用上，直到你关注的其中一个事件发生（比如“socket ready to read！”）或直到发生用户指定超时。</p><p>拿TCP Server端程序举个例子，下面的代码其实还是<code>blocking</code>的代码，写出来就是为了方便我翻译原文的一句话（如果硬翻译实在是不好理解）。根据套路编写了4步流程：<code>socket()</code>、<code>bind()</code>、<code>listen()</code>以及<code>accept()</code>。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> new_fd<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>XXX<span class="token punctuation">,</span>XXX<span class="token punctuation">,</span>XXX<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> XXX<span class="token punctuation">,</span> XXX<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> BACKLOG<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
 
  new_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> XXX<span class="token punctuation">,</span> XXX<span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>blocking</code>代码中，程序会阻塞在<code>accept()</code>，直到有一个Client连接上来。但是在<code>non-blocking</code>程序中，有Client连接上来准备被<code>accept()</code>调用之前，<code>sockfd</code>就会直接告诉我们有一个新的连接来了，我们接着找到他，然后<code>accept()</code>处理即可。大家可以对比一下这两者之间的区别。</p><p>说得不少了，看一下<code>poll()</code>的用法：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>

<span class="token comment">//返回： 如果有就绪的描述符则为其数目，若超时返回0，若出错返回-1</span>
<span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> fds<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">nfds_t</span> nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>fds</code>是一个结构数组，数组中每个元素都是一个<code>pollfd</code>结构，保存了「监听哪个socket的什么事件」的信息；<code>nfds</code>是数组的数量；<code>timeout</code>是设置的超时时间，以毫秒为单位。<code>poll()</code>返回就绪（有时间发生）的描述符数量，若超时返回<code>0</code>，若出错返回<code>-1</code>。</p><p>我们看一下<code>pollfd</code>结构：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> fd<span class="token punctuation">;</span>         <span class="token comment">// the socket descriptor</span>
  <span class="token keyword">short</span> events<span class="token punctuation">;</span>   <span class="token comment">// 我们感兴趣的事件组成的 bitmap</span>
  <span class="token keyword">short</span> revents<span class="token punctuation">;</span>  <span class="token comment">// poll() 返回时，已发生事件组成的 bitmap</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>fd</code>表示的就是你想监听的<code>socket descriptor</code>，通过设置<code>events</code>字段来指定我们感兴趣的事件类型。</p><p>events字段时下表中值的按位或：</p><table><thead><tr><th style="text-align:center;">常值</th><th style="text-align:center;">说明</th></tr></thead><tbody><tr><td style="text-align:center;">POLLIN</td><td style="text-align:center;">当数据可读时（recv()可读），提醒我</td></tr><tr><td style="text-align:center;">POLLOUT</td><td style="text-align:center;">当数据可写时（send()可写），提醒我</td></tr></tbody></table><p>得到<code>struct pollfd</code>数组之后，你就可以将其传给<code>poll()</code>函数了，同时传递的还有数组的长度以及以毫秒为单位的超时时间（你也可以指定一个负数，表示永久等待）。</p><p><code>poll()</code>返回之后，你可以检查<code>revents</code>字段，查看是否设置了<code>POLLIN</code>或<code>POLLOUT</code>，来判断是否有事件发生。</p><blockquote><p>实际上，你可以使用<code>poll()</code>进行更多操作，更多细节，参见后文的<code>poll()</code>使用手册。</p></blockquote><p>下面给出一个例子，当你在命令行敲击一下回车或者等2.5秒钟，你会看到<code>poll()</code>返回的不同状态，运行一下试试吧：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> pfds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 如果你需要监听更多的socket，就设置得更大一点</span>

    pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token comment">// 0 表示标准输入</span>
    pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span> <span class="token comment">// Tell me when ready to read</span>

    <span class="token comment">// If you needed to monitor other things, as well:</span>
    <span class="token comment">//pfds[1].fd = some_socket; // Some socket descriptor</span>
    <span class="token comment">//pfds[1].events = POLLIN;  // Tell me when ready to read</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Hit RETURN or wait 2.5 seconds for timeout\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> num_events <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>pfds<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2.5 second timeout</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_events <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Poll timed out!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> pollin_happened <span class="token operator">=</span> pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pollin_happened<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;File descriptor %d is ready to read\n&quot;</span><span class="token punctuation">,</span> pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected event occurred: %d\n&quot;</span><span class="token punctuation">,</span> pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>强调一下，<code>poll()</code>返回的是<code>pfds</code>数组中有事件发生的元素数量，但是并不会告诉你数组中有哪些元素（你需要循环判断）有事件发生。</p><p>随之而来会出现几个问题。</p><p>如何向传递给<code>poll()</code>的数组中添加新的<code>file descriptor</code>？你只要确保数组中有足够的空间来满足你的需求即可，或者根据你的需求调用 <code>realloc()</code> 重新分配内存。</p><p>怎么删除<code>pfds</code>中的元素呢？你可以将<code>pfds</code>中的最后一个数据（实际有用的数据）复制到你想删除的位置上，然后将传给<code>poll()</code>的数组长度参数 - 1。或者你也可以将你想删除的元素设置为负数，<code>poll()</code>会忽略它的。</p><p>接下来看一个稍微麻烦点儿的例子，用<code>poll()</code>编写一个聊天室。</p><p>我们需要启动一个<code>listener socket</code>，并将其添加到<code>poll()</code>的<code>file descriptors</code>集合中，这样我们就能通过它判断是不是有Client连接上来了。</p><p>然后我们把新连接添加到<code>struct pollfd</code>数组中，根据我们实际需要动态调整它的容量。当连接断开时，我们再将其从数组中清除。</p><p>当连接中有数据可读时，我们从中将数据取出并将其转发到其他连接中，这样就实现了聊天室的功能。</p><p>下面给出<code>pollserver.c</code>的代码。你可以在一个窗口中运行它，然后在其他命令行窗口中执行<code>telnet localhost 9034</code>。之后你在各个窗口命令行中输入的信息（记得敲回车），就可以在其他窗口中看到了。</p><p>不仅如此，当你输入<code>quit</code>推出<code>telnet</code>时，服务端会检测到连接断开，并且从<code>file descriptor</code>数组中将其移出。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** pollserver.c -- a cheezy multiperson chat server
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PORT</span> <span class="token string">&quot;9034&quot;</span>   <span class="token comment">// Port we&#39;re listening on</span></span>

<span class="token comment">// Get sockaddr, IPv4 or IPv6:</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>sa<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token operator">-&gt;</span>sa_family <span class="token operator">==</span> AF_INET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Return a listening socket</span>
<span class="token keyword">int</span> <span class="token function">get_listener_socket</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> listener<span class="token punctuation">;</span>     <span class="token comment">// Listening socket descriptor</span>
    <span class="token keyword">int</span> yes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment">// For setsockopt() SO_REUSEADDR, below</span>
    <span class="token keyword">int</span> rv<span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>ai<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

    <span class="token comment">// Get us a socket and bind it</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rv <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ai<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;selectserver: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> ai<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        listener <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>listener <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// Lose the pesky &quot;address already in use&quot; error message</span>
        <span class="token function">setsockopt</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>yes<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>ai<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// All done with this</span>

    <span class="token comment">// If we got here, it means we didn&#39;t get bound</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Listen</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> listener<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Add a new file descriptor to the set</span>
<span class="token keyword">void</span> <span class="token function">add_to_pfds</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token operator">*</span>pfds<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>fd_count<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>fd_size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// If we don&#39;t have room, add more space in the pfds array</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>fd_count <span class="token operator">==</span> <span class="token operator">*</span>fd_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>fd_size <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Double it</span>

        <span class="token operator">*</span>pfds <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span><span class="token operator">*</span>pfds<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>pfds<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>fd_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>pfds<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">*</span>fd_count<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> newfd<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>pfds<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">*</span>fd_count<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span> <span class="token comment">// Check ready-to-read</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>fd_count<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Remove an index from the set</span>
<span class="token keyword">void</span> <span class="token function">del_from_pfds</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> pfds<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>fd_count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Copy the one from the end over this one</span>
    pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> pfds<span class="token punctuation">[</span><span class="token operator">*</span>fd_count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>fd_count<span class="token punctuation">)</span><span class="token operator">--</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Main</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> listener<span class="token punctuation">;</span>     <span class="token comment">// Listening socket descriptor</span>

    <span class="token keyword">int</span> newfd<span class="token punctuation">;</span>        <span class="token comment">// Newly accept()ed socket descriptor</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> remoteaddr<span class="token punctuation">;</span> <span class="token comment">// Client address</span>
    <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">;</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// Buffer for client data</span>

    <span class="token keyword">char</span> remoteIP<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Start off with room for 5 connections</span>
    <span class="token comment">// (We&#39;ll realloc as necessary)</span>
    <span class="token keyword">int</span> fd_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd_size <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token operator">*</span>pfds <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token operator">*</span>pfds <span class="token operator">*</span> fd_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set up and get a listening socket</span>
    listener <span class="token operator">=</span> <span class="token function">get_listener_socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>listener <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;error getting listening socket\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Add the listener to set</span>
    pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> listener<span class="token punctuation">;</span>
    pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span> <span class="token comment">// Report ready to read on incoming connection</span>

    fd_count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// For the listener</span>

    <span class="token comment">// Main loop</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> poll_count <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>pfds<span class="token punctuation">,</span> fd_count<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>poll_count <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;poll&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Run through the existing connections looking for data to read</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fd_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// Check if someone&#39;s ready to read</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// We got one!!</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">==</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// If listener is ready to read, handle new connection</span>

                    addrlen <span class="token operator">=</span> <span class="token keyword">sizeof</span> remoteaddr<span class="token punctuation">;</span>
                    newfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>remoteaddr<span class="token punctuation">,</span>
                        <span class="token operator">&amp;</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>newfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;accept&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">add_to_pfds</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pfds<span class="token punctuation">,</span> newfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_count<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;pollserver: new connection from %s on &quot;</span>
                            <span class="token string">&quot;socket %d\n&quot;</span><span class="token punctuation">,</span>
                            <span class="token function">inet_ntop</span><span class="token punctuation">(</span>remoteaddr<span class="token punctuation">.</span>ss_family<span class="token punctuation">,</span>
                                <span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>remoteaddr<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                remoteIP<span class="token punctuation">,</span> INET6_ADDRSTRLEN<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// If not the listener, we&#39;re just a regular client</span>
                    <span class="token keyword">int</span> nbytes <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">int</span> sender_fd <span class="token operator">=</span> pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>nbytes <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Got error or connection closed by client</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>nbytes <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// Connection closed</span>
                            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;pollserver: socket %d hung up\n&quot;</span><span class="token punctuation">,</span> sender_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;recv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token function">close</span><span class="token punctuation">(</span>pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Bye!</span>

                        <span class="token function">del_from_pfds</span><span class="token punctuation">(</span>pfds<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// We got some good data from a client</span>

                        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> fd_count<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// Send to everyone!</span>
                            <span class="token keyword">int</span> dest_fd <span class="token operator">=</span> pfds<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">;</span>

                            <span class="token comment">// Except the listener and ourselves</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>dest_fd <span class="token operator">!=</span> listener <span class="token operator">&amp;&amp;</span> dest_fd <span class="token operator">!=</span> sender_fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">send</span><span class="token punctuation">(</span>dest_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> nbytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;send&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token comment">// END handle data from client</span>
            <span class="token punctuation">}</span> <span class="token comment">// END got ready-to-read from poll()</span>
        <span class="token punctuation">}</span> <span class="token comment">// END looping through file descriptors</span>
    <span class="token punctuation">}</span> <span class="token comment">// END for(;;)--and you thought it would never end!</span>
    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在下一节，我们会看学到一个功能类似，但是更老的一个函数<code>select()</code>。<code>poll()</code>和<code>select()</code>两者功能类似，性能也差不太多，区别主要在于它们的用法。</p><p>相比之下，<code>select()</code>的可移植性稍微强一点，但是使用起来稍显笨拙。学完下一节之后，根据你的系统支持情况，选择一个你最喜欢的即可。</p><h3 id="_8-3-select-—老古董的同步i-o多路复用" tabindex="-1"><a class="header-anchor" href="#_8-3-select-—老古董的同步i-o多路复用" aria-hidden="true">#</a> 8.3. select()—老古董的同步I/O多路复用</h3><p>我假设你已经读过<code>poll()</code>的用法了，因此直接进入主题。</p><p><code>select()</code>可以同时监听多个socket，当有你感兴趣的（多个）事件中的任何一个发生，内核才会唤醒<code>select()</code>。如果你真的想知道的话，<code>select()</code>会告诉你哪些socket是可以读取的，哪些是可以写入的，哪些引发了异常。</p><blockquote><p>警告：随着连接数越来越多，<code>select()</code>函数会变得巨慢！这种情况下，推荐你使用<a href="https://libevent.org/" target="_blank" rel="noopener noreferrer">libevent<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>这样的事件库。它会尝试使用你系统上可用的最快方法，获得更好的性能。</p></blockquote><p>看一下<code>select()</code>的语法：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> numfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>writefds<span class="token punctuation">,</span>
           fd_set <span class="token operator">*</span>exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token operator">*</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>select()</code>函数监听多种类型文件描述符的集合，尤其是<code>readfd</code>、<code>writefd</code>和<code>exceptfd</code>。如果你想要知道你是否能从标准输入（standard input）及某个socket descriptor（用 <code>sockfd</code> 表示）中进行读取，只要将标准输入的文件描述符表——<code>0</code> 与 <code>sockfd</code> 新增到 <code>readfds</code> 中。参数<code>numfds</code>应设置为最高文件描述符的值加1。在本例中，它应该设置为<code>sockfd+1</code>，因为它肯定高于标准输入——<code>0</code>。</p><p>当<code>select()</code>返回时，<code>readfds</code>将被修改，来反映你选择的哪些file descriptor可以读取。你可以使用下面的宏<code>FD_ISSET()</code>测试它们。</p><p>在进一步讨论之前，我先说一下如何操作这些file descriptor集合，每个集合都是<code>fd_set</code>类型，下面的宏在此类型上运行：</p><table><thead><tr><th style="text-align:center;">函数</th><th style="text-align:center;">描述</th></tr></thead><tbody><tr><td style="text-align:center;">FD_SET(int fd, fd_set *set);</td><td style="text-align:center;">将fd加入到set</td></tr><tr><td style="text-align:center;">FD_CLR(int fd, fd_set *set);</td><td style="text-align:center;">从set种移除fd</td></tr><tr><td style="text-align:center;">FD_ISSET(int fd, fd_set *set);</td><td style="text-align:center;">若fd在set中，返回true</td></tr><tr><td style="text-align:center;">FD_ZERO(fd_set *set);</td><td style="text-align:center;">清空set</td></tr></tbody></table><p>最后，这个奇怪的<code>struct timeval</code>是什么？</p><p>有时候，你不想永远一直等着别人给你发送数据。也许每隔一段时间你就想在终端上打印“Still Going…”，即使什么都没有发生。这个struct允许你指定超时时间段。如果超过了时间，<code>select()</code>仍然没有找到任何就绪的file descriptor，它将返回以便你可以继续进行处理。</p><p><code>struct timeval</code> 长这样：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> tv_sec<span class="token punctuation">;</span>     <span class="token comment">// seconds</span>
  <span class="token keyword">int</span> tv_usec<span class="token punctuation">;</span>    <span class="token comment">// microseconds</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>只需将<code>tv_sec</code>设置为等待的秒数，将<code>tv_usec</code>设置成等待的微秒数。你没看错，这是_micro_seconds，而不是毫秒。一毫秒有1000微秒，一秒钟有1000毫秒。因此，每秒有1000000微秒。为什么是“usec”？“u”应该看起来像我们用来表示“micro”的希腊字母μ（Mu）。</p><p>此外，当函数返回时，可能会更新<code>timeout</code>以显示剩余时间。这取决于你正在运行的Unix类型。</p><p>哇！我们有一个微秒级别的计时器！好吧，别指望它。无论你将<code>struct timeval</code>设置得多么小，你可能还是要等待一小段的 standard Unix timeslice（标准 Unix 时间片段）。</p><p>另一件有意思的事情是：如果将<code>struct timeval</code>中的字段设置为0，<code>select()</code>会在轮询过 sets 中的每个 file descriptor 之后立即timeout。如果将参数<code>timeout</code>设置为<code>NULL</code>，它将永远不会timeout，而是陷入等待状态，直到至少一个file descriptor已经就绪。如果你不在乎等待时间，可以在<code>select()</code>中将其设置为<code>NULL</code>。</p><p>下面的代码段等待2.5秒，等待标准输入中出现某些内容：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** select.c -- a select() demo
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STDIN</span> <span class="token expression"><span class="token number">0</span>  </span><span class="token comment">// file descriptor for standard input</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> tv<span class="token punctuation">;</span>
    fd_set readfds<span class="token punctuation">;</span>

    tv<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    tv<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">500000</span><span class="token punctuation">;</span>

    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FD_SET</span><span class="token punctuation">(</span>STDIN<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// don&#39;t care about writefds and exceptfds:</span>
    <span class="token function">select</span><span class="token punctuation">(</span>STDIN<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>STDIN<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;A key was pressed!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Timed out.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果你用的是行缓冲（line buffered）的终端，那么你从键盘输入数据后应该要尽快按下 Enter，否则程序就会发生 timeout。</p><blockquote><p>行缓存：标准输出流遇到换行符\n时冲刷缓存。</p></blockquote><p>你现在可能在想，这个方法用在需要等待数据的 datagram socket 上应该会很棒，你是对的：这可能确实是个不错的方法。有些Unix可以以这种方式使用<code>select()</code>，有些则不能。如果你想尝试的话，你应该参考一下你系统上的man手册上是怎么写的。</p><p>有些Unix系统会更新 <code>struct timeval</code> 的时间，用来反映 <code>select()</code> 还剩下多少时间才会 timeout；但是有些并不会这样。如果你想要程序具备可移植性，那就不要依赖这个特性。（如果你确实需要追踪剩下的时间，可以使用 <code>gettimeofday()</code>，我知道这让你有点不爽，这也是没有办法的事情。）</p><p>如果在 read set 中的 socket 关闭连接了，会怎样？</p><p>在这种情况下，<code>select()</code>返回时，socket descriptor会被设置为“ready to read”。当你对其执行<code>recv()</code>时，<code>recv()</code>将返回<code>0</code>。这样你就知道客户端已经断开连接了。</p><h3 id="_8-4-数据只传了一部分怎么办" tabindex="-1"><a class="header-anchor" href="#_8-4-数据只传了一部分怎么办" aria-hidden="true">#</a> 8.4. 数据只传了一部分怎么办？</h3><p>回想一下之前我讲过的<a href="https://www.chanmufeng.com/posts/network-programming/send-recv.html" target="_blank" rel="noopener noreferrer"><code>send()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>函数，我当时说过，<code>send()</code>可能不会一下子把你所有的数据都发送出去，比如你想放一个长度为<code>512</code>字节的字符串，<code>send()</code>的返回值却是<code>412</code>。你可能不禁会问到，剩下的<code>100</code>字节怎么办？</p><p>其实这<code>100</code>字节仍然在你小得可怜的缓冲区（buffer）中，等着你把他们发送出去呢！毕竟事事无法如你所愿，内核也会有自己的小脾气，有时就是不想把你的数据一下子发送出去，你还得自己动手把剩下的数据发送出去。</p><p>你可以这么写：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">sendall</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// how many bytes we&#39;ve sent</span>
    <span class="token keyword">int</span> bytesleft <span class="token operator">=</span> <span class="token operator">*</span>len<span class="token punctuation">;</span> <span class="token comment">// how many we have left to send</span>
    <span class="token keyword">int</span> n<span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>total <span class="token operator">&lt;</span> <span class="token operator">*</span>len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        n <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> buf<span class="token operator">+</span>total<span class="token punctuation">,</span> bytesleft<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        total <span class="token operator">+=</span> n<span class="token punctuation">;</span>
        bytesleft <span class="token operator">-=</span> n<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span>len <span class="token operator">=</span> total<span class="token punctuation">;</span> <span class="token comment">// return number actually sent here</span>

    <span class="token keyword">return</span> n<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">?</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// return -1 on failure, 0 on success</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上例中，<code>s</code>是你想发送数据的<code>socket</code>，<code>buf</code>是保存数据的缓冲区（buffer），<code>len</code>指向一个<code>int</code>类型的变量，这个变量记录了缓冲区剩余数据的大小。</p><p><code>send()</code>异常时会返回<code>-1</code>，并且最终实际发送的字节数量保存在了<code>len</code>变量中。<code>sendall()</code>会竭尽全力发送你所有的数据，除非发生了错误会导致立即返回，否则<code>len</code>的值一定就是你想发送的数据的长度。</p><p>为了完整性，给一个使用<code>sendall()</code>函数的例子：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Beej!&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> len<span class="token punctuation">;</span>

len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sendall</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;sendall&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;We only sent %d bytes because of the error!\n&quot;</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当部分数据包到达时，接收器端会发生什么？</p><p>如果数据包是可变长度的，接收方如何知道一个数据包何时结束，另一个何时开始？</p><p>现实世界的情景百出往往最让我们头疼。你必须得使用封装（忘记这个概念的话<a href="https://www.chanmufeng.com/posts/network-programming/%E6%BC%AB%E8%B0%88%E7%BD%91%E7%BB%9C.html" target="_blank" rel="noopener noreferrer">点我<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>）来解决这个问题喽。</p><p>下文见！</p><h3 id="_8-5-serialization-如何封装数据" tabindex="-1"><a class="header-anchor" href="#_8-5-serialization-如何封装数据" aria-hidden="true">#</a> 8.5. Serialization-如何封装数据？</h3><p>你可能已经发现了，在网络中传递字符串信息是比较容易的，但是如果你想传递像int或者float类型的二进制数据怎么办呢？你有几个选择：</p><ol><li>使用诸如 <code>sprintf()</code>之类的函数将数字转换为文本类型，然后把文本发送出去。接收方可以使用strtol()等函数将文本转换回数字。</li><li>直接以原始数据进行传送，将指向数据的指针传给send()。</li><li>将数字编码（encode）为可移植的二进制格式，接受者将其解码（decode）。</li></ol><p>看了本文的标题你就知道了，我们将选择第3种。</p><blockquote><p>在开始我们激情澎湃的旅程之前，我应该告诉你其实有现成的函数库可以帮助你做这件事情，如果你要从头实现一个具有可移植性并且没有bug的这种库可就太难了。</p></blockquote><p>实际上，上面3种方法各有利弊，但是我更倾向于第3种。接下来我们先聊一聊两外两种方法的优缺点。</p><p>第一种，发送之前先将数字转换为文本，优点是很容易打印和读取来自网络的数据。有时候适合人类阅读的传输协议比较适合于带宽不敏感（non-bandwidth-intensive）的情况，比如<a href="https://en.wikipedia.org/wiki/Internet_Relay_Chat" target="_blank" rel="noopener noreferrer">Internet Relay Chat（IRC）<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。缺点就是数据转换速度慢，并且需要比原本的数字形式使用更多的空间。</p><p>第二种方法相当简单，但是极具危险！因为这种方法不具备可移植性，举个例子：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">double</span> d <span class="token operator">=</span> <span class="token number">3490.15926535</span><span class="token punctuation">;</span>
    
<span class="token function">send</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>d<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> d<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* 不具备可移植性！! */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接收方接受需要这样：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">double</span> d<span class="token punctuation">;</span>

<span class="token function">recv</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>d<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> d<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* 不具备可移植性！! */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-6-数据封装" tabindex="-1"><a class="header-anchor" href="#_8-6-数据封装" aria-hidden="true">#</a> 8.6. 数据封装</h3><h3 id="_8-7-广播数据包-大声说「hello-world」" tabindex="-1"><a class="header-anchor" href="#_8-7-广播数据包-大声说「hello-world」" aria-hidden="true">#</a> 8.7. 广播数据包-大声说「Hello，World」</h3><p>到目前为止，我们已经讨论了怎么从一台主机发送数据到另一台主机。但是，如果有这种可能，你肯定想同时把数据发送给多台主机。</p><p>用<code>UDP</code>（只能用<code>UDP</code>，<code>TCP</code>不行）和标准的IPv4，可以通过一种叫做广播（<em>broadcasting</em>）的机制来实现。IPv6不支持广播，你得用一种更高级的技术——多播（<em>multicasting</em>）来实现。这个技术我们这次不会讲，毕竟我们现在还停留在IPv4的32位阶段呢，就不异想天开了。</p><p>Wait！你别溜走，自己偷摸开始广播，我还没开始介绍呢。你必须设置套接字选项<code>SO_BROADCAST</code>，然后才能在网络上发送广播数据包，这就好比是在导弹发射开关上盖的一个小塑料罩，你的一根指头就可以控制所有！</p><p>但是，说真的，使用广播数据包有一个危险，因为每个收到广播包的系统都要拨开一层层像洋葱皮一样的封装，直到系统知道这个资料是要发送到哪个 port 为止，然后系统会开始处理这个数据或者将其丢弃。</p><p>无论怎样，接收广播数据包的每台机器都要做很多工作，而且因为它们都在本地网络上，所以可能会有很多机器做很多不必要的工作。</p><p>现在，有很多方法可以解决这个问题。。。</p><p>等一下，真的有很多方法吗？</p><p>那是什么表情阿？让我告诉你吧，发送广播包的方式有很多，所以重点就是：你该如何指定广播数据的目地地址？</p><p>有两种常用的方法：</p><ol><li>将数据发送到指定子网的广播地址，就是把子网（ subnet&#39;s network）的主机（ host）部分全部填<code> 1</code>。例如，我的网络是<code>192.168.1.0</code>，我的子网掩码是<code>255.255.255.0</code>，所以地址的最后一个字节是我的主机号（因为根据网络掩码，前3个字节是网络号），所以我的广播地址是<code>192.168.1.255</code>。在Unix下，<code>ifconfig</code>会告诉你这些信息的。你可以将这种类型的广播数据包发送到远程网络和本地网络，但你会面临数据包被目标路由器丢弃的风险。（如果他们不放弃它，那这些广播数据可能会淹没他们的局域网。）</li><li>将数据发送到“全局（global）”广播地址。这是<code>255.255.255.255</code>，即INADDR_BROADCAST。许多机器会自动将其与您的网络号码「按位与」，以将其转换为网络广播地址，但有些机器却不会。具有讽刺意味的是，路由器不会把这种类型的广播数据包从你的本地网络转发出去。</li></ol><p>所以如果你想要将数据送到广播地址，但是并没有设置 <code>SO_BROADCAST</code> socket 选项时会怎么样呢？好，我们用之前的 <a href="https://www.chanmufeng.com/posts/network-programming/Datagram-Sockets.html" target="_blank" rel="noopener noreferrer">talker 与 listener<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 来炒个冷饭，然后看看会发生什么事情。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ talker <span class="token number">192.168</span>.1.2 foo
sent <span class="token number">3</span> bytes to <span class="token number">192.168</span>.1.2
$ talker <span class="token number">192.168</span>.1.255 foo
sendto: Permission denied
$ talker <span class="token number">255.255</span>.255.255 foo
sendto: Permission denied
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如你所见，数据发送得并不顺利......因为我们没有设置<code>SO_BROADCAST</code>这个socket选项，设置一下，然后你就可以用<code>sendto()</code>将数据发送到任何你想发送的地方去了。</p><p>事实上，这是<code>UDP</code>应用程序可以广播和不能广播的唯一区别。因此，我们改造一下之前的<code>talker</code>程序，添加一个设置<code>SO_BROADCAST</code>套接字选项的部分。代码如下：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** broadcaster.c -- a datagram &quot;client&quot; like talker.c, except
**                  this one can broadcast
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SERVERPORT</span> <span class="token expression"><span class="token number">4950</span>	</span><span class="token comment">// the port users will be connecting to</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> their_addr<span class="token punctuation">;</span> <span class="token comment">// connector&#39;s address information</span>
	<span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token operator">*</span>he<span class="token punctuation">;</span>
	<span class="token keyword">int</span> numbytes<span class="token punctuation">;</span>
	<span class="token keyword">int</span> broadcast <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">//char broadcast = &#39;1&#39;; // if that doesn&#39;t work, try this</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;usage: broadcaster hostname message\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>he<span class="token operator">=</span><span class="token function">gethostbyname</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// get the host info</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;gethostbyname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// this call is what allows broadcast packets to be sent:</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_BROADCAST<span class="token punctuation">,</span> <span class="token operator">&amp;</span>broadcast<span class="token punctuation">,</span>
		<span class="token keyword">sizeof</span> broadcast<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;setsockopt (SO_BROADCAST)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	their_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>	 <span class="token comment">// host byte order</span>
	their_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>SERVERPORT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// short, network byte order</span>
	their_addr<span class="token punctuation">.</span>sin_addr <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token operator">*</span><span class="token punctuation">)</span>he<span class="token operator">-&gt;</span>h_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>their_addr<span class="token punctuation">.</span>sin_zero<span class="token punctuation">,</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> their_addr<span class="token punctuation">.</span>sin_zero<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numbytes<span class="token operator">=</span><span class="token function">sendto</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
			 <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>their_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> their_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;sendto&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sent %d bytes to %s\n&quot;</span><span class="token punctuation">,</span> numbytes<span class="token punctuation">,</span>
		<span class="token function">inet_ntoa</span><span class="token punctuation">(</span>their_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个和一般的UDP Client/Server有什么不同呢？</p><p>除了Client可以发送广播包，没有不同！</p><p>所以你赶紧打开一个命令窗口，运行一下之前的UDP listener程序，另一个窗口中运行 <code>broadcaster</code> 程序，之前失败的操作现在就可以顺利执行了。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ broadcaster <span class="token number">192.168</span>.1.2 foo
sent <span class="token number">3</span> bytes to <span class="token number">192.168</span>.1.2
$ broadcaster <span class="token number">192.168</span>.1.255 foo
sent <span class="token number">3</span> bytes to <span class="token number">192.168</span>.1.255
$ broadcaster <span class="token number">255.255</span>.255.255 foo
sent <span class="token number">3</span> bytes to <span class="token number">255.255</span>.255.255
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-常见问题" tabindex="-1"><a class="header-anchor" href="#_9-常见问题" aria-hidden="true">#</a> 9. 常见问题</h2><p><strong>1. 我从哪获取这些头文件资料？</strong></p><p>如果你的系统中没有自带这些文件，或许你根本就不需要他们。你得看一下你平台的使用手册。</p><p>对了，如果你是为Windows开发程序，你只需要<code>\#include &lt;winsock.h&gt;</code>。</p><p><strong>2. bind()报“Address already in use”异常怎么办？</strong></p><p>你必须对正在监听的socket使用<code>setsockopt()</code>函数，并设置 <code>SO_REUSEADDR</code> 选项。看一下<code>bind()</code>章节和<code>select()</code>章节中的例子，你就明白了。</p><p><strong>3. 我该如何获取到系统中已经打开的socket列表？</strong></p><p>使用<code>netstat</code>命令。使用细节你需要参考man手册，不过你只要输入下列指令就能获取到一些不错的信息：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">netstat</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>4. 我该如何查看路由表（routing table）？</strong></p><p>执行<code>route</code>命令（多数的Linux系统是在<code>/sbin</code>下），或者<code>netstat -r</code>指令。</p><p><strong>5. 如果我只有一台电脑，我该怎么运行Client/Server程序？我需要连接外网吗？</strong></p><p>幸运的事，所有系统都有一个回环（loopback）虚拟网络“设备”，这个设备位于内核中，并假装自己是个网卡（这家伙就是<code>ifconfig</code>中列出的“<code>lo</code>”）。</p><p><img src="http://qiniu.chanmufeng.com/2022-10-24-100623.png" alt="image-20221024180623943" loading="lazy"></p><p>假设你登陆一台名为“goat”的设备，并在一个窗口中运行了Client程序，在另一个窗口中运行了Server端程序。或者你也可以在后台运行Server程序（用<code>server &amp;</code>），在另一个窗口中运行Client程序。</p><p><code>loopback设备</code>的用处就是，你可以使用 <code>client goat</code> 或者 <code>client localhost</code> （因为“<code>localhost</code>”已经在你的<code>/etc/hosts</code>中定义好了），这样你就可以让client在没有网络的情况下也可以与server通信。</p><p>简而言之，不需要改变任何代码，就可以让你的程序在没有网络的单机上运行！</p><p><strong>6. 如果远程断开了连接，我该怎么知道呢？</strong></p><p>你可以分辨，因为<code>recv()</code>会返回<code>0</code>。</p><p><strong>7. 我自己怎么实现“ping”这个小工具？啥是ICMP？我从哪儿能学到更多关于raw scoket和SOCK_RAW的知识？</strong></p><p>你对<code>raw socket</code>的全部疑问都可以在 <a href="https://beej.us/guide/bgnet/html/#books" target="_blank" rel="noopener noreferrer">W. Richard Stevens’ UNIX Network Programming books<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>这本书中找到答案。在Stevens’ UNIX Network Programming源代码的<code>ping</code>子目录中，你可以找到<a href="http://www.unpbook.com/src.html" target="_blank" rel="noopener noreferrer">ping的源码<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><p><strong>8. 我该如何改变或缩短调用connect()的过期时间？</strong></p><p>这个问题 W. Richard Stevens 已经回答了，我们就不狗尾续貂了。你可以参考UNIX Network Programming源代码中的 <a href="http://www.unpbook.com/src.html" target="_blank" rel="noopener noreferrer"><code>lib/connect_nonb.c</code> <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><p>其要点是，使用<code>socket()</code>创建一个socket descriptor，将其设置为<code>non-blocking</code>，调用<code>connect()</code>，如果一切顺利，<code>connect()</code>将立即返回<code>-1</code>，<code>errno</code>将设置为<code>EINPROGRESS</code>。然后，你可以调用<code>select()</code>，并在<code>read</code>和<code>write</code>集合中传递socket descriptor。如果没有超时，则表示<code>connect()</code>调用已完成。此时，你必须使用<code>getsockopt()</code>设置<code>SO_ERROR</code>选项，以获取<code>connect()</code>调用的返回值，如果没有错误，该值应该为<code>0</code>。</p><p>最后，在你开始通过socket传输数据之前，你可能姜再将其设置为<code>blocking</code>。</p><p>这样做有一个好处，就是让你的程序在<code>connecting</code>(连接期间)也可以做别的事情。比如：你可以将<code>timeout</code>设置为500ms，并在每次<code>timeout</code>时更新屏幕上的提示信息，然后再次调用<code>select()</code>。当你调用<code>select()</code>并超时（例如，达到20次）时，你就知道是时候放弃这个连接了。</p><p>强烈建议你看看Stevens的源码，找个好例子研究一下。</p><p><strong>9. 我该怎么写Windows网络程序？</strong></p><p>首先，卸载Windows，然后装一个Linux或者BSD。。。。哈哈哈哈，开个玩笑。</p><p>给你个链接，你看一下<a href="https://beej.us/guide/bgnet/html/#windows" target="_blank" rel="noopener noreferrer">section on building for Windows<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。</p><p><strong>10. 我该如何在Solaris/SunOS上编译程序？我进行编译的时候总报linker error</strong></p><p>链接器错误发生是因为 Sun 系统不会在套接字库中自动编译。参考一下<a href="https://beej.us/guide/bgnet/html/#solaris" target="_blank" rel="noopener noreferrer">这篇文章<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，其中于如何处理这个问题的范例。</p><h2 id="_10-man手册" tabindex="-1"><a class="header-anchor" href="#_10-man手册" aria-hidden="true">#</a> 10. man手册</h2><h3 id="_10-1-accept" tabindex="-1"><a class="header-anchor" href="#_10-1-accept" aria-hidden="true">#</a> 10.1. accept()</h3><p>接受侦听套接字上传入的连接。</p><h4 id="_10-1-1-函数原型" tabindex="-1"><a class="header-anchor" href="#_10-1-1-函数原型" aria-hidden="true">#</a> 10.1.1. 函数原型</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-1-2-说明" tabindex="-1"><a class="header-anchor" href="#_10-1-2-说明" aria-hidden="true">#</a> 10.1.2. 说明</h4><p>一旦你拿到了 SOCK_STREAM 类型的socket， 并将 socket 设定好可以用來监听（ listen()） 进入的连接，然后你就能调用 accept() 获得一个新的 socket descriptor，便于与后续新连接 client 的通信。</p><p>原本被监听的socket仍然会被保留，当有新的连接进来时，通过调用accept()获取这个新连接。主要的参数如下所示：</p><ul><li>s：listen()中的socket descriptor。</li><li>addr：这里写入连接到你这里的client的地址。</li><li>addrlen：这里会填入addr参数中传回的数据的大小。假设你得到了一个structsockaddr_in，你可以安全地忽略它，因为这是你为addr传入的类型。</li></ul><p>accept() 通常会阻塞，而你可以使用 select() 事先取得 listen 中的 socket descriptor 状态，检查 socket 是否已经可读（ready to read）。若已经可读，则表示有新的连接正在等待被 accept()！另一个方式是将 listen 中的 socket 使用 fcntl() 设置 O_NONBLOCK 选项，然后 listen 中的 socket descriptor 就不会造成 block，而是返回 -1，并将 errno 设置为 EWOULDBLOCK。</p><p>如果accept()返回成功，其返回值是由内核生成的一个全新的描述符，代表与所返回客户端的TCP连接。accept()的第一个参数成为监听套接字，称返回值为已连接套接字。区分两个套接字很重要，一个服务器通常在其生命周期内创建一个监听套接字。由 accept() 返回的 socket descriptor 是如假包换的 socket descriptor，开启并和远程主机建立连接，如果你要断开和 client 的连接，必须使用 close()。</p><h4 id="_10-1-3-返回值" tabindex="-1"><a class="header-anchor" href="#_10-1-3-返回值" aria-hidden="true">#</a> 10.1.3. 返回值</h4><p>accept() 返回新连接的 socket descriptor，发生异常时返回 -1，并将 errno 设置为合适的值。</p><h4 id="_10-1-4-例子" tabindex="-1"><a class="header-anchor" href="#_10-1-4-例子" aria-hidden="true">#</a> 10.1.4. 例子</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> their_addr<span class="token punctuation">;</span>
<span class="token class-name">socklen_t</span> addr_size<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> new_fd<span class="token punctuation">;</span>

<span class="token comment">// first, load up address structs with getaddrinfo():</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>  <span class="token comment">// use IPv4 or IPv6, whichever</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span>     <span class="token comment">// fill in my IP for me</span>

<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> MYPORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make a socket, bind it, and listen on it:</span>

sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> BACKLOG<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// now accept an incoming connection:</span>

addr_size <span class="token operator">=</span> <span class="token keyword">sizeof</span> their_addr<span class="token punctuation">;</span>
new_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>their_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ready to communicate on socket descriptor new_fd!</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-1-5-参阅" tabindex="-1"><a class="header-anchor" href="#_10-1-5-参阅" aria-hidden="true">#</a> 10.1.5. 参阅</h4><p><a href="https://beej.us/guide/bgnet/html/#socketman" target="_blank" rel="noopener noreferrer"><code>socket()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#getaddrinfoman" target="_blank" rel="noopener noreferrer"><code>getaddrinfo()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#listenman" target="_blank" rel="noopener noreferrer"><code>listen()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#sockaddr_inman" target="_blank" rel="noopener noreferrer"><code>struct sockaddr_in</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_10-2-bind" tabindex="-1"><a class="header-anchor" href="#_10-2-bind" aria-hidden="true">#</a> 10.2. bind()</h3><p>将socket与IP地址和端口号关联。</p><h4 id="_10-2-1-函数原型" tabindex="-1"><a class="header-anchor" href="#_10-2-1-函数原型" aria-hidden="true">#</a> 10.2.1. 函数原型</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>my_addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-2-2-说明" tabindex="-1"><a class="header-anchor" href="#_10-2-2-说明" aria-hidden="true">#</a> 10.2.2. 说明</h4><p>当远程计算机想要连接到你的服务器程序时，它需要两条信息：<strong>IP地址</strong>和<strong>端口号</strong>。<code>bind()</code>调用就是帮你做这件事情。</p><p>端口号是内核用来确认将收到的数据包交给哪个具体进程的<code>socket descriptor</code>的依据。</p><blockquote><p>通常在写服务端程序的时候我们才需要进行关联，客户端程序不需要我们手动绑定端口，直接<code>connect()</code>就好了。</p></blockquote><p>首先，调用<code>getaddrinfo()</code>加载一个包含目标地址和端口信息的结构<code>sockaddr</code>，然后调用<code>socket()</code>得到<code>socket descriptor</code>，然后将<code>socket</code>和地址传递到<code>bind()</code>中，IP地址和端口就会神奇地被绑定到socket上！</p><p>如果你不知道你的IP地址，或者你知道你的机器上只有一个IP地址，或者你不在乎使用机器的哪一个IP地址的话，你可以简单地将提示参数中的<code>AI_PASSIVE</code>标识传递给<code>getaddrinfo()</code>。这其实是用一个特殊值填充<code>struct sockaddr</code>的IP地址部分，该值告诉<code>bind()</code>它应该自动填充该主机的IP地址。</p><p>什么什么？你想知道在<code>struct sockaddr</code>的IP地址中加载了什么特殊值，使其自动用当前主机的IP填充地址？我会告诉你，但请记住，这只有在你手动填写<code>struct sockaddr</code>的时候才会这样；否则乖乖照我上边说的，使用<code>getaddrinfo()</code>的返回结果。</p><p>在IPv4中，<code>struct sockaddr_in</code> 结构的 <code>sin_addr.s_addr</code> 字段被设置成了<code>INADDR_ANY</code>。在IPv6中，<code>struct sockaddr_in6</code>结构的<code>sin6_addr</code>字段被赋值成全局变量<code>in6addr_any</code>。或者，如果你声明了一个新的 <code>struct in6_addr</code>，你可以将其初始化为<code>IN6ADDR_ANY_INIT</code>。</p><p>最后，<code>addrlen</code>参数应该设置为 <code>sizeof my_addr</code>。</p><h4 id="_10-2-3-返回值" tabindex="-1"><a class="header-anchor" href="#_10-2-3-返回值" aria-hidden="true">#</a> 10.2.3. 返回值</h4><p>成功返回<code>0</code>，发生异常时返回<code> -1</code>，并将 <code>errno</code> 设置为合适的值。</p><h4 id="_10-2-4-例子" tabindex="-1"><a class="header-anchor" href="#_10-2-4-例子" aria-hidden="true">#</a> 10.2.4. 例子</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// modern way of doing things with getaddrinfo()</span>

<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>

<span class="token comment">// first, load up address structs with getaddrinfo():</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>  <span class="token comment">// use IPv4 or IPv6, whichever</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span>     <span class="token comment">// fill in my IP for me</span>

<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;3490&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make a socket:</span>
<span class="token comment">// (you should actually walk the &quot;res&quot; linked list and error-check!)</span>

sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// bind it to the port we passed in to getaddrinfo():</span>

<span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// example of packing a struct by hand, IPv4</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> myaddr<span class="token punctuation">;</span>
<span class="token keyword">int</span> s<span class="token punctuation">;</span>

myaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
myaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">3490</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// you can specify an IP address:</span>
<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">&quot;63.161.169.137&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>myaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// or you can let it automatically select one:</span>
myaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>

s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bind</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>myaddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> myaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-2-5-参阅" tabindex="-1"><a class="header-anchor" href="#_10-2-5-参阅" aria-hidden="true">#</a> 10.2.5. 参阅</h4><p><a href="https://beej.us/guide/bgnet/html/#getaddrinfoman" target="_blank" rel="noopener noreferrer"><code>getaddrinfo()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#socketman" target="_blank" rel="noopener noreferrer"><code>socket()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#sockaddr_inman" target="_blank" rel="noopener noreferrer"><code>struct sockaddr_in</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#sockaddr_inman" target="_blank" rel="noopener noreferrer"><code>struct in_addr</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_10-3-connect" tabindex="-1"><a class="header-anchor" href="#_10-3-connect" aria-hidden="true">#</a> 10.3. connect()</h3><p>将你本地的socket连接到服务器。</p><h4 id="_10-3-1-函数原型" tabindex="-1"><a class="header-anchor" href="#_10-3-1-函数原型" aria-hidden="true">#</a> 10.3.1. 函数原型</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>serv_addr<span class="token punctuation">,</span>
            <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-3-2-说明" tabindex="-1"><a class="header-anchor" href="#_10-3-2-说明" aria-hidden="true">#</a> 10.3.2. 说明</h4><p>当你调用<code>socket()</code>得到一个socket descriptor之后，你可以使用<code>connect()</code>这个系统调用连接这个socket到远程服务器。你需要做的就是把socket descriptor和服务端地址传递给<code>connect()</code>。对了，还有地址的长度，也得通过参数的形式传递。</p><p>一般情况下，你可以通过调用<code>getaddrinfo()</code>来获取这些信息，但是如果你非要手动装填<code>struct sockaddr</code>也不是不行。</p><p>如果你没有对socket descriptor调用<code>bind() </code>方法，它会和你的IP地址以及随机端口号进行绑定。</p><p>如果你不是Server端程序，这种自动机制是挺好的，因为你根本就不在乎你用的是啥端口号，你只需要在乎远程端口号是什么，并把它放在<code>serv_addr</code>参数中就行了。如果你实在想绑定到某个特定IP地址和特定端口号上，你也可以用<code>bind()</code>函数进行设置，但属实没有必要。</p><p>一旦<code>connect()</code>完成，你就可以随心所以地使用 <code>send()</code> 和 <code>recv()</code>处理数据了。</p><p>记住：如果你<code>connect()</code>的是远程的 <code>SOCK_DGRAM</code> UDP socket，只要你想， <code>send()</code> 、 <code>recv()</code>和 <code>sendto()</code> 、 <code>recvfrom()</code>你都可以用。</p><h4 id="_10-3-3-返回值" tabindex="-1"><a class="header-anchor" href="#_10-3-3-返回值" aria-hidden="true">#</a> 10.3.3. 返回值</h4><p>成功返回<code>0</code>，发生异常时返回<code> -1</code>，并将 <code>errno</code> 设置为合适的值。</p><h4 id="_10-3-4-例子" tabindex="-1"><a class="header-anchor" href="#_10-3-4-例子" aria-hidden="true">#</a> 10.3.4. 例子</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// connect to www.example.com port 80 (http)</span>

<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>

<span class="token comment">// first, load up address structs with getaddrinfo():</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>  <span class="token comment">// use IPv4 or IPv6, whichever</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>

<span class="token comment">// we could put &quot;80&quot; instead on &quot;http&quot; on the next line:</span>
<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">&quot;www.example.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make a socket:</span>

sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// connect it to the address and port we passed in to getaddrinfo():</span>

<span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-3-5-参阅" tabindex="-1"><a class="header-anchor" href="#_10-3-5-参阅" aria-hidden="true">#</a> 10.3.5. 参阅</h4><p><a href="https://beej.us/guide/bgnet/html/#socketman" target="_blank" rel="noopener noreferrer"><code>socket()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#bindman" target="_blank" rel="noopener noreferrer"><code>bind()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_10-4-close" tabindex="-1"><a class="header-anchor" href="#_10-4-close" aria-hidden="true">#</a> 10.4. close()</h3><p>关闭socket descriptor。</p><h4 id="_10-4-1-函数原型" tabindex="-1"><a class="header-anchor" href="#_10-4-1-函数原型" aria-hidden="true">#</a> 10.4.1. 函数原型</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
    
<span class="token keyword">int</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-4-2-说明" tabindex="-1"><a class="header-anchor" href="#_10-4-2-说明" aria-hidden="true">#</a> 10.4.2. 说明</h4><p>当你完成了对包含你无数奇思妙想的socket的使用，并且你不想再<code>send()</code>或<code>recv()</code>，又或者任何其他事情，你可以使用<code>close()</code>，socket将被永久释放。</p><p>远程主机可以通过以下两种方式判断你是否进行了<code>close()</code>。</p><ol><li>如果远程主机调用了<code>recv()</code>，返回值会是0；</li><li>如果远程主机调用了<code>send()</code>，它将会收到一个 <code>SIGPIPE</code> 信号，并且<code>send()</code>的返回值为<code>-1</code>，<code>errno</code>值也会被设置为 <code>EPIPE</code>。</li></ol><blockquote><p><strong>Windows使用者须知：</strong></p><p>关闭的方法为<code>closesocket()</code>，而不是<code>close()</code>。如果你试图在socket descriptor上使用<code>close()</code>，Windows可能会跟你闹别扭。。。你会很苦恼。</p></blockquote><h4 id="_10-4-3-返回值" tabindex="-1"><a class="header-anchor" href="#_10-4-3-返回值" aria-hidden="true">#</a> 10.4.3. 返回值</h4><p>成功返回<code>0</code>，发生异常时返回<code> -1</code>，并将 <code>errno</code> 设置为合适的值。</p><h4 id="_10-4-4-例子" tabindex="-1"><a class="header-anchor" href="#_10-4-4-例子" aria-hidden="true">#</a> 10.4.4. 例子</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token comment">// a whole lotta stuff...*BRRRONNNN!*</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token function">close</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// not much to it, really.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-4-5-参阅" tabindex="-1"><a class="header-anchor" href="#_10-4-5-参阅" aria-hidden="true">#</a> 10.4.5. 参阅</h4><p><a href="https://beej.us/guide/bgnet/html/#socketman" target="_blank" rel="noopener noreferrer"><code>socket()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#shutdownman" target="_blank" rel="noopener noreferrer"><code>shutdown()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_10-5-getaddrinfo-freeaddrinfo-gai-strerror" tabindex="-1"><a class="header-anchor" href="#_10-5-getaddrinfo-freeaddrinfo-gai-strerror" aria-hidden="true">#</a> 10.5. getaddrinfo(), freeaddrinfo(), gai_strerror()</h3><p>获取有关host name（主机名）以及service（服务）信息，并将结果保存在<code>struct sockaddr</code>结构中。</p><h4 id="_10-5-1-函数原型" tabindex="-1"><a class="header-anchor" href="#_10-5-1-函数原型" aria-hidden="true">#</a> 10.5.1. 函数原型</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nodename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>servname<span class="token punctuation">,</span>
                <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>hints<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>ai<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">gai_strerror</span><span class="token punctuation">(</span><span class="token keyword">int</span> ecode<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span>     ai_flags<span class="token punctuation">;</span>          <span class="token comment">// AI_PASSIVE, AI_CANONNAME, ...</span>
  <span class="token keyword">int</span>     ai_family<span class="token punctuation">;</span>         <span class="token comment">// AF_xxx</span>
  <span class="token keyword">int</span>     ai_socktype<span class="token punctuation">;</span>       <span class="token comment">// SOCK_xxx</span>
  <span class="token keyword">int</span>     ai_protocol<span class="token punctuation">;</span>       <span class="token comment">// 0 (auto) or IPPROTO_TCP, IPPROTO_UDP </span>

  <span class="token class-name">socklen_t</span>  ai_addrlen<span class="token punctuation">;</span>     <span class="token comment">// length of ai_addr</span>
  <span class="token keyword">char</span>   <span class="token operator">*</span>ai_canonname<span class="token punctuation">;</span>      <span class="token comment">// canonical name for nodename</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span>  <span class="token operator">*</span>ai_addr<span class="token punctuation">;</span> <span class="token comment">// binary address</span>
  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span>  <span class="token operator">*</span>ai_next<span class="token punctuation">;</span> <span class="token comment">// next structure in linked list</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-5-2-说明" tabindex="-1"><a class="header-anchor" href="#_10-5-2-说明" aria-hidden="true">#</a> 10.5.2. 说明</h4><p><code>getaddrinfo()</code>是一个非常有用的函数，它会返回特定主机名的相关信息（例如其IP地址），并把信息保存在一个<code>struct sockaddr</code>结构中，自动为你处理细节（比如地址是IPv4还是IPv6）。</p><p>有了这个函数，原本的 <code>gethostbyname()</code> 和 <code>getservbyname()</code>也就可就可以退出江湖了。</p><p>接下来的描述可能会让你望而生畏，但是别担心，这个函数用起来贼简单。你可以先跳过下面的描述直接看一下例子，增强一下你的信心。</p><p><code>nodename</code>参数中保存的就是host name（主机名）。主机名可以是域名，比如“<a href="http://www.chanmufeng.com" target="_blank" rel="noopener noreferrer">www.chanmufeng.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>”，也可以是IPv4或者IPv6地址（以字符串形式传递）。如果你用了<code>AI_PASSIVE</code>选项，这个参数你也可以设置为<code>NULL</code>（见下文）。</p><p><code>servname</code>通常就是端口号，比如你可以以字符串格式传递“<code>80</code>”；也可以是服务名，比如“<code>http</code>”、“<code>tftp</code>”、或者“<code>smtp</code>”、“<code>pop</code>”等。众所周知的服务名可以在 <a href="https://www.iana.org/assignments/port-numbers" target="_blank" rel="noopener noreferrer">IANA Port List<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><a href="https://beej.us/guide/bgnet/html/#fn48" target="_blank" rel="noopener noreferrer">48<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 中找到，你本地的<code>/etc/services</code>文件中也有这些信息。</p><p>然后就是核心参数——<code>hints</code>。在使用<code>addrinfo</code>之前，你必须先用<code>memset()</code>将整个结构数据清空。接下来我们讲讲<code>addrinfo</code>中的字段。</p><p><code>ai_flags</code>有很多个候选项，但是重要也就几个。（如果要同时使用多个后选项，可以使用<code>｜</code>运算符对他们进行按位或运算）。查看man手册获取完整的标识列表。</p><p><code>AI_CANONNAME</code> 会令<code>res</code>的 <code>ai_canonname</code> 填充为主机的canonical(real) name（规范名，或者成为真名）。</p><p><code>AI_PASSIVE</code> 会令<code>res</code>的IP地址被设置为 <code>INADDR_ANY</code> (IPv4) 或 <code>in6addr_any</code> (IPv6)；这让之后在调用<code>bind()</code>时，可以自动使用当前主机的IP地址来填充<code>struct sockaddr</code>的IP地址。这在你写Server代码且不想写死IP地址时非常好用。</p><p>如果你使用了 <code>AI_PASSIVE</code>标识，你就可以将<code>nodename</code>字段设置为<code>NULL</code>了（因为<code>bind()</code>在之后会自动给你填上）。</p><p>接着聊参数。</p><p>你应该会想将 <code>ai_family</code> 设置为<code>AF_UNSPEC</code>，这样 <code>getaddrinfo() </code>就能同时应付IPv4和IPv6了。当然喽，你也可以用 AF_INET 或 AF_INET6 来自己指定使用IPv4还是IPv6.</p><p>另外，socktype应该被设置为 <code>SOCK_STREAM</code> 或 <code>SOCK_DGRAM</code>，具体取决于你想使用那种socket。</p><p>最后，你可以将 <code>ai_protocol</code> 设置为<code>0</code>，让其自动选择你的protocol type。</p><p>做了这么多，终于可以调用<code>getaddrinfo()</code>了。</p><p>事情变得有趣了。<code>res</code>会指向<code>struct addrinfo</code>的一个链接列表，您可以通过这个链表来获得全部的地址信息（符合你通过<code>hints</code>指定的address类型）。</p><p>但是你可能会获取到一些因为某些原因而无效的address，因此Linux的man手册提供的方法是循环读取链表，然后进行调用<code>socket()</code>、<code>connect()</code>（如果Server端程序使用了<code>AI_PASSIVE</code>，那就是<code>bind()</code>），直到成功为止。</p><p>最后，当你处理完链表之后，你需要调用<code>freeaddrinfo()</code>来释放内存，避免内存出现泄漏。</p><h4 id="_10-5-3-返回值" tabindex="-1"><a class="header-anchor" href="#_10-5-3-返回值" aria-hidden="true">#</a> 10.5.3. 返回值</h4><p>成功返回<code>0</code>，异常返回<code>非0</code>。如果返回的是<code>非0</code>，你可以调用<code>gai_strerror() </code>获取一个文字版本的错误信息。</p><h4 id="_10-5-4-例子" tabindex="-1"><a class="header-anchor" href="#_10-5-4-例子" aria-hidden="true">#</a> 10.5.4. 例子</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// code for a client connecting to a server</span>
<span class="token comment">// namely a stream socket to www.example.com on port 80 (http)</span>
<span class="token comment">// either IPv4 or IPv6</span>

<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>  
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>servinfo<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
<span class="token keyword">int</span> rv<span class="token punctuation">;</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span> <span class="token comment">// use AF_INET6 to force IPv6</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rv <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">&quot;www.example.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// loop through all the results and connect to the first we can</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> servinfo<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span>
            p<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;connect&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// if we get here, we must have connected successfully</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// looped off the end of the list with no connection</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;failed to connect\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// all done with this structure</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// code for a server waiting for connections</span>
<span class="token comment">// namely a stream socket on port 3490, on this host&#39;s IP</span>
<span class="token comment">// either IPv4 or IPv6.</span>

<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>  
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>servinfo<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
<span class="token keyword">int</span> rv<span class="token punctuation">;</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span> <span class="token comment">// use AF_INET6 to force IPv6</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span> <span class="token comment">// use my IP address</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rv <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;3490&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// loop through all the results and bind to the first we can</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> servinfo<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span>
            p<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;bind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// if we get here, we must have connected successfully</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// looped off the end of the list with no successful bind</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;failed to bind socket\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// all done with this structure</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-5-5-参阅" tabindex="-1"><a class="header-anchor" href="#_10-5-5-参阅" aria-hidden="true">#</a> 10.5.5. 参阅</h4><p><a href="https://beej.us/guide/bgnet/html/#gethostbynameman" target="_blank" rel="noopener noreferrer"><code>gethostbyname()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#getnameinfoman" target="_blank" rel="noopener noreferrer"><code>getnameinfo()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_10-6-gethostname" tabindex="-1"><a class="header-anchor" href="#_10-6-gethostname" aria-hidden="true">#</a> 10.6. gethostname()</h3><p>返回系统主机名称</p><h4 id="_10-6-1-函数原型" tabindex="-1"><a class="header-anchor" href="#_10-6-1-函数原型" aria-hidden="true">#</a> 10.6.1. 函数原型</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">gethostname</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-6-2-描述" tabindex="-1"><a class="header-anchor" href="#_10-6-2-描述" aria-hidden="true">#</a> 10.6.2. 描述</h4><p>你的系统有个名字，所有系统都有。这是一个比我们一直在谈论的其他网络内容稍微更Unixy的东西，但它仍然有它的用途。</p><p>例如，你可以获取你的主机名，然后调用gethostbyname()来查找你的IP地址。</p><p>name 参数应该指向一个保存主机名称的缓冲区，而 len 是该缓冲区的大小，以 byte 为单位。gethostname() 不会覆盖缓冲区的结尾（可能会返回错误，或者只是单纯停止写入），而且如果缓冲区有足够的空间，它还会保留字串的 NUL-结尾。</p><h4 id="_10-6-3-返回值" tabindex="-1"><a class="header-anchor" href="#_10-6-3-返回值" aria-hidden="true">#</a> 10.6.3. 返回值</h4><p>成功返回<code>0</code>，发生异常时返回<code> -1</code>，并将 <code>errno</code> 设置为合适的值。</p><h4 id="_10-6-4-例子" tabindex="-1"><a class="header-anchor" href="#_10-6-4-例子" aria-hidden="true">#</a> 10.6.4. 例子</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">char</span> hostname<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token function">gethostname</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;My hostname: %s\n&quot;</span><span class="token punctuation">,</span> hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-6-5-参阅" tabindex="-1"><a class="header-anchor" href="#_10-6-5-参阅" aria-hidden="true">#</a> 10.6.5. 参阅</h4><p><a href="https://beej.us/guide/bgnet/html/#gethostbynameman" target="_blank" rel="noopener noreferrer"><code>gethostbyname()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_10-7-gethostbyname-gethostbyaddr" tabindex="-1"><a class="header-anchor" href="#_10-7-gethostbyname-gethostbyaddr" aria-hidden="true">#</a> 10.7. gethostbyname(), gethostbyaddr()</h3><p>根据主机名获取IP地址，或者相反。</p><h4 id="_10-7-1-函数原型" tabindex="-1"><a class="header-anchor" href="#_10-7-1-函数原型" aria-hidden="true">#</a> 10.7.1. 函数原型</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token operator">*</span><span class="token function">gethostbyname</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// DEPRECATED!</span>
<span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token operator">*</span><span class="token function">gethostbyaddr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-7-2-说明" tabindex="-1"><a class="header-anchor" href="#_10-7-2-说明" aria-hidden="true">#</a> 10.7.2. 说明</h4><blockquote><p>请注意：这两个函数已经由 getaddrinfo() 与 getnameinfo() 取而代之！实际上，gethostbyname() 无法在 IPv6 中正常运行。</p></blockquote><p>这些函数可以转换 host name 与 IP addresse。例如：你可以用 <code>gethostbyname()</code> 取得其 IP address，并储存在 <code>struct in_addr</code>。</p><p>反之，如果你有一个 <code>struct in_addr</code> 或 <code>struct in6_addr</code>，你可以用 <code>gethostbyaddr()</code>得到 hostname。<code>gethostbyaddr() </code>与 IPv6 相容，但是你最好使用新的 <code>getnameinfo()</code> 代替它。</p><p>（如果你有一个点分十进制格式的IP地址，你想要查询它的 hostname，你在使用 <code>getaddrinfo()</code> 时最好要搭配<code> AI_CANONNAME</code> 标识）。</p><p><code>gethostbyname()</code> 接收一个类似 &quot;<a href="http://www.chanmufeng.com" target="_blank" rel="noopener noreferrer">www.chanmufeng.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>&quot; 的字串，然后传回一个 <code>struct hostent</code>，里面包含了超多的数据，包括了 IP address（其它的信息包括官方的 host name、一连串的别名、地址类型、地址长度、以及地址列表。这是个通用的资料结构，在特定的用途上使用起来也很方便）。</p><p>在<code>gethostbyaddr()</code>代入一个 <code>struct in_addr </code>或 <code>struct in6_addr</code>，然后就会返回给你一个相对应的 host name（如果有的话），它的作用和 <code>gethostbyname() </code>正好相反。至于参数，<code>addr </code>是一个 <code>char*</code>，你实际上想要用一个指向<code> struct in_addr</code> 的指针；<code>len </code>应该被设置成 <code>sizeof(struct in_addr)</code>，而 <code>type</code> 应为 <code>AF_INET</code>。</p><p>所以这个 <code>struct hostent</code> 会返回什么呢？它有许多字段，包含 host 的相关数据。</p><table><thead><tr><th>字段</th><th>描述</th></tr></thead><tbody><tr><td>char *h_name</td><td>主机的规范（official、canonical）名字</td></tr><tr><td>char **h_aliases</td><td>可以使用数组访问的别名列表，最后一个元素为NULL</td></tr><tr><td>int h_addrtype</td><td>结果的地址类型，出于我们的目的，它实际上应该是AF_INET。</td></tr><tr><td>int length</td><td>以字节为单位的地址长度，对于IP（版本4）地址为4。</td></tr><tr><td>char **h_addr_list</td><td>此主机的IP地址列表。虽然这是一个char**，但它实际上是一个伪装的structin_addr *s数组。最后一个数组元素为NULL。</td></tr><tr><td>h_addr</td><td>h_addr_list[0]的常用别名。如果你只是想要此主机的任何旧IP地址（是的，它们可以有多个），请使用此字段。</td></tr></tbody></table><h4 id="_10-7-3-返回值" tabindex="-1"><a class="header-anchor" href="#_10-7-3-返回值" aria-hidden="true">#</a> 10.7.3. 返回值</h4><p>成功时返回指向<code>struct hostent</code>结果的指针，错误时返回 <code>NULL</code>。</p><p>和之前介绍过的其他函数不同，当发生错误时，它不设置<code>errno</code>变量，而是将全局整数变量<code>h_errno</code>设置为在头文件<code>&lt;netdb.h&gt;</code>中定义的常值。</p><h4 id="_10-7-4-例子" tabindex="-1"><a class="header-anchor" href="#_10-7-4-例子" aria-hidden="true">#</a> 10.7.4. 例子</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// THIS IS A DEPRECATED METHOD OF GETTING HOST NAMES</span>
<span class="token comment">// use getaddrinfo() instead!</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token operator">*</span>he<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token operator">*</span><span class="token operator">*</span>addr_list<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;usage: ghbn hostname\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>he <span class="token operator">=</span> <span class="token function">gethostbyname</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// get the host info</span>
        <span class="token function">herror</span><span class="token punctuation">(</span><span class="token string">&quot;gethostbyname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// print information about this host:</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Official name is: %s\n&quot;</span><span class="token punctuation">,</span> he<span class="token operator">-&gt;</span>h_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;    IP addresses: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addr_list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>he<span class="token operator">-&gt;</span>h_addr_list<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> addr_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s &quot;</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span><span class="token operator">*</span>addr_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// THIS HAS BEEN SUPERCEDED</span>
<span class="token comment">// use getnameinfo() instead!</span>

<span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token operator">*</span>he<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">in_addr</span> ipv4addr<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> ipv6addr<span class="token punctuation">;</span>

<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">&quot;192.0.2.34&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ipv4addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
he <span class="token operator">=</span> <span class="token function">gethostbyaddr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ipv4addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> ipv4addr<span class="token punctuation">,</span> AF_INET<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Host name: %s\n&quot;</span><span class="token punctuation">,</span> he<span class="token operator">-&gt;</span>h_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> <span class="token string">&quot;2001:db8:63b3:1::beef&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ipv6addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
he <span class="token operator">=</span> <span class="token function">gethostbyaddr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ipv6addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> ipv6addr<span class="token punctuation">,</span> AF_INET6<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Host name: %s\n&quot;</span><span class="token punctuation">,</span> he<span class="token operator">-&gt;</span>h_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-7-5-参见" tabindex="-1"><a class="header-anchor" href="#_10-7-5-参见" aria-hidden="true">#</a> 10.7.5. 参见</h4><p><a href="https://beej.us/guide/bgnet/html/#getaddrinfoman" target="_blank" rel="noopener noreferrer"><code>getaddrinfo()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#getnameinfoman" target="_blank" rel="noopener noreferrer"><code>getnameinfo()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#gethostnameman" target="_blank" rel="noopener noreferrer"><code>gethostname()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#errnoman" target="_blank" rel="noopener noreferrer"><code>errno</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#perrorman" target="_blank" rel="noopener noreferrer"><code>perror()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#perrorman" target="_blank" rel="noopener noreferrer"><code>strerror()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#sockaddr_inman" target="_blank" rel="noopener noreferrer"><code>struct in_addr</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_10-8-getnameinfo" tabindex="-1"><a class="header-anchor" href="#_10-8-getnameinfo" aria-hidden="true">#</a> 10.8. getnameinfo()</h3><p>由 struct sockaddr 提供的信息查询主机名称（host name）以及服务名（service name）。</p><h4 id="_10-8-1-函数原型" tabindex="-1"><a class="header-anchor" href="#_10-8-1-函数原型" aria-hidden="true">#</a> 10.8.1. 函数原型</h4><h3 id="_10-9-shutdown" tabindex="-1"><a class="header-anchor" href="#_10-9-shutdown" aria-hidden="true">#</a> 10.9. shutdown()</h3><p>停止对socket继续传送与接受。</p><h4 id="_10-9-1-函数原型" tabindex="-1"><a class="header-anchor" href="#_10-9-1-函数原型" aria-hidden="true">#</a> 10.9.1. 函数原型</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
    
<span class="token keyword">int</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> how<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-9-2-说明" tabindex="-1"><a class="header-anchor" href="#_10-9-2-说明" aria-hidden="true">#</a> 10.9.2. 说明</h4><p>如果我不需要再对 socket 进行<code>send()</code>了，但是我仍然想要<code>recv() </code>socket 的数据，反之亦然，那我该怎么做呢？</p><p>当你使用 <code>close()</code> 关闭 socket descriptor 时，它会将 socket 的传送与接收两端都关闭，并且释放 socket descriptor。若你只想要关闭其中一端，你就可以使用 <code>shutdown() </code>这个函数。</p><p>在这些参数中，<code>s </code>显然是你想要进行动作的 socket，而要进行什么样的动作，则要由 <code>how</code> 参数指定。可以使用 <code>SHUT_RD</code> 来关闭接收，<code>SHUT_WR</code> 以关闭传送，或者 <code>SHUT_RDWR</code> 将收送功能都关闭。</p><ul><li><p>SHUT_RD</p><p>关闭连接的读功能，socket中不再有数据可以被接受，而且socket接收缓冲区中的先有数据都被丢弃。进程不能再对这样的socket调用任何读函数。</p></li><li><p>SHUT_WR</p><p>关闭连接的写功能。当前留在socket发送缓冲区中的数据将被发送掉，后面跟着TCP的正常连接终止序列。进程不能再对这样的socket调用任何写函数。</p></li><li><p>SHUT_RDWR</p><p>连接的读功能和写功能都被关闭，这等于调用<code>shutdown</code>两次：第一次调用指定<code>SHUT_RD</code>，第二次调用指定<code>SHUT_WR</code>。</p></li></ul><p><code>shutdown() </code>用来关闭连接，而不是socket，不管调用多少次<code>shutdown()</code>，socket依然存在，因为 <code>shutdown() </code>并没有释放 socket descriptor，所以即使 socket 已经整个 shutdown 了，最终仍然得透过 <code>close() </code>关闭 socket。</p><p>默认情况下，<code>close()</code>会立即向网络中发送<code>FIN</code>包，不管输出缓冲区中是否还有数据，而<code>shutdown() </code>会等输出缓冲区中的数据传输完毕再发送<code>FIN</code>包。也就意味着，调用<code> close()</code>将丢失输出缓冲区中的数据，而调用 <code>shutdown() </code>不会。</p><p>这个函数用的并不常用。</p><h4 id="_10-9-3-返回值" tabindex="-1"><a class="header-anchor" href="#_10-9-3-返回值" aria-hidden="true">#</a> 10.9.3. 返回值</h4><p>成功返回<code>0</code>，发生异常时返回<code> -1</code>，并将 <code>errno</code> 设置为合适的值。</p><h4 id="_10-9-4-例子" tabindex="-1"><a class="header-anchor" href="#_10-9-4-例子" aria-hidden="true">#</a> 10.9.4. 例子</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...do some send()s and stuff in here...</span>

<span class="token comment">// and now that we&#39;re done, don&#39;t allow any more sends()s:</span>
<span class="token function">shutdown</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> SHUT_WR<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-9-5-参阅" tabindex="-1"><a class="header-anchor" href="#_10-9-5-参阅" aria-hidden="true">#</a> 10.9.5. 参阅</h4><p><a href="https://beej.us/guide/bgnet/html/#closeman" target="_blank" rel="noopener noreferrer"><code>close()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="_11-更多资料" tabindex="-1"><a class="header-anchor" href="#_11-更多资料" aria-hidden="true">#</a> 11. 更多资料</h2><h2 id="_12-后记" tabindex="-1"><a class="header-anchor" href="#_12-后记" aria-hidden="true">#</a> 12. 后记</h2></div><!----><footer class="page-meta"><!----><div class="meta-item update-time"><span class="label">上次编辑于: </span><span class="info">2022/11/2 01:18:52</span></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: zhaoxaolong@163.com">chanmufeng</span><!--]--><!--]--></div></footer><!----><div class="giscus-wrapper input-top" style="display:block;"><div style="text-align:center">Loading...</div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"><a href='https://beian.miit.gov.cn/'>鲁ICP备20023913号</a></div><div class="copyright">Copyright © 2023 蝉沐风</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.ec803d45.js" defer></script>
  </body>
</html>
