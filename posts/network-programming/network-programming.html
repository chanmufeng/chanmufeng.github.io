<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.49" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://www.chanmufeng.com/posts/network-programming/network-programming.html"><meta property="og:site_name" content="è‰æ²é£"><meta property="og:title" content="ç®€æ˜socketç¼–ç¨‹"><meta property="og:description" content="è¿™æ˜¯ä¸€æœ¬socketç¼–ç¨‹çš„å…¥é—¨å°å†Œã€‚å­¦ä¹ ç¼–ç¨‹ï¼Œä½ è‚¯å®šå¬è¿‡"socket"ï¼Œæˆ–è®¸ä½ ä¹Ÿæƒ³ææ˜ç™½è¿™åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œé‚£å°±ç‚¹è¿›æ¥çœ‹çœ‹å§ã€‚"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-11-02T01:18:52.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:tag" content="socketç¼–ç¨‹"><meta property="article:published_time" content="2022-10-05T00:00:00.000Z"><meta property="article:modified_time" content="2022-11-02T01:18:52.000Z"><script>
                var _hmt = _hmt || [];
                (function() {
                  var hm = document.createElement("script");
                  hm.src = "https://hm.baidu.com/hm.js?dfa689801ccd10bd283b50ea146430f3";
                  var s = document.getElementsByTagName("script")[0]; 
                  s.parentNode.insertBefore(hm, s);
                })();
            </script><title>ç®€æ˜socketç¼–ç¨‹ | è‰æ²é£</title><meta name="description" content="è¿™æ˜¯ä¸€æœ¬socketç¼–ç¨‹çš„å…¥é—¨å°å†Œã€‚å­¦ä¹ ç¼–ç¨‹ï¼Œä½ è‚¯å®šå¬è¿‡"socket"ï¼Œæˆ–è®¸ä½ ä¹Ÿæƒ³ææ˜ç™½è¿™åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œé‚£å°±ç‚¹è¿›æ¥çœ‹çœ‹å§ã€‚">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.ef97199c.css">
    <link rel="modulepreload" href="/assets/app.ec803d45.js"><link rel="modulepreload" href="/assets/network-programming.html.ad789019.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/assets/network-programming.html.287d3b4f.js"><link rel="prefetch" href="/assets/index.html.f40aab20.js"><link rel="prefetch" href="/assets/home.html.4311fb4f.js"><link rel="prefetch" href="/assets/update.html.72163859.js"><link rel="prefetch" href="/assets/index.html.bc679553.js"><link rel="prefetch" href="/assets/index.html.42b16337.js"><link rel="prefetch" href="/assets/disable.html.a298796c.js"><link rel="prefetch" href="/assets/encrypt.html.04234872.js"><link rel="prefetch" href="/assets/markdown.html.c40cf8e1.js"><link rel="prefetch" href="/assets/JVMåˆ°åº•è¯¥å­¦ä¹ äº›ä»€ä¹ˆ.html.37a1cd31.js"><link rel="prefetch" href="/assets/index.html.bdb8aaf2.js"><link rel="prefetch" href="/assets/æˆ‘æ˜¯ä¸€ä¸ªåƒåœ¾.html.396cd500.js"><link rel="prefetch" href="/assets/CPUæµæ°´çº¿ä¸æŒ‡ä»¤é‡æ’åº.html.da7853a1.js"><link rel="prefetch" href="/assets/index.html.9cfc822d.js"><link rel="prefetch" href="/assets/ç”¨ã€Œé—ªç”µä¾ ã€è§£é‡Šä¸€ä¸‹è¿›ç¨‹å’Œçº¿ç¨‹.html.9c93b056.js"><link rel="prefetch" href="/assets/ç¼“å­˜ä¸€è‡´æ€§ä¸å†…å­˜å±éšœ.html.51552874.js"><link rel="prefetch" href="/assets/index.html.67e2e3d9.js"><link rel="prefetch" href="/assets/index.html.0a6236b7.js"><link rel="prefetch" href="/assets/ä»€ä¹ˆæ˜¯æ–‡ä»¶æè¿°ç¬¦.html.804cd066.js"><link rel="prefetch" href="/assets/index.html.1f5ae493.js"><link rel="prefetch" href="/assets/åŠ¨æ€ä»£ç†æ¨¡å¼.html.90a17679.js"><link rel="prefetch" href="/assets/å•ä¾‹æ¨¡å¼.html.c3742e12.js"><link rel="prefetch" href="/assets/å·¥å‚æ¨¡å¼.html.f8c7f9d6.js"><link rel="prefetch" href="/assets/é™æ€ä»£ç†æ¨¡å¼.html.7bbcf6f5.js"><link rel="prefetch" href="/assets/ä¾èµ–å€’ç½®åŸåˆ™.html.56bde280.js"><link rel="prefetch" href="/assets/å¼€é—­åŸåˆ™.html.d45ce1b8.js"><link rel="prefetch" href="/assets/Googleæœç´¢ä¸ºä»€ä¹ˆä¸èƒ½æ— é™åˆ†é¡µï¼Ÿ.html.5b88d232.js"><link rel="prefetch" href="/assets/index.html.abd3d401.js"><link rel="prefetch" href="/assets/m1èŠ¯ç‰‡ç”µè„‘å®‰è£…cerebro.html.0120f768.js"><link rel="prefetch" href="/assets/MySQLä¸Redisçš„æ•°æ®ä¸€è‡´æ€§.html.5ba6736f.js"><link rel="prefetch" href="/assets/MySQLä¼˜åŒ–çš„5ä¸ªç»´åº¦.html.4362df81.js"><link rel="prefetch" href="/assets/MySQLç´¢å¼•çš„æ­£ç¡®ä½¿ç”¨å§¿åŠ¿.html.d51dd9cb.js"><link rel="prefetch" href="/assets/MySQLé”å¼€ç¯‡.html.36ef8a4c.js"><link rel="prefetch" href="/assets/index.html.c8eb6a41.js"><link rel="prefetch" href="/assets/ä¸€æ¡SELECTè¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„.html.2ace0b89.js"><link rel="prefetch" href="/assets/ä¸€æ¡Updateè¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„.html.8736dea8.js"><link rel="prefetch" href="/assets/ä¸ºä»€ä¹ˆMySQLçš„ä¸»é”®æŸ¥è¯¢è¿™ä¹ˆå¿«.html.69305ec3.js"><link rel="prefetch" href="/assets/ä¸ºä»€ä¹ˆä¸å»ºè®®ä½ ä½¿ç”¨SELECT_.html.ee5e1bb5.js"><link rel="prefetch" href="/assets/äº‹åŠ¡çš„éš”ç¦»æ€§ä¸MVCC.html.a4ad4ac5.js"><link rel="prefetch" href="/assets/ä»æ ¹å„¿ä¸Šç†è§£ç´¢å¼•.html.c7e89f33.js"><link rel="prefetch" href="/assets/BIOä¸éé˜»å¡IO.html.56cc747b.js"><link rel="prefetch" href="/assets/index.html.9d93e6d0.js"><link rel="prefetch" href="/assets/RedisæŒä¹…åŒ–â€”â€”AOF.html.3ef66ec5.js"><link rel="prefetch" href="/assets/RedisæŒä¹…åŒ–â€”â€”RDB.html.956f2216.js"><link rel="prefetch" href="/assets/é¸¡è‚‹çš„Redisäº‹åŠ¡.html.bf1172f2.js"><link rel="prefetch" href="/assets/index.html.ccdcd4de.js"><link rel="prefetch" href="/assets/ä»0åˆ°1ç¼–å†™ä¸€æ¬¾æ’ä»¶.html.5f51ccf3.js"><link rel="prefetch" href="/assets/index.html.530ae07a.js"><link rel="prefetch" href="/assets/å¦‚ä½•åŒæ­¥é…ç½®.html.21989554.js"><link rel="prefetch" href="/assets/404.html.4285bac5.js"><link rel="prefetch" href="/assets/index.html.6717b2b6.js"><link rel="prefetch" href="/assets/index.html.5eae9e3f.js"><link rel="prefetch" href="/assets/index.html.85231e1c.js"><link rel="prefetch" href="/assets/index.html.07ef0efd.js"><link rel="prefetch" href="/assets/index.html.e5d6f701.js"><link rel="prefetch" href="/assets/index.html.accaa64c.js"><link rel="prefetch" href="/assets/index.html.9a9f30d6.js"><link rel="prefetch" href="/assets/index.html.68e6d714.js"><link rel="prefetch" href="/assets/index.html.b032f382.js"><link rel="prefetch" href="/assets/index.html.bc540566.js"><link rel="prefetch" href="/assets/index.html.4fa328ce.js"><link rel="prefetch" href="/assets/index.html.2c9f8626.js"><link rel="prefetch" href="/assets/index.html.6c184523.js"><link rel="prefetch" href="/assets/index.html.2309c271.js"><link rel="prefetch" href="/assets/index.html.94d1334e.js"><link rel="prefetch" href="/assets/index.html.3e9b5a53.js"><link rel="prefetch" href="/assets/index.html.da976a01.js"><link rel="prefetch" href="/assets/index.html.843e0dc5.js"><link rel="prefetch" href="/assets/index.html.e6adfc22.js"><link rel="prefetch" href="/assets/index.html.a46272a6.js"><link rel="prefetch" href="/assets/index.html.e68eec84.js"><link rel="prefetch" href="/assets/index.html.c3c92e66.js"><link rel="prefetch" href="/assets/index.html.a1ffa21c.js"><link rel="prefetch" href="/assets/index.html.5c810edd.js"><link rel="prefetch" href="/assets/index.html.7b661157.js"><link rel="prefetch" href="/assets/index.html.a61ab275.js"><link rel="prefetch" href="/assets/index.html.cd04393b.js"><link rel="prefetch" href="/assets/index.html.6ea94130.js"><link rel="prefetch" href="/assets/index.html.938c47df.js"><link rel="prefetch" href="/assets/index.html.b6e53603.js"><link rel="prefetch" href="/assets/index.html.abfe5d6e.js"><link rel="prefetch" href="/assets/index.html.799762a8.js"><link rel="prefetch" href="/assets/index.html.6a1f2c2a.js"><link rel="prefetch" href="/assets/index.html.91d708f1.js"><link rel="prefetch" href="/assets/index.html.2b208795.js"><link rel="prefetch" href="/assets/index.html.970ad9a6.js"><link rel="prefetch" href="/assets/index.html.18750c91.js"><link rel="prefetch" href="/assets/index.html.5832ab43.js"><link rel="prefetch" href="/assets/index.html.46963a2e.js"><link rel="prefetch" href="/assets/index.html.d8d0f261.js"><link rel="prefetch" href="/assets/index.html.656424fd.js"><link rel="prefetch" href="/assets/index.html.740f6c3e.js"><link rel="prefetch" href="/assets/index.html.75361b30.js"><link rel="prefetch" href="/assets/index.html.77d7aba9.js"><link rel="prefetch" href="/assets/index.html.c6475c4b.js"><link rel="prefetch" href="/assets/index.html.4f4df111.js"><link rel="prefetch" href="/assets/index.html.2ef7b821.js"><link rel="prefetch" href="/assets/index.html.0dc0a64e.js"><link rel="prefetch" href="/assets/index.html.8bde1faf.js"><link rel="prefetch" href="/assets/index.html.a8e5dab4.js"><link rel="prefetch" href="/assets/index.html.8dbe4bd2.js"><link rel="prefetch" href="/assets/index.html.72d090a7.js"><link rel="prefetch" href="/assets/index.html.f0f01938.js"><link rel="prefetch" href="/assets/index.html.899ba14c.js"><link rel="prefetch" href="/assets/index.html.1aac5a85.js"><link rel="prefetch" href="/assets/index.html.00e1e5ed.js"><link rel="prefetch" href="/assets/index.html.79aed47e.js"><link rel="prefetch" href="/assets/index.html.d40b22a3.js"><link rel="prefetch" href="/assets/index.html.50661535.js"><link rel="prefetch" href="/assets/index.html.47d81d31.js"><link rel="prefetch" href="/assets/index.html.3bf9cde9.js"><link rel="prefetch" href="/assets/index.html.e74f3868.js"><link rel="prefetch" href="/assets/home.html.0a39e1ac.js"><link rel="prefetch" href="/assets/update.html.d41a36d3.js"><link rel="prefetch" href="/assets/index.html.8ce6c1a4.js"><link rel="prefetch" href="/assets/index.html.d892d4ca.js"><link rel="prefetch" href="/assets/disable.html.feca1227.js"><link rel="prefetch" href="/assets/encrypt.html.6dd1693a.js"><link rel="prefetch" href="/assets/markdown.html.90c57cc5.js"><link rel="prefetch" href="/assets/JVMåˆ°åº•è¯¥å­¦ä¹ äº›ä»€ä¹ˆ.html.748dcca7.js"><link rel="prefetch" href="/assets/index.html.0f2c8809.js"><link rel="prefetch" href="/assets/æˆ‘æ˜¯ä¸€ä¸ªåƒåœ¾.html.c2dedb53.js"><link rel="prefetch" href="/assets/CPUæµæ°´çº¿ä¸æŒ‡ä»¤é‡æ’åº.html.d6501987.js"><link rel="prefetch" href="/assets/index.html.cc293dbb.js"><link rel="prefetch" href="/assets/ç”¨ã€Œé—ªç”µä¾ ã€è§£é‡Šä¸€ä¸‹è¿›ç¨‹å’Œçº¿ç¨‹.html.ff47218f.js"><link rel="prefetch" href="/assets/ç¼“å­˜ä¸€è‡´æ€§ä¸å†…å­˜å±éšœ.html.7cb837f2.js"><link rel="prefetch" href="/assets/index.html.b6c692db.js"><link rel="prefetch" href="/assets/index.html.36d79926.js"><link rel="prefetch" href="/assets/ä»€ä¹ˆæ˜¯æ–‡ä»¶æè¿°ç¬¦.html.03a9134e.js"><link rel="prefetch" href="/assets/index.html.403eaf64.js"><link rel="prefetch" href="/assets/åŠ¨æ€ä»£ç†æ¨¡å¼.html.3382a4fc.js"><link rel="prefetch" href="/assets/å•ä¾‹æ¨¡å¼.html.e398af04.js"><link rel="prefetch" href="/assets/å·¥å‚æ¨¡å¼.html.1c29f15f.js"><link rel="prefetch" href="/assets/é™æ€ä»£ç†æ¨¡å¼.html.e9a9e65e.js"><link rel="prefetch" href="/assets/ä¾èµ–å€’ç½®åŸåˆ™.html.cfed4972.js"><link rel="prefetch" href="/assets/å¼€é—­åŸåˆ™.html.07c917ad.js"><link rel="prefetch" href="/assets/Googleæœç´¢ä¸ºä»€ä¹ˆä¸èƒ½æ— é™åˆ†é¡µï¼Ÿ.html.5218b4cb.js"><link rel="prefetch" href="/assets/index.html.3bef9268.js"><link rel="prefetch" href="/assets/m1èŠ¯ç‰‡ç”µè„‘å®‰è£…cerebro.html.c79f4590.js"><link rel="prefetch" href="/assets/MySQLä¸Redisçš„æ•°æ®ä¸€è‡´æ€§.html.650683c4.js"><link rel="prefetch" href="/assets/MySQLä¼˜åŒ–çš„5ä¸ªç»´åº¦.html.dd276592.js"><link rel="prefetch" href="/assets/MySQLç´¢å¼•çš„æ­£ç¡®ä½¿ç”¨å§¿åŠ¿.html.e43a936b.js"><link rel="prefetch" href="/assets/MySQLé”å¼€ç¯‡.html.4312417c.js"><link rel="prefetch" href="/assets/index.html.52fbf30e.js"><link rel="prefetch" href="/assets/ä¸€æ¡SELECTè¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„.html.e56c6d3a.js"><link rel="prefetch" href="/assets/ä¸€æ¡Updateè¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„.html.2b765326.js"><link rel="prefetch" href="/assets/ä¸ºä»€ä¹ˆMySQLçš„ä¸»é”®æŸ¥è¯¢è¿™ä¹ˆå¿«.html.03d68e34.js"><link rel="prefetch" href="/assets/ä¸ºä»€ä¹ˆä¸å»ºè®®ä½ ä½¿ç”¨SELECT_.html.ebd9fc69.js"><link rel="prefetch" href="/assets/äº‹åŠ¡çš„éš”ç¦»æ€§ä¸MVCC.html.68831001.js"><link rel="prefetch" href="/assets/ä»æ ¹å„¿ä¸Šç†è§£ç´¢å¼•.html.4762ba49.js"><link rel="prefetch" href="/assets/BIOä¸éé˜»å¡IO.html.823dc552.js"><link rel="prefetch" href="/assets/index.html.8baf2f95.js"><link rel="prefetch" href="/assets/RedisæŒä¹…åŒ–â€”â€”AOF.html.8c06f00f.js"><link rel="prefetch" href="/assets/RedisæŒä¹…åŒ–â€”â€”RDB.html.cd286dc6.js"><link rel="prefetch" href="/assets/é¸¡è‚‹çš„Redisäº‹åŠ¡.html.a67a50d1.js"><link rel="prefetch" href="/assets/index.html.12b16d58.js"><link rel="prefetch" href="/assets/ä»0åˆ°1ç¼–å†™ä¸€æ¬¾æ’ä»¶.html.eb3c5add.js"><link rel="prefetch" href="/assets/index.html.6b7245a5.js"><link rel="prefetch" href="/assets/å¦‚ä½•åŒæ­¥é…ç½®.html.4cf3e6c5.js"><link rel="prefetch" href="/assets/404.html.4e4be11b.js"><link rel="prefetch" href="/assets/index.html.45b7f9f7.js"><link rel="prefetch" href="/assets/index.html.d093923a.js"><link rel="prefetch" href="/assets/index.html.8b820911.js"><link rel="prefetch" href="/assets/index.html.e7ad23bc.js"><link rel="prefetch" href="/assets/index.html.fe1df11a.js"><link rel="prefetch" href="/assets/index.html.7352c99f.js"><link rel="prefetch" href="/assets/index.html.c435077f.js"><link rel="prefetch" href="/assets/index.html.104d0f5c.js"><link rel="prefetch" href="/assets/index.html.f5585f62.js"><link rel="prefetch" href="/assets/index.html.ebbb496f.js"><link rel="prefetch" href="/assets/index.html.9050dd8e.js"><link rel="prefetch" href="/assets/index.html.66f49414.js"><link rel="prefetch" href="/assets/index.html.e930f19a.js"><link rel="prefetch" href="/assets/index.html.42c7bbbe.js"><link rel="prefetch" href="/assets/index.html.7285c2eb.js"><link rel="prefetch" href="/assets/index.html.bbaf227e.js"><link rel="prefetch" href="/assets/index.html.e3fde442.js"><link rel="prefetch" href="/assets/index.html.7c50d84e.js"><link rel="prefetch" href="/assets/index.html.b3cbffcd.js"><link rel="prefetch" href="/assets/index.html.62ee9702.js"><link rel="prefetch" href="/assets/index.html.2debbaa4.js"><link rel="prefetch" href="/assets/index.html.9dc8f507.js"><link rel="prefetch" href="/assets/index.html.09e7e8c2.js"><link rel="prefetch" href="/assets/index.html.5f069056.js"><link rel="prefetch" href="/assets/index.html.a7f1ae4f.js"><link rel="prefetch" href="/assets/index.html.30f1d7b9.js"><link rel="prefetch" href="/assets/index.html.1de98967.js"><link rel="prefetch" href="/assets/index.html.548d90ad.js"><link rel="prefetch" href="/assets/index.html.651110c2.js"><link rel="prefetch" href="/assets/index.html.45b71406.js"><link rel="prefetch" href="/assets/index.html.4f90b041.js"><link rel="prefetch" href="/assets/index.html.30234545.js"><link rel="prefetch" href="/assets/index.html.d2d34d0a.js"><link rel="prefetch" href="/assets/index.html.a9d78eed.js"><link rel="prefetch" href="/assets/index.html.0b7066f1.js"><link rel="prefetch" href="/assets/index.html.fa43fb4d.js"><link rel="prefetch" href="/assets/index.html.ddc062c2.js"><link rel="prefetch" href="/assets/index.html.8ba1f500.js"><link rel="prefetch" href="/assets/index.html.984619d2.js"><link rel="prefetch" href="/assets/index.html.23417bb8.js"><link rel="prefetch" href="/assets/index.html.2288b8be.js"><link rel="prefetch" href="/assets/index.html.4f7f5c89.js"><link rel="prefetch" href="/assets/index.html.588b3b32.js"><link rel="prefetch" href="/assets/index.html.13296de3.js"><link rel="prefetch" href="/assets/index.html.57925638.js"><link rel="prefetch" href="/assets/index.html.ba85260b.js"><link rel="prefetch" href="/assets/index.html.64083fff.js"><link rel="prefetch" href="/assets/index.html.004e7946.js"><link rel="prefetch" href="/assets/index.html.1e6478b4.js"><link rel="prefetch" href="/assets/index.html.c83a65ff.js"><link rel="prefetch" href="/assets/index.html.716585f3.js"><link rel="prefetch" href="/assets/index.html.4198b78d.js"><link rel="prefetch" href="/assets/index.html.76594791.js"><link rel="prefetch" href="/assets/index.html.902bd2bd.js"><link rel="prefetch" href="/assets/index.html.7f3fb562.js"><link rel="prefetch" href="/assets/index.html.c684ef10.js"><link rel="prefetch" href="/assets/index.html.75c631cf.js"><link rel="prefetch" href="/assets/index.html.def6ee32.js"><link rel="prefetch" href="/assets/index.html.3a471deb.js"><link rel="prefetch" href="/assets/index.html.9785d007.js"><link rel="prefetch" href="/assets/index.html.b25dc0cb.js"><link rel="prefetch" href="/assets/404.cb0b2bad.js"><link rel="prefetch" href="/assets/Layout.74ccbd97.js"><link rel="prefetch" href="/assets/Slide.d30de832.js"><link rel="prefetch" href="/assets/Blog.ae7c67e2.js"><link rel="prefetch" href="/assets/giscus.8fe73ced.js"><link rel="prefetch" href="/assets/auto.esm.2565cd3a.js"><link rel="prefetch" href="/assets/index.d8a59108.js"><link rel="prefetch" href="/assets/index.1842ee54.js"><link rel="prefetch" href="/assets/mermaid.esm.min.ee1e0284.js"><link rel="prefetch" href="/assets/highlight.esm.d982e650.js"><link rel="prefetch" href="/assets/markdown.esm.832a189d.js"><link rel="prefetch" href="/assets/math.esm.a3f84b6f.js"><link rel="prefetch" href="/assets/notes.esm.3c361cb7.js"><link rel="prefetch" href="/assets/reveal.esm.b96f05d8.js"><link rel="prefetch" href="/assets/search.esm.80da4a02.js"><link rel="prefetch" href="/assets/zoom.esm.8514a202.js"><link rel="prefetch" href="/assets/photoswipe.esm.218074cd.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/" class="brand"><img class="logo" src="https://img-blog.csdnimg.cn/d16e11af2edb4972833f88083d2f0375.png" alt="è‰æ²é£"><!----><span class="site-name hide-in-pad">è‰æ²é£</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="ä¸»é¡µ"><span class="icon iconfont icon-home"></span>ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="æŠ€æœ¯åšæ–‡"><span class="title"><span class="icon iconfont icon-xieboke"></span>æŠ€æœ¯åšæ–‡</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>å†…åŠŸå¿ƒæ³•</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/basic/design-pattern/" class="nav-link" aria-label="è®¾è®¡æ¨¡å¼"><span class="icon iconfont icon-design"></span>è®¾è®¡æ¨¡å¼<!----></a></li><li class="dropdown-subitem"><a href="/posts/basic/design-principle/%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99.html" class="nav-link" aria-label="è®¾è®¡åŸåˆ™"><span class="icon iconfont icon-design"></span>è®¾è®¡åŸåˆ™<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>å­˜å‚¨ç¯‡</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/storage/MySQL" class="nav-link" aria-label="MySQL"><span class="icon iconfont icon-mysql"></span>MySQL<!----></a></li><li class="dropdown-subitem"><a href="/posts/storage/Redis" class="nav-link" aria-label="Redis"><span class="icon iconfont icon-redis"></span>Redis<!----></a></li><li class="dropdown-subitem"><a href="/posts/storage/ElasticSearch" class="nav-link" aria-label="ElasticSearch"><span class="icon iconfont icon-elasticsearch-Elasticsearch"></span>ElasticSearch<!----></a></li></ul></li><li class="dropdown-item"><a href="/posts/concurrency" class="nav-link" aria-label="å¹¶å‘ç¯‡"><span class="icon iconfont icon-CPU"></span>å¹¶å‘ç¯‡<!----></a></li><li class="dropdown-item"><a href="/posts/JVM" class="nav-link" aria-label="JVM"><span class="icon iconfont icon-PCxuniji"></span>JVM<!----></a></li><li class="dropdown-item"><a href="/posts/os" class="nav-link" aria-label="Linux"><span class="icon iconfont icon-linux"></span>Linux<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="å¼€å‘å·¥å…·"><span class="title"><span class="icon iconfont icon-keyboard"></span>å¼€å‘å·¥å…·</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/posts/tools/IDEA" class="nav-link" aria-label="IDEA"><span class="icon iconfont icon-jetbrains"></span>IDEA<!----></a></li><li class="dropdown-item"><a href="/posts/tools/VSCode" class="nav-link" aria-label="VSCode"><span class="icon iconfont icon-VsCode"></span>VSCode<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="/posts/network-programming" class="nav-link active" aria-label="socketç¼–ç¨‹"><span class="icon iconfont icon-wangluojiekou"></span>socketç¼–ç¨‹<!----></a></div><div class="nav-item hide-in-mobile"><a href="/update.html" class="nav-link" aria-label="æœ€è¿‘æ›´æ–°"><span class="icon iconfont icon-Update"></span>æœ€è¿‘æ›´æ–°<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://space.bilibili.com/519360358" rel="noopener noreferrer" target="_blank" aria-label class="nav-link"><span class="icon iconfont icon-bilibili"></span><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!----></div><div class="navbar-right"><!----><!----><div class="nav-item"><a class="repo-link" href="https://github.com/chanmufeng/chanmufeng.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><div id="docsearch-container"></div><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->ç®€æ˜socketç¼–ç¨‹</h1><div class="page-info"><span class="author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down" localizeddate="2022å¹´10æœˆ5æ—¥" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://www.chanmufeng.com" target="_blank" rel="noopener noreferrer">è‰æ²é£</a></span><span property="author" content="è‰æ²é£"></span></span><!----><span class="date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022å¹´10æœˆ5æ—¥</span><meta property="datePublished" content="2022-10-05T00:00:00.000Z"></span><span class="category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down" localizeddate="2022å¹´10æœˆ5æ—¥" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><ul class="categories-wrapper"><li class="category category1 clickable" role="navigation">socket</li><meta property="articleSection" content="socket"></ul></span><span aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down" localizeddate="2022å¹´10æœˆ5æ—¥" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><ul class="tags-wrapper"><li class="tag tag7 clickable" role="navigation">socketç¼–ç¨‹</li></ul><meta property="keywords" content="socketç¼–ç¨‹"></span><span class="reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down" localizeddate="2022å¹´10æœˆ5æ—¥" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 107 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT107M"></span><!----><span class="words-info" aria-label="å­—æ•°ğŸ” " data-balloon-pos="down" localizeddate="2022å¹´10æœˆ5æ—¥" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>çº¦ 31968 å­—</span><meta property="wordCount" content="31968"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_1-ç®€ä»‹" class="router-link-active router-link-exact-active toc-link level2">1. ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_2-å¯¼è¯»" class="router-link-active router-link-exact-active toc-link level2">2. å¯¼è¯»</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_3-ä»€ä¹ˆæ˜¯socket" class="router-link-active router-link-exact-active toc-link level2">3. ä»€ä¹ˆæ˜¯socket</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_3-1-ä¸¤ç§internet-socket" class="router-link-active router-link-exact-active toc-link level3">3.1. ä¸¤ç§Internet Socket</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_3-2-æ¼«è°ˆç½‘ç»œ" class="router-link-active router-link-exact-active toc-link level3">3.2. æ¼«è°ˆç½‘ç»œ</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_4-ipåœ°å€ã€structä»¥åŠåœ°å€è½¬æ¢" class="router-link-active router-link-exact-active toc-link level2">4. IPåœ°å€ã€structä»¥åŠåœ°å€è½¬æ¢</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_4-1-ipv4ä¸ipv6" class="router-link-active router-link-exact-active toc-link level3">4.1. IPv4ä¸IPv6</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_4-2-å­—èŠ‚åº" class="router-link-active router-link-exact-active toc-link level3">4.2. å­—èŠ‚åº</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_4-3-socketç›¸å…³çš„æ•°æ®ç»“æ„" class="router-link-active router-link-exact-active toc-link level3">4.3. socketç›¸å…³çš„æ•°æ®ç»“æ„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_4-4-ipçš„äºŒè¿›åˆ¶è½¬æ¢" class="router-link-active router-link-exact-active toc-link level3">4.4. IPçš„äºŒè¿›åˆ¶è½¬æ¢</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_5-ä»ipv4è¿ç§»åˆ°ipv6" class="router-link-active router-link-exact-active toc-link level2">5. ä»IPv4è¿ç§»åˆ°IPv6</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-socketç¼–ç¨‹ç›¸å…³å‡½æ•°" class="router-link-active router-link-exact-active toc-link level2">6. socketç¼–ç¨‹ç›¸å…³å‡½æ•°</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-1-getaddrinfo-â€”å‡†å¤‡å¼€å§‹" class="router-link-active router-link-exact-active toc-link level3">6.1. getaddrinfo()â€”å‡†å¤‡å¼€å§‹ï¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-2-socket-â€”æ‹¿åˆ°å¥—æ¥å­—æè¿°ç¬¦" class="router-link-active router-link-exact-active toc-link level3">6.2. socket()â€”æ‹¿åˆ°å¥—æ¥å­—æè¿°ç¬¦ï¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-3-bind-â€”æˆ‘åœ¨ç›‘å¬å“ªä¸ªç«¯å£" class="router-link-active router-link-exact-active toc-link level3">6.3. bind()â€”æˆ‘åœ¨ç›‘å¬å“ªä¸ªç«¯å£?</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-4-connect-â€”å˜¿-ä½ å¥½å•Š" class="router-link-active router-link-exact-active toc-link level3">6.4. connect()â€”å˜¿ï¼Œä½ å¥½å•Šï¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-5-listen-â€”ä¼šæœ‰äººè”ç³»æˆ‘å—" class="router-link-active router-link-exact-active toc-link level3">6.5. listen()â€”ä¼šæœ‰äººè”ç³»æˆ‘å—?</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-6-accept-â€”æ„Ÿè°¢å‘¼å«3490ç«¯å£" class="router-link-active router-link-exact-active toc-link level3">6.6. accept()â€”æ„Ÿè°¢å‘¼å«3490ç«¯å£</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-7-send-and-recv-â€”è·Ÿæˆ‘å” å” å§-å®å„¿" class="router-link-active router-link-exact-active toc-link level3">6.7. send() and recv()â€”è·Ÿæˆ‘å” å” å§ï¼Œå®å„¿!</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-8-sendto-and-recvfrom-â€”ç”¨dgramé£æ ¼è·Ÿæˆ‘è¯´è¯" class="router-link-active router-link-exact-active toc-link level3">6.8. sendto() and recvfrom()â€”ç”¨DGRAMé£æ ¼è·Ÿæˆ‘è¯´è¯</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-9-close-and-shutdown-â€”æ»šçŠŠå­" class="router-link-active router-link-exact-active toc-link level3">6.9. close() and shutdown()â€”æ»šçŠŠå­ï¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-10-getpeername-â€”ä½ å“ªä½" class="router-link-active router-link-exact-active toc-link level3">6.10. getpeername()â€”ä½ å“ªä½?</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_6-11-gethostname-â€”æˆ‘æ˜¯è°" class="router-link-active router-link-exact-active toc-link level3">6.11. gethostname()â€”æˆ‘æ˜¯è°?</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_7-client-serveråŸºç¡€" class="router-link-active router-link-exact-active toc-link level2">7. Client-ServeråŸºç¡€</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_7-1-ä¸€ä¸ªç®€å•çš„stream-server" class="router-link-active router-link-exact-active toc-link level3">7.1. ä¸€ä¸ªç®€å•çš„stream server</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_7-2-ä¸€ä¸ªç®€å•çš„stream-client" class="router-link-active router-link-exact-active toc-link level3">7.2. ä¸€ä¸ªç®€å•çš„stream client</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_7-3-datagram-sockets" class="router-link-active router-link-exact-active toc-link level3">7.3. Datagram Sockets</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-æŠ€æœ¯è¿›é˜¶" class="router-link-active router-link-exact-active toc-link level2">8. æŠ€æœ¯è¿›é˜¶</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-1-blockingâ€”ä½•è°“é˜»å¡" class="router-link-active router-link-exact-active toc-link level3">8.1. Blockingâ€”ä½•è°“é˜»å¡ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-2-poll-â€”åŒæ­¥çš„i-oå¤šè·¯å¤ç”¨" class="router-link-active router-link-exact-active toc-link level3">8.2. poll()â€”åŒæ­¥çš„I/Oå¤šè·¯å¤ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-3-select-â€”è€å¤è‘£çš„åŒæ­¥i-oå¤šè·¯å¤ç”¨" class="router-link-active router-link-exact-active toc-link level3">8.3. select()â€”è€å¤è‘£çš„åŒæ­¥I/Oå¤šè·¯å¤ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-4-æ•°æ®åªä¼ äº†ä¸€éƒ¨åˆ†æ€ä¹ˆåŠ" class="router-link-active router-link-exact-active toc-link level3">8.4. æ•°æ®åªä¼ äº†ä¸€éƒ¨åˆ†æ€ä¹ˆåŠï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-5-serialization-å¦‚ä½•å°è£…æ•°æ®" class="router-link-active router-link-exact-active toc-link level3">8.5. Serialization-å¦‚ä½•å°è£…æ•°æ®ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-6-æ•°æ®å°è£…" class="router-link-active router-link-exact-active toc-link level3">8.6. æ•°æ®å°è£…</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_8-7-å¹¿æ’­æ•°æ®åŒ…-å¤§å£°è¯´ã€Œhello-worldã€" class="router-link-active router-link-exact-active toc-link level3">8.7. å¹¿æ’­æ•°æ®åŒ…-å¤§å£°è¯´ã€ŒHelloï¼ŒWorldã€</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_9-å¸¸è§é—®é¢˜" class="router-link-active router-link-exact-active toc-link level2">9. å¸¸è§é—®é¢˜</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-manæ‰‹å†Œ" class="router-link-active router-link-exact-active toc-link level2">10. manæ‰‹å†Œ</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-1-accept" class="router-link-active router-link-exact-active toc-link level3">10.1. accept()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-2-bind" class="router-link-active router-link-exact-active toc-link level3">10.2. bind()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-3-connect" class="router-link-active router-link-exact-active toc-link level3">10.3. connect()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-4-close" class="router-link-active router-link-exact-active toc-link level3">10.4. close()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-5-getaddrinfo-freeaddrinfo-gai-strerror" class="router-link-active router-link-exact-active toc-link level3">10.5. getaddrinfo(), freeaddrinfo(), gai_strerror()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-6-gethostname" class="router-link-active router-link-exact-active toc-link level3">10.6. gethostname()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-7-gethostbyname-gethostbyaddr" class="router-link-active router-link-exact-active toc-link level3">10.7. gethostbyname(), gethostbyaddr()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-8-getnameinfo" class="router-link-active router-link-exact-active toc-link level3">10.8. getnameinfo()</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_10-9-shutdown" class="router-link-active router-link-exact-active toc-link level3">10.9. shutdown()</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_11-æ›´å¤šèµ„æ–™" class="router-link-active router-link-exact-active toc-link level2">11. æ›´å¤šèµ„æ–™</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/network-programming/network-programming.html#_12-åè®°" class="router-link-active router-link-exact-active toc-link level2">12. åè®°</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h2 id="_1-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#_1-ç®€ä»‹" aria-hidden="true">#</a> 1. ç®€ä»‹</h2><h2 id="_2-å¯¼è¯»" tabindex="-1"><a class="header-anchor" href="#_2-å¯¼è¯»" aria-hidden="true">#</a> 2. å¯¼è¯»</h2><h2 id="_3-ä»€ä¹ˆæ˜¯socket" tabindex="-1"><a class="header-anchor" href="#_3-ä»€ä¹ˆæ˜¯socket" aria-hidden="true">#</a> 3. ä»€ä¹ˆæ˜¯socket</h2><p>ä½ ä¸€ç›´åœ¨å¬åˆ«äººè°ˆè®º&quot;<code>sockets</code>&quot;ï¼Œæˆ–è®¸ä½ ä¹Ÿæƒ³ææ˜ç™½è¿™åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ã€‚</p><p>å¥½å§ï¼Œå®ƒä»¬å…¶å®å°±æ˜¯ï¼šã€Œä½¿ç”¨æ ‡å‡†çš„<code>Unix file descriptors</code>ï¼ˆUnixæ–‡ä»¶æè¿°ç¬¦ï¼‰ä¸å…¶ä»–ç¨‹åºè¿›è¡Œæ²Ÿé€šçš„ä¸€ç§æ–¹å¼ã€ã€‚</p><p>å•¥ç©æ„å„¿ï¼Ÿ</p><p>å¦‚æœæ¥è§¦è¿‡Unixï¼Œä½ ä¸€å®šå¬è¯´è¿‡ã€ŒUnixä¸€åˆ‡çš†æ–‡ä»¶ã€çš„è¯´æ³•ã€‚</p><p>ä¸€å®šæ„ä¹‰ä¸Šæ¥è¯´ï¼Œè¿™ä¸ªè¯´æ³•å¹¶æ²¡æœ‰ä»€ä¹ˆé”™ã€‚å› ä¸ºUnixç¨‹åºåšä»»ä½•I/Oæ“ä½œï¼Œéƒ½æ˜¯é€šè¿‡å¯¹<code>file descriptor</code>ï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰è¿›è¡Œè¯»å†™æ¥å®ç°çš„ã€‚</p><p>æ–‡ä»¶æè¿°ç¬¦å…¶å®å°±æ˜¯ä¸€ä¸ªæ•´æ•°ç½¢äº†ï¼Œåªæ˜¯è¿™ä¸ªæ•´æ•°å…³è”äº†ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶ã€‚è¿™é‡Œçš„æ–‡ä»¶å¯ä»¥æ˜¯ä¸€ä¸ª<code>ç½‘ç»œè¿æ¥</code>ã€<code>FIFO</code>ã€<code>pipe</code>ï¼ˆç®¡é“ï¼‰ã€<code>terminal</code>ï¼ˆç»ˆç«¯ï¼‰ã€ç£ç›˜ä¸­çš„å®é™…æ–‡ä»¶ç­‰ç­‰ã€‚</p><blockquote><p>æˆ‘ä¹‹å‰å†™è¿‡ä¸€ç¯‡ã€Š<a href="https://www.chanmufeng.com/posts/os/%E4%BB%80%E4%B9%88%E6%98%AF%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6.html" target="_blank" rel="noopener noreferrer">ä»€ä¹ˆæ˜¯æ–‡ä»¶æè¿°ç¬¦<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‹çš„æ–‡ç« ï¼Œæ„Ÿå…´è¶£çš„è¯å¤§å®¶å¯ä»¥çœ‹ä¸€ä¸‹</p></blockquote><p>æ‰€ä»¥ã€ŒUnixä¸€åˆ‡çš†æ–‡ä»¶ã€çš„è¯´æ³•å¹¶éæ˜¯å¤¸å¤§å…¶è¯ã€‚</p><p>ä¸ç®¡ä½ ä¿¡ä¸ä¿¡ï¼Œå½“ä½ æƒ³é€šè¿‡ç½‘ç»œå’Œå¦ä¸€ä¸ªç¨‹åºè¿›è¡Œé€šè®¯æ—¶ï¼Œä½ å¿…é¡»é€šè¿‡<code>file descriptor</code>æ¥å®ç°ã€‚</p><p>é‚£ä¹ˆæ€ä¹ˆè·å–åˆ°å’Œç½‘ç»œé€šä¿¡ç›¸å…³çš„è¿™ä¸ª<code>file descriptor</code>å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>socket()</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸€ä¸ª<code>socket descriptor</code>ï¼ˆ<code>socket</code>éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œ<code>socket descriptor</code>è‡ªç„¶å°±æ˜¯ä¸€ä¸ª<code>file descriptor</code>äº†ï¼‰ã€‚ç„¶åä½ å°±å¯ä»¥é€šè¿‡è¿™ä¸ª<code>socket descriptor</code>ï¼Œä½¿ç”¨<code>send()</code>å’Œ<code>recv()</code>è¿™ä¸¤ä¸ªå‡½æ•°ä¸å…¶ä»–ç¨‹åºè¿›è¡Œé€šä¿¡äº†ã€‚</p><p>å¦‚æœä½ ç”¨Cè¯­è¨€å¯¹æ–‡ä»¶è¿›è¡Œè¿‡è¯»å†™æ“ä½œï¼Œä½ å°±çŸ¥é“<code>read()/write()</code>è¿™ä¸€ç»„å‡½æ•°åŒæ ·å¯ä»¥ä½œç”¨äº<code>file descriptor</code>ï¼Œä¸ºä»€ä¹ˆä¸ç”¨è¿™ä¸€å¥—å‡½æ•°å‘¢ï¼Ÿ</p><p>å½“ç„¶å®Œå…¨å¯ä»¥ç”¨ï¼åªä¸è¿‡<code>send()/recv()</code>åœ¨æ•°æ®ä¼ è¾“æ–¹é¢æ¯”<code>read/write()</code>æä¾›äº†æ›´å¤šå¯é€‰é¡¹ç½¢äº†ã€‚</p><p>å…¶å®<code>sockets</code>çš„ç§ç±»æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼š</p><ul><li>DARPA Internet addressesï¼Œç®€ç§°<code>Internet Sockets </code></li></ul><p>Internet Socketsæ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è®²è§£çš„é‡ç‚¹ï¼Œå› ä¸ºå®ƒæ˜¯æˆ‘ä»¬ç›®å‰è¿›è¡Œç½‘ç»œé€šä¿¡æ—¶ä½¿ç”¨æœ€å¤šçš„ä¸€ç§Socket.</p><blockquote><p>DARPAè¡¨ç¤ºå›½é˜²éƒ¨é«˜çº§ç ”ç©¶è®¡åˆ’å±€</p></blockquote><ul><li>path names on a local nodeï¼Œç®€ç§°<code>Unix Sockets</code></li></ul><p>è¿™ä¸ªè‹±æ–‡ç¿»è¯‘æˆä¸­æ–‡ä¹Ÿä¸æ˜¯å¾ˆç›´è§‚ï¼Œæ‰€ä»¥å¹²è„†ä¸ç¿»è¯‘äº†ï¼Œ<code>Unix Sockets</code>æœ‰æ—¶å€™è¢«ç§°ä¸º<code>UnixåŸŸå¥—æ¥å­—</code>ã€‚ç®€è€Œè¨€ä¹‹ï¼Œ<code>Unix Sockets</code>æ˜¯ç”¨äºåŒä¸€å°ä¸»æœºä¸­è¿›ç¨‹é—´é€šè®¯çš„ä¸€ç§æ–¹å¼ã€‚</p><p>ä½¿ç”¨è¿‡MySQLçš„æœ‹å‹å¾ˆå¯èƒ½è§è¿‡ä¸‹é¢è¿™ä¸ªé”™è¯¯ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>ERROR <span class="token number">2002</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: 
Can<span class="token string">&#39;t connect to local MySQL server through socket &#39;</span>/var/lib/mysql/mysql.sock&#39; <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªé”™è¯¯è¯´æ˜MySQL Clientå’ŒMySQL Serverè¿è¡Œåœ¨åŒä¸€å°ä¸»æœºä¸Šï¼Œå¹¶ä¸”ä¸¤ä¸ªè¿›ç¨‹é€šè¿‡<code>/var/lib/mysql/mysql.sock</code>è¿™ä¸ªæ–‡ä»¶è¿›è¡Œé€šä¿¡ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯UnixåŸŸå¥—æ¥å­—æ–‡ä»¶ï¼Œä¸éœ€è¦ç»è¿‡ç½‘ç»œåè®®æ ˆï¼Œä¸éœ€è¦æ‰“åŒ…æ‹†åŒ…ã€è®¡ç®—æ ¡éªŒå’Œã€ç»´æŠ¤åºåˆ—å·åº”ç­”ç­‰ç­‰ç½‘ç»œé€šä¿¡ç»†èŠ‚ã€‚</p><p>ä½ å¯èƒ½ä¼šé—®ï¼ŒMySQL Clientå’ŒMySQL Serverä¹‹é—´ä¸ºä»€ä¹ˆä¸é€šè¿‡æœ¬åœ°ç½‘ç»œè¿›è¡Œé€šä¿¡å‘¢ï¼Ÿ</p><p>è¿™å’Œä½ å¯¹MySQLçš„é…ç½®æœ‰å…³ç³»ã€‚</p><p>å¦‚æœä½ æŒ‡å®šçš„MySQLä¸»æœºåä¸º<code>localhost</code>ï¼Œæˆ–è€…ä½ æŒ‡å®šäº†<code>--protocl=socket</code>çš„å¯åŠ¨å‚æ•°ï¼Œé‚£ä¹ˆClientå’ŒServerä¹‹é—´å°±ä¼šé€šè¿‡<code>UnixåŸŸå¥—æ¥å­—</code>è¿›è¡Œé€šä¿¡äº†ã€‚</p><p>ç›¸åï¼Œå¦‚æœä½ æŒ‡å®šçš„MySQLä¸»æœºåæ˜¯<code>127.0.0.1</code>ï¼Œé‚£ä¹ˆClientå’ŒServerä¹‹é—´å°±ä¼šé€šè¿‡<code>Internet Sockets</code>è¿›è¡Œé€šä¿¡äº†ã€‚</p><h3 id="_3-1-ä¸¤ç§internet-socket" tabindex="-1"><a class="header-anchor" href="#_3-1-ä¸¤ç§internet-socket" aria-hidden="true">#</a> 3.1. ä¸¤ç§Internet Socket</h3><p>å•¥ï¼Ÿåªæœ‰ä¸¤ç§<code>Internet Socket</code>å—ï¼Ÿ</p><p>å¼€ç©ç¬‘çš„å•¦ï¼Œå½“ç„¶è¿œä¸æ­¢ä¸¤ç§å–½ã€‚ä½†æ˜¯ä¸ºäº†æ€•å“åˆ°ä½ ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»<code>Stream Sockets</code>ä»¥åŠ<code>Datagram Sockets</code>ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œ<code>Raw Sockets</code>ï¼ˆåŸå§‹å¥—æ¥å­—ï¼‰ä¹Ÿæ˜¯ä¸€ç§åŠŸèƒ½æ›´åŠ å¼ºå¤§çš„Socketï¼Œå¦‚æœæ„Ÿå…´è¶£ï¼Œä½ å¯ä»¥æŸ¥ä¸€æŸ¥èµ„æ–™äº†è§£ä¸€ä¸‹ã€‚</p><p><img src="http://qiniu.chanmufeng.com/2022-09-30-074116.png" alt="image-20220930154115557" loading="lazy"></p><p>å¦‚æœè¦è¿›è¡Œç½‘ç»œé€šä¿¡ï¼Œæˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹è‚¯å®šæ˜¯è°ƒç”¨<code>socket()</code>å‡½æ•°ï¼Œå¹¶æŒ‡å®šæƒ³ä½¿ç”¨çš„å¥—æ¥å­—ç±»å‹ï¼Œæ¯”å¦‚<code>SOCK_STREAM</code>ã€<code>SOCK_DGRAM</code>ã€<code>SOCK_RAW</code>ç­‰ç±»å‹ï¼Œä»–ä»¬åˆ†åˆ«è¡¨ç¤º<code>Stream Sockets</code>ã€<code>Datagram Sockets</code>ä»¥åŠ<code>Raw Sockets</code>ã€‚</p><p>æˆ‘ä»¬å…ˆä»<code>Stream Sockets</code>è¯´èµ·ã€‚</p><h4 id="_3-1-1-stream-sockets" tabindex="-1"><a class="header-anchor" href="#_3-1-1-stream-sockets" aria-hidden="true">#</a> 3.1.1. Stream Sockets</h4><p><code>Stream sockets</code>æ˜¯ä¸€ç§å¯é çš„ã€æ”¯æŒåŒå‘è¿æ¥çš„é€šä¿¡æµã€‚</p><p>å¦‚æœä½ ä»¥â€œ1ï¼Œ2â€çš„é¡ºåºå°†è¿™ä¸²æ•°å­—å‘é€åˆ°socketä¸­ï¼Œé‚£ä¹ˆåœ¨æ¥æ”¶ç«¯å°±ä¼šä»¥åŒæ ·çš„é¡ºåºæ¥å—åˆ°â€œ1ï¼Œ2â€ï¼Œè‚¯å®šä¸ä¼šå‡ºé”™ã€‚</p><p>å“ªé‡Œä¼šç”¨åˆ°<code>Stream sockets</code>å‘¢ï¼Ÿ</p><p>æˆ–è®¸ä½ å¬è¯´è¿‡<code>telnet</code>ç¨‹åºï¼Ÿ<code>telnet</code>ç”¨çš„å°±æ˜¯<code>Stream sockets</code>ï¼Œä½ è¾“å…¥çš„æ¯ä¸ªå­—ç¬¦éƒ½å¿…é¡»æŒ‰ç…§ä½ çš„è¾“å…¥é¡ºåºä¾æ¬¡æŠµè¾¾ï¼Œè¦ä¸ç„¶æŒ‡ä»¤è‚¯å®šå°±é”™ä¹±äº†ä¸æ˜¯ï¼Ÿ</p><p>åŒæ ·ï¼Œæµè§ˆå™¨ä½¿ç”¨çš„<code>HTTP</code>åè®®åº•å±‚ä¹Ÿä½¿ç”¨äº†<code>Stream sockets</code>æ¥è·å–ç½‘é¡µä¿¡æ¯ã€‚å¦‚æœä½ é€šè¿‡80ç«¯å£<code>telnet</code>åˆ°ä¸€ä¸ªç½‘ç«™ï¼Œå¹¶è¾“å…¥ &quot;<code>GET / HTTP/1.0</code>&quot;ï¼Œç„¶åæŒ‰ä¸¤ä¸‹Enterï¼Œä½ å°±ä¼šæ”¶åˆ°ç½‘ç«™å‘é€ç»™ä½ çš„ HTML ï¼</p><p><code>Stream sockets</code> æ˜¯æ€ä¹ˆåšåˆ°å¦‚æ­¤é«˜è´¨é‡åœ°ä¼ è¾“æ•°æ®çš„å‘¢ï¼Ÿ</p><p><code>Stream sockets </code>åº•å±‚ä½¿ç”¨äº† &quot;The Transmission Control Protocol&quot;ï¼ˆä¼ è¾“æ§åˆ¶åè®®ï¼‰ï¼Œå°±æ˜¯å¤§åé¼é¼çš„ &quot;<code>TCP</code>&quot;ï¼ˆTCP çš„å…¨éƒ¨ç»†èŠ‚å¯ä»¥å‚è€ƒ<a href="https://tools.ietf.org/html/rfc793" target="_blank" rel="noopener noreferrer">RFC 793<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼‰ã€‚</p><p><code>TCP </code>ä¼šç¡®ä¿ä½ çš„æ•°æ®å¯ä»¥æŒ‰ç…§é¡ºåºæŠµè¾¾è€Œä¸”ä¸ä¼šå‡ºé”™ã€‚ä½ ä¹‹å‰å¯èƒ½æ˜¯ä»&quot;<code>TCP/IP</code>&quot;è¿™ä¸ªä¸“ä¸šåè¯ä¸­å¬è¯´çš„<code>TCP</code>ï¼Œå…¶ä¸­çš„<code>IP</code> æ˜¯æŒ‡ &quot;Internet Protocol&quot;ï¼ˆç½‘ç»œåè®®ï¼Œè¯¦è§ <a href="https://tools.ietf.org/html/rfc791" target="_blank" rel="noopener noreferrer">RFC 791<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼‰ã€‚<code>IP</code> ä¸»è¦å¤„ç†æ•°æ®åœ¨å„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„Internet routingï¼ˆç½‘ç»œè·¯ç”±ï¼‰ï¼Œé€šå¸¸ä¸ä¿éšœæ•°æ®çš„å®Œæ•´æ€§ã€‚</p><h4 id="_3-1-2-datagram-sockets" tabindex="-1"><a class="header-anchor" href="#_3-1-2-datagram-sockets" aria-hidden="true">#</a> 3.1.2. Datagram Sockets</h4><p><code>Datagram sockets</code> æœ‰æ—¶å€™è¢«å«åš â€œconnectionless socketsâ€ï¼ˆæ— è¿æ¥çš„socketsï¼‰ï¼Œè€Œä¸”ï¼Œè¿™ç©æ„é€šå¸¸ä¹Ÿä¸æ€ä¹ˆå¯é ï¼</p><p>ä¸ºå•¥ï¼Ÿ</p><p>å› ä¸º<code>Datagram Sockets</code>åº•å±‚ç”¨çš„æ˜¯â€œUser Datagram Protocolâ€ï¼ˆç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼Œè¯¦è§<a href="https://tools.ietf.org/html/rfc768" target="_blank" rel="noopener noreferrer">RFC 768<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼‰ï¼Œä¹Ÿå°±æ˜¯â€œ<code>UDP</code>â€ã€‚</p><p><code>UDP</code>å¹¶ä¸åƒ<code>TCP</code>é‚£æ ·ä¼šç›´æ¥åœ¨ä¼ è¾“å±‚å°†æ•°æ®é‡è¿‡å¤§çš„æ¶ˆæ¯åˆ†ç‰‡ï¼ˆTCP segmentsï¼‰ï¼Œè€Œæ˜¯ä¼šåœ¨IPå±‚è¢«åŠ¨è¿›è¡Œåˆ†åŒ…ï¼Œå°†ä¸€ä¸ªIP packetåˆ†åŒ…æˆå¤šä¸ªIP fragmentsã€‚è¿™æ ·ä¸€æ¥ï¼Œæ¥æ”¶ç«¯å°±å¿…é¡»åšIP fragmentsçš„é‡ç»„ï¼Œåˆå¹¶ä¸ºåŸæ¥çš„IP packetï¼Œè¿™æ— ç–‘å¢åŠ äº†æ•°æ®åŒ…ä¸¢å¤±çš„æ¦‚ç‡ã€‚ï¼ˆå…¶å®åˆ†åŒ…å€’è¿˜å¥½ï¼Œä¸»è¦æ˜¯UDPæ²¡æœ‰TCPé‚£ä¹ˆå¼ºå¤§çš„çº é”™èƒ½åŠ›ï¼‰</p><p>å¦‚æœä½ å‘é€äº†ä¸€ä¸ª <code>datagram</code>ï¼ˆUDPçš„æ•°æ®æŠ¥ï¼‰ï¼Œå®ƒå¯èƒ½ä¼šé¡ºåˆ©æŠµè¾¾ã€ä½†å¯èƒ½ä¸ä¼šæŒ‰ç…§å‘é€é¡ºåºæŠµè¾¾ã€‚</p><blockquote><p>è¯‘è€…æ³¨ï¼šä¸‹æ–‡å°†ç§°UDPå‘é€çš„æ•°æ®ä¸ºdatagramï¼Œä¹‹åæåˆ°è¿™ä¸ªè¯å°±æ„å‘³ç€ä½¿ç”¨çš„æ˜¯UDPåè®®</p></blockquote><p>é‚£ä¸ºä»€ä¹ˆåˆä¼šè¢«ç§°ä¸ºâ€œæ— è¿æ¥çš„socketsâ€å‘¢ï¼Ÿ</p><p>å› ä¸º<code>Datagram Sockets</code>ä¸ç”¨åƒ<code>Stream Sockets</code>ä¸€æ ·ç»´æŒåŒæ–¹çš„è¿æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠéœ€è¦å‘é€çš„æ•°æ®æ‰“åŒ…ï¼Œç»™å®ƒä¸€ä¸ªç›®çš„åœ°ä¿¡æ¯ï¼Œç„¶åå‘é€å‡ºå»å°±è¡Œäº†ã€‚</p><p>å› æ­¤å½“<code>TCP</code>åè®®ä¸å¯ç”¨ï¼Œæˆ–è€…ä½ å¾ˆç¡®å®šä¸¢å‡ ä¸ªæ•°æ®åŒ…ä¸è‡³äºæƒ¹ä»€ä¹ˆå¤§ä¹±å­çš„æƒ…å†µä¸‹ï¼Œä¸å¦¨ä½¿ç”¨<code>datagram socket</code>ã€‚è¿™æ ·çš„ä½¿ç”¨åœºæ™¯æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚<code>tftp</code>ï¼ˆtrivial file transfer protocolï¼Œç®€æ˜“æ–‡ä»¶ä¼ è¾“åè®®ï¼Œæ˜¯ <code>FTP</code> åè®®çš„å°å…„å¼Ÿï¼‰ï¼Œå¤šäººæ¸¸æˆä»¥åŠè§†é¢‘ä¼šè®®ç­‰ã€‚</p><p>äº‹æƒ…æœ‰ç‚¹ä¸å¤ªå¯¹åŠ²ï¼<code>tftp</code>å¯æ˜¯è¿›è¡Œæ–‡ä»¶ä¼ è¾“çš„åè®®å•Šï¼Œå¦‚æœä¼ è¾“è¿‡ç¨‹ä¸­ä¸¢åŒ…äº†ï¼Œå®¢æˆ·æ ¹æœ¬æ²¡æ³•æ­£å¸¸ä½¿ç”¨å•Šã€‚</p><p>æ²¡é”™ï¼<code>UDP</code>æ˜¯ä¸å¯é çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨<code>UDP</code>çš„ä¸Šå±‚ä½¿ç”¨å¯é çš„åº”ç”¨å±‚åè®®ï¼Œå°±æ¯”å¦‚<code>tftp</code>åè®®ã€‚<code>tftp </code>åè®®ä¼šæ­»æ­»ç›¯ç€è‡ªå·±å‘é€çš„æ¯ä¸ªæ•°æ®åŒ…ï¼Œè¦æ±‚æ¥å—æ–¹å¿…é¡»å›å¤ä¸€ä¸ªæ•°æ®åŒ…æ¥è¡¨ç¤ºï¼‚æˆ‘æ”¶åˆ°äº†ï¼ï¼‚ï¼ˆä¸€ä¸ªï¼‚<code>ACK</code>ï¼‚å›å¤æ•°æ®åŒ…ï¼‰ã€‚å¦‚æœå‘é€æ–¹åœ¨5ç§’å†…æ²’æœ‰æ”¶åˆ°<code>ACK</code>ï¼Œè¡¨ç¤ºå®ƒè¯¥é‡ä¼ è¿™ä¸ªæ•°æ®åŒ…ï¼Œç›´åˆ°æ”¶åˆ° <code>ACK </code>ä¸ºæ­¢ã€‚åœ¨ä¸å¯é çš„<code>UDP</code>ä¸Šæ„å»ºå¯é çš„<code>SOCK_DGRAM</code>åº”ç”¨ç¨‹åºï¼Œè¿™ç§<code>ACK</code>æœºåˆ¶éå¸¸å€¼å¾—å€Ÿé‰´ã€‚</p><p>æ—¢ç„¶æœ‰äº†<code>TCP</code>è¿™ç§å¯é çš„ä¼ è¾“ï¼Œ<code>UDP</code>æœ‰å­˜åœ¨çš„å¿…è¦å—ï¼Ÿ</p><p>è¿™é‡Œæœ‰ä¸¤ä¸ªåŸå› æ¥è¯´æ˜<code>UDP</code>çš„å¿…è¦æ€§ï¼Œç¬¬ä¸€ä¸ªåŸå› æ˜¯é€Ÿåº¦ï¼Œç¬¬äºŒä¸ªåŸå› è¿˜æ˜¯é€Ÿåº¦ã€‚ï¼ˆé²è¿…æ—¢è§†æ„Ÿï¼‰</p><p>ç›¸æ¯”äºè·Ÿè¸ªæ•°æ®åŒ…çš„æŠµè¾¾çŠ¶å†µå¹¶ç¡®ä¿æ•°æ®åŒ…çš„é¡ºåºæ€§è¿™ç§ç´¯æ´»å„¿ï¼Œâ€œæ•°æ®åŒ…ä¸¢äº†å°±ä¸¢äº†â€è¿™ç§å¤„ç†æ€åº¦å¯èƒ½æ›´é«˜æ•ˆã€‚å¦‚æœä½ æ˜¯è¦å‘é€èŠå¤©ä¿¡æ¯ï¼Œ<code>TCP</code>æ˜¯ä¸ªå¥½çš„é€‰æ‹©ã€‚ä½†æ˜¯å¦‚æœä½ æƒ³ä¸ºå…¨ä¸–ç•Œçš„æ¸¸æˆç©å®¶æ¯ç§’é€å‡º40ä¸ªä½ç½®æ›´æ–°ä¿¡æ¯ï¼Œå¹¶ä¸”ä¸¢ä¸€ä¸¤ä¸ªæ•°æ®åŒ…ä¹Ÿæ— è¶³è½»é‡çš„è¯ï¼Œ<code>UDP</code>è‚¯å®šæ˜¯ä¸äºŒä¹‹é€‰ã€‚</p><h3 id="_3-2-æ¼«è°ˆç½‘ç»œ" tabindex="-1"><a class="header-anchor" href="#_3-2-æ¼«è°ˆç½‘ç»œ" aria-hidden="true">#</a> 3.2. æ¼«è°ˆç½‘ç»œ</h3><p>å­¦ä¹ è®¡ç®—æœºæ€ä¹ˆèƒ½ä¸è°ˆç½‘ç»œåˆ†å±‚å‘¢ã€‚ä¸‹é¢æˆ‘ä»¬å°±ç®€å•äº†è§£ä¸€ä¸‹ç½‘ç»œæ˜¯æ€æ ·å·¥ä½œçš„ï¼Œå¹¶ä¸”ä¸¾ä¸€äº›å¦‚ä½•<code>SOCK_DGRAM</code> å°åŒ…çš„ä¾‹å­ã€‚</p><p>å®é™…ä¸Šï¼Œå¦‚æœä½ å¯ä»¥è·³è¿‡è¿™ä¸€èŠ‚å†…å®¹ï¼Œä¸è¿‡ï¼Œè¿™ä¸€èŠ‚èƒ½å¸®ä½ å¾ˆå¥½çš„äº†è§£ç½‘ç»œèƒŒæ™¯ï¼Œæœ‰ä¸€å®šçš„å‚è€ƒæ„ä¹‰ã€‚</p><p><img src="http://qiniu.chanmufeng.com/2022-10-01-012138.png" alt="æ•°æ®å°è£…" loading="lazy"></p><p>ç°åœ¨æ˜¯æ—¶å€™äº†è§£ä¸€ä¸‹<code>*Data Encapsulation*</code>ï¼ˆæ•°æ®å°è£…ï¼‰äº†ï¼Œå®ƒå®åœ¨å®åœ¨æ˜¯éå¸¸é‡è¦ï¼å³ä¾¿å¦‚æ­¤ï¼Œåœ¨å¤§éƒ¨åˆ†çš„ç½‘ç»œè¯¾ç¨‹çš„å­¦ä¹ ä¸­ï¼Œæ‰€å çš„ç¬”å¢¨å¹¶ä¸ç®—å¤šã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šè¿™ä¹ˆè®²ï¼š</p><p>ä½ å‘é€çš„æ•°æ®æ„æˆäº†æœ€åˆå§‹çš„æ•°æ®åŒ…ï¼Œç„¶åå°†æ•°æ®åŒ…å°è£…åˆ°åº”ç”¨å±‚åè®®ï¼ˆæ¯”å¦‚<code>TFTP</code>åè®®ï¼‰çš„<code>header</code>ä¸­ï¼Œç„¶åå°†å°è£…ä¹‹åçš„åŒ…å†æ¬¡å°è£…åˆ°ä¸‹ä¸€ä¸ªåè®®ï¼ˆ<code>UDP</code>ï¼‰ä¸­ï¼Œå†æ¥ç€è¢«å°è£…åˆ°ä¸‹ä¸€ä¸ªåè®®ï¼ˆ<code>IP</code>åè®®ï¼‰ï¼Œæœ€ç»ˆè¢«ç¡¬ä»¶å±‚é¢çš„é€šè®¯åè®®ï¼ˆä»¥å¤ªç½‘åè®®ï¼‰å°è£…ã€‚</p><p>æ¥æ”¶æ–¹æ¥æ”¶åˆ°æ•°æ®åï¼Œç¡¬ä»¶å±‚ä¼šæ‹†æ‰<code>ä»¥å¤ªç½‘header</code>å’Œ<code>footer</code>ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¼šæ‹†å¼€ <code>IP</code> ä¸<code> UDP header</code>ï¼Œæœ€åç”±åº”ç”¨å±‚ç¨‹åº<code> TFTP</code> è§£å¼€<code> TFTP header</code>ï¼Œæœ€ç»ˆè·å–åˆ°ç”¨æˆ·æ•°æ®ã€‚</p><p><img src="http://qiniu.chanmufeng.com/2022-10-01-080343.png" alt="image-20221001160343286" loading="lazy"></p><p>æ¥ä¸‹æ¥ç»ˆäºå¯ä»¥èŠä¸€èŠå£°åç‹¼è—‰çš„ç½‘ç»œåˆ†å±‚æ¨¡å‹ï¼ˆLayered Network Modelï¼‰ï¼Œä¹Ÿå°±æ˜¯ &quot;<strong>ISO/OSI</strong>&quot;äº†ã€‚</p><p>è¯´å®ƒå£°åç‹¼è—‰ï¼Œæ˜¯å› ä¸ºæ‰€æœ‰å…¥é—¨è®¡ç®—æœºç½‘ç»œçš„äººé¦–å…ˆå­¦ä¹ çš„ä¾¿æ˜¯è¿™ä¸ªåˆ†å±‚æ¨¡å‹ï¼Œè€Œå¯¹åˆšæ¥è§¦ç½‘ç»œçš„å°ç™½è€Œè¨€å¾ˆéš¾å¯¹åˆ†å±‚æœ‰å¾ˆæ·±çš„ç†è§£å’Œæ„Ÿæ‚Ÿï¼Œåªèƒ½æ˜¯æ­»è®°ç¡¬èƒŒï¼Œæœ€ç»ˆçš„ç»“æœå°±æ˜¯åº”ä»˜è€ƒè¯•è€Œå·²ã€‚</p><p>20ä¸–ç•Œ70å¹´ä»£åæœŸï¼Œå›½é™…æ ‡å‡†åŒ–ç»„ç»‡ï¼ˆISOï¼‰æå‡ºè®¡ç®—æœºç½‘ç»œåº”è¯¥ç»„ç»‡ä¸ºå¤§æ¦‚7å±‚ï¼Œå¹¶ç§°ä¹‹ä¸ºå¼€æ”¾ç³»ç»Ÿäº’è¿ï¼ˆOSIï¼‰æ¨¡å‹ã€‚äº‹å®ä¸Šï¼ŒOSIæ¨¡å‹çš„åˆ›å»ºè€…æå‡ºè¿™ä¸ªæ¨¡å‹çš„æ—¶å€™å¹¶æ²¡æœ‰è”æƒ³åˆ°å¦‚ä»Šä½¿ç”¨çš„å› ç‰¹ç½‘ï¼Œä½†å¹¶ä¸å¦¨ç¢OSIæ¨¡å‹åˆ°å¦‚ä»Šä¾ç„¶é€‚ç”¨ï¼Œè¿™ä¾¿æ˜¯æŠ½è±¡çš„èƒ½åŠ›ã€‚</p><p>OSIæ¨¡å‹å°†ç½‘ç»œåˆ†å±‚ä¸ºï¼š</p><ul><li>åº”ç”¨å±‚</li><li>è¡¨ç¤ºå±‚</li><li>ä¼šè¯å±‚</li><li>ä¼ è¾“å±‚</li><li>ç½‘ç»œå±‚</li><li>é“¾è·¯å±‚</li><li>ç‰©ç†å±‚</li></ul><p>ä½†æ˜¯è¿™ç§åˆ†å±‚å®åœ¨æ˜¯è¿‡äºç¹çï¼Œå› æ­¤ç°åœ¨ä»‹ç»ç½‘ç»œåˆ†å±‚ï¼Œä¸€èˆ¬éƒ½æ˜¯æ‹¿<code>TCP/IP</code>åè®®æ ˆæ¥è¿›è¡Œè¯´æ˜ã€‚</p><ul><li>åº”ç”¨å±‚ï¼ˆæ¯”å¦‚<code>telnet</code>ã€<code>ftp</code>ç­‰ï¼‰</li><li>ä¼ è¾“å±‚ï¼ˆ<code>TCP</code>ã€<code>UDP</code>ç­‰ï¼‰</li><li>ç½‘ç»œå±‚ï¼ˆ<code>IP</code>ã€<code>ICMP</code>ä»¥åŠ<code>IGMP</code>ï¼‰</li><li>ç½‘ç»œæ¥å£å±‚ï¼ˆ<code>ä»¥å¤ªç½‘</code>ã€<code>wi-fi</code>ç­‰ï¼‰</li></ul><p>æ¯ä¸€å±‚åˆ†åˆ«è´Ÿè´£ä¸åŒçš„é€šä¿¡åŠŸèƒ½ï¼š</p><ol><li>åº”ç”¨å±‚è´Ÿè´£å¤„ç†ç‰¹å®šåº”ç”¨ç¨‹åºçš„ç»†èŠ‚ã€‚æ¯”å¦‚å¯¹ç”¨æˆ·æ¶ˆæ¯çš„åŠ å¯†è§£å¯†æ“ä½œã€æŒ‰ç…§ç‰¹å®šæ ¼å¼å¯¹æ•°æ®è¿›è¡Œç»„è£…æˆ–è§£æç­‰ã€‚</li><li>ä¼ è¾“å±‚ä¸»è¦ä¸ºä¸¤å°ä¸»æœºä¸Šçš„åº”ç”¨ç¨‹åºæä¾›ç«¯åˆ°ç«¯çš„é€šä¿¡ã€‚æ‰€è°“çš„ç«¯åˆ°ç«¯ï¼Œå°±æ˜¯èƒ½æ‰¾åˆ°çœŸæ­£å¤„ç†æ•°æ®åŒ…çš„ä¸¤ä¸ªè¿›ç¨‹ã€‚ä¸¾ä¸ªä¾‹å­å°±æ˜¯å¿«é€’èƒ½å¤Ÿä¿è¯é€è´§ä¸Šé—¨ï¼Œè€Œä¸åªæ˜¯é€åˆ°å°åŒºé©¿ç«™ã€‚</li><li>ç½‘ç»œå±‚ï¼Œç”¨äºä¸»æœºä¹‹é—´çš„è·¯ç”±ï¼Œå°±æ˜¯åªè´Ÿè´£æ‰¾åˆ°å¯¹åº”çš„ä¸»æœºã€‚</li><li>ç½‘ç»œæ¥å£å±‚ï¼Œæœ‰æ—¶å€™ä¹Ÿè¢«ç§°ä¸ºæ•°æ®é“¾è·¯å±‚æˆ–é“¾è·¯å±‚ï¼Œé€šå¸¸åŒ…æ‹¬æ“ä½œç³»ç»Ÿä¸­çš„è®¾å¤‡é©±åŠ¨ç¨‹åºå’Œè®¡ç®—æœºçš„ç½‘å¡è®¾å¤‡ï¼Œå®ƒä»¬ä¸€èµ·å¤„ç†ä¸ç‰©ç†ä¼ è¾“åª’ä»‹çš„é€šä¿¡ç»†èŠ‚ã€‚</li></ol><h2 id="_4-ipåœ°å€ã€structä»¥åŠåœ°å€è½¬æ¢" tabindex="-1"><a class="header-anchor" href="#_4-ipåœ°å€ã€structä»¥åŠåœ°å€è½¬æ¢" aria-hidden="true">#</a> 4. IPåœ°å€ã€structä»¥åŠåœ°å€è½¬æ¢</h2><p>ç»ˆäºè¦è®²ç‚¹å¥½ç©å„¿çš„ä¸œè¥¿äº†ï¼Œè¿™ä¸€ç« æˆ‘ä»¬è¦å¼€å§‹å†™ä¸€ç‚¹ä»£ç äº†ã€‚</p><p>ä½†æ˜¯é¦–å…ˆï¼Œæˆ‘ä»¬è¿˜å¾—å†èŠä¸€äº›ä¸ä»£ç æ— å…³çš„ä¸œè¥¿ã€‚</p><p>å…ˆç¨å¾®ä»‹ç»ä¸€ç‚¹IP addressï¼ˆIPåœ°å€ï¼‰å’Œportï¼ˆç«¯å£ï¼‰çš„çŸ¥è¯†ï¼Œå…¥ä¸ªé—¨ï¼›ç„¶åæˆ‘ä»¬ä¼šè®¨è®ºsocket APIæ˜¯å¦‚ä½•å­˜å‚¨å’Œæ“ä½œIP addressä»¥åŠå…¶ä»–æ•°æ®çš„ã€‚</p><h3 id="_4-1-ipv4ä¸ipv6" tabindex="-1"><a class="header-anchor" href="#_4-1-ipv4ä¸ipv6" aria-hidden="true">#</a> 4.1. IPv4ä¸IPv6</h3><p>è¿œåœ¨ã€Œå§é¾™å‡¤é›ã€æˆä¸ºè´¬ä¹‰è¯ä¹‹å‰ï¼Œå°±æœ‰ä¸€ä¸ªå¾ˆæ£’çš„ç½‘ç»œè·¯ç”±ç³»ç»Ÿï¼ˆ network routing systemï¼‰äº†ï¼Œç§°ä¸º<strong>äº’è”ç½‘é€šä¿¡åè®®ç¬¬å››ç‰ˆ</strong>ï¼ˆ Internet Protocol Version 4ï¼‰ï¼Œåˆç§°ä¸º IPv4ã€‚å®ƒçš„åœ°å€ç”±4ä¸ªå­—èŠ‚ç»„æˆï¼Œé€šå¸¸è¢«å†™ä½œ<strong>ç‚¹åˆ†åè¿›åˆ¶</strong>çš„å½¢å¼ï¼Œå³å››ä¸ªå­—èŠ‚è¢«åˆ†å¼€ç”¨åè¿›åˆ¶å†™å‡ºï¼Œä¸­é—´ç”¨ç‚¹åˆ†éš”ï¼Œæ¯”å¦‚ï¼š<code>192.0.2.111</code>ã€‚</p><p>ä½ å¤§æ¦‚ç‡è§è¿‡ä¸å°‘IPv4çš„åœ°å€äº†ã€‚</p><p>å®é™…ä¸Šï¼Œåœ¨æ’°å†™æœ¬æ–‡ä¹‹å‰ï¼Œå‡ ä¹æ•´ä¸ªäº’è”ç½‘çš„å„ä¸ªç½‘ç«™éƒ½è¿˜ç”¨çš„æ˜¯IPv4ã€‚</p><p>äººä»¬ç”¨IPv4ç”¨çš„å¾ˆå¼€å¿ƒï¼Œä¸€åˆ‡éƒ½æ˜¯å¦‚æ­¤ç¾å¥½ã€‚ç›´åˆ°ä¸€ä¸ªå« Vint Cerf çš„è€å¤´å„¿æå‡ºäº†è­¦å‘Šï¼Œè¯´æ˜¯IPv4çš„åœ°å€å³å°†è€—å°½ã€‚</p><blockquote><p>é™¤äº†è­¦å‘Šæ¯ä¸ªäººå³å°†åˆ°æ¥çš„IPv4å±æœºï¼Œ<a href="https://en.wikipedia.org/wiki/Vint_Cerf" target="_blank" rel="noopener noreferrer">Vint Cerf<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> æœ¬èº«è¿˜æ˜¯é¼é¼å¤§åçš„â€œInternetä¹‹çˆ¶â€ï¼Œæˆ‘å®åœ¨æ˜¯æ²¡æœ‰ä»€ä¹ˆèµ„æ ¼è¯„åˆ¤ä»–çš„åˆ¤æ–­ã€‚</p></blockquote><p>IPv4åœ°å€è€—å°½ï¼Ÿè¿™æ€ä¹ˆå¯èƒ½å‘¢ï¼Ÿ32-bitçš„IPv4æœ‰å‡ åäº¿ä¸ªIPåœ°å€å‘¢ï¼Œæˆ‘ä»¬çœŸçš„æœ‰å‡ åäº¿å°ç”µè„‘åœ¨ç”¨å—ï¼Ÿ</p><p>æ˜¯çš„ã€‚</p><p>ä¸€å¼€å§‹åœ¨ç”µè„‘æ•°é‡è¿˜ä¸å¤šçš„æ—¶å€™ï¼Œå¤§å®¶ä¹Ÿæ˜¯è®¤ä¸ºè¿™ä¸ªæ•°é‡å·²ç»è¶³å¤Ÿäº†ï¼Œå‡ åäº¿å·²ç»ç®—æ˜¯ä¸€ä¸ªå¤©æ–‡æ•°å­—äº†ã€‚ç”šè‡³å½“æ—¶è¿˜å¾ˆæ…·æ…¨åœ°åˆ†ç»™æŸäº›å¤§å‹ç»„ç»‡å‡ ç™¾ä¸‡ä¸ªIPåœ°å€ç»™ä»–ä»¬ä½¿ç”¨ï¼ˆæ¯”å¦‚Xeroxã€MITã€Fordã€HPã€IBMã€GEã€AT&amp;T åŠæŸä¸ªåä¸º Apple çš„å°å…¬å¸ï¼Œç­‰ç­‰ï¼‰ã€‚</p><p>äº‹å®ä¸Šï¼Œè¦ä¸æ˜¯æˆ‘ä»¬ç”¨äº†ä¸€äº›å°æ‰‹æ®µï¼ˆNATè½¬æ¢ç­‰ï¼‰ï¼ŒIPv4æ—©å°±è¢«ç”¨å°½äº†ã€‚</p><p>æˆ‘ä»¬ç°åœ¨ç”Ÿæ´»äºæ¯ä¸ªäººã€æ¯å°ç”µè„‘ã€æ¯éƒ¨è®¡ç®—å™¨ã€æ¯ä¸ªç”µè¯ã€æ¯éƒ¨åœè½¦è®¡æ—¶æ”¶è´¹å™¨ï¼Œç”šè‡³æ˜¯æ¯ä¸ªç©å…·å°ç‹—ï¼ˆæ²¡ä»€ä¹ˆä¸å¯èƒ½çš„ï¼‰éƒ½æœ‰ä¸€ä¸ªIPåœ°å€çš„æ—¶ä»£ã€‚</p><p>äºæ˜¯ä¹ï¼Œ128-bitçš„IPv6è¯ç”Ÿäº†ã€‚</p><p>Vint Cerf æˆ–è®¸æ˜¯ä¸æœ½çš„ï¼Œå¯æ˜¯è°ä¹Ÿæ¶ä¸ä½åœ¨æ¯æ¬¡åœ°å€ä¸å¤Ÿç”¨è€Œç ”å‘ä¸‹ä¸€ä»£Internetåè®®çš„æ—¶å€™ï¼Œä»–è€äººå®¶å‡ºæ¥å˜Ÿå›”ä¸€å¥ï¼šâ€œæˆ‘æ—©å°±è¯´è¿‡äº†å§...ã€‚ã€‚ã€‚â€</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆå µä½ä»–çš„å˜´ï¼Ÿ</p><p>æˆ‘ä»¬éœ€è¦æ›´å¤šçš„åœ°å€ï¼Œä¸åªæ˜¯éœ€è¦ä¸¤å€ä»¥ä¸Šçš„åœ°å€ã€ä¹Ÿä¸æ­¢å‡ åäº¿å€ã€æ›´ä¸æ­¢äºåƒå…†å€ï¼Œè€Œæ˜¯éœ€è¦79âœ–ï¸ç™¾ä¸‡âœ–ï¸åäº¿âœ–ï¸å…†å€ä»¥ä¸Šçš„å¯ç”¨åœ°å€ï¼æˆ‘ä»¬ç»ˆå°†è§è¯†åˆ°ã€‚</p><p>ä½ å¯èƒ½ä¼šè¯´ï¼šâ€œçœŸçš„å—ï¼Ÿè¿™ä¸ªæ•°å­—å¤§çš„è®©æˆ‘æœ‰ç‚¹ä¸å¯ç½®ä¿¡ã€‚â€</p><p>32-bitå’Œ128-bitå¬èµ·æ¥å·®å¾—å¹¶ä¸ç®—å¤ªå¤šï¼Œåªæ˜¯å¤šäº†96ä¸ªbitè€Œå·²ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œè¯´çš„å¯æ˜¯ç­‰æ¯”æ•°åˆ—ï¼Œ32 bitså¯ä»¥è¡¨ç¤º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup></mrow><annotation encoding="application/x-tex">2^{32}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span></span></span></span></span></span></span></span></span> ä¸ªæ•°å­—ï¼Œ128 bitså¯ä»¥è¡¨ç¤º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>128</mn></msup></mrow><annotation encoding="application/x-tex">2^{128}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">128</span></span></span></span></span></span></span></span></span></span></span></span>ï¼ˆå¤§çº¦340ä¸ªå…†å…†å…†ï¼‰ä¸ªæ•°å­—ï¼Œå¤§åˆ°æˆ‘éƒ½ä¸çŸ¥é“æ€ä¹ˆè¯»ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚è¿™ä¹ˆè¯´å§ï¼Œè¿™ä¸ªæ•°å­—ç›¸å½“äºå®‡å®™ä¸­çš„æ¯é¢—æ˜Ÿæ˜Ÿéƒ½èƒ½æ‹¥æœ‰ä¸€ç™¾ä¸‡ä¸ª IPv4 åœ°å€ã€‚</p><p>å¿˜è®°ç‚¹åˆ†åè¿›åˆ¶çš„IPv4çš„å†™æ³•å§ï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†16è¿›åˆ¶è¡¨ç¤ºæ³•ï¼Œæ¯ä¸¤ä¸ªå­—èŠ‚ä¹‹é—´ç”¨<code>:</code>åˆ†éš”ï¼Œç±»ä¼¼è¿™æ ·ï¼š</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>2001:0db8:c9d2:aee5:73e3:934a:a5ae:9551
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿˜æ²¡å®Œå‘¢ï¼å¤§å¤šæ—¶å€™ï¼ŒIPåœ°å€é‡Œè¾¹ä¼šæœ‰å¾ˆå¤šä¸ª0ï¼Œä½ å¯ä»¥å°†å®ƒä»¬å‹ç¼©åˆ°ä¸¤ä¸ªå†’å·ä¹‹é—´ï¼Œè€Œä¸”å¯ä»¥çœç•¥æ¯ä¸ªå­—èŠ‚å¯¹å¼€å¤´çš„0ã€‚ä¾‹å¦‚ï¼Œè¿™äº›åœ°å€å¯¹ä¸­çš„æ¯ä¸€å¯¹éƒ½æ˜¯ç­‰ä»·çš„ï¼š</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>2001:0db8:c9d2:0012:0000:0000:0000:0051
2001:db8:c9d2:12::51
    
2001:0db8:ab00:0000:0000:0000:0000:0000
2001:db8:ab00::
    
0000:0000:0000:0000:0000:0000:0000:0001
::1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ°å€ <code>::1</code> æ˜¯å€‹ loopbackï¼ˆæœ¬åœ°å›ç¯ï¼‰åœ°å€ï¼Œç›¸å½“äº IPv4 ä¸­çš„<code>127.0.0.1</code>ã€‚</p><p>æœ€åï¼Œä½ å¯èƒ½ä¼šç¢°åˆ° IPv6 ä¸ IPv4 å…¼å®¹çš„æ¨¡å¼ã€‚ä½ å¦‚æœæ„¿æ„ï¼Œä½ å¯ä»¥å°† IPv4åœ°å€ <code>192.0.2.33</code> ç”¨ IPv6 å½¢å¼è¡¨ç¤ºï¼š<code>::ffff:192.0.2.33</code>ã€‚</p><p>äº‹å®ä¸Šï¼ŒIPv6çš„åˆ›å»ºè€…ä»¬å·²ç»è‚†æ— å¿Œæƒ®åœ°ä¿ç•™äº†ä¸‡äº¿è®¡çš„åœ°å€ä»¥ä¾›å¤‡ç”¨ï¼Œè¿™çœŸæ˜¯å¤ªæœ‰è¶£äº†ï¼Œä½†å¦ç™½åœ°è®²ï¼Œæˆ‘ä»¬æœ‰è¿™ä¹ˆå¤šåœ°å€ï¼Œè°åœ¨æ„å‘¢ï¼Ÿ</p><h4 id="_4-1-1-å­ç½‘" tabindex="-1"><a class="header-anchor" href="#_4-1-1-å­ç½‘" aria-hidden="true">#</a> 4.1.1. å­ç½‘</h4><p>ç°ä»£çš„äº’è”ç½‘æ˜¯åŸºäº<code>TCP/IP</code>çš„æ€è·¯æ¥è®¾è®¡çš„ï¼Œè¯´å¾—é€šä¿—ç‚¹å°±æ˜¯äº’è”ç½‘ç”±è®¸è®¸å¤šå¤šçš„å°å­ç½‘ç»„æˆï¼Œå­ç½‘ä¸­çš„è®¾å¤‡ç”¨é›†çº¿å™¨è¿›è¡Œè¿æ¥ï¼Œå­ç½‘ä¹‹é—´é€šè¿‡è·¯ç”±å™¨è¿›è¡Œäº’è”ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://qiniu.chanmufeng.com/2022-10-03-040038.png" alt="image-20221003120038276" loading="lazy"></p><p>ä¸ºäº†æ›´å¥½åœ°ç®¡ç†IPåœ°å€ï¼ˆå…¶å®ä¹Ÿæ˜¯è·µè¡Œä¸Šé¢è¿™ä¸ªæ€è·¯ï¼‰ï¼ŒIPåœ°å€æœ¬èº«è¢«åˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ç½‘ç»œå·å’Œä¸»æœºå·ã€‚</p><p>æ›´å…·ä½“åœ°ï¼Œäº’è”ç½‘è¯ç”Ÿä¹‹åˆï¼ŒIPåœ°å€æ›¾ç»è¢«åˆ†æˆäº†<code>A</code>ã€<code>B</code>ã€<code>C</code>ã€<code>D</code>ã€<code>E</code> 5ç±»ï¼Œå¾ˆå¤šè®¡ç®—æœºç½‘ç»œçš„ä¹¦ä»‹ç»IPåœ°å€çš„æ—¶å€™ä¹Ÿæ˜¯ä»¥è¿™ä¸ªåˆ†ç±»å¼€å§‹çš„ã€‚</p><p>ä½†æ˜¯è¿™ä¸ªåˆ’åˆ†ä¾ç„¶æ˜¯ä¸€ä¸ªå†å²æ¦‚å¿µï¼Œå®é™…ä½¿ç”¨ä¸­å·²ç»æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼å› æ­¤å…³äºè¿™éƒ¨åˆ†çŸ¥è¯†çš„è®²è¿°éƒ½å¯ä»¥ç›´æ¥å¿½ç•¥ã€‚</p><p>å–è€Œä»£ä¹‹çš„æ˜¯åœ¨1993å¹´ï¼Œå› ç‰¹ç½‘å·¥ç¨‹ä»»åŠ¡ç»„IETFåˆæå‡ºäº†<strong>æ— åˆ†ç±»ç¼–å€</strong>ï¼ˆCIDRï¼‰çš„æ–¹æ³•æ¥è§£å†³IPv4åœ°å€ç´§ç¼ºçš„é—®é¢˜ï¼Œå½“ç„¶äº†ï¼ŒåŒæ—¶å¯åŠ¨çš„è¿˜æœ‰å½»åº•è§£å†³IPåœ°å€è€—å°½é—®é¢˜çš„IPv6é¡¹ç›®ã€‚</p><p>åœ¨äº’è”ç½‘ä¸­ï¼Œæ¯ä¸ªè®¾å¤‡éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªIPåœ°å€ï¼ˆå…¶å®è¢«åˆ†é…IPåœ°å€çš„æ˜¯è®¾å¤‡ä¸Šçš„ç½‘å¡ï¼Œå¦‚æœä¸€å°è®¾å¤‡æœ‰å¤šä¸ªç½‘å¡ï¼Œè‡ªç„¶å°±ä¼šæœ‰å¤šä¸ªIPåœ°å€ï¼‰ï¼Œè¿™ä¸ªåœ°å€å°±ç›¸å½“äºâ€œXXè·¯XXå·â€ï¼Œå…¶ä¸­â€œè·¯â€å°±ç›¸å½“äºç½‘ç»œå·ï¼Œâ€œå·â€å°±ç›¸å½“äºä¸»æœºå·ï¼Œä¸¤è€…åˆèµ·æ¥å°±æ˜¯IPåœ°å€å•¦ï¼</p><p>å› æ­¤ï¼Œç†è®ºä¸Šæˆ‘ä»¬åº”è¯¥èƒ½é€šè¿‡IPåœ°å€è¯†åˆ«å‡ºä¸»æœºå¤„äºçš„å­ç½‘å·ï¼Œä»¥åŠå­ç½‘ä¸‹çš„ä¸»æœºå·ã€‚</p><p>IPv4çš„IPåœ°å€ç”±<code>32</code>ä¸ªbitç»„æˆï¼ŒæŒ‰ç…§æ¯<code>8</code>ä¸ªæ¯”ç‰¹ï¼ˆ1å­—èŠ‚ï¼‰ä¸ºä¸€ç»„åˆ†æˆ4ç»„ï¼Œä½†æ˜¯ä»…å‡­è¿™ä¸€ä¸²æ•°å­—æ ¹æœ¬æ— æ³•åŒºåˆ†å“ªéƒ¨åˆ†æ˜¯ç½‘ç»œå·ï¼Œå“ªéƒ¨åˆ†æ˜¯ä¸»æœºå·ã€‚</p><p>å› æ­¤éœ€è¦æŸäº›é™„åŠ ä¿¡æ¯ã€‚è¿™ä¸ªé™„åŠ ä¿¡æ¯å°±æ˜¯<strong>å­ç½‘æ©ç </strong>ã€‚</p><p>å­ç½‘æ©ç çš„æ ¼å¼æ˜¯ä¸€ä¸²ä¸IPåœ°å€é•¿åº¦ç›¸åŒçš„<code>32</code>æ¯”ç‰¹æ•°å­—ï¼Œå·¦è¾¹æ˜¯ä¸€ä¸²è¿ç»­çš„<code>1</code>ï¼Œå³è¾¹å‰©ä¸‹çš„éƒ½æ˜¯<code>0</code>ã€‚å…¶ä¸­ä¸º<code>1</code>çš„é‚£ä¸€éƒ¨åˆ†è¡¨ç¤ºçš„æ˜¯ç½‘ç»œå·ï¼Œå‰©ä¸‹ä¸º<code>0</code>çš„ä¸€éƒ¨åˆ†è¡¨ç¤ºçš„æ˜¯ä¸»æœºå·ã€‚å­ç½‘æ©ç è¡¨ç¤ºç½‘ç»œå·ä¸ä¸»æœºå·ä¹‹é—´çš„è¾¹ç•Œï¼Œæ­£è§„çš„è¡¨ç¤ºæ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="http://qiniu.chanmufeng.com/2022-10-03-130009.png" alt="image-20221003210009224" loading="lazy"></p><p>ä¸€ç§æœ€ç®€å•çš„è¡¨ç¤ºæ–¹æ³•æ˜¯ï¼ŒæŠŠ<code>1</code>çš„éƒ¨åˆ†çš„æ¯”ç‰¹æ•°ç”¨åè¿›åˆ¶çš„æ–¹å¼å†™åœ¨IPåœ°å€çš„å³ä¾§ï¼Œæ¯”å¦‚ï¼š</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>182.92.193.45/24
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_4-1-2-ç«¯å£å·" tabindex="-1"><a class="header-anchor" href="#_4-1-2-ç«¯å£å·" aria-hidden="true">#</a> 4.1.2. ç«¯å£å·</h4><p>å¦‚æœä½ é‚„è¨˜å¾—æˆ‘ä¹‹å‰è·Ÿä½ èªªéçš„åˆ†å±¤ç¶²è·¯æ¨¡å‹ï¼ˆLayered Network Modelï¼‰ï¼Œå®ƒå°‡ç¶²è·¯å±¤ï¼ˆIPï¼‰èˆ‡ä¸»æ©Ÿåˆ°ä¸»æ©Ÿé–“çš„å‚³è¼¸å±¤ï¼»TCP èˆ‡ UDPï¼½åˆ†é–‹ã€‚</p><p>æˆ‘å€‘è¦åŠ å¿«è…³æ­¥äº†ã€‚</p><p>é™¤äº† IP address ä¹‹å¤–ï¼»IP å±¤ï¼½ï¼Œæœ‰å¦ä¸€å€‹ TCPï¼»stream socketï¼½ä½¿ç”¨çš„ä½å€ï¼Œå‰›å¥½ UDPï¼»datagram socketï¼½ä¹Ÿç”¨é€™å€‹ï¼Œå°±æ˜¯ port numberï¼Œé€™æ˜¯ä¸€å€‹ 16-bit çš„æ•¸å­—ï¼Œå°±åƒæ˜¯é€£ç·šçš„æœ¬åœ°ç«¯ä½å€ä¸€æ¨£ã€‚</p><p>å°‡ IP address æƒ³æˆé£¯åº—çš„åœ°å€ï¼Œè€Œ port number å°±æ˜¯é£¯åº—çš„æˆ¿é–“è™Ÿç¢¼ã€‚é€™æ˜¯è²¼åˆ‡çš„æ¯”å–»ï¼›æˆ–è¨±ä»¥å¾Œæˆ‘æœƒç”¨æ±½è»Šå·¥æ¥­ä¾†æ¯”å–»ã€‚</p><p>ä½ èªªæƒ³è¦æœ‰ä¸€å°é›»è…¦èƒ½è™•ç†æ”¶åˆ°çš„é›»å­éƒµä»¶èˆ‡ç¶²é æœå‹™ï¼ä½ è¦å¦‚ä½•åœ¨ä¸€å°åªæœ‰ä¸€å€‹ IP address çš„é›»è…¦ä¸Šåˆ†è¾¨é€™äº›å°åŒ…å‘¢ï¼Ÿ</p><p>å¥½ï¼ŒInternet ä¸Šä¸åŒçš„æœå‹™éƒ½æœ‰å·²çŸ¥çš„ï¼ˆwell-knownï¼‰port numbersã€‚ä½ å¯ä»¥åœ¨ Big IANA Port æ¸…å–® [12] ä¸­æ‰¾åˆ°ï¼Œå¦‚æœä½ ç”¨çš„æ˜¯ Unix ç³»çµ±ï¼Œä½ å¯ä»¥åƒè€ƒæª”æ¡ˆ /etc/servicesã€‚HTTPï¼ˆç¶²ç«™ï¼‰æ˜¯ port 80ã€telnet æ˜¯ port 23ã€SMTP æ˜¯ port 25ï¼Œè€Œ DOOM éŠæˆ² [13] ä½¿ç”¨ port 666 ç­‰ï¼Œè«¸å¦‚æ­¤é¡ã€‚Port 1024 ä»¥ä¸‹é€šå¸¸æ˜¯æœ‰ç‰¹åœ°ç”¨é€”çš„ï¼Œè€Œä¸”è¦æœ‰ä½œæ¥­ç³»çµ±ç®¡ç†å“¡æ¬Šé™æ‰èƒ½ä½¿ç”¨ã€‚</p><p>æ‘ï¼Œé€™å°±æ˜¯ port number çš„ä»‹ç´¹ã€‚</p><h3 id="_4-2-å­—èŠ‚åº" tabindex="-1"><a class="header-anchor" href="#_4-2-å­—èŠ‚åº" aria-hidden="true">#</a> 4.2. å­—èŠ‚åº</h3><h4 id="_4-2-1-ä»€ä¹ˆæ˜¯å­—èŠ‚åº" tabindex="-1"><a class="header-anchor" href="#_4-2-1-ä»€ä¹ˆæ˜¯å­—èŠ‚åº" aria-hidden="true">#</a> 4.2.1. ä»€ä¹ˆæ˜¯å­—èŠ‚åº</h4><p>å­—èŠ‚æ˜¯å†…å­˜è¯»å†™çš„æœ€å°å•ä½ï¼Œä¸€ä¸ªå­—èŠ‚èƒ½å¤Ÿè¡¨ç¤ºçš„æ•°æ®èŒƒå›´æ˜¯0ï½255ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœä½ è¦ä¿å­˜ä¸€ä¸ªåœ¨æ­¤èŒƒå›´åŒºé—´çš„æ•°å­—ï¼Œä¸€ä¸ªå­—èŠ‚è¶³çŸ£ã€‚</p><p>ä½†æ˜¯åƒå 4ä¸ªå­—èŠ‚çš„<code>int</code>ï¼Œ8ä¸ªå­—èŠ‚çš„<code>double</code>ï¼Œè¯¥æ€ä¹ˆå­˜å‚¨å‘¢ï¼Ÿå¤šä¸ªå­—èŠ‚è¯¥ç”¨æ€æ ·çš„é¡ºåºæ¥è¿›è¡Œæ’åˆ—ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œ<code>0xb3f4</code>ï¼Œæ•°å€¼çš„é«˜ä½<code>b3</code>æ˜¯å­˜å‚¨åœ¨äº†å†…å­˜çš„é«˜åœ°å€å¤„ï¼Œè¿˜æ˜¯å†…å­˜çš„ä½åœ°å€å¤„å‘¢ï¼Ÿ</p><p>è¿™ç§å­—èŠ‚çš„æ’åˆ—é¡ºåºå°±å«åšå­—èŠ‚åºï¼Œå­—èŠ‚åºæœ‰ä¸¤ç§ï¼š</p><ol><li>å¤§ç«¯å­—èŠ‚åº</li></ol><p>æ•°å€¼çš„ä½å­—èŠ‚æ”¾åœ¨å†…å­˜çš„ä½åœ°å€å¤„ï¼Œæ•°å€¼çš„é«˜å­—èŠ‚æ”¾åœ¨å†…å­˜çš„é«˜åœ°å€ã€‚</p><ol start="2"><li>å°ç«¯å­—èŠ‚åº</li></ol><p>æ•°å€¼çš„ä½å­—èŠ‚æ”¾åœ¨å†…å­˜çš„é«˜åœ°å€å¤„ï¼Œæ•°å€¼çš„é«˜å­—èŠ‚æ”¾åœ¨å†…å­˜çš„ä½åœ°å€ã€‚</p><h4 id="_4-2-2-ä¸»æœºå­—èŠ‚åº" tabindex="-1"><a class="header-anchor" href="#_4-2-2-ä¸»æœºå­—èŠ‚åº" aria-hidden="true">#</a> 4.2.2. ä¸»æœºå­—èŠ‚åº</h4><p>å½“æˆ‘ä»¬è°ˆè®ºå­—èŠ‚åºï¼Œå¤§éƒ¨åˆ†æ—¶å€™å¯¹åº”çš„éƒ½æ˜¯CPUè®¿é—®å†…å­˜æ—¶çš„æ¦‚å¿µï¼Œæ¯”å¦‚å¯¹ä¸‹å›¾è€Œè¨€ï¼š</p><p><img src="http://qiniu.chanmufeng.com/2022-10-06-030645.png" alt="image-20221006110645258" loading="lazy"></p><p>å†…å­˜ä½ä½å­˜å‚¨çš„å­—èŠ‚æ˜¯<code>0xb3</code>ï¼Œé«˜ä½å­˜å‚¨çš„æ˜¯<code>0xf4</code>ï¼Œè‡³äºCPUè¯»å–è¿™ä¸ª2å­—èŠ‚æ•°æ®çš„æ—¶å€™ï¼Œæ˜¯å°†å…¶è§£é‡Šä¸º<code>0xb3f4</code>ï¼ˆå°ç«¯ï¼‰è¿˜æ˜¯<code>0xf4b3</code>ï¼ˆå¤§ç«¯ï¼‰å°±å–å†³äºCPUé‡‡ç”¨çš„æ˜¯å“ªä¸€ç§å­—èŠ‚åºäº†ã€‚</p><p>å¸¸ç”¨çš„CPUå­—èŠ‚åºå¦‚ä¸‹ï¼š</p><ul><li><p>å¤§ç«¯å­—èŠ‚åºï¼šIBMã€PowerPC</p></li><li><p>å°ç«¯å­—èŠ‚åºï¼šx86</p></li></ul><p>è¿™ç§CPUå­—èŠ‚åºä¹Ÿè¢«ç§°ä¸º<strong>ä¸»æœºå­—èŠ‚åºï¼ˆHost Byte Orderï¼‰</strong>ã€‚ç¿»è¯‘ä¸€ä¸‹å°±æ˜¯ï¼ŒIBMçš„ä¸»æœºåºæ˜¯å¤§ç«¯ï¼Œx86çš„ä¸»æœºåºæ˜¯å°ç«¯ã€‚</p><p>é—®é¢˜æ¥äº†ã€‚</p><p>ä¸–ç•Œä¸Šçš„ä¸»æœºè¿™ä¹ˆå¤šï¼Œæ¯å°ä¸»æœºçš„CPUç±»å‹è¿˜ä¸ä¸€æ ·ï¼ŒAä¸»æœºæŒ‰ç…§Açš„ä¸»æœºå­—èŠ‚åºå‘ä¿¡æ¯ç»™Bä¸»æœºï¼ŒBä¸»æœºå¦‚æœç›´æ¥æŒ‰ç…§Bçš„ä¸»æœºå­—èŠ‚åºæ¥è§£æä¿¡æ¯ï¼Œé‚£ä¹ˆææœ‰å¯èƒ½ä¼šäº§ç”Ÿé”™è¯¯ã€‚</p><p>è¦æƒ³è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿˜å¿…é¡»å¼•å‡ºä¸€äº›å…¶ä»–æƒ…å†µä¸‹çš„å­—èŠ‚åºã€‚</p><blockquote><p>ä¸ºäº†é¿å…å¼•èµ·æ··æ·†ï¼Œæˆ‘åœ¨è¿™é‡Œå¼ºè°ƒä¸€ä¸‹ï¼Œå­—èŠ‚åºå°±åˆ†ä¸º2ç§ï¼Œå¤§ç«¯å’Œå°ç«¯ã€‚è€Œæ‰€è°“çš„ä¸»æœºå­—èŠ‚åºä»¥åŠä¸‹é¢æˆ‘å°†æåˆ°çš„ä¸¤ç§ï¼Œéƒ½åªæ˜¯å­—èŠ‚åºä½œç”¨åœ¨ä¸åŒçš„åœºæ™¯ä¸­å–å¾—ç‰¹å®šåç§°ç½¢äº†ã€‚</p></blockquote><h4 id="_4-2-3-æ–‡ä»¶å­˜å‚¨å­—èŠ‚åº" tabindex="-1"><a class="header-anchor" href="#_4-2-3-æ–‡ä»¶å­˜å‚¨å­—èŠ‚åº" aria-hidden="true">#</a> 4.2.3. æ–‡ä»¶å­˜å‚¨å­—èŠ‚åº</h4><p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å­˜å‚¨æ–‡ä»¶ä¿¡æ¯çš„æ—¶å€™ç”¨çš„æ˜¯å¤§ç«¯è¿˜æ˜¯å°ç«¯ã€‚</p><p>bmpæ ¼å¼çš„å›¾ç‰‡å±äºå°ç«¯å­—èŠ‚åºï¼Œjpegæ ¼å¼çš„å›¾ç‰‡å°±æ˜¯å¤§ç«¯å­—èŠ‚åºã€‚</p><p>è¿™é‡ŒæåŠæ–‡ä»¶å­˜å‚¨å­—èŠ‚åºä¸»è¦æ˜¯ä¸ºäº†è®©å¤§å®¶ç†è§£ä¸€ä¸ªäº‹å®ï¼š<strong>é‡‡ç”¨ä»€ä¹ˆå­—èŠ‚åºå®Œå…¨æ˜¯å¼€å‘è€…è®¾è®¡äº§å“æ—¶çš„ä¸€ç§æŠ€æœ¯é€‰å‹ç½¢äº†</strong>ã€‚ä½†æ˜¯è¿™ç§é€‰å‹ä¸€å®šè¦æˆä¸ºä¸€ç§æ ‡å‡†ï¼Œè®©å…¶ä»–å¼€å‘è€…è§£æçš„æ—¶å€™æ˜ç™½åº”è¯¥ç”¨å“ªç§å­—èŠ‚åºï¼Œå¦åˆ™jpegçš„å›¾ç‰‡ä¹Ÿå°±æ²¡åŠæ³•åœ¨æ‰€æœ‰çš„ç”µè„‘ä¸Šæ­£å¸¸æ˜¾ç¤ºäº†ï¼Œä½ è¯´å¯¹å—ï¼Ÿ</p><p>ç°åœ¨å¥½äº†ï¼Œæ‰€æœ‰jpegè½¯ä»¶çš„å¼€å‘è€…éƒ½çŸ¥é“åº”è¯¥ç”¨å¤§ç«¯å­—èŠ‚åºæ¥ä¿å­˜jpegå›¾ç‰‡ï¼Œä½†æ˜¯å¯¹äºä»å…¶ä»–ä¸»æœºä¼ è¿‡æ¥çš„jpegæ•°æ®æµï¼Œå¼€å‘è€…åˆæ€ä¹ˆçŸ¥é“è¿™ä¸ªæ•°æ®æµç”¨çš„æ˜¯å¤§ç«¯è¿˜æ˜¯å°ç«¯å‘¢ï¼Ÿ</p><p>è¿™å°±æ˜¯<strong>ç½‘ç»œå­—èŠ‚åºï¼ˆNetwork Byte Orderï¼‰</strong> çš„é—®é¢˜äº†ã€‚</p><h4 id="_4-2-4-ç½‘ç»œå­—èŠ‚åº" tabindex="-1"><a class="header-anchor" href="#_4-2-4-ç½‘ç»œå­—èŠ‚åº" aria-hidden="true">#</a> 4.2.4. ç½‘ç»œå­—èŠ‚åº</h4><p>æˆ‘æƒ³ä½ åº”è¯¥èƒ½æƒ³æ˜ç™½äº†ï¼Œç½‘ç»œå­—èŠ‚åºä¸æ˜¯å¤§ç«¯å°±æ˜¯å°ç«¯ï¼Œä¸å¯èƒ½å­˜åœ¨ã€Œå¯èƒ½æ˜¯å¤§ç«¯ä¹Ÿå¯èƒ½æ˜¯å°ç«¯ã€è¿™ç§æƒ…å†µï¼Œå¦åˆ™ç½‘ç»œä¼ é€’çš„æ¶ˆæ¯å…¨éƒ½ä¹±å¥—äº†ï¼</p><p>TCP/IPæ—¢ç„¶æ˜¯ä¸€ç§æ ‡å‡†ï¼Œé‚£æ ‡å‡†è‡ªç„¶å°±æœ‰è‡ªå·±çš„å­—èŠ‚åºè§„å®šã€‚</p><p><strong>TCP/IPç½‘ç»œé‡‡ç”¨çš„æ˜¯å¤§ç«¯ï¼Œæ˜¯è§„å®šå¥½çš„ä¸€ç§æ•°æ®è¡¨ç¤ºæ ¼å¼ï¼Œå®ƒä¸å…·ä½“çš„CPUç±»å‹ã€æ“ä½œç³»ç»Ÿç­‰æ— å…³ï¼Œä»è€Œå¯ä»¥ä¿è¯æ•°æ®åœ¨ä¸åŒä¸»æœºä¹‹é—´ä¼ è¾“æ—¶èƒ½å¤Ÿè¢«æ­£ç¡®è§£é‡Šã€‚</strong></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½ æƒ³è®©ä½ çš„æ¶ˆæ¯èƒ½åœ¨å…¶ä»–è®¾å¤‡æ­£å¸¸è§£æï¼Œå°±å¿…é¡»æŒ‰ç…§å¤§ç«¯å­—èŠ‚åºè¿›è¡Œå¤„ç†ã€‚æ¯”å¦‚ï¼Œç½‘ç»œä¼ è¾“çš„æ˜¯<code>0x12345678</code>è¿™ä¸ªæ•´å½¢å˜é‡ï¼Œé¦–å…ˆè¢«å‘é€çš„åº”è¯¥æ˜¯<code>0x12</code>ï¼Œæ¥ç€æ˜¯<code>0x34</code>ï¼Œç„¶åæ˜¯<code>0x56</code>ï¼Œæœ€åæ˜¯<code>0x78</code>ã€‚</p><h4 id="_4-2-5-å­—èŠ‚åºåœ¨socketä¸­çš„ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#_4-2-5-å­—èŠ‚åºåœ¨socketä¸­çš„ä¾‹å­" aria-hidden="true">#</a> 4.2.5. å­—èŠ‚åºåœ¨socketä¸­çš„ä¾‹å­</h4><p>å½“ä½ åœ¨ç½‘ç»œå°åŒ…æˆ–è€…åœ¨å¡«å……æ•°æ®çš„æ—¶å€™ï¼Œä½ éœ€è¦ç¡®å®šä½ çš„ç«¯å£å·ï¼ˆport numberï¼‰å’Œipåœ°å€éƒ½æ˜¯ç¬¦åˆç½‘ç»œå­—èŠ‚åºçš„ã€‚ä½†æ˜¯ä½ å¹¶ä¸çŸ¥é“ä½ çš„ä¸»æœºå­—èŠ‚åºæ˜¯å¤§ç«¯è¿˜æ˜¯å°ç«¯ï¼Œä½ è‡ªç„¶ä¹Ÿå°±æä¸æ¸…ä½ åˆ°åº•éœ€ä¸éœ€è¦è¿›è¡Œè½¬æ¢ã€‚</p><p>å…¶å®ä¸å¿…å¦‚æ­¤è´¹ç¥ï¼Œä¸ç”¨åœ¨æ„ä¸»æœºåºï¼Œç›´æ¥è°ƒç”¨å‡½æ•°å¼ºè¡Œå°†ä¸»æœºåºè½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åºå³å¯ã€‚ä¸‹é¢ä¸¾ä¸€ä¸ªCè¯­è¨€ç¼–å†™æœåŠ¡å™¨ä»£ç ç»‘å®šç«¯å£çš„ä¾‹å­ã€‚</p><p><img src="http://qiniu.chanmufeng.com/2022-10-06-053355.png" alt="image-20221006133355026" loading="lazy"></p><p>ä»£ç ä¸­è¢«çº¢è‰²æ ‡è®°çš„éƒ¨åˆ†å°±æ˜¯åˆ†åˆ«å°†ç«¯å£å·<code>33000</code>ç”±ä¸»æœºåºè½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åºï¼Œå°†ipåœ°å€ç”±ä¸»æœºåºè½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åºçš„å‡½æ•°ã€‚</p><p>ä¹çœ¼ä¸€çœ‹ï¼Œå‡½æ•°åéå¸¸å¤æ€ªï¼Œä¸å¥½è®°å¿†ï¼Œä¸‹é¢ç¨å¾®è§£é‡Šä¸€ä¸‹ï¼Œå„ä½å°±è±ç„¶å¼€æœ—äº†ã€‚</p><p><code>Socketå‡½æ•°åº“</code>æä¾›äº†è¿™ç§å­—èŠ‚åºè½¬æ¢çš„å‡½æ•°ï¼Œå‡½æ•°çš„ä½œç”¨å¯¹è±¡æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯<code>short</code>ï¼ˆ2å­—èŠ‚ï¼‰å’Œ<code>long</code>ï¼ˆ4å­—èŠ‚ï¼‰ï¼Œè¿™å°±æ˜¯å‡½æ•°æœ€åçš„ã€Œ<code>s</code>ã€å’Œã€Œ<code>l</code>ã€çš„å«ä¹‰ã€‚</p><p>è¿˜æœ‰ï¼Œä¸»æœºå­—èŠ‚åºçš„è‹±æ–‡æ˜¯<code>Host Byte Order</code>ï¼Œç®€å†™ä¸ºã€Œ<code>h</code>ã€ï¼Œç½‘ç»œå­—èŠ‚åºçš„è‹±æ–‡æ˜¯<code>Network Byte Order</code>ï¼Œç®€å†™ä¸ºã€Œ<code>n</code>ã€ï¼Œã€Œ<code>to</code>ã€è¡¨ç¤ºè½¬æ¢ï¼Œæ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³å°†<code>short</code>æ•°æ®ä»ä¸»æœºå­—èŠ‚åºè½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åºï¼Œé‚£å°±åº”è¯¥æ˜¯<code>h-to-n-s</code>ï¼Œè¡¨ç¤º<code>Host to Network Short</code>ã€‚æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿ</p><p>æ‰€ä»¥ç†è®ºä¸Šï¼Œä½ å¯ä»¥ç”¨ã€Œ<code>h</code>ã€ã€ã€Œ<code>to</code>ã€ã€ã€Œ<code>n</code>ã€ã€ã€Œ<code>s/l</code>ã€è¿™å‡ ä¸ªå­—æ¯çµæ´»ç»„åˆï¼Œç»„æˆä½ æƒ³è¦çš„apiï¼Œä½†æ˜¯ä¹Ÿåˆ«çæï¼Œstolh()ï¼»&quot;Short to Long Host&quot;ï¼½è¿™ç§ç»„åˆå‹æ ¹éƒ½ä¸å­˜åœ¨ã€‚</p><p>åŸºæœ¬ä¸Šä½ éœ€è¦çš„ä¹Ÿå°±æ˜¯ä»¥ä¸‹å››ç§ç½¢äº†ï¼š</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>htons() // host to network short
htonl() // host to network long
ntohs() // network to host short
ntohl() // network to host long
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œsocketç¼–ç¨‹æ—¶ï¼Œåœ¨å‘é€æ•°æ®ä¹‹å‰éƒ½éœ€è¦æŠŠæ•°æ®è½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åºï¼Œå¹¶åœ¨æ”¶åˆ°æ•°æ®ä¹‹åå†è½¬æ¢æˆä¸»æœºå­—èŠ‚åºã€‚</p><blockquote><p>æ›´å¤šå…³äºæµ®ç‚¹æ•°çš„å¤„ç†ï¼Œä¼šåœ¨ä¹‹åä¸“é—¨çš„ç« èŠ‚æåŠã€‚</p></blockquote><blockquote><p>å¦‚æ— ç‰¹æ®Šè¯´æ˜ï¼Œæœ¬å°å†Œçš„æ•°å€¼é¢„è®¾éƒ½è§†ä¸ºä¸»æœºå­—èŠ‚åºã€‚</p></blockquote><h3 id="_4-3-socketç›¸å…³çš„æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_4-3-socketç›¸å…³çš„æ•°æ®ç»“æ„" aria-hidden="true">#</a> 4.3. socketç›¸å…³çš„æ•°æ®ç»“æ„</h3><p>ç»ˆäºè®²åˆ°è¿™é‡Œäº†ï¼Œç°åœ¨è¯¥èŠä¸€èŠå’Œç¼–ç¨‹ç›´æ¥ç›¸å…³çš„ä¸€äº›å†…å®¹äº†ï¼Œæœ¬èŠ‚ä¼šä»‹ç»å¤šç§Socketåº“ä½¿ç”¨çš„æ•°æ®ç»“æ„ã€‚</p><h4 id="_4-3-1-socketæè¿°ç¬¦" tabindex="-1"><a class="header-anchor" href="#_4-3-1-socketæè¿°ç¬¦" aria-hidden="true">#</a> 4.3.1. socketæè¿°ç¬¦</h4><p>é¦–å…ˆä»‹ç»ä¸€ä¸ªæœ€ç®€å•çš„ï¼šsocketæè¿°ç¬¦ã€‚å®ƒçš„ç±»å‹æ˜¯ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ²¡é”™ï¼Œå°±åªæ˜¯ä¸ªæ™®æ™®é€šé€šçš„<code>int</code>è€Œå·²ã€‚</p><p>ç¬¬ä¸€ä¸ªä»‹ç»å®Œäº†ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ç®€å•å§ã€‚</p><p>ä½†æ˜¯ä»è¿™å„¿å¼€å§‹å°±ç¨å¾®æœ‰ç‚¹ä¸å¥½ç†è§£äº†ï¼Œå¤§å®¶è·Ÿä¸Šè½¦é€Ÿï¼Œæ…¢æ…¢æ¥ã€‚</p><h4 id="_4-3-2-structâ€”addrinfo" tabindex="-1"><a class="header-anchor" href="#_4-3-2-structâ€”addrinfo" aria-hidden="true">#</a> 4.3.2. structâ€”addrinfo</h4><p>ç¬¬ä¸€ä¸ªè¦ä»‹ç»çš„<code>struct</code>ç»“æ„æ˜¯<code>addrinfo</code>ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„çš„å‘æ˜æ—¶é—´è¿˜ä¸ç®—å¾ˆä¹…ï¼Œæ˜¯ç”¨æ¥å‡†å¤‡<code>socketåœ°å€</code>ç­‰ä¿¡æ¯ä»¥ä¾›åç»­ä½¿ç”¨çš„ã€‚å®ƒä¹Ÿä¼šè¢«ç”¨åœ¨<strong>åŸŸåæŸ¥æ‰¾</strong>ï¼ˆhost name lookupsï¼‰ä»¥åŠ<strong>æœåŠ¡æŸ¥æ‰¾</strong>ï¼ˆservice name lookupsï¼‰ç­‰æ–¹é¢ã€‚</p><p>è¿™ä¹ˆå¬èµ·æ¥æ„Ÿè§‰å¾ˆæŠ½è±¡ï¼Œç­‰ä¹‹åæˆ‘ä»¬å®é™…ä½¿ç”¨çš„æ—¶å€™å°±å¥½ç†è§£äº†ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦çŸ¥é“çš„å°±æ˜¯ï¼šæˆ‘ä»¬åœ¨å»ºç«‹ç½‘ç»œè¿æ¥çš„æ—¶å€™ä¼šç”¨åˆ°<code>addrinfo</code>è¿™ä¸ªæ•°æ®ç»“æ„ã€‚</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span>              ai_flags<span class="token punctuation">;</span>     <span class="token comment">// AI_PASSIVE, AI_CANONNAME, etc.</span>
    <span class="token keyword">int</span>              ai_family<span class="token punctuation">;</span>    <span class="token comment">// AF_INET, AF_INET6, AF_UNSPEC</span>
    <span class="token keyword">int</span>              ai_socktype<span class="token punctuation">;</span>  <span class="token comment">// SOCK_STREAM, SOCK_DGRAM</span>
    <span class="token keyword">int</span>              ai_protocol<span class="token punctuation">;</span>  <span class="token comment">// use 0 for &quot;any&quot;</span>
    <span class="token class-name">size_t</span>           ai_addrlen<span class="token punctuation">;</span>   <span class="token comment">// size of ai_addr in bytes</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>ai_addr<span class="token punctuation">;</span>      <span class="token comment">// struct sockaddr_in or _in6</span>
    <span class="token keyword">char</span>            <span class="token operator">*</span>ai_canonname<span class="token punctuation">;</span> <span class="token comment">// full canonical hostname</span>

    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>ai_next<span class="token punctuation">;</span>      <span class="token comment">// é“¾è¡¨ç»“æ„ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨åŸŸåæŸ¥æ‰¾æ¥åšä¸ªä¾‹å­ï¼Œå¸®åŠ©å¤§å®¶ç†è§£ã€‚</p><h5 id="_4-3-2-1-ä½¿ç”¨ipå»ºç«‹è¿æ¥" tabindex="-1"><a class="header-anchor" href="#_4-3-2-1-ä½¿ç”¨ipå»ºç«‹è¿æ¥" aria-hidden="true">#</a> 4.3.2.1. ä½¿ç”¨ipå»ºç«‹è¿æ¥</h5><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯ç›´æ¥åˆ©ç”¨IPå’Œç«¯å£å‘æœåŠ¡å™¨å‘èµ·è¿æ¥ï¼Œåƒè¿™æ ·</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> si<span class="token punctuation">;</span>

<span class="token comment">//è¿™ä¸€è¡Œä½ å¯èƒ½è¿˜ä¸çŸ¥é“ä»€ä¹ˆæ„æ€ï¼Œåˆ«æ€¥ï¼Œä¸‹æ–‡ä¼šè§£é‡Š</span>
<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>si<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

si<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
si<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">&quot;182.25.23.123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
si<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">connect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>si<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ²¡æ¥è§¦è¿‡Cçš„socketç¼–ç¨‹ï¼Œä½ å¯èƒ½å·²ç»å¼€å§‹æ‰“é€€å ‚é¼“äº†ã€‚æˆ‘æ‡‚ä½ è¿™ç§æ„Ÿè§‰ï¼Œæˆ‘éƒ½å·²ç»æ”¾å¼ƒå¥½å‡ æ¬¡äº†ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p><p>ä½†æ˜¯åæ¥ç¡¬ç€å¤´çš®çœ‹å…¶å®ä¹Ÿæ²¡ä»€ä¹ˆï¼Œè™½ç„¶å†™æ³•æ€ªå¼‚ï¼Œä½†éƒ½æ˜¯Cè¯­è¨€ä¸Šçš„å¥—è·¯è€Œå·²ï¼Œçœ‹å¤šäº†ä¹Ÿå°±é‚£ä¹ˆå›äº‹å„¿ï¼</p><p>ä¸Šé¢çš„ä»£ç çš„æ„æ€å°±æ˜¯å¯¹<code>182.25.23.123</code>çš„<code>80</code>ç«¯å£å‘èµ·äº†ä¸€ä¸ªè¿æ¥ã€‚å‰ææ˜¯æˆ‘ä»¬å·²ç»çŸ¥é“äº†ä¸»æœºçš„IPäº†ï¼Œå¦‚æœåªæœ‰åŸŸåè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>é‚£æˆ‘ä»¬å°±å¾—åˆ©ç”¨<code>DNS</code>ï¼Œç”¨å¦ä¸€ç§æ–¹å¼æ¥æ„å»ºå®¢æˆ·ç«¯å¥—æ¥å­—äº†ï¼Œè€Œè¿™ç§æ–¹å¼å°±ä¼šç”¨åˆ°<code>addrinfo</code>ã€‚</p><h5 id="_4-3-2-2-ä½¿ç”¨åŸŸåå»ºç«‹è¿æ¥" tabindex="-1"><a class="header-anchor" href="#_4-3-2-2-ä½¿ç”¨åŸŸåå»ºç«‹è¿æ¥" aria-hidden="true">#</a> 4.3.2.2. ä½¿ç”¨åŸŸåå»ºç«‹è¿æ¥</h5><p>ç›´æ¥ä¸Šä»£ç ï¼</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// ä¸ºäº†ä½¿ç”¨getaddrinfo()å‡½æ•°ï¼Œéœ€è¦è¿™ä¸ªå¤´æ–‡ä»¶</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>hints<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">&quot;www.chanmufeng.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;80&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>getaddrinfo()</code>å‡½æ•°ä¼šåˆ›å»ºä¸€ä¸ªå«åš<strong>åå­—èµ„æº</strong>çš„æ–°æ•°æ®ç»“æ„ï¼ˆä¹Ÿå°±æ˜¯ä»£ç ä¸­çš„<code>res</code>ï¼‰ï¼Œç»™å®š<code>åŸŸå</code>å’Œ<code>ç«¯å£å·</code>ä»¥åŠ<code>hints</code>ä¿¡æ¯ï¼Œè¯¥å‡½æ•°å°±ä¼šå°†åå­—èµ„æºçš„æ•°æ®ä¿å­˜åœ¨äº†ä¸€ä¸ªå«åš<code>res</code>çš„<code>addrinfo</code>æ•°æ®ç»“æ„ä¸­ï¼Œ<code>res</code>å°±åŒ…å«äº†æœåŠ¡å™¨çš„IPç­‰ä¸‹ä¸€æ­¥æ‰€éœ€çš„ä¿¡æ¯ã€‚</p><blockquote><p>åœ¨å‘æ˜<code>struct addrinfo</code>ä¹‹å‰ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æ‰‹åŠ¨å¡«å†™<code>res</code>ä¸­çš„æ¯ä¸€ä¸ªå­—æ®µçš„ï¼Œè¿œä¸å¦‚ç°åœ¨<code>getaddrinfo()</code>å¸®æˆ‘ä»¬å¤„ç†åœ°è¿™ä¹ˆå¥½ã€‚</p></blockquote><p>è¿˜æ²¡å®Œå‘¢ï¼Œè¿™åªæ˜¯è·å–åˆ°äº†æœåŠ¡å™¨çš„IPä¿¡æ¯è€Œå·²ï¼Œæˆ‘ä»¬è¿˜å¾—åˆ›å»ºå®¢æˆ·ç«¯<code>socket</code>ï¼Œç„¶åè¿›è¡Œ<code>connect()</code>ï¼Œä½†æ˜¯å†è¿›ä¸€æ­¥è®²è§£ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆç¨å¾®è§£é‡Šä¸€ä¸‹ä»£ç ä¸­<code>hints</code>çš„ä¿¡æ¯åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€ï¼Œæ¯•ç«Ÿè®©æŸäº›è¯»è€…å¸¦ç€ç–‘é—®å¾€ä¸‹è¯»ä¹Ÿæ˜¯æœ‰äº›äºå¿ƒä¸å¿ã€‚</p><p><code>hints.ai_family</code>æœ‰3ç§é€‰æ‹©ï¼Œ</p><ul><li><code>AF_INET</code>ï¼Œè¡¨ç¤ºå¼ºåˆ¶ä½¿ç”¨IPv4</li><li><code>AF_INET6</code>ï¼Œè¡¨ç¤ºå¼ºåˆ¶ä½¿ç”¨IPv6</li><li><code>AF_UNSPEC</code>ï¼Œéšä¾¿ï¼ŒIPv4æˆ–è€…IPv6éƒ½è¡Œ</li></ul><p><code>hints.ai_socktype</code>æœ‰2ç§é€‰æ‹©ï¼Œ</p><ul><li><code>SOCK_STREAM</code>ï¼Œè¡¨ç¤ºä½¿ç”¨TCPåè®®</li><li><code>SOCK_DGRAM</code>ï¼Œè¡¨ç¤ºä½¿ç”¨UDPåè®®</li></ul><p>è§£é‡Šå®Œäº†ï¼Œç„¶åæˆ‘ä»¬ç”¨<code>res</code>ä¸­çš„æ•°æ®ç»§ç»­æˆ‘ä»¬çš„è¿æ¥è¿‡ç¨‹ã€‚ä»ä¸‹é¢çš„ä»£ç ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œåˆ›å»º<code>socket</code>å¥—æ¥å­—ä»¥åŠ<code>connect</code>æ‰€éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯æˆ‘ä»¬éƒ½å¯ä»¥ä»<code>res</code>ä¸­ç›´æ¥è·å–åˆ°äº†ã€‚</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">connect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ‰ä¸€ç‚¹éœ€è¦éœ€è¦æˆ‘ä»¬ç‰¹åˆ«æ³¨æ„ï¼Œåœ¨ä½¿ç”¨ipå»ºç«‹è¿æ¥æ—¶ï¼Œ<code>connect()</code>çš„ç¬¬äºŒä¸ªå‚æ•°æˆ‘ä»¬é‡‡ç”¨äº†ç±»å‹å¼ºè½¬çš„æ–¹å¼ï¼Œå°†<code>struct sockraddr_in *</code>å¼ºè½¬æˆäº†<code>struct sockaddr *</code>ã€‚ä½†æ˜¯åœ¨ä½¿ç”¨åŸŸå<code>connect()</code>æ—¶ï¼Œç›´æ¥ä»<code>res</code>è¿™ä¸ª<code>addrinfo</code>ç»“æ„ä¸­ä½¿ç”¨äº†<code>struct sockaddr *ai_addr</code>è¿™ä¸ªå­—æ®µï¼ˆä¸æ¸…æ¥šçš„è¯å†çœ‹ä¸€çœ‹<code>addrinfo</code>çš„æ•°æ®ç»“æ„ï¼‰ã€‚</p><p>æ‰€ä»¥ï¼Œ<code>sockaddr</code>å°±æ˜¯æˆ‘ä»¬è¦å­¦ä¹ çš„ä¸‹ä¸€ä¸ªæ•°æ®ç»“æ„äº†ã€‚</p><blockquote><p>æ³¨ï¼šæœ‰äº›æ•°æ®ç»“æ„å±äº IPv4ï¼Œè€Œæœ‰äº›æ˜¯ IPv6ï¼Œæœ‰äº›ä¸¤è€…çš†å¯ï¼Œæˆ‘ä¼šç‰¹åˆ¥æ³¨æ˜å®ƒä»¬å±äºå“ªä¸€ç§ã€‚</p></blockquote><h4 id="_4-3-3-structâ€”sockaddr" tabindex="-1"><a class="header-anchor" href="#_4-3-3-structâ€”sockaddr" aria-hidden="true">#</a> 4.3.3. structâ€”sockaddr</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span>    sa_family<span class="token punctuation">;</span>    <span class="token comment">// address family, AF_xxx</span>
    <span class="token keyword">char</span>              sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 14 bytes of protocol address</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sa_family</code>çš„å¯é€‰å€¼æœ‰å¾ˆå¤šï¼Œä½†æ˜¯æœ¬å°å†Œä¸­åªä¼šä½¿ç”¨<code>AF_INET</code>ï¼ˆIPv4ï¼‰æˆ– <code>AF_INET6</code>ï¼ˆIPv6ï¼‰ã€‚</p><p><code>sa_data</code>åŒ…å«äº†socketéœ€è¦çš„ç›®çš„åœ°å€ä»¥åŠç«¯å£å·ï¼Œä½†æ˜¯è¿™æ ·å®åœ¨æ˜¯å¾ˆä¸æ–¹ä¾¿ï¼Œå› ä¸ºä½ éœ€è¦æ‰‹åŠ¨æŠŠipåœ°å€å’Œç«¯å£å·æ‰“åŒ…åˆ°14å­—èŠ‚çš„æ•°ç»„ä¸­ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¤§ä½¬ä»¬åˆåˆ›é€ äº†ä¸¤ä¸ªæ›¿ä»£å“ï¼Œ<code>sockaddr_in</code>å’Œ<code>sockaddr_in6</code>ã€‚</p><h4 id="_4-3-4-structâ€”sockaddr-in" tabindex="-1"><a class="header-anchor" href="#_4-3-4-structâ€”sockaddr-in" aria-hidden="true">#</a> 4.3.4. structâ€”sockaddr_in</h4><p>åç¼€<code>in</code>è¡¨ç¤º<code>internet</code>ï¼Œè€Œä¸”è¿™ä¸ªæ•°æ®ç»“æ„åªèƒ½ç”¨åœ¨<code>IPv4</code>ï¼</p><p>éå¸¸é‡è¦çš„ä¸€ç‚¹ï¼ˆå…¶å®ä¸Šæ–‡å·²ç»æåˆ°è¿‡ï¼‰ï¼Œ<code>struct sockaddr_in *</code>ç±»å‹å¯ä»¥å’Œ <code>struct sockaddr *</code>ç›¸äº’è¿›è¡Œç±»å‹è½¬æ¢ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ<code>connect()</code>å‡½æ•°éœ€è¦ä¸€ä¸ª<code>struct sockaddr *</code>å‚æ•°ï¼Œæˆ‘ä»¬å´å¯ä»¥é€šè¿‡ä½¿ç”¨<code>struct sockaddr_in *</code>è¿›è¡Œå¼ºè½¬ä¼ å…¥çš„åŸå› ã€‚</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// (IPv4ä¸“ç”¨--IPv6è§ä¸‹æ–‡çš„ sockaddr_in6)</span>
    
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token punctuation">{</span>
    <span class="token keyword">short</span> <span class="token keyword">int</span>          sin_family<span class="token punctuation">;</span>  <span class="token comment">// Address family, AF_INET</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> sin_port<span class="token punctuation">;</span>    <span class="token comment">// Port number</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span>     sin_addr<span class="token punctuation">;</span>    <span class="token comment">// Internet address</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      sin_zero<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Same size as struct sockaddr</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sockaddr_in</code>ä¸­çš„æ¯ä¸ªå­—æ®µçœ‹èµ·æ¥å°±æ¯”<code>sockaddr</code>è¦æ¸…æ™°å¾ˆå¤šäº†ã€‚</p><p><code>sin_zero</code>æ˜¯ä¸ºäº†è®©<code>sockaddr</code>ä¸<code>sockaddr_in</code>ä¸¤ä¸ªæ•°æ®ç»“æ„ä¿æŒå¤§å°ç›¸åŒè€Œä¿ç•™çš„ç©ºå­—èŠ‚ï¼Œä½¿ç”¨ä¹‹å‰åº”è¯¥ä½¿ç”¨<code>memset()</code>å°†æ‰€æœ‰æ•°æ®ç½®ä¸º0ã€‚</p><p><code>sin_family</code>å¯¹åº”çš„å°±æ˜¯<code>sockaddr</code>ä¸­çš„<code>sa_family</code>ï¼Œåº”è¯¥è®¾ç½®ä¸º<code>AF_INET</code>ã€‚<code>sin_port</code>å¿…é¡»ä½¿ç”¨<code>htons()</code>ä½¿å…¶ç¬¦åˆ<a href="https://www.chanmufeng.com/posts/network-programming/%E5%AD%97%E8%8A%82%E5%BA%8F.html" target="_blank" rel="noopener noreferrer">ç½‘ç»œå­—èŠ‚åº<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚</p><p>å†ç»§ç»­æŒ–å¾—æ·±ä¸€ç‚¹ï¼<code>sockaddr_in</code>çš„<code>sin_addr</code>å­—æ®µæ˜¯<code>struct in_addr</code>ç»“æ„ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// (IPv4 ä¸“ç”¨--IPv6è§ä¸‹æ–‡çš„in6_addr)</span>
    
<span class="token comment">// Internet address (ç”±äºå†å²åŸå› è€Œä¿ç•™çš„ä¸€ä¸ªæ•°æ®ç»“æ„)</span>
<span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token punctuation">{</span>
  	<span class="token class-name">uint32_t</span> s_addr<span class="token punctuation">;</span> <span class="token comment">// that&#39;s a 32-bit int (4 bytes)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œå¦‚æœä½ å£°æ˜äº†ä¸€ä¸ª<code>sockaddr_in</code>çš„å˜é‡<code>sin</code>ï¼Œé‚£ä¹ˆ<code>sin.sin_addr.s_addr</code>è¡¨ç¤ºçš„å°±æ˜¯ä¸€ä¸ª4å­—èŠ‚çš„IPåœ°å€ï¼ˆç¬¦åˆç½‘ç»œå­—èŠ‚åºï¼‰ã€‚</p><p>IPv4çš„è¯´å®Œäº†ï¼Œå¯¹åº”ç€ï¼Œæˆ‘ä»¬å†çœ‹çœ‹IPv6çš„ã€‚</p><h4 id="_4-3-5-structâ€”sockaddr-in6" tabindex="-1"><a class="header-anchor" href="#_4-3-5-structâ€”sockaddr-in6" aria-hidden="true">#</a> 4.3.5. structâ€”sockaddr_in6</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// (IPv6 ä¸“ç”¨--IPv4è§ä¸Šæ–‡çš„sockaddr_in)</span>
    
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token punctuation">{</span>
    <span class="token class-name">u_int16_t</span>       sin6_family<span class="token punctuation">;</span>   <span class="token comment">// address family, AF_INET6</span>
    <span class="token class-name">u_int16_t</span>       sin6_port<span class="token punctuation">;</span>     <span class="token comment">// port number, Network Byte Order</span>
    <span class="token class-name">u_int32_t</span>       sin6_flowinfo<span class="token punctuation">;</span> <span class="token comment">// IPv6 flow information</span>
    <span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> sin6_addr<span class="token punctuation">;</span>     <span class="token comment">// IPv6 address</span>
    <span class="token class-name">u_int32_t</span>       sin6_scope_id<span class="token punctuation">;</span> <span class="token comment">// Scope ID</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
    
<span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>   s6_addr<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// IPv6 address</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sin6_family</code>å¯¹åº”çš„æ˜¯<code>sockaddr_in</code>çš„<code>sin_family</code>å­—æ®µï¼Œ<code>sin6_port</code>å¯¹åº”çš„æ˜¯<code>sockaddr_in</code>çš„<code>sin_port</code>å­—æ®µï¼Œ<code>sin6_addr</code>å¯¹åº”çš„æ˜¯<code>sockaddr_in</code>çš„<code>sin_addr</code>å­—æ®µã€‚</p><p>è‡³äº<code>sin6_flowinfo</code>å’Œ<code>sin6_scope_id</code>æœ¬å°å†Œå°±ä¸ä¼šæ¶‰åŠäº†ï¼Œæ¯•ç«Ÿæˆ‘ä»¬æ˜¯ç®€æ˜æ•™ç¨‹å˜›ã€‚</p><p>hold onï½hold onï½</p><p>è¿˜æ²¡ç»“æŸï¼Œæœ€åå†ä»‹ç»ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œé‚£å¥è‹±æ–‡æ€ä¹ˆè¯´æ¥ç€ï¼ŸLast but not leastï¼Œè™½ç„¶å®ƒæ’åœ¨æœ€åï¼Œä½†æ˜¯ä¹Ÿä¸å®¹å¿½è§†ã€‚</p><h4 id="_4-3-6-structâ€”sockaddr-storage" tabindex="-1"><a class="header-anchor" href="#_4-3-6-structâ€”sockaddr-storage" aria-hidden="true">#</a> 4.3.6. structâ€”sockaddr_storage</h4><p><code>sockaddr_storage</code>æ˜¯ä¸€ä¸ªä¸<code>sockaddr</code>åŒä¸€çº§åˆ«çš„æ•°æ®ç»“æ„ï¼Œç”¨æ¥ä¿å­˜IPv4åœ°å€å’ŒIPv6åœ°å€ã€‚</p><p>ä¸æ˜¯å·²ç»æœ‰äº†<code>sockaddr_in</code>æ¥ä¿å­˜IPv4ï¼Œ<code>sockaddr_in6</code>æ¥ä¿å­˜IPv6äº†å˜›ï¼Ÿç”šè‡³<code>sockaddr</code>è¿˜é€šç”¨ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦<code>sockaddr_storage</code>å‘¢ï¼Ÿ</p><p>å› ä¸ºæœ‰äº›æ—¶å€™ä½ å¯èƒ½æ— æ³•æå‰ç¡®å®šä½ è¦ä½¿ç”¨IPv4è¿˜æ˜¯IPv6ï¼</p><p>ä½ å¯èƒ½ä¼šé—®ï¼Œè¿™æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿæˆ‘ä»¬è¿˜æœ‰<code>sockaddr</code>å•Šï¼Œå®ƒå¯æ˜¯é€šåƒå•Šã€‚</p><p>å¯¹ï¼Œé€šåƒï¼ä½†åªæ˜¯åä¹‰ä¸Šçš„ã€‚æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ã€‚</p><p><code>sockaddr</code>èº«ä¸ºä¸€ä¸ªé€šç”¨çš„åœ°å€æ•°æ®ç»“æ„ï¼Œç†è®ºä¸Šçš„å¤§å°å°±åº”è¯¥æ˜¯æ‰€æœ‰å…·ä½“åè®®åœ°å€ç»“æ„å¤§å°çš„æœ€å¤§å€¼ã€‚ä½†æ˜¯<code>sizeof(struct sockaddr) = 16</code>, è€Œ<code>sizeof(struct sockaddr_in6) = 28</code>ï¼Œ<code>sockaddr</code>æ²¡æœ‰èƒ½åŠ›ä¿å­˜IPv6å•Šã€‚</p><p>äºæ˜¯<code>sockaddr_storage</code>å°±è¯ç”Ÿäº†ã€‚å®ƒçš„å¤§å°ä¸º128å­—èŠ‚ï¼Œåº”è¯¥èƒ½è£…å¾—ä¸‹ç›®å‰æ‰€ä»¥åè®®çš„åœ°å€ç»“æ„äº†ã€‚</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> <span class="token punctuation">{</span>
  <span class="token class-name">sa_family_t</span>  ss_family<span class="token punctuation">;</span>     <span class="token comment">// address family</span>

  <span class="token comment">// all this is padding, implementation specific, ignore it:</span>
  <span class="token keyword">char</span>      __ss_pad1<span class="token punctuation">[</span>_SS_PAD1SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token class-name">int64_t</span>   __ss_align<span class="token punctuation">;</span>
  <span class="token keyword">char</span>      __ss_pad2<span class="token punctuation">[</span>_SS_PAD2SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸¾ä¸ªæ —å­å§ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> addr<span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isIPv6 <span class="token operator">==</span> TRUE<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token operator">*</span>addr_v6 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">;</span>
    addr_v6<span class="token operator">-&gt;</span>sin6_family <span class="token operator">=</span> AF_INET6<span class="token punctuation">;</span>
    addr_v6<span class="token operator">-&gt;</span>sin6_port <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> â€œ<span class="token number">2201</span><span class="token operator">:</span><span class="token number">3212</span><span class="token operator">::</span><span class="token number">1</span>â€<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>addr_v6<span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span>addr_v4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">;</span>
    addr_v4<span class="token operator">-&gt;</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    addr_v4<span class="token operator">-&gt;</span>sin_port <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token function">inet_aton</span><span class="token punctuation">(</span>â€œ<span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.45</span>â€<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>addr_v4<span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">sendto</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ€»ç»“ä¸€ä¸‹ä½ ä¹Ÿå°±æ˜ç™½äº†ï¼Œå¯¹äºå­˜å‚¨åœ°å€çš„æ•°æ®ç»“æ„ï¼Œä¸€å…±æœ‰4ç§ï¼Œå¹¶ä¸”æ¯ç§ä¹‹é—´éƒ½å¯ä»¥è¿›è¡Œè½¬æ¢</p><ul><li><code>sockaddr</code>ï¼ˆæœ€åŸå§‹çš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯è£…ä¸ä¸‹IPv6ï¼‰</li><li><code>sockaddr_in</code>ï¼ˆä¸“ç”¨äºIPv4ï¼‰</li><li><code>sockaddr_in6</code>ï¼ˆä¸“ç”¨äºIPv6ï¼‰</li><li><code>sockaddr_storage</code>ï¼ˆç›¸å½“äº<code>sockaddr</code>çš„è¡¥ä¸ï¼Œèƒ½è£…ä¸ä¸‹IPv6ï¼‰</li></ul><p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå3ç§ç»“æ„éƒ½éœ€è¦å¼ºè½¬ä¸º<code>sockaddr</code>ï¼Œä½ å¯èƒ½ä¼šé—®ä¸ºä»€ä¹ˆä¸ç›´æ¥ä¼ å…¥<code>sockaddr_storage</code>å‘¢ï¼Ÿè¿™ä¹Ÿæ˜¯æ²¡åŠæ³•çš„äº‹æƒ…ï¼Œå› ä¸ºapiä»ä¸€å¼€å§‹çš„æ—¶å€™å°±å·²ç»ç¡®å®šå¥½äº†ï¼Œå˜äº†çš„è¯æ—§ä»£ç ä¹Ÿå°±ä¸èƒ½è¿è¡Œäº†ã€‚æˆ‘ä»¬èƒ½åšçš„å°±æ˜¯æ‰“è¡¥ä¸ã€‚</p><p>å¾ˆå¤šå¥‡å¥‡æ€ªæ€ªæ•°æ®ç»“æ„çš„å‡ºç°ï¼Œå°±æ˜¯ç”±äºæœ€å¼€å§‹æ²¡æƒ³åˆ°ä¼šå‘å±•åˆ°ç°åœ¨è¿™ç§æƒ…å†µè€Œå¯¼è‡´çš„ã€‚åŒ…æ‹¬ç°åœ¨ä¹Ÿä¸€æ ·ï¼Œæˆ‘ä»¬å¾ˆéš¾é¢„æµ‹æœªæ¥çš„å…¨éƒ¨å˜åŒ–ï¼Œèƒ½æƒ³åˆ°æœ€å¥½ï¼Œæƒ³ä¸å…¨æˆ–æ˜¯ä½ä¼°æœªæ¥æ‰æ˜¯å¸¸æ€ã€‚</p><h3 id="_4-4-ipçš„äºŒè¿›åˆ¶è½¬æ¢" tabindex="-1"><a class="header-anchor" href="#_4-4-ipçš„äºŒè¿›åˆ¶è½¬æ¢" aria-hidden="true">#</a> 4.4. IPçš„äºŒè¿›åˆ¶è½¬æ¢</h3><p>ä¸å¾—ä¸è¯´ï¼Œæˆ‘ä»¬çœŸçš„å¾ˆå¹¸è¿ï¼Œå¦‚ä»Šå·²ç»æœ‰äº†å¾ˆå¤šå‡½æ•°å¯ä»¥è®©æˆ‘ä»¬æ“ä½œIPåœ°å€ï¼Œè€Œä¸éœ€è¦æˆ‘ä»¬è‡ªå·±ç”¨<code>long</code>ç±»å‹æ•°æ®ä»¥åŠ<code>&lt;&lt;</code>è¿ç®—ç¬¦æ¥å¤„ç†å®ƒä»¬ã€‚</p><p>å‡å¦‚ä½ å£°æ˜äº†ä¸€ä¸ªæ•°æ®ç»“æ„<code>struct sockaddr_in ina</code>ï¼Œä½ è¿˜æœ‰ä¸€ä¸ªâ€œ<code>10.12.110.57</code>â€æˆ–â€œ<code>2001:db8:63b3:1::3490</code>â€è¿™æ ·çš„IPåœ°å€ï¼Œè¯¥æ€ä¹ˆæŠŠIPåœ°å€å­˜å…¥<code>ina</code>å‘¢ã€‚</p><h4 id="_4-4-1-ipè½¬äºŒè¿›åˆ¶" tabindex="-1"><a class="header-anchor" href="#_4-4-1-ipè½¬äºŒè¿›åˆ¶" aria-hidden="true">#</a> 4.4.1. IPè½¬äºŒè¿›åˆ¶</h4><p>ä½ å¯ä»¥ä½¿ç”¨<code>inet_pton()</code>å°†ç‚¹åˆ†åè¿›åˆ¶å½¢å¼çš„IPv4åœ°å€ä¿å­˜åœ¨<code>ina</code>ä¸­ï¼Œä½†å¦‚æœè¦ä¿å­˜IPv6åœ°å€çš„è¯ï¼Œæˆ‘ä»¬å°±éœ€è¦<code>struct sockaddr_in6 ina6</code>äº†ã€‚</p><blockquote><p>â€œ<code>pton</code>â€çš„å…¨ç§°æ˜¯â€œpresentation to networkâ€ï¼Œä¹Ÿå¯ä»¥æ˜¯â€œprintable to networkâ€ï¼Œé€‰ä¸€ä¸ªèƒ½å¸®åŠ©ä½ è®°å¿†çš„å°±è¡Œã€‚</p></blockquote><p>å…·ä½“çš„è½¬æ¢å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> sa<span class="token punctuation">;</span> <span class="token comment">// IPv4</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> sa6<span class="token punctuation">;</span> <span class="token comment">// IPv6</span>
    
<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">&quot;10.12.110.57&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>sa<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// IPv4</span>
<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> <span class="token string">&quot;2001:db8:63b3:1::3490&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>sa6<span class="token punctuation">.</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// IPv6</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>å°è®°ï¼šåŸæœ¬çš„è€æ–¹æ³•æ˜¯ä½¿ç”¨åä¸º<code>inet_addr()</code>æˆ–æ˜¯ <code>inet_aton() </code>çš„å‡½æ•°ï¼›è¿™äº›å‡½æ•°å·²ç»è¿‡æ—¶äº†ï¼Œè€Œä¸”ä¸é€‚ç”¨äº IPv6</p></blockquote><p>ä¸Šé¢çš„ç¨‹åºå†™çš„æ¯”è¾ƒç®€å•ï¼Œè€Œä¸”ä¸å¤Ÿå¥å£®ï¼Œå› ä¸ºæ²¡æœ‰è¿›è¡Œé”™è¯¯æ£€æŸ¥ã€‚<code>inet_pton() </code>åœ¨å‘ç”Ÿé”™è¯¯æ—¶ä¼šè¿”å›<code>-1</code>ï¼Œè€Œè‹¥åœ°å€æ— æ•ˆåˆ™è¿”å›<code>0</code>ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨ä¹‹å‰è¦æ£€æŸ¥è¿”å›å€¼ï¼Œå¹¶ä¿è¯è¿”å›ç»“æœæ˜¯å¤§äº 0 çš„ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å°†å­—ç¬¦ä¸²æ ¼å¼çš„IPåœ°å€è½¬æ¢ä¸ºäºŒè¿›åˆ¶å½¢å¼äº†ã€‚é‚£ä¹ˆåè¿‡æ¥éœ€è¦æ€ä¹ˆåšï¼Ÿ</p><h4 id="_4-4-2-äºŒè¿›åˆ¶è½¬ip" tabindex="-1"><a class="header-anchor" href="#_4-4-2-äºŒè¿›åˆ¶è½¬ip" aria-hidden="true">#</a> 4.4.2. äºŒè¿›åˆ¶è½¬IP</h4><p>å¦‚æœæˆ‘ä»¬å·²ç»æœ‰äº†<code>struct in_addr</code>ï¼Œæ€ä¹ˆå°†ç‚¹åˆ†åè¿›åˆ¶çš„IPæ‰“å°å‡ºæ¥ï¼Ÿï¼ˆæˆ–è€…æˆ‘ä»¬æœ‰<code>struct in6_addr</code>ï¼Œæ€ä¹ˆæ‰“å°å­—ç¬¦ä¸²ç±»å‹çš„IPv6åœ°å€å‘¢ï¼Ÿï¼‰</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>inet_ntop()</code>å‡½æ•°ï¼Œçœ‹ä»£ç ï¼š</p><blockquote><p>â€œ<code>ntop</code>â€çš„å…¨ç§°æ˜¯â€œnetwork to presentationâ€ï¼Œä¹Ÿå¯ä»¥æ˜¯â€œnetwork to printableâ€ï¼Œé€‰ä¸€ä¸ªèƒ½å¸®åŠ©ä½ è®°å¿†çš„å°±è¡Œã€‚</p></blockquote><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// IPv4:</span>
<span class="token keyword">char</span> ip4<span class="token punctuation">[</span>INET_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// space to hold the IPv4 string</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> sa<span class="token punctuation">;</span>      <span class="token comment">// å‡è®¾saä¸­ä¿å­˜äº†ipä¿¡æ¯</span>
<span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>sa<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> ip4<span class="token punctuation">,</span> INET_ADDRSTRLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;The IPv4 address is: %s\n&quot;</span><span class="token punctuation">,</span> ip4<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// IPv6:</span>
<span class="token keyword">char</span> ip6<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// space to hold the IPv6 string</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> sa6<span class="token punctuation">;</span>    <span class="token comment">// å‡è®¾sa6ç§ä¿å­˜äº†ipä¿¡æ¯</span>
<span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>sa6<span class="token punctuation">.</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> ip6<span class="token punctuation">,</span> INET6_ADDRSTRLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;The address is: %s\n&quot;</span><span class="token punctuation">,</span> ip6<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“æˆ‘ä»¬è°ƒç”¨<code>inet_ntop()</code>ï¼Œä½ éœ€è¦ä¼ é€’IPåœ°å€ç±»å‹ï¼ˆIPv4 æˆ–è€… IPv6ï¼‰ï¼Œä¸€ä¸ªæŒ‡å‘ä¿å­˜å­—ç¬¦ä¸²ç»“æœçš„æŒ‡é’ˆä»¥åŠè¯¥å­—ç¬¦ä¸²çš„æœ€å¤§é•¿åº¦ã€‚æœ‰ä¸¤ä¸ªå®ï¼ˆå¯ä»¥ç†è§£ä¸ºå¸¸é‡ï¼‰å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¸®åŠ©æˆ‘ä»¬è¡¨ç¤ºè¦å­˜å‚¨çš„IPv4æˆ–è€…IPv6åœ°å€å­—ç¬¦ä¸²çš„æœ€å¤§é•¿åº¦ï¼Œåˆ†åˆ«æ˜¯<code>INET_ADDRSTRLEN</code> å’Œ <code>INET6_ADDRSTRLEN</code>ã€‚</p><blockquote><p>å°è®°ï¼šåŸæœ¬çš„è€æ–¹æ³•æ˜¯ä½¿ç”¨åä¸º<code>inet_ntoa()</code>çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å·²ç»è¿‡æ—¶äº†ï¼Œè€Œä¸”ä¸é€‚ç”¨äº IPv6</p></blockquote><p>æœ€åï¼Œæœ¬æ–‡è®²åˆ°çš„å‡½æ•°åªèƒ½ç”¨äºæ•°å€¼å‹çš„IPåœ°å€ä¸Šï¼Œå®ƒä»¬ä¸ä¼šç”¨DNSåšåŸŸåè§£æï¼Œæ‰€ä»¥ä½ ä¼ å…¥â€œ<a href="http://www.chanmufeng.com" target="_blank" rel="noopener noreferrer">www.chanmufeng.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>â€è¿™æ ·çš„åŸŸåæ˜¯æ²¡æœ‰ç”¨çš„ã€‚</p><p>å…³äºåŸŸåæŸ¥è¯¢ï¼Œæˆ‘ä»¬å°†ä¼šä½¿ç”¨<code>getaddrinfo()</code>å‡½æ•°ï¼Œä¹‹å‰çš„æ–‡ç« æè¿‡ä¸€å˜´ï¼Œåæ–‡å°†ä¼šè¯¦ç»†è®²è¿°ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p><h2 id="_5-ä»ipv4è¿ç§»åˆ°ipv6" tabindex="-1"><a class="header-anchor" href="#_5-ä»ipv4è¿ç§»åˆ°ipv6" aria-hidden="true">#</a> 5. ä»IPv4è¿ç§»åˆ°IPv6</h2><p>æœªæ¥ä¸€å®šå±äºIPv6ï¼Œä½†å¯èƒ½è¿˜ä¸æ˜¯ç°åœ¨ã€‚</p><p>è™½ç„¶å˜´ä¸Šåš·åš·ç€IPv4ä¸å¤Ÿç”¨äº†ï¼Œä½†æ˜¯ä¸ç®¡å›½å†…è¿˜æ˜¯å›½å¤–ï¼ŒIPv6å§‹ç»ˆæ²¡æœ‰é¢„æƒ³ä¸­çš„é‚£ä¹ˆæ™®åŠã€‚</p><p><img src="http://qiniu.chanmufeng.com/2022-10-08-101452.png" alt="image-20221008181452021" loading="lazy"></p><p>å›¾ä¸­é¢œè‰²è¶Šæ·±çš„åœ°åŒºï¼Œè¡¨ç¤ºå…¶ IPv6 éƒ¨ç½²ç¨‹åº¦è¶Šé«˜ï¼Œç›¸åº”çš„ IPv6 éƒ¨ç½²ç‡æ•°å€¼è¶Šå¤§ã€‚æ‰€è°“çš„éƒ¨ç½²ç‡æ˜¯æ ¹æ®å„ä¸ªå›½å®¶åœ°åŒºçš„ç½‘ç»œï¼ˆIPv6 Prefix/Transit IPv6 ASï¼‰ï¼ŒIPv6 ç½‘ç«™åŠ IPv6 ç”¨æˆ·ç­‰æ•°æ®æŒ‰ç…§ä¸€å®šæƒå€¼å¹¶è®¡ç®—å¾—å‡ºçš„ã€‚</p><p>çœ‹èµ·æ¥å…¨çƒå¤§éƒ¨åˆ†åœ°åŒºéƒ½æ˜¯ç»¿çš„ï¼Œä½†æ˜¯å°±å…¨çƒçš„IPv6è¦†ç›–ç‡è€Œè¨€ï¼Œè¿˜è¾¾ä¸åˆ°40%ã€‚</p><p>ä½†æ˜¯æ€»å½’éœ€è¦å¯¹æœªæ¥åšå‡ºä¸€ç‚¹å‡†å¤‡å˜›ï¼Œæ‰€ä»¥æœ¬æ–‡ç”¨12ä¸ªæ­¥éª¤æ•™ä½ å¦‚ä½•åœ¨socketç¼–ç¨‹ä¸­ä»IPv4è¿ç§»åˆ°IPv6ã€‚</p><ol><li><p>é¦–å…ˆï¼Œå°è¯•ä½¿ç”¨<a href="https://www.chanmufeng.com/posts/network-programming/6%E7%A7%8Dsocket%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.html#struct%E2%80%94addrinfo" target="_blank" rel="noopener noreferrer"><code>getaddrinfo()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æ¥è·å–<code>struct sockaddr</code>çš„ä¿¡æ¯ï¼Œä¸è¦å†æ‰‹åŠ¨å¡«å……è¿™ä¸ªæ•°æ®ç»“æ„äº†ã€‚è¿™æ ·å°±å¯ä»¥å±è”½IPçš„ç‰ˆæœ¬å½±å“ï¼Œçœå»åç»­å¾ˆå¤šéº»çƒ¦ï¼›</p></li><li><p>æ‰¾å‡ºæ‰€æœ‰å¯¹IPç‰ˆæœ¬ç¡¬ç¼–ç çš„ä»£ç ï¼Œè¯•ç€æŠŠå®ƒä»¬å°è£…èµ·æ¥ï¼›</p></li><li><p>å°†<code>AF_INET</code> ä¿®æ”¹ä¸º <code>AF_INET6</code>ï¼›</p></li><li><p>å°† <code>PF_INET</code> ä¿®æ”¹ä¸º <code>PF_INET6</code>ï¼›</p></li><li><p>å°† <code>INADDR_ANY</code> ä¿®æ”¹ä¸º <code>in6addr_any</code> ï¼Œç»™ä½ ä¸ªä¾‹å­ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> sa<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> sa6<span class="token punctuation">;</span>

sa<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>  <span class="token comment">// ä½¿ç”¨IPv4</span>
sa6<span class="token punctuation">.</span>sin6_addr <span class="token operator">=</span> in6addr_any<span class="token punctuation">;</span> <span class="token comment">// ä½¿ç”¨IPv6</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ä½¿ç”¨ <code>struct sockaddr_in6</code>ä»£æ›¿ <code>struct sockaddr_in</code> ï¼Œåƒä¸‡è¦æ³¨æ„ï¼Œâ€œ6â€å¯ä¸è¦ä¹±åŠ å“¦ï¼Œå¦‚æœä½ å¿˜è®°é‚£äº›å­—æ®µæœ‰â€œ6â€äº†ï¼Œå‚è€ƒä¹‹å‰è®²è¿‡çš„<a href="https://www.chanmufeng.com/posts/network-programming/6%E7%A7%8Dsocket%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.html" target="_blank" rel="noopener noreferrer"><code>struct</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚æ¯”å¦‚ï¼Œå‹æ ¹å„¿ä¸å­˜åœ¨<code>sin6_zero</code>è¿™ä¸ªå­—æ®µï¼›</p></li><li><p>ä½¿ç”¨<code>struct in6_addr</code> ä»£æ›¿<code>struct in_addr</code> ï¼Œå…³äºâ€œ6â€çš„ç»†èŠ‚ï¼Œå‚è€ƒç¬¬6æ¡ï¼›</p></li><li><p>ä½¿ç”¨<code>inet_pton()</code>ä»£æ›¿<code>inet_aton()</code> ä»¥åŠ <code>inet_addr()</code>ï¼›</p></li><li><p>ä½¿ç”¨<code>inet_ntop()</code>ï¼Œä¸è¦ä½¿ç”¨<code>inet_ntoa()</code>ï¼›</p></li><li><p>ä½¿ç”¨æ›´é«˜çº§çš„<code>getaddrinfo()</code>ä»£æ›¿<code>gethostbyname()</code>äº†ï¼›</p></li><li><p>ç”¨æ›´é«˜çº§çš„<code>getnameinfo()</code>ä»£æ›¿<code>gethostbyaddr()</code>ï¼ˆè™½ç„¶<code>gethostbyaddr</code>åœ¨IPv6ä¸­ä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨ï¼‰ï¼›</p></li><li><p>ä¸è¦ç”¨ <code>INADDR_BROADCAST </code>äº†ï¼Œè¯·ä½¿ç”¨ <code>IPv6 multicast</code> ä¾†ä»£æ›¿ã€‚</p></li></ol><p>ä»¥ä¸Šï¼</p><h2 id="_6-socketç¼–ç¨‹ç›¸å…³å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_6-socketç¼–ç¨‹ç›¸å…³å‡½æ•°" aria-hidden="true">#</a> 6. socketç¼–ç¨‹ç›¸å…³å‡½æ•°</h2><p>è¿™ä¸€ç« ï¼Œæˆ‘ä»¬å°†èµ°è¿›<strong>ç³»ç»Ÿè°ƒç”¨</strong>ï¼ˆSystem Callï¼‰ï¼Œè¿™äº›ç³»ç»Ÿè°ƒç”¨å…è®¸æˆ‘ä»¬è®¿é—®Linuxè®¾å¤‡æˆ–å…¶ä»–ä»»ä½•æ”¯æŒSocket APIè®¾å¤‡ï¼ˆæ¯”å¦‚BSDã€Windowsã€Linuxã€Macç­‰ï¼‰çš„ç½‘ç»œåŠŸèƒ½ã€‚å½“ä½ è°ƒç”¨æŸä¸ªç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå†…æ ¸å°†æ¥ç®¡ä¸€åˆ‡ï¼Œè‡ªåŠ¨ä¸ºä½ å¤„ç†æ¥ä¸‹æ¥çš„ä¸€åˆ‡ä»»åŠ¡ã€‚</p><p>å¤šæ•°äººè§‰å¾—ç½‘ç»œç¼–ç¨‹å¾ˆéš¾æ˜¯å› ä¸ºä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™è¯¥è°ƒç”¨ä»€ä¹ˆå‡½æ•°ï¼Œè¿™ä¸ªé—®é¢˜åœ¨<strong>man</strong>æ‰‹å†Œé‡Œæ˜¯æ‰¾ä¸åˆ°è§£å†³æ–¹æ¡ˆçš„ã€‚ä¸ºäº†å¸¦å¤§å®¶èµ°å‡ºå›°å¢ƒï¼Œæ¥ä¸‹æ¥æˆ‘å°±æŒ‰ç…§ä¸€èˆ¬çš„è°ƒç”¨é¡ºåºæ¥ç»™å¤§å®¶è®²è§£æ¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä½ åœ¨å†™ç¨‹åºçš„æ—¶å€™å°±æŒ‰ç…§è¿™ä¸ªé¡ºåºè°ƒç”¨å°±è¡Œäº†ã€‚</p><p>è¦æƒ³çœ‹æ‡‚æ¥ä¸‹æ¥æ•£è½å„å¤„çš„ä»£ç ç‰‡æ®µï¼Œä½ éœ€è¦å¤‡ç‚¹ç‰›å¥¶å’Œé¥¼å¹²äº†ï¼Œè¿˜å¤šå°‘éœ€è¦å¤‡ç‚¹å†³å¿ƒå’Œå‹‡æ°”ï¼Œç„¶åä½ å°±èƒ½å°†socketç¼–ç¨‹ç©å„¿å¾—é£ç”Ÿæ°´èµ·äº†ï¼Œä¸çŸ¥é“çš„è¿˜ä»¥ä¸ºä½ å¾—äº†Jon PostelçœŸä¼ å‘¢ï¼</p><blockquote><p>Jon Postelæ˜¯äº’è”ç½‘çš„å·¨æ“˜ï¼Œä»–çš„å‘æ˜ä½œå“åŒ…æ‹¬ä½†ä¸é™äº<code>SMTPåè®®</code>ã€<code>FTPåè®®</code>ã€<code>UDPåè®®</code>ã€‚</p></blockquote><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸ºäº†ç®€æ´ï¼Œå¾ˆå¤šä»£ç ç‰‡æ®µå¹¶æ²¡æœ‰åŒ…å«å¿…è¦çš„é”™è¯¯æ£€æŸ¥ã€‚æ¯”å¦‚æ–‡ç« ä¼šå§‹ç»ˆå‡è®¾<code>getaddrinfo()</code> ä¼šè°ƒç”¨æˆåŠŸã€‚åœ¨ç¼–å†™ç”Ÿäº§ç¯å¢ƒä»£ç æ—¶å°¤å…¶éœ€è¦æ³¨æ„è¿™ä¸€ç‚¹ã€‚</p><h3 id="_6-1-getaddrinfo-â€”å‡†å¤‡å¼€å§‹" tabindex="-1"><a class="header-anchor" href="#_6-1-getaddrinfo-â€”å‡†å¤‡å¼€å§‹" aria-hidden="true">#</a> 6.1. getaddrinfo()â€”å‡†å¤‡å¼€å§‹ï¼</h3><p>è¿™æ˜¯socketç¼–ç¨‹ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæœ‰éå¸¸å¤šçš„å‚æ•°ï¼Œä½†æ˜¯åˆ«å®³æ€•ï¼Œç”¨èµ·æ¥å…¶å®éå¸¸ç®€å•ã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å¸®ä½ è®¾ç½®ä¹‹åéœ€è¦çš„structã€‚</p><p>ç¨å¾®æä¸€å˜´å®ƒçš„å†å²ï¼šå®ƒçš„å‰èº«æ˜¯ç”¨æ¥åšDNSæŸ¥è¯¢çš„<code>gethostbyname()</code>ï¼Œå½“æ—¶è¿˜éœ€è¦ä½ æ‰‹åŠ¨æŠŠæ•°æ®è®¾ç½®åˆ°<code>struct sockaddr_in</code>ä¸­å‘¢ã€‚è°¢å¤©è°¢åœ°ï¼Œç°åœ¨ä¸ç”¨äº†ã€‚</p><p>ä½¿ç”¨<code>getaddrinfo()</code>å¯ä»¥å¸®åŠ©ä½ å†™å‡ºå…¼å®¹IPv4å’ŒIPv6çš„ä»£ç ï¼Œç”šè‡³åœ¨å¸®ä½ è¿›è¡ŒDNSæŸ¥è¯¢å’Œservice nameæŸ¥è¯¢ä¹‹åï¼Œè¿˜ä¼šè‡ªåŠ¨å°†ä½ éœ€è¦çš„ä¿¡æ¯å¡«å……åˆ°<code>struct</code>ä¸­ï¼Œå’±å°±è¯´å¤šç‰›ï¼</p><p>çœ‹ä¸€çœ¼é•¿å•¥æ ·å…ˆã€‚</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>node<span class="token punctuation">,</span>     <span class="token comment">// e.g. &quot;www.example.com&quot; or IP</span>
                <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">,</span>  <span class="token comment">// e.g. &quot;http&quot; or port number</span>
                <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>hints<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ ä¼ ç»™å®ƒ3ä¸ªå‚æ•°ï¼ˆå…¶å®æ˜¯4ä¸ªï¼Œä½†æ˜¯ç¬¬4ä¸ªåªæ˜¯ä¸ªå£°æ˜çš„å˜é‡è€Œå·²ï¼‰ï¼Œå®ƒç»™ä½ è¿”å›ä¸€ä¸ªæŒ‡å‘é“¾è¡¨çš„æŒ‡é’ˆ<code>res</code>ã€‚</p><p>å…¶ä¸­ï¼Œ<code>node</code>å‚æ•°æ˜¯ä½ æƒ³è¿›è¡Œè¿æ¥çš„æœåŠ¡å™¨çš„åŸŸåï¼Œæˆ–è€…IPåœ°å€ã€‚</p><p><code>service</code>å‚æ•°å¯ä»¥æ˜¯ä¸ªç«¯å£å·ï¼Œæ¯”å¦‚â€œ<code>80</code>â€ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªç‰¹å®šæœåŠ¡çš„åç§°ï¼Œæ¯”å¦‚â€œ<code>http</code>â€ã€â€œ<code>ftp</code>â€ã€â€œ<code>telnet</code>â€ã€â€œ<code>smtp</code>â€ ç­‰ã€‚</p><p>æœ€åï¼Œ<code>hints</code>å‚æ•°æŒ‡å‘äº†ä¸€ä¸ªéœ€è¦ä½ è®¾ç½®ç›¸å…³å‚æ•°çš„<code>struct addrinfo</code>ã€‚</p><blockquote><p>å¸¸ç”¨ç«¯å£å·ä»¥åŠæœåŠ¡åå¯ä»¥å‚è§ <a href="https://www.iana.org/assignments/port-numbers" target="_blank" rel="noopener noreferrer">The IANA Port List<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æˆ–è€…Unixè®¾å¤‡ä¸Šçš„<code>/etc/services</code>æ–‡ä»¶</p></blockquote><p>æ¥ä¸‹æ¥ç»™ä¸€ä¸ªæœåŠ¡ç«¯ç¨‹åºç›‘å¬æœ¬æœºIPåœ°å€å’Œ<code>3490</code>ç«¯å£çš„ä¾‹å­ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»£ç ç¤ºä¾‹ä¸­å¹¶æ²¡æœ‰åšç›‘å¬ï¼ˆlistenï¼‰å’Œä»»ä½•ç½‘ç»œè®¾ç½®çš„å·¥ä½œï¼Œåªæ˜¯ç®€å•è®¾ç½®äº†ä¹‹åä¼šç”¨åˆ°æ•°æ®ç»“æ„è€Œå·²ã€‚</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> status<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>servinfo<span class="token punctuation">;</span>  <span class="token comment">// will point to the results</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// make sure the struct is empty</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>     <span class="token comment">// don&#39;t care IPv4 or IPv6</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span> <span class="token comment">// TCP stream sockets</span>
hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span>     <span class="token comment">// fill in my IP for me</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>status <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;3490&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo error: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// servinfo ç°åœ¨æŒ‡å‘äº†åŒ…å«1ä¸ªæˆ–å¤šä¸ªaddrinfoç»“æ„çš„é“¾è¡¨</span>

<span class="token comment">// ... do everything until you don&#39;t need servinfo anymore ....</span>

<span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// free the linked-list</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼Œæˆ‘å°†<code>ai_family</code>è®¾ç½®æˆäº†<code>AF_UNSPEC</code>ï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘å‹æ ¹ä¸åœ¨æ„æˆ‘ä»¬ç”¨IPv4è¿˜æ˜¯IPv6ã€‚å¦‚æœä½ æƒ³ç²¾ç¡®æŒ‡å®šIPv4æˆ–è€…IPv6çš„è¯è¯·ä½¿ç”¨<code>AF_INET</code>æˆ–<code>AF_INET6</code>ã€‚</p><p>ä½ å¯èƒ½æ³¨æ„åˆ°äº†ï¼Œæˆ‘æŠŠ<code>ai_flags</code>è®¾ç½®ä¸ºäº†<code>AI_PASSIVE</code>ï¼Œæ„æ€æ˜¯å‘Šè¯‰<code>getaddrinfo()</code>å‡½æ•°æŠŠæˆ‘æœ¬æœºçš„IPè®¾ç½®åˆ°<code>servinfo</code>ä¸­ï¼Œè¿™æ ·æˆ‘å°±ä¸ç”¨å°†<code>getaddrinfo()</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆå¦‚æœå¿˜äº†æ˜¯å•¥æ„æ€ï¼Œçœ‹çœ‹ä¸Šæ–‡ï¼‰ç¡¬ç¼–ç äº†ï¼Œç›´æ¥è®¾ç½®æˆ<code>NULL</code>å°±è¡Œäº†ã€‚</p><p>ç„¶åæˆ‘ä»¬å°±è°ƒç”¨<code>getaddrinfo()</code>äº†ã€‚å¦‚æœå‡½æ•°æŠ¥é”™ï¼ˆè¿”å›å€¼ä¸ä¸º0ï¼‰ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨<code>gai_strerror() </code>å‡½æ•°å°†é”™è¯¯æ‰“å°å‡ºæ¥ã€‚å¦‚æœç¨‹åºæ­£å¸¸è¿è¡Œï¼Œé‚£ä¹ˆ<code>servinfo</code>æœ€ç»ˆå°±ä¼šæŒ‡å‘ä¸€ä¸ªç”±<code>struct addrinfo</code>é“¾æ¥å½¢æˆçš„é“¾è¡¨ï¼Œé“¾è¡¨ä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½ä¼šåŒ…å«ä¸€ä¸ªæˆ‘ä»¬ä¹‹åä¼šç”¨åˆ°çš„<code>struct sockaddr</code>ã€‚</p><p>æœ€åï¼Œ<code>getaddrinfo()</code>ä¼šåœ¨å †å†…å­˜ä¸­åˆ›å»º<code>servinfo</code>æŒ‡å‘çš„é“¾è¡¨ï¼Œä½¿ç”¨å®Œä¹‹åä¸€å®šè¦ä½¿ç”¨<code>freeaddrinfo()</code>è¿›è¡Œå†…å­˜é‡Šæ”¾ã€‚</p><p>å†ç»™ä¸€ä¸ªå®¢æˆ·ç«¯ä»£ç çš„ä¾‹å­ï¼Œæˆ‘ä»¬å‡è®¾å®¢æˆ·ç«¯æƒ³è¿æ¥åˆ°åŸŸåä¸ºâ€œ<a href="http://www.chanmufeng.com" target="_blank" rel="noopener noreferrer">www.chanmufeng.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>â€ï¼Œç«¯å£ä¸º<code>3490</code>çš„æœåŠ¡å™¨ã€‚å†æ¬¡å¼ºè°ƒï¼Œä»£ç ç‰‡æ®µä¸­çœç•¥äº†å®é™…è¿›è¡Œé“¾æ¥çš„éƒ¨åˆ†ï¼Œåªæ˜¯ç®€å•è®¾ç½®äº†ä¹‹åä¼šç”¨åˆ°æ•°æ®ç»“æ„è€Œå·²ã€‚</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> status<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>servinfo<span class="token punctuation">;</span>  <span class="token comment">// will point to the results</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// make sure the struct is empty</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>     <span class="token comment">// don&#39;t care IPv4 or IPv6</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span> <span class="token comment">// TCP stream sockets</span>

<span class="token comment">// get ready to connect</span>
status <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">&quot;www.chanmufeng.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3490&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// servinfo now points to a linked list of 1 or more struct addrinfos</span>

<span class="token comment">// etc.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç æ¯”serverç«¯çš„ä»£ç è¿˜ç®€å•ï¼Œå°±ä¸è¿‡å¤šè§£é‡Šäº†ã€‚</p><p>æ¥ç€æˆ‘ä»¬ç»¼åˆä½¿ç”¨ä¸€ä¸‹æˆ‘ä»¬å­¦è¿‡çš„çŸ¥è¯†ï¼Œå†™ä¸€æ®µç¨å¾®é•¿ä¸€ä¸¢ä¸¢çš„demoï¼Œè¿™ä¸ªdemoçš„ä½œç”¨æ˜¯æ‰“å°ä½ åœ¨å‘½ä»¤è¡Œä¸ŠæŒ‡å®šçš„ä»»ä½•ä¸»æœºçš„IPåœ°å€ã€‚</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** showip.c -- show IP addresses for a host given on the command line
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">int</span> status<span class="token punctuation">;</span>
    <span class="token keyword">char</span> ipstr<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;usage: showip hostname\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span> <span class="token comment">// AF_INET or AF_INET6 to force version</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>status <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;IP addresses for %s:\n\n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> res<span class="token punctuation">;</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>ipver<span class="token punctuation">;</span>

        <span class="token comment">// get the pointer to the address itself,</span>
        <span class="token comment">// different fields in IPv4 and IPv6:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family <span class="token operator">==</span> AF_INET<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// IPv4</span>
            <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span>ipv4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">;</span>
            addr <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>ipv4<span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipver <span class="token operator">=</span> <span class="token string">&quot;IPv4&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// IPv6</span>
            <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token operator">*</span>ipv6 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">;</span>
            addr <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>ipv6<span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipver <span class="token operator">=</span> <span class="token string">&quot;IPv6&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// convert the IP to a string and print it:</span>
        <span class="token function">inet_ntop</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> ipstr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> ipstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;  %s: %s\n&quot;</span><span class="token punctuation">,</span> ipver<span class="token punctuation">,</span> ipstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// free the linked list</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¨‹åºä½¿ç”¨ä½ åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥çš„å‚æ•°æ¥è°ƒç”¨<code>getaddrinfo()</code>ï¼Œç„¶åæˆ‘ä»¬å°±å¾—åˆ°äº†<code>res</code>æŒ‡å‘çš„é“¾è¡¨ï¼Œéå†é“¾è¡¨æ¯ä¸ªèŠ‚ç‚¹æˆ‘ä»¬å°±èƒ½å¾—åˆ°å…¨éƒ¨çš„IPä¿¡æ¯ã€‚</p><p>è¿è¡Œæ–¹å¼å¦‚ä¸‹ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ showip www.example.net
IP addresses <span class="token keyword">for</span> www.example.net:

	IPv4: <span class="token number">192.0</span>.2.88

$ showip ipv6.example.com
IP addresses <span class="token keyword">for</span> ipv6.example.com:

	IPv4: <span class="token number">192.0</span>.2.101
	IPv6: <span class="token number">2001</span>:db8:8c00:22::171
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ä¸€åˆ‡å°½åœ¨æˆ‘ä»¬æŒæ¡ä¹‹ä¸­äº†ï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>getaddrinfo()</code>è‡ªåŠ¨ä¸ºæˆ‘ä»¬å¡«å……å¥½çš„æ•°æ®ä¼ é€’ç»™å…¶ä»–çš„socketå‡½æ•°ï¼Œè¿™å°±æ˜¯æŠŠ<code>getaddrinfo()</code>å‡½æ•°æ”¾åœ¨ç¬¬ä¸€ä½è¿›è¡Œä»‹ç»çš„åŸå› äº†ã€‚</p><p>æ›´å¤šsocketç³»ç»Ÿè°ƒç”¨ï¼Œè¯·æœŸå¾…ä¸‹ç¯‡ã€‚</p><h3 id="_6-2-socket-â€”æ‹¿åˆ°å¥—æ¥å­—æè¿°ç¬¦" tabindex="-1"><a class="header-anchor" href="#_6-2-socket-â€”æ‹¿åˆ°å¥—æ¥å­—æè¿°ç¬¦" aria-hidden="true">#</a> 6.2. socket()â€”æ‹¿åˆ°å¥—æ¥å­—æè¿°ç¬¦ï¼</h3><p>ç°åœ¨æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹<code>socket()</code>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚</p><p>å…ˆçœ‹ä¸€äº›ç”¨æ³•å’Œå‚æ•°ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯æ˜¯è¿™ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿåˆšå¼€å§‹ç”¨è¿™ä¸ªå‡½æ•°å¯èƒ½ä¼šä¸€è„¸æ‡µï¼Œåˆ«æ€•ï¼Œæˆ‘æ…¢æ…¢ä»‹ç»ã€‚</p><p>å‡½æ•°å‚æ•°æ˜¯ç”¨æ¥æŒ‡å®šä½ æƒ³è¦çš„socketç±»å‹ï¼ˆIPv4è¿˜æ˜¯IPv6ï¼Œæ•°æ®æµï¼ˆstreamï¼‰è¿˜æ˜¯æ•°æ®æŠ¥ï¼ˆdatagramï¼‰ï¼Œ<code>TCP</code>è¿˜æ˜¯<code>UDP</code>ï¼‰ã€‚</p><p><code>domain</code>å‚æ•°æŒ‡çš„æ˜¯åè®®æ—ï¼Œä½ å¯ä»¥è®¾ç½®ä¸º<code>PF_INET</code>æˆ–è€…<code>PF_INET6</code>ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸‹è¡¨ï¼ˆåªåˆ—ä¸¾äº†ä¸€éƒ¨åˆ†ï¼‰ä¸­çš„æŸä¸ªå¸¸å€¼ã€‚</p><table><thead><tr><th style="text-align:center;">family</th><th style="text-align:center;">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center;">AF_INET</td><td style="text-align:center;">IPv4åè®®</td></tr><tr><td style="text-align:center;">AF_INET6</td><td style="text-align:center;">IPv6åè®®</td></tr><tr><td style="text-align:center;">AF_LOCAL</td><td style="text-align:center;">UnixåŸŸåè®®</td></tr><tr><td style="text-align:center;">AF_ROUTE</td><td style="text-align:center;">è·¯ç”±å¥—æ¥å­—</td></tr><tr><td style="text-align:center;">AF_KEY</td><td style="text-align:center;">å¯†é’¥å¥—æ¥å­—</td></tr></tbody></table><p><code>type</code>è¡¨ç¤ºsocketçš„ç±»å‹ï¼Œå¯ä»¥æ˜¯ä¸‹è¡¨ä¸­çš„æŸä¸ªå¸¸å€¼ã€‚</p><table><thead><tr><th style="text-align:center;">type</th><th style="text-align:center;">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center;">SOCK_STREAM</td><td style="text-align:center;">å­—èŠ‚æµsocket</td></tr><tr><td style="text-align:center;">SOCK_DGRAM</td><td style="text-align:center;">æ•°æ®æŠ¥socket</td></tr><tr><td style="text-align:center;">SOCK_SEQPACKET</td><td style="text-align:center;">æœ‰åºåˆ†ç»„socket</td></tr><tr><td style="text-align:center;">SOCK_RAW</td><td style="text-align:center;">åŸå§‹socket</td></tr></tbody></table><p>è‡³äº<code>protocol</code>ï¼Œä½ å¯ä»¥ç®€å•åœ°å°†<code>protocol</code>è®¾ç½®ä¸º<code>0</code>ï¼Œä¼šè‡ªåŠ¨é€‰æ‹©<code>domain</code>å’Œ<code>type</code>å­—æ®µç»„åˆçš„ç³»ç»Ÿé»˜è®¤å€¼ã€‚å½“ç„¶å–½ï¼Œå¦‚æœä½ æƒ³äº²åŠ›äº²ä¸ºï¼Œä½ ä¹Ÿå¯ä»¥è°ƒç”¨ <code>getprotobyname()</code> æ¥æŸ¥æ‰¾ä½ æƒ³è¦çš„åè®®ï¼Œå‚æ•°å¯ä»¥æ˜¯â€œ<code>tcp</code>â€ã€â€œ<code>udp</code>â€ç­‰ï¼Œè¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸‹è¡¨ä¸­çš„å¸¸å€¼ã€‚</p><table><thead><tr><th style="text-align:center;">protocol</th><th style="text-align:center;">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center;">IPPROTO_TCP</td><td style="text-align:center;">TCPä¼ è¾“åè®®</td></tr><tr><td style="text-align:center;">IPPROTO_UDP</td><td style="text-align:center;">UDPä¼ è¾“åè®®</td></tr><tr><td style="text-align:center;">IPPROTO_SCTP</td><td style="text-align:center;">SCTPä¼ è¾“åè®®</td></tr></tbody></table><p>å¯èƒ½ä½ å·²ç»æ³¨æ„åˆ°äº†ï¼Œ<code>domain</code>å­—æ®µçš„å€™é€‰å€¼ä¸­æ—¢æœ‰<code>AF_INET</code>åˆæœ‰<code>PF_INET</code>ï¼Œ<code>AF_XXX</code> å’Œ <code>PF_XXX</code>æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p><p><code>AF_</code>å‰ç¼€è¡¨ç¤ºåœ°å€æ—ï¼ˆ<code>AF</code>è¡¨ç¤º<code>Address Family</code>ï¼‰ï¼Œ<code>PF_</code> å‰ç¼€è¡¨ç¤ºåè®®æ—ï¼ˆ<code>PF</code>è¡¨ç¤º<code>Protocol Family</code>ï¼‰ã€‚ä½ å¯èƒ½å‘ç°æœ‰äº›èµ„æ–™çš„<code>socket()</code>ç¬¬ä¸€ä¸ªå‚æ•°ä½¿ç”¨<code>AF_XXX</code>ï¼Œæœ‰äº›èµ„æ–™å´ä½¿ç”¨<code>PF_XXX</code>ï¼Œè¿™ç¡®å®æœ‰ç‚¹è®©äººå¤´ç–¼ã€‚</p><p>è¿½æ ¹æº¯æºï¼Œè¿™å…¶å®æ˜¯æœ‰å†å²åŸå› çš„ã€‚å¾ˆä¹…å¾ˆä¹…ä¹‹å‰ï¼Œäººä»¬è®¾æƒ³å•ä¸ªåè®®æ—å¯ä»¥æ”¯æŒå¤šä¸ªåœ°å€æ—ï¼Œä½†æ˜¯è¿™ä¸ªæƒ³æ³•å°±ä»æ¥æ²¡æœ‰å®ç°è¿‡ã€‚è€Œä¸”<code>&lt;sys/socket.h&gt;</code>è¿™ä¸ªå¤´æ–‡ä»¶ä¸­ä¸ºæŸä¸ªç»™å®šåè®®å®šä¹‰çš„<code>PF_</code>å€¼æ€»æ˜¯å’Œæ­¤åè®®çš„<code>AF_</code>å€¼ç›¸ç­‰ï¼Œè¿™å°±ç›´æ¥é€ æˆäº†<code>AF_</code>å’Œ<code>PF_</code>æ»¥ç”¨çš„ä¹±è±¡ã€‚</p><p>ç›¸æ¯”<code>PF_XXX</code>ï¼Œå¾ˆå¤šç¨‹åºå‘˜æ›´å–œæ¬¢å°†<code>AF_XXX</code>ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥socketï¼Œç”šè‡³åŒ…æ‹¬ã€ŠUnixç½‘ç»œç¼–ç¨‹ã€‹çš„ä½œè€…Stevensä¹Ÿåœ¨ä¹¦ä¸­ç›´æ¥ç”¨<code>AF_XXX</code>ä½œä¸ºå‚æ•°ï¼ˆè¿™å…¶å®åªæ˜¯ä½œè€…æƒ³ä¸å¤§éƒ¨åˆ†ä»£ç ä¿æŒä¸€è‡´ç½¢äº†ï¼Œç®—æ˜¯ä¸€ç§å¦¥åï¼‰ã€‚ä½†å¤§å¤šæ•°äººåšçš„æœªå¿…å°±æ˜¯å¯¹çš„ã€‚</p><p>æˆ‘ä»¬æœ€æ¨å´‡çš„ä¸€ç§åšæ³•æ˜¯éµå®ˆPOSIXè§„èŒƒï¼Œå°†<code>socket()</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°è®¾ç½®ä¸º<code>PF_</code>å€¼ï¼Œè€Œåœ¨<code>struct sockaddr_in</code>ç»“æ„ä¸­ä½¿ç”¨<code>AF_</code>ã€‚</p><p>è¯´è¿™ä¹ˆå¤šå·²ç»å¤Ÿç”¨äº†ã€‚ç»“åˆä¹‹å‰è®²è¿‡çš„<code>getaddrinfo()</code>ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯å°†<code>getaddrinfo()</code>è°ƒç”¨å¾—åˆ°ç»“æœç›´æ¥å–‚ç»™<code>socket()</code>ï¼Œåƒè¿™æ ·ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> s<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>

<span class="token comment">// do the lookup</span>
<span class="token comment">// [pretend we already filled out the &quot;hints&quot; struct]</span>
<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">&quot;www.example.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// again, you should do error-checking on getaddrinfo(), and walk</span>
<span class="token comment">// the &quot;res&quot; linked list looking for valid entries instead of just</span>
<span class="token comment">// assuming the first one is good (like many of these examples do).</span>
<span class="token comment">// See the section on client/server for real examples.</span>

s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>socket()</code>å‡½æ•°åœ¨è¿”å›æˆåŠŸæ—¶ä¼šè¿”å›ä¸€ä¸ªå¥—æ¥å­—æè¿°ç¬¦ï¼ˆsocket descriptorï¼‰,å®ƒæ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼Œåœ¨åç»­çš„å…¶ä»–å‡½æ•°è°ƒç”¨ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥è¡¨ç¤ºè¿™ä¸ªsocketã€‚</p><p>å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œ<code>socket()</code>ä¼šè¿”å›<code>-1</code>ï¼Œæ­¤æ—¶<code>errno</code>è¿™ä¸ªå…¨å±€å˜é‡ä¼šè¢«è®¾ç½®ä¸ºè¯¥é”™è¯¯çš„å€¼ã€‚</p><blockquote><p>åªè¦ä¸€ä¸ªUnixå‡½æ•°å‘ç”Ÿé”™è¯¯ï¼ŒUnixçš„å…¨å±€å˜é‡<code>errno</code>å°±ä¼šè¢«è®¾ç½®ä¸ºä¸€ä¸ªæŒ‡æ˜è¯¥é”™è¯¯ç±»å‹çš„æŸä¸ªæ­£æ•°ï¼Œè€Œå‡½æ•°æœ¬èº«é€šå¸¸è¿”å›<code>-1</code>ã€‚</p><p>ä¸‹é¢å±•ç¤ºäº†<code>&lt;sys/errno.h&gt;</code>å¤´æ–‡ä»¶ä¸­å®šä¹‰çš„<code>errno</code>çš„éƒ¨åˆ†å€™é€‰å€¼ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">/*
 * Error codes
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPERM</span>           <span class="token expression"><span class="token number">1</span>               </span><span class="token comment">/* Operation not permitted */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENOENT</span>          <span class="token expression"><span class="token number">2</span>               </span><span class="token comment">/* No such file or directory */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESRCH</span>           <span class="token expression"><span class="token number">3</span>               </span><span class="token comment">/* No such process */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EINTR</span>           <span class="token expression"><span class="token number">4</span>               </span><span class="token comment">/* Interrupted system call */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EIO</span>             <span class="token expression"><span class="token number">5</span>               </span><span class="token comment">/* Input/output error */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENXIO</span>           <span class="token expression"><span class="token number">6</span>               </span><span class="token comment">/* Device not configured */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">E2BIG</span>           <span class="token expression"><span class="token number">7</span>               </span><span class="token comment">/* Argument list too long */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENOEXEC</span>         <span class="token expression"><span class="token number">8</span>               </span><span class="token comment">/* Exec format error */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EBADF</span>           <span class="token expression"><span class="token number">9</span>               </span><span class="token comment">/* Bad file descriptor */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ECHILD</span>          <span class="token expression"><span class="token number">10</span>              </span><span class="token comment">/* No child processes */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EDEADLK</span>         <span class="token expression"><span class="token number">11</span>              </span><span class="token comment">/* Resource deadlock avoided */</span></span>
                                        <span class="token comment">/* 11 was EAGAIN */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENOMEM</span>          <span class="token expression"><span class="token number">12</span>              </span><span class="token comment">/* Cannot allocate memory */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EACCES</span>          <span class="token expression"><span class="token number">13</span>              </span><span class="token comment">/* Permission denied */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EFAULT</span>          <span class="token expression"><span class="token number">14</span>              </span><span class="token comment">/* Bad address */</span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h3 id="_6-3-bind-â€”æˆ‘åœ¨ç›‘å¬å“ªä¸ªç«¯å£" tabindex="-1"><a class="header-anchor" href="#_6-3-bind-â€”æˆ‘åœ¨ç›‘å¬å“ªä¸ªç«¯å£" aria-hidden="true">#</a> 6.3. bind()â€”æˆ‘åœ¨ç›‘å¬å“ªä¸ªç«¯å£?</h3><p>å½“ä½ åˆ›å»ºäº†socketä¹‹åï¼Œä½ ä¼šæƒ³è¦æŠŠè¿™ä¸ªsocketå’Œä½ æœ¬æœºä¸Šçš„æŸä¸ªç«¯å£å·ï¼ˆportï¼‰è¿›è¡Œå…³è”ã€‚</p><p>ç«¯å£å·æ˜¯å†…æ ¸ç”¨æ¥ç¡®è®¤å°†æ”¶åˆ°çš„æ•°æ®åŒ…äº¤ç»™å“ªä¸ªå…·ä½“è¿›ç¨‹çš„<code>socket descriptor</code>çš„ä¾æ®ã€‚</p><blockquote><p>é€šå¸¸åœ¨å†™æœåŠ¡ç«¯ç¨‹åºçš„æ—¶å€™æˆ‘ä»¬æ‰éœ€è¦è¿›è¡Œå…³è”ï¼Œå®¢æˆ·ç«¯ç¨‹åºä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ç»‘å®šç«¯å£ï¼Œç›´æ¥<code>connect()</code>å°±å¥½äº†ã€‚</p></blockquote><p>æ¥çœ‹çœ‹ç«¯å£å·å…·ä½“æ˜¯æ€ä¹ˆç»‘å®šçš„å§ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>my_addr<span class="token punctuation">,</span> <span class="token keyword">int</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sockfd</code>æ˜¯<code>socket()</code>è¿”å›çš„ä¸€ä¸ª<code>socket file descriptor</code>ï¼›<code>my_addr</code>æ˜¯ä¸€ä¸ªæŒ‡å‘åŒ…å«äº†ä½ çš„ç«¯å£å·å’ŒIPåœ°å€ä¿¡æ¯çš„<code>struct sockaddr</code>æŒ‡é’ˆï¼›<code>addrlen</code>æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½çš„åœ°å€é•¿åº¦ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»™å‡ºä¸€ä¸ªä¾‹å­ï¼Œå®ƒå°†socketå’Œæˆ‘æœ¬æœºçš„<code>3490</code>ç«¯å£è¿›è¡Œç»‘å®šï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>

<span class="token comment">// first, load up address structs with getaddrinfo():</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>  <span class="token comment">// use IPv4 or IPv6, whichever</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span>     <span class="token comment">// fill in my IP for me</span>

<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;3490&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make a socket:</span>

sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// bind it to the port we passed in to getaddrinfo():</span>

<span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä½¿ç”¨<code>AI_PASSIVE</code>æ ‡è¯†ï¼Œç¨‹åºä¼šè‡ªåŠ¨ç»‘å®šå®ƒæ‰€åœ¨çš„ç¨‹åºçš„IPã€‚å¦‚æœä½ æƒ³ç²¾ç¡®ç»‘å®šåˆ°æœ¬æœºçš„æŸä¸€ä¸ªIPåœ°å€ï¼Œä½ å°±ä¸èƒ½ç”¨<code>AI_PASSIVE</code>äº†ï¼Œè€Œä¸”ä½ è¿˜å¾—æŠŠ<code>getaddrinfo()</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°ä»<code>NULL</code>æ”¹ä¸ºä½ æƒ³ç»‘å®šçš„é‚£ä¸ªIPåœ°å€ã€‚</p><p><code>bind()</code>å’Œå…¶ä»–ç³»ç»Ÿè°ƒç”¨ä¸€æ ·ï¼Œå‘ç”Ÿé”™è¯¯çš„æ—¶å€™è¿”å›<code>-1</code>ï¼Œå¹¶ä¸”ä¼šè®¾ç½®å…¨å±€å˜é‡<code>errno</code>çš„å€¼ã€‚</p><p>å¾ˆå¤šè€ä»£ç éƒ½ä¼šåœ¨è°ƒç”¨<code>bind()</code>ä¹‹å‰æ‰‹åŠ¨å°è£… <code>struct sockaddr_in</code> ã€‚å½“ç„¶ï¼Œè¿™é‡Œç»‘å®šçš„è‚¯å®šæ˜¯IPv4çš„åœ°å€ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨IPv6ï¼Œä½ ç…§æ ·å¯ä»¥æ‰‹åŠ¨å°è£…<code>struct sockaddr_in6</code> ï¼Œä½†æ˜¯æåŠ›ä¸æ¨èä½ è¿™ä¹ˆåšã€‚ä½ è¿˜æ˜¯åº”è¯¥è€è€å®å®ç”¨ <code>getaddrinfo()</code> ï¼Œè¿™æ ·æ›´ä¼˜é›…ã€æ›´ç®€å•ã€‚</p><p>ç»™ä½ çœ‹çœ‹è€ä»£ç é•¿ä»€ä¹ˆæ ·å­å§ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// !!! THIS IS THE OLD WAY !!!</span>

<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> my_addr<span class="token punctuation">;</span>

sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

my_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
my_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>MYPORT<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// short, network byte order</span>
my_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">&quot;10.12.110.57&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span>my_addr<span class="token punctuation">.</span>sin_zero<span class="token punctuation">,</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> my_addr<span class="token punctuation">.</span>sin_zero<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>my_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> my_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢è¿™ä¸ªä»£ç ä¸­ï¼Œä½ ä¾ç„¶å¯ä»¥æŠŠ<code>my_addr.sin_addr.s_addr</code>è®¾ç½®ä¸º <code>INADDR_ANY</code> ï¼Œå®ƒçš„ä½œç”¨ä¸Šæ–‡æåˆ°çš„<code>AI_PASSIVE</code>ä¸€æ ·ï¼Œéƒ½ä¼šè®©ä»£ç è‡ªåŠ¨ç»‘å®šåˆ°æœ¬æœºIPã€‚ <code>INADDR_ANY</code> çš„IPv6ç‰ˆæœ¬æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå«<code>in6addr_any</code>ï¼Œè¿™ä¸ªå˜é‡ä¼šè¢«æŒ‡å®šç»™ä½ çš„ <code>struct sockaddr_in6</code> çš„<code>sin6_addr</code>å­—æ®µã€‚</p><blockquote><p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨<code>IN6ADDR_ANY_INIT</code>è¿™ä¸ªå®æ¥åˆå§‹åŒ–å˜é‡</p></blockquote><p>è°ƒç”¨<code>bind()</code>æ—¶æœ‰ä¸€ä»¶äº‹éœ€è¦ä½ ç‰¹åˆ«æ³¨æ„ï¼šä¸è¦ä½¿ç”¨<code>1024</code>ä»¥ä¸‹çš„ç«¯å£å·ï¼Œå› ä¸ºè¿™äº›ç«¯å£å·æ˜¯è¢«ä¿ç•™ä½¿ç”¨çš„ï¼Œé™¤éä½ æ˜¯è¶…çº§ç®¡ç†å‘˜ã€‚é™¤äº†<code>1024</code>ä»¥ä¸‹çš„ï¼Œ<code>1025ï½65535</code>ä¹‹é—´çš„éšä¾¿ç”¨ï¼ˆå…¶ä»–ç¨‹åºå ç”¨çš„é™¤å¤–ï¼‰ã€‚</p><p>æœ‰æ—¶å€™ï¼Œä½ æ˜æ˜é‡æ–°è¿è¡Œäº†ä½ çš„æœåŠ¡ç«¯ç¨‹åºï¼Œä½†æ˜¯<code>bind()</code>æŠ¥é”™äº†ï¼Œæç¤ºä½ â€œAddress already in useâ€ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿç†è®ºä¸Šé‡å¯ä¹‹åç«¯å£å°±ä¼šè¢«é‡Šæ”¾å•Šï¼å¥½å§ï¼Œè¿™æ˜¯å› ä¸ºæœ‰ä¸€äº›è¿æ¥åˆ°socketçš„è¿æ¥è¿˜æ‚¬åœ¨å†…æ ¸ä¸­ï¼Œå°±æ˜¯å®ƒä»¬å ç”¨äº†è¿™ä¸ªç«¯å£å·ã€‚ä½ å¯ä»¥ç­‰ä¸€åˆ†é’Ÿå·¦å³è®©å®ƒä»¬è‡ªè¡Œæ¶ˆå¤±ï¼Œæˆ–è€…åœ¨ä½ çš„ä»£ç åŠ è¿™ä¹ˆå‡ è¡Œï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> yes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//char yes=&#39;1&#39;; // Solaris people use this</span>

<span class="token comment">// lose the pesky &quot;Address already in use&quot; error message</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token operator">&amp;</span>yes<span class="token punctuation">,</span><span class="token keyword">sizeof</span> yes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;setsockopt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·å°±ä¸ä¼šå†å‡ºç°ç«¯å£è¢«å ç”¨çš„é—®é¢˜äº†ã€‚</p><h3 id="_6-4-connect-â€”å˜¿-ä½ å¥½å•Š" tabindex="-1"><a class="header-anchor" href="#_6-4-connect-â€”å˜¿-ä½ å¥½å•Š" aria-hidden="true">#</a> 6.4. connect()â€”å˜¿ï¼Œä½ å¥½å•Šï¼</h3><p>å®¢æˆ·ç«¯å°±æ˜¯ç”¨<code>connect()</code>å‡½æ•°æ¥å»ºç«‹ä¸æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥çš„ã€‚</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>serv_addr<span class="token punctuation">,</span> <span class="token keyword">int</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sockfd</code>æ˜¯æˆ‘ä»¬çš„è€æœ‹å‹äº†ï¼Œæ˜¯ç”±<code>socket()</code>å‡½æ•°è¿”å›çš„å¥—æ¥å­—æè¿°ç¬¦ï¼Œ<code>serv_addr</code>æ˜¯ä¸€ä¸ªæ‰§è¡Œå¥—æ¥å­—åœ°å€ç»“æ„ <code>struct sockaddr</code> çš„æŒ‡é’ˆï¼Œ <code>struct sockaddr</code> ä¸­å­˜å‚¨äº†ç›®æ ‡IPåœ°å€å’Œç«¯å£å·ä¿¡æ¯ï¼Œ<code>addrlen</code>æ˜¯<code>serv_addr</code>æŒ‡å‘çš„<code>struct sockaddr</code> å¤§å°ã€‚</p><p>å†æ¬¡å¼ºè°ƒä¸€ä¸‹ <code>getaddrinfo()</code> çš„å¦™å¤„ï¼Œæ‰€æœ‰ä½ éœ€è¦çš„è¿æ¥ä¿¡æ¯éƒ½å¯ä»¥ä»è¿™ä¸ªå‡½æ•°çš„è¿”å›ç»“æœä¸­è·å–ã€‚</p><p>å®¢æˆ·ç«¯åœ¨è°ƒç”¨<code>connect()</code>ä¹‹å‰ä¸å¿…éå¾—è°ƒç”¨<code>bind()</code>å‡½æ•°ï¼Œå› ä¸ºå¦‚æœæœ‰å¿…è¦ï¼Œå†…æ ¸ä¼šç¡®å®šæºIPåœ°å€ï¼Œå¹¶é€‰æ‹©ä¸€ä¸ªä¸´æ—¶ç«¯å£å·ä½œä¸ºæºç«¯å£ã€‚</p><p>ä¸¾ä¸€ä¸ªä½¿ç”¨<code>connect()</code>è¿æ¥åˆ°&quot;<a href="http://www.chanmufeng.com" target="_blank" rel="noopener noreferrer">www.chanmufeng.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>&quot; çš„<code>3490</code>ç«¯å£çš„ä¾‹å­ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>

<span class="token comment">// first, load up address structs with getaddrinfo():</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>

<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">&quot;www.example.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3490&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make a socket:</span>

sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// connect!</span>

<span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å’Œä¸Šä¸€èŠ‚è®²çš„<code>bind()</code>ä¸€æ ·ï¼Œæœ‰äº›è€ä»£ç åœ¨è°ƒç”¨<code>connect()</code>ä¹‹å‰ä¼šæ‰‹åŠ¨å°è£… <code>struct sockaddr_in</code>ï¼Œç„¶åä¼ ç»™<code>connect()</code>ä½œä¸ºå‚æ•°ã€‚ä½ ç°åœ¨ä»ç„¶å¯ä»¥è¿™ä¹ˆåšï¼Œä½†æ˜¯æ²¡å¿…è¦ï¼</p><p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯TCPå¥—æ¥å­—ï¼Œè°ƒç”¨<code>connect</code>å‡½æ•°ä¼šè§¦å‘TCPçš„ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼Œè€Œä¸”ä»…åœ¨è¿æ¥æˆåŠŸæˆ–è€…å¤±è´¥æ—¶æ‰ä¼šè¿”å›ï¼Œå¤±è´¥è¿”å›<code>-1</code>ï¼Œå¹¶ä¸”ä¼šè®¾ç½®å…¨å±€å˜é‡<code>errno</code>çš„å€¼ã€‚</p><h3 id="_6-5-listen-â€”ä¼šæœ‰äººè”ç³»æˆ‘å—" tabindex="-1"><a class="header-anchor" href="#_6-5-listen-â€”ä¼šæœ‰äººè”ç³»æˆ‘å—" aria-hidden="true">#</a> 6.5. listen()â€”ä¼šæœ‰äººè”ç³»æˆ‘å—?</h3><p>ä¹‹å‰è®²çš„å‡½æ•°æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½å¯ä»¥ä½¿ç”¨ï¼Œè®©æˆ‘ä»¬æ¢æ¢å£å‘³ï¼Œè¿™æ¬¡è®²ä¸€ä¸ªä»…ç”¨äºæœåŠ¡ç«¯çš„å‡½æ•°ï¼Œä¸ä»…å¦‚æ­¤ï¼Œå®ƒè¿˜åªèƒ½ç”¨äºTCPæœåŠ¡ç«¯ã€‚</p><p>èº«ä¸ºæœåŠ¡ç«¯ï¼Œè‚¯å®šæ˜¯éœ€è¦ç­‰å¾…éšæ—¶å¯èƒ½åˆ°æ¥çš„å®¢æˆ·ç«¯è¿æ¥ï¼Œå¹¶é‡‡ç”¨æŸç§æ–¹å¼å¤„ç†è¿æ¥ã€‚æ•´ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸¤æ­¥ï¼šå…ˆè°ƒç”¨<code>listen()</code>ï¼Œç„¶åè°ƒç”¨<code>accept()</code>ï¼ˆè¿™æ˜¯ä¸‹ä¸€å°èŠ‚çš„å†…å®¹ï¼‰ã€‚</p><p><code>listen</code>çš„è°ƒç”¨éå¸¸ç®€å•ï¼Œå¦‚ä¸‹ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sock.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è™½ç„¶åªæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä½†æ˜¯å…¶ä¸­æœ‰ä¸€äº›ç»†èŠ‚å€¼å¾—ç©å‘³ã€‚</p><p><code>sockfd</code>å°±æ˜¯é€šè¿‡<code>socket()</code>è¿”å›çš„ä¸€ä¸ª<strong>æ™®é€š</strong><code>socket file descriptor</code>è€Œå·²ï¼Œç³»ç»Ÿé»˜è®¤è¿™ä¸ªsocketåªæ˜¯ä¸€ä¸ªç­‰å¾…è¿›è¡Œä¸»åŠ¨è¿æ¥çš„å®¢æˆ·ç«¯socketã€‚è€Œ<code>listen</code>å‡½æ•°ä¼šæŠŠè¿™ä¸ªå®¢æˆ·ç«¯socketè½¬æ¢ä¸ºæœåŠ¡ç«¯socketï¼Œå‘Šè¯‰å†…æ ¸éœ€è¦æ¥å—æŒ‡å‘è¯¥socketçš„è¿æ¥è¯·æ±‚ï¼Œå¹¶ä¸”è¯¥socketçš„TCPçŠ¶æ€ä»<code>CLOSED</code>è½¬æ¢ä¸º<code>LISTEN</code>ã€‚</p><p><code>backlog</code>å‚æ•°è¡¨ç¤ºå†…æ ¸åº”è¯¥ä¸ºè¯¥å¥—æ¥å­—æ’é˜Ÿçš„æœ€å¤§è¿æ¥ä¸ªæ•°ã€‚è¿™æ˜¯å•¥æ„æ€ï¼Ÿæ‰€æœ‰å®¢æˆ·ç«¯ä¸è¯¥socketå»ºç«‹çš„è¿æ¥éƒ½ä¼šåœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­æ’é˜Ÿç­‰å¾…ï¼Œç›´åˆ°ä½ <code>accept()</code>ï¼ˆè§ä¸‹èŠ‚ï¼‰å®ƒä»¬ï¼Œè¿™ä¸ªå‚æ•°å°±è¡¨ç¤ºæœ€å¤šæœ‰å¤šå°‘ä¸ªè¿æ¥æœ‰èµ„æ ¼æ’é˜Ÿã€‚å¤§å¤šæ•°ç³»ç»Ÿå°†è¿™ä¸ªå€¼é¢„è®¾ä¸º20ï¼Œä½ å¯ä»¥åˆå§‹åŒ–ä¸º5æˆ–è€…10ã€‚</p><p>è¿˜æœ‰è€ç”Ÿå¸¸è°ˆçš„ï¼Œ<code>listen() </code>åœ¨é”™è¯¯çš„æ—¶å€™ä¼šè¿”å›<code> -1</code>ï¼Œå¹¶è®¾ç½® <code>errno</code>ã€‚</p><p>è”ç³»ä¹‹å‰è®²è¿‡çš„3ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œåˆ›å»ºæœåŠ¡ç«¯ä»£ç éœ€è¦è°ƒç”¨çš„å‡½æ•°ä¾æ¬¡ä¸ºï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* accept() å°†è¢«å†™åœ¨è¿™é‡Œ */</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘åªæ˜¯åˆ—å‡ºäº†å‡½æ•°çš„è°ƒç”¨é¡ºåºè€Œå·²ï¼Œè¿™å‡ ä¸ªæ­¥éª¤éƒ½æ¯”è¾ƒç®€å•ï¼Œç¨å¾®éœ€è¦ç‚¹å¤„ç†æŠ€å·§çš„æ˜¯ä¸‹ä¸€èŠ‚çš„<code>accept()</code>ã€‚</p><h3 id="_6-6-accept-â€”æ„Ÿè°¢å‘¼å«3490ç«¯å£" tabindex="-1"><a class="header-anchor" href="#_6-6-accept-â€”æ„Ÿè°¢å‘¼å«3490ç«¯å£" aria-hidden="true">#</a> 6.6. accept()â€”æ„Ÿè°¢å‘¼å«3490ç«¯å£</h3><p>ç³»å¥½å®‰å…¨å¸¦ï¼Œ<code>accept()</code>ä¹‹æ—…å¼€å§‹äº†ã€‚</p><p>ä¸€ä¸ªè¿œç¨‹ç”¨æˆ·è¯•å›¾è°ƒç”¨<code>connect()</code>æ¥è¿æ¥åˆ°ä½ ä½¿ç”¨<code>listen()</code>è¿›è¡Œç›‘å¬çš„ç«¯å£ä¸Šï¼Œè¿™ä¸ªè¿æ¥ä¼šè¢«æ”¾åˆ°é˜Ÿåˆ—ä¸­ç­‰ç€è¢«ä½ <code>accept()</code>ã€‚è¿™å¥è¯è¦æ˜¯ä½ çœ‹ä¸æ‡‚ä½ éœ€è¦å›å»çœ‹çœ‹å‰æ–‡å“¦ã€‚</p><p>ç„¶åä½ è°ƒç”¨<code>accept()</code>ï¼Œä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªç­‰å€™å·²ä¹…çš„è¿æ¥ï¼Œ<code>accept()</code>ä¼šè¿”å›ç»™ä½ ä¸€ä¸ªä¸“å±äºè¿™ä¸ªè¿æ¥çš„ä¸€ä¸ª<strong>å…¨æ–°çš„</strong><code>socket file descriptor</code>ï¼</p><p>æ²¡é”™ï¼Œä½ ç°åœ¨æœ‰<strong>2ä¸ª</strong><code>socket file descriptor</code>äº†ï¼åŸæ¥çš„<code>socket file descriptor</code>ä»åœ¨å¤„äºè¢«<code>listen()</code>çš„çŠ¶æ€ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œè€Œä½ åˆšåˆšå¾—åˆ°çš„<code>socket file descriptor</code>åˆ™æ˜¯å‡†å¤‡ç»™<code>send()</code>å’Œ<code>recv()</code>ä½¿ç”¨çš„ï¼Œé€šè¿‡è¿™ä¿©å‡½æ•°ï¼Œå°±å¯ä»¥å®ç°å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„é€šä¿¡äº†ã€‚</p><p><code>accept()</code>ä½¿ç”¨å¦‚ä¸‹ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sockfd</code>å°±æ˜¯æ­£åœ¨è¢«<code>listen()</code>çš„é‚£ä¸ª<code>socket descriptor</code>ï¼Œè¿™ä¸ªæ²¡å•¥éš¾åº¦ã€‚</p><p><code>addr</code>å°±æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>struct sockaddr_storage</code>çš„æŒ‡é’ˆï¼Œè¿™é‡Œè¾¹ä¼šè‡ªåŠ¨ä¿å­˜å®¢æˆ·ç«¯çš„ä¸€äº›ä¿¡æ¯ï¼Œä½ èƒ½ä»ä¸­å¾—çŸ¥å®¢æˆ·ç«¯æ˜¯ä»å“ªä¸ªIPã€å“ªä¸ªç«¯å£å¯¹ä½ å‘èµ·çš„è¿æ¥ã€‚</p><p><code>addrlen</code>æ˜¯ä¸€ä¸ªæ•´æ•°å˜é‡ï¼Œä½ åº”è¯¥åœ¨å°†å®ƒçš„åœ°å€ä¼ ç»™<code>accept()</code>ä¹‹å‰ï¼ŒæŠŠå®ƒè®¾ç½®ä¸º <code>sizeof(struct sockaddr_storage)</code> ã€‚<code>accept()</code>ä¿å­˜åœ¨<code>addr</code>æŒ‡å‘çš„å¯¹è±¡ä¸­çš„æ•°æ®å¤§å°åªä¼šå°äºç­‰äº<code>addrlen</code>ï¼Œå¦‚æœå°äºçš„è¯ï¼Œ<code>accept()</code>ä¼šé€šè¿‡æ”¹å˜<code>addrlen</code>çš„å€¼æ¥å‘Šè¯‰ä½ ï¼Œæ‰€ä»¥ä½ åº”è¯¥çŸ¥é“ä¸ºä»€ä¹ˆè¿™ä¸ªå­—æ®µæ˜¯ä¸ªæŒ‡é’ˆå˜é‡äº†å§ã€‚</p><p>çŒœçŒœæˆ‘è¦è¯´å•¥ï¼Œä¸€å¥æˆ‘å¿«è¯´åäº†çš„è¯ã€‚<code>accept() </code>åœ¨é”™è¯¯çš„æ—¶å€™ä¼šè¿”å›<code> -1</code>ï¼Œå¹¶è®¾ç½® <code>errno</code>ã€‚</p><p>å’Œä¹‹å‰ä¸€æ ·ï¼Œshow you the codeå¯èƒ½ä¼šæ›´å¥½å¸æ”¶ï¼Œçœ‹ä¸€æ®µä»£ç ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MYPORT</span> <span class="token string">&quot;3490&quot;</span>  <span class="token comment">// the port users will be connecting to</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BACKLOG</span> <span class="token expression"><span class="token number">10</span>     </span><span class="token comment">// how many pending connections queue will hold</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> their_addr<span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span> addr_size<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> new_fd<span class="token punctuation">;</span>

    <span class="token comment">// !! don&#39;t forget your error checking for these calls !!</span>

    <span class="token comment">// first, load up address structs with getaddrinfo():</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>  <span class="token comment">// use IPv4 or IPv6, whichever</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span>     <span class="token comment">// fill in my IP for me</span>

    <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> MYPORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// make a socket, bind it, and listen on it:</span>

    sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> BACKLOG<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// now accept an incoming connection:</span>

    addr_size <span class="token operator">=</span> <span class="token keyword">sizeof</span> their_addr<span class="token punctuation">;</span>
    new_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>their_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ready to communicate on socket descriptor new_fd!</span>
    <span class="token punctuation">.</span>
    <span class="token punctuation">.</span>
    <span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¼šç”¨å¾—åˆ°çš„<code>new_fd</code>è¿™ä¸ª<code>socket descriptor</code>è¿›è¡Œ<code>send()</code>å’Œ<code>recv()</code>ã€‚</p><p>å¦‚æœä½ åªæ˜¯æƒ³è·å–è¿™ä¸€ä¸ªè¿æ¥ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>close()</code>æ¥å…³é—­å¤„äº<code>LISTEN</code>çŠ¶æ€çš„<code>sockfd</code>ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æœ‰æ›´å¤šçš„å®¢æˆ·ç«¯è¿æ¥åˆ°<code>3490</code>è¿™ä¸ªç«¯å£ä¸Šäº†ã€‚</p><h3 id="_6-7-send-and-recv-â€”è·Ÿæˆ‘å” å” å§-å®å„¿" tabindex="-1"><a class="header-anchor" href="#_6-7-send-and-recv-â€”è·Ÿæˆ‘å” å” å§-å®å„¿" aria-hidden="true">#</a> 6.7. send() and recv()â€”è·Ÿæˆ‘å” å” å§ï¼Œå®å„¿!</h3><p><code>send()</code>å’Œ<code>recv()</code>ä¸¤ä¸ªå‡½æ•°æ˜¯æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯é€šè¿‡<code>stream socket</code>æˆ–è€…æ˜¯<code>connected datagram socket</code>ç”¨æ¥é€šä¿¡çš„ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨å¸¸è§„çš„<code>unconnected datagram socket</code>ï¼Œä½ éœ€è¦å‚è€ƒä¸‹æ–‡çš„<code>sendto()</code>å’Œ<code>recvfrom()</code>ä¸€èŠ‚äº†ã€‚</p><p><code>send()</code>çš„å£°æ˜é•¿è¿™æ ·å„¿ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>sockfd</code>æ˜¯ä¸€ä¸ªä½ æƒ³å‘é€æ•°æ®è¿‡å»çš„<code>socket descriptor</code>ï¼Œè¿™ä¸ª<code>socket descriptor</code>å¯èƒ½æ˜¯<code>socket()</code>è¿”å›çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯é€šè¿‡<code>accept()</code>å¾—åˆ°çš„ã€‚</p><p><code>msg</code>æ˜¯æŒ‡å‘å‘æƒ³å‘é€çš„æ•°æ®çš„æŒ‡é’ˆï¼Œ<code>len</code>æ˜¯æ•°æ®çš„å­—èŠ‚é•¿åº¦ã€‚è‡³äº<code>flags</code>ï¼Œä½ å°±ç›´æ¥è®¾ç½®æˆ<code>0</code>å°±å®Œäº†ï¼ˆæ›´å¤šçš„ç»†èŠ‚å‚è§åæ–‡çš„<code>send()</code>æ‰‹å†Œï¼ŒPSï¼šè¿˜æ²¡ç¿»è¯‘åˆ°é‚£é‡Œï¼‰ã€‚</p><p>ä¸Šä¾‹å­ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">char</span> <span class="token operator">*</span>msg <span class="token operator">=</span> <span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> len<span class="token punctuation">,</span> bytes_sent<span class="token punctuation">;</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
bytes_sent <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>send()</code>çš„è¿”å›å€¼è¡¨ç¤ºå®é™…å‘é€æ•°æ®çš„å­—èŠ‚æ•°ï¼Œè¿™ä¸ªæ•°å¯èƒ½æ¯”ä½ è®¾ç½®çš„æƒ³å‘é€çš„æ•°æ®é•¿åº¦<code>len</code>è¦å°ã€‚äº‹æƒ…å°±æ˜¯è¿™ä¹ˆå¥‡æ€ªï¼Œæ˜æ˜ä½ æƒ³è®©å‡½æ•°å‘é€æ‰€æœ‰çš„æ•°æ®ï¼Œå®ƒå´åšä¸åˆ°ï¼Œå®ƒåªèƒ½å°½åŠ›æŠŠèƒ½å‘é€çš„æ•°æ®éƒ½å‘é€å‡ºå»ï¼Œä½†æ˜¯å®ƒä¸ä¼šè‡ªåŠ¨å‘é€å‰©ä¸‹çš„æ•°æ®ã€‚</p><p>å› æ­¤ï¼Œå¦‚æœ<code>send()</code>è¿”å›çš„å€¼å°äº<code>len</code>çš„è¯ï¼Œå°±éœ€è¦ç”±ä½ æ¥å†³å®šæ˜¯ä¸æ˜¯è¦å‘é€å‰©ä¸‹çš„æ•°æ®äº†ã€‚ä¹Ÿå¹¶éæ¯æ¬¡éƒ½è¿™æ ·ï¼Œå¦‚æœæ•°æ®åŒ…å¾ˆå°ï¼ˆå°äº<code>1K</code>æˆ–æ›´å°ï¼‰ï¼Œ<code>send()</code><strong>å¯èƒ½</strong>ä¼šä¸€ä¸‹å­æŠŠæ‰€æœ‰æ•°æ®éƒ½å‘å‡ºå»ã€‚</p><p>å†å¼ºè°ƒä¸€éï¼Œ<code>send()</code>å¼‚å¸¸çš„è¯ä¼šè¿”å›<code>-1</code>ï¼Œå¹¶ä¸”ä¿®æ”¹<code>errno</code>è¿™ä¸ªå…¨å±€å˜é‡ã€‚</p><p><code>recv()</code>è¿™ä¸ªå‡½æ•°åœ¨å¾ˆå¤šæ–¹é¢å’Œ<code>send()</code>ç±»ä¼¼ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">recv</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>sockfd</code>æ˜¯ä½ æƒ³ä»ä¸­è¯»å–æ•°æ®çš„<code>socket descriptor</code>ï¼Œ<code>buf</code>æ˜¯å­˜å‚¨ä½ è¯»å–çš„æ•°æ®çš„ç¼“å†²åŒºï¼Œ<code>len</code>æ˜¯ç¼“å†²åŒºçš„æœ€å¤§é•¿åº¦ï¼Œ<code>flags</code>è¿˜æ˜¯ç›´æ¥è®¾ç½®æˆ<code>0</code>å°±è¡Œï¼ˆæ›´å¤šçš„ç»†èŠ‚å‚è§ä¹‹åçš„<code>recv()</code>æ‰‹å†Œï¼ŒPSï¼šè¿˜æ²¡ç¿»è¯‘åˆ°é‚£é‡Œï¼‰ã€‚</p><p><code>recv()</code>çš„è¿”å›å€¼è¡¨ç¤ºå®é™…è¯»åˆ°ç¼“å†²åŒºçš„å­—èŠ‚æ•°ï¼Œå¼‚å¸¸çš„è¯ä¼šè¿”å›<code>-1</code>ï¼Œå¹¶ä¸”ä¿®æ”¹<code>errno</code>è¿™ä¸ªå…¨å±€å˜é‡ã€‚</p><p>æ³¨æ„ï¼<code>recv()</code>çš„è¿”å›å€¼å¯ä»¥æ˜¯<code>0</code>ï¼Œæ˜¯<code>0</code>æ„å‘³ç€å¯¹é¢å…³é—­äº†ä¸ä½ çš„è¿æ¥ï¼Œè¿”å›<code>0</code>æ˜¯ä¸ºäº†è®©ä½ çŸ¥é“è¿™å›äº‹å„¿ã€‚</p><p>åˆ°è¿™å°±ç»“æŸäº†ï¼Œå¾ˆç®€å•å¯¹å§ã€‚ä½ ç°åœ¨å¯ä»¥é€šè¿‡<code>stream socket</code>è¿›è¡Œå¾€è¿”æ•°æ®å¤„ç†äº†ã€‚</p><p>æ­å–œä½ ï¼Œæ­£å¼æˆä¸ºä¸€åUNIXç½‘ç»œç¼–ç¨‹è®¾è®¡å¸ˆï¼</p><h3 id="_6-8-sendto-and-recvfrom-â€”ç”¨dgramé£æ ¼è·Ÿæˆ‘è¯´è¯" tabindex="-1"><a class="header-anchor" href="#_6-8-sendto-and-recvfrom-â€”ç”¨dgramé£æ ¼è·Ÿæˆ‘è¯´è¯" aria-hidden="true">#</a> 6.8. sendto() and recvfrom()â€”ç”¨DGRAMé£æ ¼è·Ÿæˆ‘è¯´è¯</h3><p><code>datagram socket</code>åœ¨å‘é€æ•°æ®æ•°æ®ä¹‹å‰ä¸éœ€è¦å»ºç«‹å’Œå¯¹æ–¹çš„è¿æ¥ï¼Œä½†æ˜¯åœ¨å‘é€æ•°æ®ä¹‹å‰æˆ‘ä»¬èµ·ç å¾—æŠŠç›®çš„åœ°å€ç»™å‡†å¤‡å¥½ã€‚</p><p>çœ‹ä¸€ä¸‹<code>sendto()</code>è¿™ä¸ªå‡½æ•°ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">sendto</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
           <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>to<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> tolen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>é™¤äº†åè¾¹ä¸¤ä¸ªå‚æ•°ï¼Œå‰©ä¸‹çš„å‚æ•°å’Œ<code>send()</code>å‡½æ•°åŸºæœ¬ä¿æŒä¸€è‡´ï¼Œå°±ä¸å†ä»‹ç»äº†ã€‚</p><p><code>to</code>æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>struct sockaddr</code>ï¼ˆä¹Ÿå¯èƒ½æ˜¯è¢«å¼ºåˆ¶ç±»å‹è½¬æ¢æˆçš„ <code>struct sockaddr_in</code> ã€ <code>struct sockaddr_in6</code> æˆ–è€… <code>struct sockaddr_storage</code>ç»“æ„ ï¼‰çš„æŒ‡é’ˆï¼Œè¿™ä¸ªstructä¸­åŒ…å«äº†ç›®çš„IPåœ°å€å’Œç«¯å£å·ã€‚<code>tolen</code>æ˜¯ä¸€ä¸ª<code>int</code>å˜é‡ï¼Œå¯ä»¥ç®€å•åœ°è®¾ç½®ä¸º<code>sizeof *to</code>æˆ–<code>sizeof(struct sockaddr_storage)</code>ã€‚</p><p>æƒ³å¾—åˆ°åŒ…å«ç›®çš„åœ°å€çš„è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œä½ éœ€è¦é€šè¿‡è°ƒç”¨ <code>getaddrinfo()</code>æˆ–è€…ä¸‹æ–‡çš„ <code>recvfrom()</code>ï¼Œä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨å°è£…ã€‚</p><p>ç±»ä¼¼<code>send()</code>ï¼Œ<code>sendto()</code>çš„è¿”å›å€¼è¡¨ç¤ºçš„ä¹Ÿæ˜¯å®é™…å‘é€å­—èŠ‚æ•°ï¼Œè€Œä¸”è¿™ä¸ªæ•°å¯èƒ½æ¯”ä½ æƒ³å‘é€çš„å¤§å°è¦å°ã€‚æ‰§è¡Œå¼‚å¸¸å°±è¿”å›<code>-1</code>ã€‚</p><p><code>recvfrom()</code>å’Œ<code>recv()</code>å·®ä¸å¤šï¼Œ<code>recvfrom()</code>è¯­æ³•å¦‚ä¸‹ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
             <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>fromlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ çœ‹ï¼Œæ˜¯ä¸æ˜¯é™¤äº†æœ€åä¸¤ä¸ªå‚æ•°ä¹‹å¤–å…¶ä»–å·®ä¸å¤šå•Šã€‚<code>from</code>æ˜¯ä¸€ä¸ªæŒ‡å‘æœ¬åœ°çš„<code>struct sockaddr_storage</code>ç»“æ„çš„æŒ‡é’ˆï¼Œå…¶ä¸­ä¿å­˜äº†æ•°æ®åŒ…æ¥æºä¸»æœºçš„IPåœ°å€å’Œç«¯å£ã€‚<code>fromlen</code>æ˜¯ä¸€ä¸ªæ•´æ•°ç±»å‹æŒ‡é’ˆï¼Œè¿™ä¸ªæ•´æ•°åº”è¯¥è¢«åˆå§‹åŒ–ä¸º <code>sizeof *from</code> æˆ–è€… <code>sizeof(struct sockaddr_storage)</code>ã€‚<code>recvfrom()</code>å‡½æ•°è°ƒç”¨å®Œæˆä¹‹åï¼Œ<code>fromlen</code>ä¿å­˜çš„æ˜¯å®é™…å­˜å‚¨åœ¨<code>from</code>ç»“æ„ä¸­çš„åœ°å€é•¿åº¦ã€‚</p><p><code>recvfrom()</code>çš„è¿”å›å€¼è¡¨ç¤ºå®é™…è¯»å–åˆ°çš„æ•°æ®å­—èŠ‚æ•°ï¼Œå¼‚å¸¸è¿”å›<code>-1</code>ï¼Œå¹¶è®¾ç½®<code>errno</code>å€¼ã€‚</p><p>æœ‰ä¸ªé—®é¢˜å•Šï¼Œä¸ºä»€ä¹ˆæˆ‘ä¸Šæ–‡è¯´<code>from</code>æ˜¯ä¸€ä¸ªæŒ‡å‘<code>struct sockaddr_storage</code>çš„ç»“æ„å•Šï¼Œä¸ºä»€ä¹ˆä¸æ˜¯ <code>struct sockaddr_in</code>ï¼Ÿå› ä¸ºæˆ‘ä»¬ä¸æƒ³åœ¨IPv4æˆ–è€…IPv6ä¸€æ£µæ ‘ä¸ŠåŠæ­»ï¼Œè€Œ<code>sockaddr_storage</code>æœ‰è¶³å¤Ÿçš„å­˜å‚¨ç©ºé—´è®©æˆ‘ä»¬æ¥è‡ªç”±é€‰æ‹©IPv4è¿˜æ˜¯IPv6åœ°å€ã€‚</p><p>ä½ å¯èƒ½åˆä¼šæå‡ºä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆä¸æŠŠ <code>struct sockaddr</code> è®¾è®¡çš„è¶³å¤Ÿå®¹çº³ä»»ä½•åœ°å€å‘¢ï¼Œè¿™æ ·ä¸å°±ä¸ç”¨æ¥å›å¼ºè½¬äº†å˜›ã€‚è¿™éƒ½æ˜¯å†å²åŸå› äº†ï¼Œå½“æ—¶ä¹Ÿæ²¡æƒ³åˆ°IPv4çš„åœ°å€ä¸å¤Ÿç”¨ï¼Œæ‰€ä»¥åªèƒ½æ–°è®¾è®¡ä¸€ä¸ª<code>struct sockaddr_storage</code> äº†ã€‚</p><p>è°¨è®°ï¼Œå¦‚æœä½ å¯¹<code>datagram socket</code>ä½¿ç”¨<code>connect()</code>ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨<code>send()</code>å’Œ<code>recv()</code>ã€‚<code>socket</code>æœ¬èº«ä»ç„¶æ˜¯<code>datagram socket</code>ï¼Œå¹¶ä¸”åè®®ç”¨çš„ä¹Ÿæ˜¯<code>UDP</code>ï¼Œåªä¸è¿‡<code>socket</code>æ¥å£ä¼šè‡ªåŠ¨å¸®ä½ æ·»åŠ ç›®çš„å’Œæ¥æºä¿¡æ¯ã€‚</p><h3 id="_6-9-close-and-shutdown-â€”æ»šçŠŠå­" tabindex="-1"><a class="header-anchor" href="#_6-9-close-and-shutdown-â€”æ»šçŠŠå­" aria-hidden="true">#</a> 6.9. close() and shutdown()â€”æ»šçŠŠå­ï¼</h3><p>å½“ä½ ç©å„¿å¤Ÿäº†<code>send()</code>å’Œ<code>recv()</code>ï¼Œä½ å¯èƒ½æƒ³å…³é—­ä½ çš„<code>socket descriptor</code>è¿æ¥äº†ï¼Œè¿™ä¸ªæ“ä½œå¾ˆç®€å•ï¼Œåªéœ€è¦è°ƒç”¨<code>close()</code>å‡½æ•°å°±å¯ä»¥äº†ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™å°†é¿å…<code>sockfd</code>è¿›è¡Œæ›´å¤šçš„è¯»å†™æ“ä½œï¼Œä»»ä½•æƒ³è¦å¯¹è¿™ä¸ª<code>socket</code>è¿›è¡Œè¯»å†™çš„æ“ä½œéƒ½ä¼šæŠ¥é”™ã€‚</p><p>å¦‚æœä½ æƒ³å¯¹<code>socket</code>å…³é—­çš„å§¿åŠ¿å¤šä¸€ç‚¹æ§åˆ¶ï¼Œé‚£ä½ åº”è¯¥ä½¿ç”¨çš„æ˜¯<code>shutdown()</code>å‡½æ•°ï¼Œå®ƒå…è®¸é€‰æ‹©æ€§åœ°åˆ‡æ–­å•å‘è¿æ¥æˆ–è€…åŒå‘è¿æ¥ï¼ˆè¿™ä¸€ç‚¹å’Œ<code>close()</code>ä¸€æ ·ï¼‰ã€‚è¯­æ³•å¦‚ä¸‹ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> how<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>sockfd</code>è¡¨ç¤ºä½ æƒ³å…³é—­çš„<code>socket file descriptor</code>ï¼Œ<code>how</code>çš„å‚æ•°ä»¥åŠå«ä¹‰è§ä¸‹è¡¨ï¼š</p><table><thead><tr><th style="text-align:center;">howçš„å€¼</th><th style="text-align:center;">å«ä¹‰</th></tr></thead><tbody><tr><td style="text-align:center;">0</td><td style="text-align:center;">ç¦æ­¢æ¥æ”¶æ•°æ®</td></tr><tr><td style="text-align:center;">1</td><td style="text-align:center;">ç¦æ­¢å‘é€æ•°æ®</td></tr><tr><td style="text-align:center;">2</td><td style="text-align:center;">ç¦æ­¢æ¥æ”¶ã€å‘é€æ•°æ®ï¼ˆå’Œ<code>close()</code>ç›¸åŒï¼‰</td></tr></tbody></table><p><code>shutdown()</code>æˆåŠŸæ—¶è¿”å›<code>0</code>ï¼Œå¤±è´¥æ—¶è¿”å›<code>-1</code>ï¼Œå¹¶ä¸”è®¾ç½®å…¨å±€å˜é‡<code>errno</code>ã€‚</p><p>å¦‚æœä½ åœ¨<code>unconnected datagram socket</code>ä¸Šä½¿ç”¨<code>shutdown()</code>ï¼Œå®ƒåªä¼šå•çº¯åœ°è®©<code>socket</code>æ— æ³•ç»§ç»­è¿›è¡Œ<code>send()</code>å’Œ<code>recv()</code>è°ƒç”¨ã€‚å¦‚æœä½ æƒ³è®©<code>shutdown()</code>å‘æŒ¥åŸæœ¬çš„ä½œç”¨ï¼Œé‚£ä¹ˆä½ åº”è¯¥æŠŠå®ƒç”¨åœ¨ä½¿ç”¨äº†<code>connect()</code>å‡½æ•°çš„<code>datagram socket</code>èº«ä¸Šã€‚</p><p>éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œ<code>shutdown()</code>å¹¶ä¸ä¼šå®é™…å…³é—­<code>file descriptor</code>ï¼Œåªæ˜¯æ”¹å˜äº†å¯ç”¨çŠ¶æ€è€Œå·²ã€‚æƒ³è¦çœŸæ­£é‡Šæ”¾<code>file descriptor</code>ï¼Œä½ è¿˜æ˜¯å¾—è°ƒç”¨<code>close()</code>ã€‚</p><p>æ²¡äº†ã€‚</p><p>ã€Œå¯¹äº†ï¼Œå¦‚æœä½ ç”¨çš„æ˜¯<code>Windows</code>å’Œ<code>Winsock</code>ï¼Œä½ éœ€è¦ç”¨çš„æ˜¯<code>closesocket()</code>ï¼Œè€Œä¸æ˜¯<code>close()</code>ï¼Œè°¨è®°ï¼ã€</p><h3 id="_6-10-getpeername-â€”ä½ å“ªä½" tabindex="-1"><a class="header-anchor" href="#_6-10-getpeername-â€”ä½ å“ªä½" aria-hidden="true">#</a> 6.10. getpeername()â€”ä½ å“ªä½?</h3><p>è¿™ä¸ªå‡½æ•°æœ‰ç‚¹ç®€å•ã€‚</p><p>ç®€å•åˆ°æˆ‘éƒ½ä¸æƒ³å•ç‹¬æŠŠå®ƒåˆ—å‡ºæ¥ï¼Œä½†æ˜¯æˆ‘è¿˜æ˜¯åˆ—å‡ºæ¥äº†ã€‚</p><p><code>getpeername()</code>ä¼šå‘Šè¯‰ä½ å¦ä¸€ç«¯è¿æ¥çš„<code>stream socket</code>æ˜¯è°ã€‚è¯­æ³•å¦‚ä¸‹ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
    
<span class="token keyword">int</span> <span class="token function">getpeername</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sockfd</code>æ˜¯ä¸€ä¸ªå·²è¿æ¥çš„<code>stream socket</code>ï¼›<code>addr</code>æ˜¯ä¸€ä¸ªæŒ‡å‘<code>struct sockaddr</code> (æˆ–è€… <code>struct sockaddr_in</code>) ç»“æ„çš„æŒ‡é’ˆï¼Œç»“æ„ä¸­å­˜å‚¨äº†è¿æ¥çš„å¦ä¸€å¤´å„¿çš„ä¿¡æ¯ï¼›<code>addrlen</code>æ˜¯ä¸€ä¸ª<code>int</code>å‹æŒ‡é’ˆï¼Œè¿™ä¸ªintå˜é‡åº”è¯¥è¢«åˆå§‹åŒ–ä¸º <code>sizeof *addr</code> æˆ–è€… <code>sizeof(struct sockaddr)</code>ã€‚</p><p>å‡½æ•°å¼‚å¸¸æ—¶ä¼šè¿”å›<code>-1</code>ï¼Œå¹¶ä¸”è®¾ç½®å…¨å±€å˜é‡<code>errno</code>ã€‚</p><p>ä¸€æ—¦ä½ è·å–äº†å¯¹é¢çš„åœ°å€ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨ <code>inet_ntop()</code>, <code>getnameinfo()</code>, æˆ–è€… <code>gethostbyaddr()</code> æ‰“å°å‡ºæ¥æˆ–è€…è·å–æ›´å¤šä¿¡æ¯ï¼ˆä½†æ˜¯åˆ«å¦„æƒ³èƒ½è·å–åˆ°åˆ«äººçš„ç™»å½•åå“¦ï½ï¼‰ã€‚</p><h3 id="_6-11-gethostname-â€”æˆ‘æ˜¯è°" tabindex="-1"><a class="header-anchor" href="#_6-11-gethostname-â€”æˆ‘æ˜¯è°" aria-hidden="true">#</a> 6.11. gethostname()â€”æˆ‘æ˜¯è°?</h3><p>è¿™è´§æ¯” <code>getpeername()</code> è¿˜ç®€å•ã€‚</p><p><code>gethostname()</code>ä¼šè¿”å›ç¨‹åºæ‰€æœ‰çš„ä¸»æœºåç§°ï¼Œè¿™ä¸ªä¸»æœºåç§°å¯ä»¥ç»§ç»­ç”¨åœ¨ <code>gethostbyname()</code>ä¸­æ¥ç¡®å®šä¸»æœºçš„IPåœ°å€ã€‚</p><p>è¿˜èƒ½ç©å¾—æ›´èŠ±ä¸€ç‚¹å„¿å—ï¼Ÿ</p><p>å½“ç„¶æœ‰ï¼Œä¸è¿‡è¿™å°±å’Œsocketç¼–ç¨‹å…³ç³»ä¸å¤§äº†ï¼Œè¿˜æ˜¯ç®€å•ä»‹ç»ä¸€ä¸‹ä½¿ç”¨æ–¹æ³•å§ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">gethostname</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚æ•°å¾ˆç®€å•ï¼š<code>hostname</code>æ˜¯ä¸€ä¸ªå­—ç¬¦æŒ‡é’ˆï¼Œå°†å­˜å‚¨è¿”å›çš„ä¸»æœºåç§°ï¼ˆhostnameï¼‰ï¼›<code>size</code>æ˜¯è¿”å›çš„ä¸»æœºåç§°çš„å­—èŠ‚é•¿åº¦ã€‚</p><p>å‡½æ•°åœ¨æ‰§è¡ŒæˆåŠŸæ˜¯è¿”å›<code>0</code>ï¼Œé”™è¯¯æ—¶è¿”å›<code>-1</code>ï¼Œå¹¶ä¸€æ ·ä¼šè®¾ç½®<code>errno</code>ã€‚</p><h2 id="_7-client-serveråŸºç¡€" tabindex="-1"><a class="header-anchor" href="#_7-client-serveråŸºç¡€" aria-hidden="true">#</a> 7. Client-ServeråŸºç¡€</h2><p>å®å„¿ï¼Œä½ å¾—æ‰¿è®¤ï¼Œè¿™æ˜¯ä¸ª<code>Client-Server</code>çš„ä¸–ç•Œã€‚</p><p>ç½‘ç»œä¸Šå‡ ä¹æ‰€æœ‰çš„å†…å®¹æœ¬è´¨ä¸Šéƒ½æ˜¯Clientè¿›ç¨‹ä¸`erverè¿›ç¨‹ä¹‹é—´çš„ä¼šè¯ï¼Œåä¹‹äº¦ç„¶ã€‚</p><p>æ‹¿telnetä¸¾ä¸ªä¾‹å­ã€‚å½“ä½ ä½¿ç”¨<code>telnet</code>ï¼ˆClientç«¯ï¼‰è¿æ¥ä¸Šè¿œç¨‹ä¸»æœºçš„<code>23</code>ç«¯å£ï¼Œè¿œç¨‹ä¸»æœºä¸Šç›‘å¬è¯¥ç«¯å£çš„ç¨‹åºï¼ˆå«<code>telnetd</code>ï¼Œå°±æ˜¯<code>telnet</code>çš„Serverç«¯ï¼‰å°±åŠ¨äº†èµ·æ¥ã€‚å®ƒä¼šå¤„ç†åˆ°æ¥çš„<code>telnet</code>è¿æ¥ï¼Œå¹¶ä¸ºä½ è®¾ç½®å¥½ç™»é™†æç¤ºä¿¡æ¯ç­‰ã€‚</p><p><img src="http://qiniu.chanmufeng.com/2022-10-15-130214.png" alt="Client-Serveräº¤äº’" loading="lazy"></p><p>ä¸Šå›¾å¾ˆå½¢è±¡åœ°è¡¨è¾¾äº†Clientå’ŒServerä¹‹é—´çš„ä¿¡æ¯äº¤äº’ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>Client-Server</code>è¿™ä¸€ç»„æ­æ¡£å¯ä»¥ä½¿ç”¨ <code>SOCK_STREAM</code>ã€ <code>SOCK_DGRAM</code>æˆ–å…¶ä»–ä»»ä½•åè®®ï¼ˆåªè¦åŒæ–¹ä½¿ç”¨çš„åè®®ä¸€è‡´å³å¯ï¼‰ã€‚</p><p><code>telnet</code>/<code>telnetd</code>, <code>ftp</code>/<code>ftpd</code>, ä»¥åŠ <code>Firefox</code>/<code>Apache</code>ç­‰éƒ½æ˜¯<code>Client-Server</code>æ¨¡å¼éå¸¸å¥½çš„èŒƒä¾‹ã€‚æ¯”å¦‚ï¼Œæ¯æ¬¡ä½ ä½¿ç”¨<code>ftp</code>çš„æ—¶å€™ï¼Œåœ¨è¿œç¨‹éƒ½ä¼šä¸€ä¸ª<code>ftpd</code>ç¨‹åºä¸ºä½ æœåŠ¡ã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€å°ä¸»æœºåªä¼šæœ‰ä¸€ä¸ªServerç¨‹åºï¼ˆè¿™é‡ŒæŒ‡çš„æ˜¯å¤„ç†åŒä¸€åŠŸèƒ½çš„æœåŠ¡ç«¯ï¼‰ï¼Œè¯¥ç¨‹åºä¼šä½¿ç”¨<code>fork()</code>æ¥å¤„ç†å¤šä¸ªClientã€‚åŸºæœ¬çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼šServerä¼šç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ï¼Œç„¶å<code>accept()</code>è¯¥è¿æ¥ï¼Œå†<code>fork()</code>å‡ºä¸€ä¸ªå­è¿›ç¨‹æ¥å¤„ç†è¯¥è¿æ¥ã€‚</p><p>è¿™å°±æ˜¯æˆ‘ä»¬ä¸‹ä¸€èŠ‚çš„Serverç«¯ç¨‹åºåšçš„äº‹æƒ…ã€‚</p><h3 id="_7-1-ä¸€ä¸ªç®€å•çš„stream-server" tabindex="-1"><a class="header-anchor" href="#_7-1-ä¸€ä¸ªç®€å•çš„stream-server" aria-hidden="true">#</a> 7.1. ä¸€ä¸ªç®€å•çš„stream server</h3><p>è¿™ä¸ªServerç«¯ç¨‹åºåšçš„å·¥ä½œå°±æ˜¯æŠŠ â€œ<code>Hello, world!</code>â€å­—ç¬¦ä¸²é€šè¿‡<code>stream connection</code> å‘é€ç»™Clientã€‚</p><p>ä½ å¦‚æœè¦æµ‹è¯•è¿™ä¸ªServerç¨‹åºï¼Œä½ éœ€è¦åœ¨ä¸€èµ·å‘½ä»¤è¡Œçª—å£ä¸­è¿è¡Œè¿™ä¸ªServerç¨‹åºï¼Œç„¶ååœ¨å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ telnet remotehostname <span class="token number">3490</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>remotehostname</code>æŒ‡çš„æ˜¯è¿è¡Œç¨‹åºçš„ä¸»æœºåï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªIPåœ°å€ã€‚</p><p>Serverç«¯ç¨‹åºæ¥å–½ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** server.c -- a stream socket server demo
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PORT</span> <span class="token string">&quot;3490&quot;</span>  <span class="token comment">// the port users will be connecting to</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BACKLOG</span> <span class="token expression"><span class="token number">10</span>   </span><span class="token comment">// how many pending connections queue will hold</span></span>

<span class="token keyword">void</span> <span class="token function">sigchld_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// waitpid() might overwrite errno, so we save and restore it:</span>
    <span class="token keyword">int</span> saved_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    errno <span class="token operator">=</span> saved_errno<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// get sockaddr, IPv4 or IPv6:</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>sa<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token operator">-&gt;</span>sa_family <span class="token operator">==</span> AF_INET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> new_fd<span class="token punctuation">;</span>  <span class="token comment">// listen on sock_fd, new connection on new_fd</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>servinfo<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> their_addr<span class="token punctuation">;</span> <span class="token comment">// connector&#39;s address information</span>
    <span class="token class-name">socklen_t</span> sin_size<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sa<span class="token punctuation">;</span>
    <span class="token keyword">int</span> yes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> s<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> rv<span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span> <span class="token comment">// use my IP</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rv <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// loop through all the results and bind to the first we can</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> servinfo<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span>
                p<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;server: socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>yes<span class="token punctuation">,</span>
                <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;setsockopt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;server: bind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// all done with this structure</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;server: failed to bind\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> BACKLOG<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;listen&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> sigchld_handler<span class="token punctuation">;</span> <span class="token comment">// reap all dead processes</span>
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> SA_RESTART<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;sigaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;server: waiting for connections...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// main accept() loop</span>
        sin_size <span class="token operator">=</span> <span class="token keyword">sizeof</span> their_addr<span class="token punctuation">;</span>
        new_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>their_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sin_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>new_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;accept&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">inet_ntop</span><span class="token punctuation">(</span>their_addr<span class="token punctuation">.</span>ss_family<span class="token punctuation">,</span>
            <span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>their_addr<span class="token punctuation">)</span><span class="token punctuation">,</span>
            s<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;server: got connection from %s\n&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// this is the child process</span>
            <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// child doesn&#39;t need the listener</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">send</span><span class="token punctuation">(</span>new_fd<span class="token punctuation">,</span> <span class="token string">&quot;Hello, world!&quot;</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;send&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">close</span><span class="token punctuation">(</span>new_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">close</span><span class="token punctuation">(</span>new_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// parent doesn&#39;t need this</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸ºäº†è®©ä»£ç çœ‹æ¥èµ·æ›´æ¸…æ™°ï¼ˆèµ·ç æˆ‘æ˜¯è¿™ä¹ˆè®¤ä¸ºçš„ï¼‰ï¼Œæˆ‘æŠŠæ‰€æœ‰ä»£ç éƒ½æ”¾åœ¨äº†ä¸€ä¸ª<code>main()</code>å‡½æ•°ä¸­ã€‚å¦‚æœä½ æƒ³æŠŠå®ƒåˆ†æˆå¤šä¸ªæ›´å°çš„å‡½æ•°ï¼Œå°½ç®¡åˆ†å°±å¥½äº†ã€‚</p><p>å¦å¤–ï¼Œä½ å¯èƒ½å¯¹ <code>sigaction()</code> è¿™ä¸ªå‡½æ•°æœ‰ç‚¹é™Œç”Ÿï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥å¤„ç†åƒµå°¸è¿›ç¨‹ï¼ˆzombie processesï¼‰çš„ã€‚</p><p>ä½ å¯ä»¥ä½¿ç”¨ä¸‹èŠ‚è®²åˆ°çš„Clientç«¯ä»£ç æ¥è·å–è¿™ä¸ªç¨‹åºå‘é€çš„æ¶ˆæ¯ã€‚</p><h3 id="_7-2-ä¸€ä¸ªç®€å•çš„stream-client" tabindex="-1"><a class="header-anchor" href="#_7-2-ä¸€ä¸ªç®€å•çš„stream-client" aria-hidden="true">#</a> 7.2. ä¸€ä¸ªç®€å•çš„stream client</h3><p>Clientä»£ç æ¯”Serverä»£ç è¿˜è¦ç®€å•ã€‚</p><p>è¿™æ®µä»£ç çš„åŠŸèƒ½å°±æ˜¯è¿æ¥ä½ åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šçš„ä¸»æœºä¸Šçš„<code>3490</code>ç«¯å£ï¼Œè·å–Serverç«¯å‘é€çš„æ•°æ®ã€‚</p><p>ä¸Šä»£ç ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** client.c -- a stream socket client demo
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PORT</span> <span class="token string">&quot;3490&quot;</span> <span class="token comment">// the port client will be connecting to </span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXDATASIZE</span> <span class="token expression"><span class="token number">100</span> </span><span class="token comment">// max number of bytes we can get at once </span></span>

<span class="token comment">// get sockaddr, IPv4 or IPv6:</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>sa<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token operator">-&gt;</span>sa_family <span class="token operator">==</span> AF_INET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> numbytes<span class="token punctuation">;</span>  
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXDATASIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>servinfo<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rv<span class="token punctuation">;</span>
    <span class="token keyword">char</span> s<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;usage: client hostname\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rv <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// loop through all the results and connect to the first we can</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> servinfo<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span>
                p<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;client: socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;client: connect&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;client: failed to connect\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">inet_ntop</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> <span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">)</span><span class="token punctuation">,</span>
            s<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;client: connecting to %s\n&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// all done with this structure</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numbytes <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXDATASIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;recv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    buf<span class="token punctuation">[</span>numbytes<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;client: received &#39;%s&#39;\n&quot;</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿è¡ŒClientç¨‹åºä¹‹å‰ï¼Œä½ éœ€è¦å…ˆè¿è¡ŒServerç¨‹åºï¼Œå¦åˆ™çš„è¯ä½ å¯èƒ½ä¼šæ”¶åˆ° â€œConnection refusedâ€ çš„é”™è¯¯æç¤ºã€‚</p><h3 id="_7-3-datagram-sockets" tabindex="-1"><a class="header-anchor" href="#_7-3-datagram-sockets" aria-hidden="true">#</a> 7.3. Datagram Sockets</h3><p><code>UDP datagram socket</code> çš„åŸºç¡€æˆ‘ä»¬åœ¨<code>sendto()</code>å’Œ<code>recvfrom()</code>é‚£ä¸€èŠ‚çš„å·²ç»è®²è¿‡äº†ã€‚æœ¬èŠ‚ï¼Œæˆ‘å°†ç»™å‡ºä¸¤æ®µç¨‹åºï¼š <code>talker.c</code> å’Œ <code>listener.c</code>ã€‚</p><p><code>listener.c</code>è¿è¡Œåœ¨ä¸»æœºä¸Šä¸€ç›´ç­‰å¾…ç€å»å¾€<code>4950</code>ç«¯å£çš„æ•°æ®åŒ…ã€‚<code>talker</code>å°†ç”¨æˆ·åœ¨å‘½ä»¤è¡Œè¾“å…¥çš„æ•°æ®ä»æŒ‡å®šçš„ä¸»æœºå‘å¾€<code>4950</code>ç«¯å£ã€‚</p><p>å› ä¸º<code>datagram sockets</code>æ˜¯æ— è¿æ¥çš„ï¼Œå› æ­¤åªéœ€è¦æŠŠæ•°æ®åŒ…é€šè¿‡ä»¥å¤ªç½‘å‘é€å‡ºå»å°±è¡Œï¼Œç”­ç®¡æˆåŠŸå¤±è´¥ã€‚</p><p>æ­¤å¤–ï¼Œç¨‹åºä¸­æˆ‘ä»¬ä»¤Clientå’ŒServeréƒ½ä½¿ç”¨IPv6ã€‚è¿™æ ·ä»¥æ¥å°±é¿å…äº†Serveræ®µä½¿ç”¨IPv6ï¼Œè€ŒClientä½¿ç”¨IPv4å¯¼è‡´æ•°æ®ä¸ä¼šè¢«æ¥æ”¶çš„è¿™ç§æƒ…å†µã€‚</p><blockquote><p>å®é™…ä¸Šï¼Œåœ¨ä½¿ç”¨<code>TCP stream sockets</code>çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¾ç„¶å¯èƒ½ä¼šç¢°åˆ°åœ°å€æ—ä¸åŒ¹é…çš„æƒ…å†µï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬ä¼šä½¿ç”¨<code>connect()</code>å‡½æ•°ï¼Œå¦‚æœå› ä¸ºåœ°å€æ—çš„é—®é¢˜å¯¼è‡´<code>connect()</code>æŠ¥é”™ï¼Œå°±ç­‰äºæ˜¾å¼æé†’æˆ‘ä»¬éœ€è¦æ¢å¦ä¸€ä¸ªåœ°å€æ—äº†ã€‚</p></blockquote><p>ä¸‹é¢ç»™å‡º <code>listener.c</code>çš„ä»£ç ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** listener.c -- a datagram sockets &quot;server&quot; demo
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MYPORT</span> <span class="token string">&quot;4950&quot;</span>    <span class="token comment">// the port users will be connecting to</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXBUFLEN</span> <span class="token expression"><span class="token number">100</span></span></span>

<span class="token comment">// get sockaddr, IPv4 or IPv6:</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>sa<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token operator">-&gt;</span>sa_family <span class="token operator">==</span> AF_INET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>servinfo<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> numbytes<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> their_addr<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXBUFLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span> addr_len<span class="token punctuation">;</span>
    <span class="token keyword">char</span> s<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_INET6<span class="token punctuation">;</span> <span class="token comment">// set to AF_INET to use IPv4</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_DGRAM<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span> <span class="token comment">// use my IP</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rv <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> MYPORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// loop through all the results and bind to the first we can</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> servinfo<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span>
                p<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;listener: socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;listener: bind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;listener: failed to bind socket\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;listener: waiting to recvfrom...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    addr_len <span class="token operator">=</span> <span class="token keyword">sizeof</span> their_addr<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numbytes <span class="token operator">=</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> MAXBUFLEN<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>their_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;recvfrom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;listener: got packet from %s\n&quot;</span><span class="token punctuation">,</span>
        <span class="token function">inet_ntop</span><span class="token punctuation">(</span>their_addr<span class="token punctuation">.</span>ss_family<span class="token punctuation">,</span>
            <span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>their_addr<span class="token punctuation">)</span><span class="token punctuation">,</span>
            s<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;listener: packet is %d bytes long\n&quot;</span><span class="token punctuation">,</span> numbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span>numbytes<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;listener: packet contains \&quot;%s\&quot;\n&quot;</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨ <code>getaddrinfo()</code> æ—¶ï¼Œä½¿ç”¨äº† <code>SOCK_DGRAM</code>ã€‚è€Œä¸”æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨ <code>listen()</code> æˆ–è€… <code>accept()</code>å‡½æ•°ï¼Œè¿™æ˜¯ä½¿ç”¨<code>unconnected datagram sockets</code>çš„å¥½å¤„ä¹‹ä¸€ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹<code>talker</code>çš„ä»£ç ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** talker.c -- a datagram &quot;client&quot; demo
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SERVERPORT</span> <span class="token string">&quot;4950&quot;</span>    <span class="token comment">// the port users will be connecting to</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>servinfo<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> numbytes<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;usage: talker hostname message\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_INET6<span class="token punctuation">;</span> <span class="token comment">// set to AF_INET to use IPv4</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_DGRAM<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rv <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> SERVERPORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// loop through all the results and make a socket</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> servinfo<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span>
                p<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;talker: socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;talker: failed to create socket\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numbytes <span class="token operator">=</span> <span class="token function">sendto</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
             p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;talker: sendto&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;talker: sent %d bytes to %s\n&quot;</span><span class="token punctuation">,</span> numbytes<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™äº›å°±æ˜¯å…¨éƒ¨äº†ã€‚ä½ åœ¨æŸå°ä¸»æœºä¸Šæ‰§è¡Œ<code>listener</code>ï¼Œç„¶ååœ¨å¦ä¸€å°ä¸»æœºä¸Šæ‰§è¡Œ<code>talker</code>ï¼Œè§‚å¯Ÿå®ƒä»¬ä¹‹é—´çš„é€šä¿¡ï¼Œä½ ä¼šå‘ç°è¿™å¾ˆæœ‰è¶£ã€‚</p><p>ä½ ç”šè‡³éƒ½å¯ä»¥ä¸å…ˆæ‰§è¡ŒServerï¼å¯ä»¥åªæ‰§è¡Œ<code>talker</code>ï¼Œ<code>talker</code>ä¼šå¾ˆå¼€å¿ƒåœ°å°†æ•°æ®åŒ…æ‰”åˆ°ç½‘ç»œä¸Šï¼Œå¦‚æœå¦ä¸€æ®µæ²¡æœ‰äººè´Ÿè´£ç”¨<code>recvfrom()</code>æ¥æ”¶ï¼Œå¤§ä¸äº†å°±æ˜¯æ•°æ®åŒ…ä¸¢äº†è€Œå·²ã€‚</p><blockquote><p>è°¨è®°ï¼š<code>UDP</code>å‘é€æ•°æ®å¹¶ä¸ä¼šä¿è¯æ•°æ®ä¸€å®šä¼šé€è¾¾å¯¹æ–¹ã€‚</p></blockquote><p>è¿™é‡Œæä¸€ä¸‹ä¹‹å‰æè¿‡å¾ˆå¤šæ¬¡çš„ä¸€ä¸ªå°ç»†èŠ‚ï¼š<code>connected datagram sockets</code>ï¼Œæ¯•ç«Ÿæˆ‘ä»¬è¿™èŠ‚è®²çš„å°±æ˜¯<code>datagram socket</code>å˜›ã€‚</p><p>å¦‚æœ<code>talker</code>è°ƒç”¨äº†<code>connect()</code>å¹¶ä¸”æŒ‡å®šäº†<code>listener</code>çš„åœ°å€ï¼Œè¿™æ ·ä¸€æ¥ï¼Œ<code>talker</code>åªèƒ½å’Œ<code>connect()</code>æŒ‡å®šçš„åœ°å€è¿›è¡Œæ•°æ®å‘é€ä¸æ¥æ”¶ã€‚è¿™å°±æ˜¯<code>connected datagram socket</code>ï¼Œä½ ä¹Ÿå¯ä»¥ä¸å¿…å±€é™äº<code>sendto()</code>å’Œ<code>recvfrom()</code>ï¼Œç›´æ¥ä½¿ç”¨<code>send()</code>å’Œ<code>recv()</code>å°±å¯ä»¥äº†ã€‚</p><h2 id="_8-æŠ€æœ¯è¿›é˜¶" tabindex="-1"><a class="header-anchor" href="#_8-æŠ€æœ¯è¿›é˜¶" aria-hidden="true">#</a> 8. æŠ€æœ¯è¿›é˜¶</h2><p>è¿™å¹¶ä¸æ˜¯ç‰¹åˆ«é«˜é˜¶çš„çŸ¥è¯†ï¼Œä½†æ˜¯å¯ä»¥è®©ä½ è·³è„±å‡ºä½ å·²ç»æŒæ¡çš„åŸºç¡€çŸ¥è¯†äº†ã€‚å¦‚æœä½ ä¸€æ­¥ä¸€æ­¥å­¦ä¹ åˆ°è¿™é‡Œäº†ï¼Œä½ å¯ä»¥è®¤ä¸ºä½ å·²ç»ç›¸å½“ç²¾é€šUnixç½‘ç»œç¼–ç¨‹çš„<strong>åŸºç¡€çŸ¥è¯†</strong>äº†ï¼Œæ­å–œä½ ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å°†è¿›å…¥ä¸€ä¸ªæ–°çš„ä¸–ç•Œï¼Œå­¦ä¹ ä¸€ä¸‹å…³äºsocketæ›´æ·±å¥¥çš„çŸ¥è¯†ã€‚</p><h3 id="_8-1-blockingâ€”ä½•è°“é˜»å¡" tabindex="-1"><a class="header-anchor" href="#_8-1-blockingâ€”ä½•è°“é˜»å¡" aria-hidden="true">#</a> 8.1. Blockingâ€”ä½•è°“é˜»å¡ï¼Ÿ</h3><p>ä½ å¯èƒ½å¬è¯´è¿‡<strong>é˜»å¡</strong>ï¼ˆBlockingï¼‰è¿™ä¸ªè¯ï¼Œé‚£ä¹ˆå®ƒåˆ°åº•æ˜¯ä¸ªä»€ä¹ˆé¬¼ä¸œè¥¿ï¼Ÿç®€è€Œè¨€ä¹‹ï¼Œâ€œblockâ€æ˜¯â€œsleepâ€çš„ä¸€ç§æ›´å…·æœ‰ç§‘æŠ€æ„Ÿçš„å«æ³•ã€‚</p><blockquote><p>ä¸‹æ–‡ä¸­ï¼Œã€Œblockingã€ã€ã€Œblockã€å’Œã€Œé˜»å¡ã€ä¼šæ··ç”¨ï¼Œéƒ½æ˜¯ä¸€ä¸ªæ„æ€ï¼Œæ‚‰çŸ¥</p></blockquote><p>å½“ä½ è¿è¡Œå‰æ–‡çš„<code>listener</code>ç¨‹åºæ—¶ï¼Œä½ å¯èƒ½å‘ç°å®ƒä¸€ç›´åœ¨â€œblockâ€ï¼Œç›´åˆ°æ•°æ®åŒ…åˆ°è¾¾æ‰ä¼šåŠ¨èµ·æ¥ã€‚äº§ç”Ÿè¿™ä¸ªç°è±¡çš„åŸå› æ˜¯å®ƒè°ƒç”¨äº†<code>recvfrom()</code>ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œ<code>recvfrom()</code>å°±ä¼šè¢«â€œblockâ€ï¼ˆä½ å¯ä»¥ç†è§£ä¸ºâ€œsleepâ€ï¼‰ï¼Œç›´åˆ°æœ‰æ•°æ®åˆ°è¾¾ã€‚</p><p>å¾ˆå¤šå‡½æ•°éƒ½ä¼šblockã€‚<code>accept()</code>ä¼šblockï¼Œæ‰€æœ‰çš„<code>recv()</code>ä¼šblockï¼Œå®ƒä»¬ä¹‹æ‰€ä»¥å¯ä»¥blockï¼Œæ˜¯å› ä¸ºå®ƒä»¬è¢«å†…æ ¸èµ‹äºˆäº†è¿™ä¸ªèƒ½åŠ›ã€‚å½“ä½ ä½¿ç”¨<code>socket()</code>å‡½æ•°åˆ›å»ºå‡ºä¸€ä¸ª<code>socket descriptor</code>æ—¶ï¼Œå†…æ ¸å°±ä¼šå°†å…¶è®¾ç½®ä¸º<code>blocking</code>ã€‚å¦‚æœä½ ä¸æƒ³è¦blocking socketï¼Œä½ éœ€è¦è°ƒç”¨<code>fcntl()</code>è¿›è¡Œè®¾ç½®ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fcntl</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å°†socketè®¾ç½®ä¸ºnon-blockingï¼ˆéé˜»å¡ï¼‰ï¼Œä½ å°±å¯ä»¥<code>poll</code>ï¼ˆè½®è¯¢ï¼‰socketæ¥è·å–æ•°æ®äº†ã€‚å¦‚æœä½ å¯¹ä¸€ä¸ªnon-blocking socketè¿›è¡Œè¯»å–ï¼Œè€Œsocketæ²¡æœ‰æ•°æ®çš„æ—¶å€™ï¼Œå®ƒå¹¶ä¸ä¼šé˜»å¡ï¼Œè€Œæ˜¯ä¼šè¿”å›<code>-1</code>ï¼Œå¹¶ä¸”å°†<code>errno</code>è®¾ç½®ä¸º <code>EAGAIN</code> æˆ– <code>EWOULDBLOCK</code>ã€‚</p><p>å•¥ï¼Ÿ <code>EAGAIN</code> <strong>æˆ–</strong> <code>EWOULDBLOCK</code>å—ï¼Ÿé‚£æˆ‘åˆ°åº•åº”è¯¥æ£€æŸ¥å“ªä¸€ä¸ªï¼Ÿå®é™…ä¸Šï¼Œä¸åŒæ“ä½œç³»ç»Ÿè¿”å›å“ªä¸ªå€¼æ˜¯ä¸ç¡®å®šçš„ï¼Œå› æ­¤ä¸ºäº†å…¼å®¹æ€§ï¼Œä½ æœ€å¥½æŠŠè¿™ä¸¤ä¸ªå€¼éƒ½æ£€æŸ¥ä¸€ä¸‹ã€‚</p><p>ä½†æ˜¯è€å®è¯´ï¼Œä½ è¦æ˜¯æ—¶æ—¶åˆ»åˆ»è¿›è¡Œæ•°æ®è½®è¯¢å¹¶ä¸æ˜¯ä¸ªå¥½ä¸»æ„ï¼Œå› ä¸ºä¼šç©ºè€—CPUæ—¶é—´ç‰‡ï¼Œåšçš„å¤§éƒ¨åˆ†éƒ½æ˜¯æ— ç”¨åŠŸã€‚åä¸‹ä¸€èŠ‚çš„<code>poll()</code>æä¾›äº†ä¸€ä¸ªæ›´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼Œç”¨äºæ£€æŸ¥æ˜¯å¦æœ‰ç­‰å¾…è¯»å–çš„æ•°æ®ã€‚</p><h3 id="_8-2-poll-â€”åŒæ­¥çš„i-oå¤šè·¯å¤ç”¨" tabindex="-1"><a class="header-anchor" href="#_8-2-poll-â€”åŒæ­¥çš„i-oå¤šè·¯å¤ç”¨" aria-hidden="true">#</a> 8.2. poll()â€”åŒæ­¥çš„I/Oå¤šè·¯å¤ç”¨</h3><p>ä½ å¯èƒ½åœ¨æƒ³ï¼Œæœ‰æ²¡æœ‰ä¸€ç§åŠæ³•ï¼Œå¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ªsocketï¼Œç„¶ååªå¤„ç†å…¶ä¸­å·²ç»æœ‰æ•°æ®çš„socketå‘¢ï¼Ÿè¿™æ ·çš„è¯æˆ‘ä»¬å°±ä¸ç”¨å‚»ä¹ä¹åœ°ä¸åœè½®è¯¢ï¼Œæ¥æ£€æŸ¥å“ªäº›socketå·²ç»æœ‰æ•°æ®äº†ã€‚</p><p>é‚£æ€ä¹ˆé¿å…pollï¼ˆè½®è¯¢ï¼‰å‘¢ï¼Ÿè¯´èµ·æ¥æœ‰ç‚¹æç¬‘ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>poll()</code>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ¥é¿å…pollï¼ˆè½®è¯¢ï¼‰ã€‚æœ¬è´¨ä¸Šï¼Œæˆ‘ä»¬éƒ½æ˜¯è®©å†…æ ¸æ¥æ›¿æˆ‘ä»¬åšå„ç§è„æ´»ç´¯æ´»ï¼Œç„¶åå‘Šè¯‰æˆ‘ä»¬å“ªäº›socketæœ‰æ•°æ®å¯è¯»äº†ã€‚æ²¡æœ‰æ•°æ®å¯è¯»çš„æ—¶å€™æˆ‘ä»¬çš„è¿›ç¨‹å¯ä»¥å¤„äºä¼‘çœ çŠ¶æ€ï¼Œä¸ä¼šå ç”¨CPUã€‚</p><blockquote><p>è­¦å‘Šï¼šéšç€è¿æ¥æ•°å˜å¾—å·¨å¤§ï¼Œpoll()å‡½æ•°ä¼šå˜å¾—å·¨æ…¢ï¼è¿™ç§æƒ…å†µä¸‹ï¼Œæ¨èä½ ä½¿ç”¨<a href="https://libevent.org/" target="_blank" rel="noopener noreferrer">libevent<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>è¿™æ ·çš„äº‹ä»¶åº“ã€‚å®ƒä¼šå°è¯•ä½¿ç”¨ä½ ç³»ç»Ÿä¸Šå¯ç”¨çš„æœ€å¿«æ–¹æ³•ï¼Œè·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚</p></blockquote><p>ä¸€èˆ¬çš„åšæ³•æ˜¯ç»´æŠ¤ä¸€ä¸ª <code>struct pollfd</code>çš„æ•°ç»„ï¼Œå…¶ä¸­åŒ…å«æˆ‘ä»¬æƒ³è¦ç›‘å¬çš„<code>socket descriptor</code>ä»¥åŠæˆ‘ä»¬æƒ³è¦ç›‘å¬çš„äº‹ä»¶ç±»å‹çš„ä¿¡æ¯ã€‚å†…æ ¸ä¼šé˜»å¡åœ¨<code>poll()</code>è¿™ä¸ªè°ƒç”¨ä¸Šï¼Œç›´åˆ°ä½ å…³æ³¨çš„å…¶ä¸­ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿï¼ˆæ¯”å¦‚â€œsocket ready to readï¼â€ï¼‰æˆ–ç›´åˆ°å‘ç”Ÿç”¨æˆ·æŒ‡å®šè¶…æ—¶ã€‚</p><p>æ‹¿TCP Serverç«¯ç¨‹åºä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢çš„ä»£ç å…¶å®è¿˜æ˜¯<code>blocking</code>çš„ä»£ç ï¼Œå†™å‡ºæ¥å°±æ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘ç¿»è¯‘åŸæ–‡çš„ä¸€å¥è¯ï¼ˆå¦‚æœç¡¬ç¿»è¯‘å®åœ¨æ˜¯ä¸å¥½ç†è§£ï¼‰ã€‚æ ¹æ®å¥—è·¯ç¼–å†™äº†4æ­¥æµç¨‹ï¼š<code>socket()</code>ã€<code>bind()</code>ã€<code>listen()</code>ä»¥åŠ<code>accept()</code>ã€‚</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> new_fd<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>XXX<span class="token punctuation">,</span>XXX<span class="token punctuation">,</span>XXX<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> XXX<span class="token punctuation">,</span> XXX<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> BACKLOG<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
 
  new_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> XXX<span class="token punctuation">,</span> XXX<span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨<code>blocking</code>ä»£ç ä¸­ï¼Œç¨‹åºä¼šé˜»å¡åœ¨<code>accept()</code>ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªClientè¿æ¥ä¸Šæ¥ã€‚ä½†æ˜¯åœ¨<code>non-blocking</code>ç¨‹åºä¸­ï¼Œæœ‰Clientè¿æ¥ä¸Šæ¥å‡†å¤‡è¢«<code>accept()</code>è°ƒç”¨ä¹‹å‰ï¼Œ<code>sockfd</code>å°±ä¼šç›´æ¥å‘Šè¯‰æˆ‘ä»¬æœ‰ä¸€ä¸ªæ–°çš„è¿æ¥æ¥äº†ï¼Œæˆ‘ä»¬æ¥ç€æ‰¾åˆ°ä»–ï¼Œç„¶å<code>accept()</code>å¤„ç†å³å¯ã€‚å¤§å®¶å¯ä»¥å¯¹æ¯”ä¸€ä¸‹è¿™ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ã€‚</p><p>è¯´å¾—ä¸å°‘äº†ï¼Œçœ‹ä¸€ä¸‹<code>poll()</code>çš„ç”¨æ³•ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>

<span class="token comment">//è¿”å›ï¼š å¦‚æœæœ‰å°±ç»ªçš„æè¿°ç¬¦åˆ™ä¸ºå…¶æ•°ç›®ï¼Œè‹¥è¶…æ—¶è¿”å›0ï¼Œè‹¥å‡ºé”™è¿”å›-1</span>
<span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> fds<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">nfds_t</span> nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>fds</code>æ˜¯ä¸€ä¸ªç»“æ„æ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª<code>pollfd</code>ç»“æ„ï¼Œä¿å­˜äº†ã€Œç›‘å¬å“ªä¸ªsocketçš„ä»€ä¹ˆäº‹ä»¶ã€çš„ä¿¡æ¯ï¼›<code>nfds</code>æ˜¯æ•°ç»„çš„æ•°é‡ï¼›<code>timeout</code>æ˜¯è®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ã€‚<code>poll()</code>è¿”å›å°±ç»ªï¼ˆæœ‰æ—¶é—´å‘ç”Ÿï¼‰çš„æè¿°ç¬¦æ•°é‡ï¼Œè‹¥è¶…æ—¶è¿”å›<code>0</code>ï¼Œè‹¥å‡ºé”™è¿”å›<code>-1</code>ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>pollfd</code>ç»“æ„ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> fd<span class="token punctuation">;</span>         <span class="token comment">// the socket descriptor</span>
  <span class="token keyword">short</span> events<span class="token punctuation">;</span>   <span class="token comment">// æˆ‘ä»¬æ„Ÿå…´è¶£çš„äº‹ä»¶ç»„æˆçš„ bitmap</span>
  <span class="token keyword">short</span> revents<span class="token punctuation">;</span>  <span class="token comment">// poll() è¿”å›æ—¶ï¼Œå·²å‘ç”Ÿäº‹ä»¶ç»„æˆçš„ bitmap</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>fd</code>è¡¨ç¤ºçš„å°±æ˜¯ä½ æƒ³ç›‘å¬çš„<code>socket descriptor</code>ï¼Œé€šè¿‡è®¾ç½®<code>events</code>å­—æ®µæ¥æŒ‡å®šæˆ‘ä»¬æ„Ÿå…´è¶£çš„äº‹ä»¶ç±»å‹ã€‚</p><p>eventså­—æ®µæ—¶ä¸‹è¡¨ä¸­å€¼çš„æŒ‰ä½æˆ–ï¼š</p><table><thead><tr><th style="text-align:center;">å¸¸å€¼</th><th style="text-align:center;">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center;">POLLIN</td><td style="text-align:center;">å½“æ•°æ®å¯è¯»æ—¶ï¼ˆrecv()å¯è¯»ï¼‰ï¼Œæé†’æˆ‘</td></tr><tr><td style="text-align:center;">POLLOUT</td><td style="text-align:center;">å½“æ•°æ®å¯å†™æ—¶ï¼ˆsend()å¯å†™ï¼‰ï¼Œæé†’æˆ‘</td></tr></tbody></table><p>å¾—åˆ°<code>struct pollfd</code>æ•°ç»„ä¹‹åï¼Œä½ å°±å¯ä»¥å°†å…¶ä¼ ç»™<code>poll()</code>å‡½æ•°äº†ï¼ŒåŒæ—¶ä¼ é€’çš„è¿˜æœ‰æ•°ç»„çš„é•¿åº¦ä»¥åŠä»¥æ¯«ç§’ä¸ºå•ä½çš„è¶…æ—¶æ—¶é—´ï¼ˆä½ ä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªè´Ÿæ•°ï¼Œè¡¨ç¤ºæ°¸ä¹…ç­‰å¾…ï¼‰ã€‚</p><p><code>poll()</code>è¿”å›ä¹‹åï¼Œä½ å¯ä»¥æ£€æŸ¥<code>revents</code>å­—æ®µï¼ŒæŸ¥çœ‹æ˜¯å¦è®¾ç½®äº†<code>POLLIN</code>æˆ–<code>POLLOUT</code>ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿã€‚</p><blockquote><p>å®é™…ä¸Šï¼Œä½ å¯ä»¥ä½¿ç”¨<code>poll()</code>è¿›è¡Œæ›´å¤šæ“ä½œï¼Œæ›´å¤šç»†èŠ‚ï¼Œå‚è§åæ–‡çš„<code>poll()</code>ä½¿ç”¨æ‰‹å†Œã€‚</p></blockquote><p>ä¸‹é¢ç»™å‡ºä¸€ä¸ªä¾‹å­ï¼Œå½“ä½ åœ¨å‘½ä»¤è¡Œæ•²å‡»ä¸€ä¸‹å›è½¦æˆ–è€…ç­‰2.5ç§’é’Ÿï¼Œä½ ä¼šçœ‹åˆ°<code>poll()</code>è¿”å›çš„ä¸åŒçŠ¶æ€ï¼Œè¿è¡Œä¸€ä¸‹è¯•è¯•å§ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> pfds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// å¦‚æœä½ éœ€è¦ç›‘å¬æ›´å¤šçš„socketï¼Œå°±è®¾ç½®å¾—æ›´å¤§ä¸€ç‚¹</span>

    pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token comment">// 0 è¡¨ç¤ºæ ‡å‡†è¾“å…¥</span>
    pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span> <span class="token comment">// Tell me when ready to read</span>

    <span class="token comment">// If you needed to monitor other things, as well:</span>
    <span class="token comment">//pfds[1].fd = some_socket; // Some socket descriptor</span>
    <span class="token comment">//pfds[1].events = POLLIN;  // Tell me when ready to read</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Hit RETURN or wait 2.5 seconds for timeout\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> num_events <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>pfds<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2.5 second timeout</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_events <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Poll timed out!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> pollin_happened <span class="token operator">=</span> pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pollin_happened<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;File descriptor %d is ready to read\n&quot;</span><span class="token punctuation">,</span> pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected event occurred: %d\n&quot;</span><span class="token punctuation">,</span> pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¼ºè°ƒä¸€ä¸‹ï¼Œ<code>poll()</code>è¿”å›çš„æ˜¯<code>pfds</code>æ•°ç»„ä¸­æœ‰äº‹ä»¶å‘ç”Ÿçš„å…ƒç´ æ•°é‡ï¼Œä½†æ˜¯å¹¶ä¸ä¼šå‘Šè¯‰ä½ æ•°ç»„ä¸­æœ‰å“ªäº›å…ƒç´ ï¼ˆä½ éœ€è¦å¾ªç¯åˆ¤æ–­ï¼‰æœ‰äº‹ä»¶å‘ç”Ÿã€‚</p><p>éšä¹‹è€Œæ¥ä¼šå‡ºç°å‡ ä¸ªé—®é¢˜ã€‚</p><p>å¦‚ä½•å‘ä¼ é€’ç»™<code>poll()</code>çš„æ•°ç»„ä¸­æ·»åŠ æ–°çš„<code>file descriptor</code>ï¼Ÿä½ åªè¦ç¡®ä¿æ•°ç»„ä¸­æœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥æ»¡è¶³ä½ çš„éœ€æ±‚å³å¯ï¼Œæˆ–è€…æ ¹æ®ä½ çš„éœ€æ±‚è°ƒç”¨ <code>realloc()</code> é‡æ–°åˆ†é…å†…å­˜ã€‚</p><p>æ€ä¹ˆåˆ é™¤<code>pfds</code>ä¸­çš„å…ƒç´ å‘¢ï¼Ÿä½ å¯ä»¥å°†<code>pfds</code>ä¸­çš„æœ€åä¸€ä¸ªæ•°æ®ï¼ˆå®é™…æœ‰ç”¨çš„æ•°æ®ï¼‰å¤åˆ¶åˆ°ä½ æƒ³åˆ é™¤çš„ä½ç½®ä¸Šï¼Œç„¶åå°†ä¼ ç»™<code>poll()</code>çš„æ•°ç»„é•¿åº¦å‚æ•° - 1ã€‚æˆ–è€…ä½ ä¹Ÿå¯ä»¥å°†ä½ æƒ³åˆ é™¤çš„å…ƒç´ è®¾ç½®ä¸ºè´Ÿæ•°ï¼Œ<code>poll()</code>ä¼šå¿½ç•¥å®ƒçš„ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸ªç¨å¾®éº»çƒ¦ç‚¹å„¿çš„ä¾‹å­ï¼Œç”¨<code>poll()</code>ç¼–å†™ä¸€ä¸ªèŠå¤©å®¤ã€‚</p><p>æˆ‘ä»¬éœ€è¦å¯åŠ¨ä¸€ä¸ª<code>listener socket</code>ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°<code>poll()</code>çš„<code>file descriptors</code>é›†åˆä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½é€šè¿‡å®ƒåˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰Clientè¿æ¥ä¸Šæ¥äº†ã€‚</p><p>ç„¶åæˆ‘ä»¬æŠŠæ–°è¿æ¥æ·»åŠ åˆ°<code>struct pollfd</code>æ•°ç»„ä¸­ï¼Œæ ¹æ®æˆ‘ä»¬å®é™…éœ€è¦åŠ¨æ€è°ƒæ•´å®ƒçš„å®¹é‡ã€‚å½“è¿æ¥æ–­å¼€æ—¶ï¼Œæˆ‘ä»¬å†å°†å…¶ä»æ•°ç»„ä¸­æ¸…é™¤ã€‚</p><p>å½“è¿æ¥ä¸­æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œæˆ‘ä»¬ä»ä¸­å°†æ•°æ®å–å‡ºå¹¶å°†å…¶è½¬å‘åˆ°å…¶ä»–è¿æ¥ä¸­ï¼Œè¿™æ ·å°±å®ç°äº†èŠå¤©å®¤çš„åŠŸèƒ½ã€‚</p><p>ä¸‹é¢ç»™å‡º<code>pollserver.c</code>çš„ä»£ç ã€‚ä½ å¯ä»¥åœ¨ä¸€ä¸ªçª—å£ä¸­è¿è¡Œå®ƒï¼Œç„¶ååœ¨å…¶ä»–å‘½ä»¤è¡Œçª—å£ä¸­æ‰§è¡Œ<code>telnet localhost 9034</code>ã€‚ä¹‹åä½ åœ¨å„ä¸ªçª—å£å‘½ä»¤è¡Œä¸­è¾“å…¥çš„ä¿¡æ¯ï¼ˆè®°å¾—æ•²å›è½¦ï¼‰ï¼Œå°±å¯ä»¥åœ¨å…¶ä»–çª—å£ä¸­çœ‹åˆ°äº†ã€‚</p><p>ä¸ä»…å¦‚æ­¤ï¼Œå½“ä½ è¾“å…¥<code>quit</code>æ¨å‡º<code>telnet</code>æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šæ£€æµ‹åˆ°è¿æ¥æ–­å¼€ï¼Œå¹¶ä¸”ä»<code>file descriptor</code>æ•°ç»„ä¸­å°†å…¶ç§»å‡ºã€‚</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** pollserver.c -- a cheezy multiperson chat server
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PORT</span> <span class="token string">&quot;9034&quot;</span>   <span class="token comment">// Port we&#39;re listening on</span></span>

<span class="token comment">// Get sockaddr, IPv4 or IPv6:</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>sa<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sa<span class="token operator">-&gt;</span>sa_family <span class="token operator">==</span> AF_INET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span><span class="token operator">*</span><span class="token punctuation">)</span>sa<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sin6_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Return a listening socket</span>
<span class="token keyword">int</span> <span class="token function">get_listener_socket</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> listener<span class="token punctuation">;</span>     <span class="token comment">// Listening socket descriptor</span>
    <span class="token keyword">int</span> yes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment">// For setsockopt() SO_REUSEADDR, below</span>
    <span class="token keyword">int</span> rv<span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>ai<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

    <span class="token comment">// Get us a socket and bind it</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rv <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ai<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;selectserver: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> ai<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        listener <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>listener <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// Lose the pesky &quot;address already in use&quot; error message</span>
        <span class="token function">setsockopt</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>yes<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>ai<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// All done with this</span>

    <span class="token comment">// If we got here, it means we didn&#39;t get bound</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Listen</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> listener<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Add a new file descriptor to the set</span>
<span class="token keyword">void</span> <span class="token function">add_to_pfds</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token operator">*</span>pfds<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>fd_count<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>fd_size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// If we don&#39;t have room, add more space in the pfds array</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>fd_count <span class="token operator">==</span> <span class="token operator">*</span>fd_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>fd_size <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Double it</span>

        <span class="token operator">*</span>pfds <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span><span class="token operator">*</span>pfds<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>pfds<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>fd_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>pfds<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">*</span>fd_count<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> newfd<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>pfds<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">*</span>fd_count<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span> <span class="token comment">// Check ready-to-read</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>fd_count<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Remove an index from the set</span>
<span class="token keyword">void</span> <span class="token function">del_from_pfds</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> pfds<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>fd_count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Copy the one from the end over this one</span>
    pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> pfds<span class="token punctuation">[</span><span class="token operator">*</span>fd_count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>fd_count<span class="token punctuation">)</span><span class="token operator">--</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Main</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> listener<span class="token punctuation">;</span>     <span class="token comment">// Listening socket descriptor</span>

    <span class="token keyword">int</span> newfd<span class="token punctuation">;</span>        <span class="token comment">// Newly accept()ed socket descriptor</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> remoteaddr<span class="token punctuation">;</span> <span class="token comment">// Client address</span>
    <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">;</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// Buffer for client data</span>

    <span class="token keyword">char</span> remoteIP<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Start off with room for 5 connections</span>
    <span class="token comment">// (We&#39;ll realloc as necessary)</span>
    <span class="token keyword">int</span> fd_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd_size <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token operator">*</span>pfds <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token operator">*</span>pfds <span class="token operator">*</span> fd_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set up and get a listening socket</span>
    listener <span class="token operator">=</span> <span class="token function">get_listener_socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>listener <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;error getting listening socket\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Add the listener to set</span>
    pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> listener<span class="token punctuation">;</span>
    pfds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span> <span class="token comment">// Report ready to read on incoming connection</span>

    fd_count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// For the listener</span>

    <span class="token comment">// Main loop</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> poll_count <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>pfds<span class="token punctuation">,</span> fd_count<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>poll_count <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;poll&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Run through the existing connections looking for data to read</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fd_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// Check if someone&#39;s ready to read</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// We got one!!</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">==</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// If listener is ready to read, handle new connection</span>

                    addrlen <span class="token operator">=</span> <span class="token keyword">sizeof</span> remoteaddr<span class="token punctuation">;</span>
                    newfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>remoteaddr<span class="token punctuation">,</span>
                        <span class="token operator">&amp;</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>newfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;accept&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">add_to_pfds</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pfds<span class="token punctuation">,</span> newfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_count<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;pollserver: new connection from %s on &quot;</span>
                            <span class="token string">&quot;socket %d\n&quot;</span><span class="token punctuation">,</span>
                            <span class="token function">inet_ntop</span><span class="token punctuation">(</span>remoteaddr<span class="token punctuation">.</span>ss_family<span class="token punctuation">,</span>
                                <span class="token function">get_in_addr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>remoteaddr<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                remoteIP<span class="token punctuation">,</span> INET6_ADDRSTRLEN<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// If not the listener, we&#39;re just a regular client</span>
                    <span class="token keyword">int</span> nbytes <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">int</span> sender_fd <span class="token operator">=</span> pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>nbytes <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Got error or connection closed by client</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>nbytes <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// Connection closed</span>
                            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;pollserver: socket %d hung up\n&quot;</span><span class="token punctuation">,</span> sender_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;recv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token function">close</span><span class="token punctuation">(</span>pfds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Bye!</span>

                        <span class="token function">del_from_pfds</span><span class="token punctuation">(</span>pfds<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// We got some good data from a client</span>

                        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> fd_count<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// Send to everyone!</span>
                            <span class="token keyword">int</span> dest_fd <span class="token operator">=</span> pfds<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">;</span>

                            <span class="token comment">// Except the listener and ourselves</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>dest_fd <span class="token operator">!=</span> listener <span class="token operator">&amp;&amp;</span> dest_fd <span class="token operator">!=</span> sender_fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">send</span><span class="token punctuation">(</span>dest_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> nbytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;send&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token comment">// END handle data from client</span>
            <span class="token punctuation">}</span> <span class="token comment">// END got ready-to-read from poll()</span>
        <span class="token punctuation">}</span> <span class="token comment">// END looping through file descriptors</span>
    <span class="token punctuation">}</span> <span class="token comment">// END for(;;)--and you thought it would never end!</span>
    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸‹ä¸€èŠ‚ï¼Œæˆ‘ä»¬ä¼šçœ‹å­¦åˆ°ä¸€ä¸ªåŠŸèƒ½ç±»ä¼¼ï¼Œä½†æ˜¯æ›´è€çš„ä¸€ä¸ªå‡½æ•°<code>select()</code>ã€‚<code>poll()</code>å’Œ<code>select()</code>ä¸¤è€…åŠŸèƒ½ç±»ä¼¼ï¼Œæ€§èƒ½ä¹Ÿå·®ä¸å¤ªå¤šï¼ŒåŒºåˆ«ä¸»è¦åœ¨äºå®ƒä»¬çš„ç”¨æ³•ã€‚</p><p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œ<code>select()</code>çš„å¯ç§»æ¤æ€§ç¨å¾®å¼ºä¸€ç‚¹ï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥ç¨æ˜¾ç¬¨æ‹™ã€‚å­¦å®Œä¸‹ä¸€èŠ‚ä¹‹åï¼Œæ ¹æ®ä½ çš„ç³»ç»Ÿæ”¯æŒæƒ…å†µï¼Œé€‰æ‹©ä¸€ä¸ªä½ æœ€å–œæ¬¢çš„å³å¯ã€‚</p><h3 id="_8-3-select-â€”è€å¤è‘£çš„åŒæ­¥i-oå¤šè·¯å¤ç”¨" tabindex="-1"><a class="header-anchor" href="#_8-3-select-â€”è€å¤è‘£çš„åŒæ­¥i-oå¤šè·¯å¤ç”¨" aria-hidden="true">#</a> 8.3. select()â€”è€å¤è‘£çš„åŒæ­¥I/Oå¤šè·¯å¤ç”¨</h3><p>æˆ‘å‡è®¾ä½ å·²ç»è¯»è¿‡<code>poll()</code>çš„ç”¨æ³•äº†ï¼Œå› æ­¤ç›´æ¥è¿›å…¥ä¸»é¢˜ã€‚</p><p><code>select()</code>å¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ªsocketï¼Œå½“æœ‰ä½ æ„Ÿå…´è¶£çš„ï¼ˆå¤šä¸ªï¼‰äº‹ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ªå‘ç”Ÿï¼Œå†…æ ¸æ‰ä¼šå”¤é†’<code>select()</code>ã€‚å¦‚æœä½ çœŸçš„æƒ³çŸ¥é“çš„è¯ï¼Œ<code>select()</code>ä¼šå‘Šè¯‰ä½ å“ªäº›socketæ˜¯å¯ä»¥è¯»å–çš„ï¼Œå“ªäº›æ˜¯å¯ä»¥å†™å…¥çš„ï¼Œå“ªäº›å¼•å‘äº†å¼‚å¸¸ã€‚</p><blockquote><p>è­¦å‘Šï¼šéšç€è¿æ¥æ•°è¶Šæ¥è¶Šå¤šï¼Œ<code>select()</code>å‡½æ•°ä¼šå˜å¾—å·¨æ…¢ï¼è¿™ç§æƒ…å†µä¸‹ï¼Œæ¨èä½ ä½¿ç”¨<a href="https://libevent.org/" target="_blank" rel="noopener noreferrer">libevent<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>è¿™æ ·çš„äº‹ä»¶åº“ã€‚å®ƒä¼šå°è¯•ä½¿ç”¨ä½ ç³»ç»Ÿä¸Šå¯ç”¨çš„æœ€å¿«æ–¹æ³•ï¼Œè·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚</p></blockquote><p>çœ‹ä¸€ä¸‹<code>select()</code>çš„è¯­æ³•ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> numfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>writefds<span class="token punctuation">,</span>
           fd_set <span class="token operator">*</span>exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token operator">*</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>select()</code>å‡½æ•°ç›‘å¬å¤šç§ç±»å‹æ–‡ä»¶æè¿°ç¬¦çš„é›†åˆï¼Œå°¤å…¶æ˜¯<code>readfd</code>ã€<code>writefd</code>å’Œ<code>exceptfd</code>ã€‚å¦‚æœä½ æƒ³è¦çŸ¥é“ä½ æ˜¯å¦èƒ½ä»æ ‡å‡†è¾“å…¥ï¼ˆstandard inputï¼‰åŠæŸä¸ªsocket descriptorï¼ˆç”¨ <code>sockfd</code> è¡¨ç¤ºï¼‰ä¸­è¿›è¡Œè¯»å–ï¼Œåªè¦å°†æ ‡å‡†è¾“å…¥çš„æ–‡ä»¶æè¿°ç¬¦è¡¨â€”â€”<code>0</code> ä¸ <code>sockfd</code> æ–°å¢åˆ° <code>readfds</code> ä¸­ã€‚å‚æ•°<code>numfds</code>åº”è®¾ç½®ä¸ºæœ€é«˜æ–‡ä»¶æè¿°ç¬¦çš„å€¼åŠ 1ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œå®ƒåº”è¯¥è®¾ç½®ä¸º<code>sockfd+1</code>ï¼Œå› ä¸ºå®ƒè‚¯å®šé«˜äºæ ‡å‡†è¾“å…¥â€”â€”<code>0</code>ã€‚</p><p>å½“<code>select()</code>è¿”å›æ—¶ï¼Œ<code>readfds</code>å°†è¢«ä¿®æ”¹ï¼Œæ¥åæ˜ ä½ é€‰æ‹©çš„å“ªäº›file descriptorå¯ä»¥è¯»å–ã€‚ä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å®<code>FD_ISSET()</code>æµ‹è¯•å®ƒä»¬ã€‚</p><p>åœ¨è¿›ä¸€æ­¥è®¨è®ºä¹‹å‰ï¼Œæˆ‘å…ˆè¯´ä¸€ä¸‹å¦‚ä½•æ“ä½œè¿™äº›file descriptoré›†åˆï¼Œæ¯ä¸ªé›†åˆéƒ½æ˜¯<code>fd_set</code>ç±»å‹ï¼Œä¸‹é¢çš„å®åœ¨æ­¤ç±»å‹ä¸Šè¿è¡Œï¼š</p><table><thead><tr><th style="text-align:center;">å‡½æ•°</th><th style="text-align:center;">æè¿°</th></tr></thead><tbody><tr><td style="text-align:center;">FD_SET(int fd, fd_set *set);</td><td style="text-align:center;">å°†fdåŠ å…¥åˆ°set</td></tr><tr><td style="text-align:center;">FD_CLR(int fd, fd_set *set);</td><td style="text-align:center;">ä»setç§ç§»é™¤fd</td></tr><tr><td style="text-align:center;">FD_ISSET(int fd, fd_set *set);</td><td style="text-align:center;">è‹¥fdåœ¨setä¸­ï¼Œè¿”å›true</td></tr><tr><td style="text-align:center;">FD_ZERO(fd_set *set);</td><td style="text-align:center;">æ¸…ç©ºset</td></tr></tbody></table><p>æœ€åï¼Œè¿™ä¸ªå¥‡æ€ªçš„<code>struct timeval</code>æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>æœ‰æ—¶å€™ï¼Œä½ ä¸æƒ³æ°¸è¿œä¸€ç›´ç­‰ç€åˆ«äººç»™ä½ å‘é€æ•°æ®ã€‚ä¹Ÿè®¸æ¯éš”ä¸€æ®µæ—¶é—´ä½ å°±æƒ³åœ¨ç»ˆç«¯ä¸Šæ‰“å°â€œStill Goingâ€¦â€ï¼Œå³ä½¿ä»€ä¹ˆéƒ½æ²¡æœ‰å‘ç”Ÿã€‚è¿™ä¸ªstructå…è®¸ä½ æŒ‡å®šè¶…æ—¶æ—¶é—´æ®µã€‚å¦‚æœè¶…è¿‡äº†æ—¶é—´ï¼Œ<code>select()</code>ä»ç„¶æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å°±ç»ªçš„file descriptorï¼Œå®ƒå°†è¿”å›ä»¥ä¾¿ä½ å¯ä»¥ç»§ç»­è¿›è¡Œå¤„ç†ã€‚</p><p><code>struct timeval</code> é•¿è¿™æ ·ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> tv_sec<span class="token punctuation">;</span>     <span class="token comment">// seconds</span>
  <span class="token keyword">int</span> tv_usec<span class="token punctuation">;</span>    <span class="token comment">// microseconds</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åªéœ€å°†<code>tv_sec</code>è®¾ç½®ä¸ºç­‰å¾…çš„ç§’æ•°ï¼Œå°†<code>tv_usec</code>è®¾ç½®æˆç­‰å¾…çš„å¾®ç§’æ•°ã€‚ä½ æ²¡çœ‹é”™ï¼Œè¿™æ˜¯_micro_secondsï¼Œè€Œä¸æ˜¯æ¯«ç§’ã€‚ä¸€æ¯«ç§’æœ‰1000å¾®ç§’ï¼Œä¸€ç§’é’Ÿæœ‰1000æ¯«ç§’ã€‚å› æ­¤ï¼Œæ¯ç§’æœ‰1000000å¾®ç§’ã€‚ä¸ºä»€ä¹ˆæ˜¯â€œusecâ€ï¼Ÿâ€œuâ€åº”è¯¥çœ‹èµ·æ¥åƒæˆ‘ä»¬ç”¨æ¥è¡¨ç¤ºâ€œmicroâ€çš„å¸Œè…Šå­—æ¯Î¼ï¼ˆMuï¼‰ã€‚</p><p>æ­¤å¤–ï¼Œå½“å‡½æ•°è¿”å›æ—¶ï¼Œå¯èƒ½ä¼šæ›´æ–°<code>timeout</code>ä»¥æ˜¾ç¤ºå‰©ä½™æ—¶é—´ã€‚è¿™å–å†³äºä½ æ­£åœ¨è¿è¡Œçš„Unixç±»å‹ã€‚</p><p>å“‡ï¼æˆ‘ä»¬æœ‰ä¸€ä¸ªå¾®ç§’çº§åˆ«çš„è®¡æ—¶å™¨ï¼å¥½å§ï¼Œåˆ«æŒ‡æœ›å®ƒã€‚æ— è®ºä½ å°†<code>struct timeval</code>è®¾ç½®å¾—å¤šä¹ˆå°ï¼Œä½ å¯èƒ½è¿˜æ˜¯è¦ç­‰å¾…ä¸€å°æ®µçš„ standard Unix timesliceï¼ˆæ ‡å‡† Unix æ—¶é—´ç‰‡æ®µï¼‰ã€‚</p><p>å¦ä¸€ä»¶æœ‰æ„æ€çš„äº‹æƒ…æ˜¯ï¼šå¦‚æœå°†<code>struct timeval</code>ä¸­çš„å­—æ®µè®¾ç½®ä¸º0ï¼Œ<code>select()</code>ä¼šåœ¨è½®è¯¢è¿‡ sets ä¸­çš„æ¯ä¸ª file descriptor ä¹‹åç«‹å³timeoutã€‚å¦‚æœå°†å‚æ•°<code>timeout</code>è®¾ç½®ä¸º<code>NULL</code>ï¼Œå®ƒå°†æ°¸è¿œä¸ä¼štimeoutï¼Œè€Œæ˜¯é™·å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°è‡³å°‘ä¸€ä¸ªfile descriptorå·²ç»å°±ç»ªã€‚å¦‚æœä½ ä¸åœ¨ä¹ç­‰å¾…æ—¶é—´ï¼Œå¯ä»¥åœ¨<code>select()</code>ä¸­å°†å…¶è®¾ç½®ä¸º<code>NULL</code>ã€‚</p><p>ä¸‹é¢çš„ä»£ç æ®µç­‰å¾…2.5ç§’ï¼Œç­‰å¾…æ ‡å‡†è¾“å…¥ä¸­å‡ºç°æŸäº›å†…å®¹ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** select.c -- a select() demo
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STDIN</span> <span class="token expression"><span class="token number">0</span>  </span><span class="token comment">// file descriptor for standard input</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> tv<span class="token punctuation">;</span>
    fd_set readfds<span class="token punctuation">;</span>

    tv<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    tv<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">500000</span><span class="token punctuation">;</span>

    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FD_SET</span><span class="token punctuation">(</span>STDIN<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// don&#39;t care about writefds and exceptfds:</span>
    <span class="token function">select</span><span class="token punctuation">(</span>STDIN<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>STDIN<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;A key was pressed!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Timed out.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœä½ ç”¨çš„æ˜¯è¡Œç¼“å†²ï¼ˆline bufferedï¼‰çš„ç»ˆç«¯ï¼Œé‚£ä¹ˆä½ ä»é”®ç›˜è¾“å…¥æ•°æ®ååº”è¯¥è¦å°½å¿«æŒ‰ä¸‹ Enterï¼Œå¦åˆ™ç¨‹åºå°±ä¼šå‘ç”Ÿ timeoutã€‚</p><blockquote><p>è¡Œç¼“å­˜ï¼šæ ‡å‡†è¾“å‡ºæµé‡åˆ°æ¢è¡Œç¬¦\næ—¶å†²åˆ·ç¼“å­˜ã€‚</p></blockquote><p>ä½ ç°åœ¨å¯èƒ½åœ¨æƒ³ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨åœ¨éœ€è¦ç­‰å¾…æ•°æ®çš„ datagram socket ä¸Šåº”è¯¥ä¼šå¾ˆæ£’ï¼Œä½ æ˜¯å¯¹çš„ï¼šè¿™å¯èƒ½ç¡®å®æ˜¯ä¸ªä¸é”™çš„æ–¹æ³•ã€‚æœ‰äº›Unixå¯ä»¥ä»¥è¿™ç§æ–¹å¼ä½¿ç”¨<code>select()</code>ï¼Œæœ‰äº›åˆ™ä¸èƒ½ã€‚å¦‚æœä½ æƒ³å°è¯•çš„è¯ï¼Œä½ åº”è¯¥å‚è€ƒä¸€ä¸‹ä½ ç³»ç»Ÿä¸Šçš„manæ‰‹å†Œä¸Šæ˜¯æ€ä¹ˆå†™çš„ã€‚</p><p>æœ‰äº›Unixç³»ç»Ÿä¼šæ›´æ–° <code>struct timeval</code> çš„æ—¶é—´ï¼Œç”¨æ¥åæ˜  <code>select()</code> è¿˜å‰©ä¸‹å¤šå°‘æ—¶é—´æ‰ä¼š timeoutï¼›ä½†æ˜¯æœ‰äº›å¹¶ä¸ä¼šè¿™æ ·ã€‚å¦‚æœä½ æƒ³è¦ç¨‹åºå…·å¤‡å¯ç§»æ¤æ€§ï¼Œé‚£å°±ä¸è¦ä¾èµ–è¿™ä¸ªç‰¹æ€§ã€‚ï¼ˆå¦‚æœä½ ç¡®å®éœ€è¦è¿½è¸ªå‰©ä¸‹çš„æ—¶é—´ï¼Œå¯ä»¥ä½¿ç”¨ <code>gettimeofday()</code>ï¼Œæˆ‘çŸ¥é“è¿™è®©ä½ æœ‰ç‚¹ä¸çˆ½ï¼Œè¿™ä¹Ÿæ˜¯æ²¡æœ‰åŠæ³•çš„äº‹æƒ…ã€‚ï¼‰</p><p>å¦‚æœåœ¨ read set ä¸­çš„ socket å…³é—­è¿æ¥äº†ï¼Œä¼šæ€æ ·ï¼Ÿ</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>select()</code>è¿”å›æ—¶ï¼Œsocket descriptorä¼šè¢«è®¾ç½®ä¸ºâ€œready to readâ€ã€‚å½“ä½ å¯¹å…¶æ‰§è¡Œ<code>recv()</code>æ—¶ï¼Œ<code>recv()</code>å°†è¿”å›<code>0</code>ã€‚è¿™æ ·ä½ å°±çŸ¥é“å®¢æˆ·ç«¯å·²ç»æ–­å¼€è¿æ¥äº†ã€‚</p><h3 id="_8-4-æ•°æ®åªä¼ äº†ä¸€éƒ¨åˆ†æ€ä¹ˆåŠ" tabindex="-1"><a class="header-anchor" href="#_8-4-æ•°æ®åªä¼ äº†ä¸€éƒ¨åˆ†æ€ä¹ˆåŠ" aria-hidden="true">#</a> 8.4. æ•°æ®åªä¼ äº†ä¸€éƒ¨åˆ†æ€ä¹ˆåŠï¼Ÿ</h3><p>å›æƒ³ä¸€ä¸‹ä¹‹å‰æˆ‘è®²è¿‡çš„<a href="https://www.chanmufeng.com/posts/network-programming/send-recv.html" target="_blank" rel="noopener noreferrer"><code>send()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>å‡½æ•°ï¼Œæˆ‘å½“æ—¶è¯´è¿‡ï¼Œ<code>send()</code>å¯èƒ½ä¸ä¼šä¸€ä¸‹å­æŠŠä½ æ‰€æœ‰çš„æ•°æ®éƒ½å‘é€å‡ºå»ï¼Œæ¯”å¦‚ä½ æƒ³æ”¾ä¸€ä¸ªé•¿åº¦ä¸º<code>512</code>å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼Œ<code>send()</code>çš„è¿”å›å€¼å´æ˜¯<code>412</code>ã€‚ä½ å¯èƒ½ä¸ç¦ä¼šé—®åˆ°ï¼Œå‰©ä¸‹çš„<code>100</code>å­—èŠ‚æ€ä¹ˆåŠï¼Ÿ</p><p>å…¶å®è¿™<code>100</code>å­—èŠ‚ä»ç„¶åœ¨ä½ å°å¾—å¯æ€œçš„ç¼“å†²åŒºï¼ˆbufferï¼‰ä¸­ï¼Œç­‰ç€ä½ æŠŠä»–ä»¬å‘é€å‡ºå»å‘¢ï¼æ¯•ç«Ÿäº‹äº‹æ— æ³•å¦‚ä½ æ‰€æ„¿ï¼Œå†…æ ¸ä¹Ÿä¼šæœ‰è‡ªå·±çš„å°è„¾æ°”ï¼Œæœ‰æ—¶å°±æ˜¯ä¸æƒ³æŠŠä½ çš„æ•°æ®ä¸€ä¸‹å­å‘é€å‡ºå»ï¼Œä½ è¿˜å¾—è‡ªå·±åŠ¨æ‰‹æŠŠå‰©ä¸‹çš„æ•°æ®å‘é€å‡ºå»ã€‚</p><p>ä½ å¯ä»¥è¿™ä¹ˆå†™ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">sendall</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// how many bytes we&#39;ve sent</span>
    <span class="token keyword">int</span> bytesleft <span class="token operator">=</span> <span class="token operator">*</span>len<span class="token punctuation">;</span> <span class="token comment">// how many we have left to send</span>
    <span class="token keyword">int</span> n<span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>total <span class="token operator">&lt;</span> <span class="token operator">*</span>len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        n <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> buf<span class="token operator">+</span>total<span class="token punctuation">,</span> bytesleft<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        total <span class="token operator">+=</span> n<span class="token punctuation">;</span>
        bytesleft <span class="token operator">-=</span> n<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span>len <span class="token operator">=</span> total<span class="token punctuation">;</span> <span class="token comment">// return number actually sent here</span>

    <span class="token keyword">return</span> n<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">?</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// return -1 on failure, 0 on success</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šä¾‹ä¸­ï¼Œ<code>s</code>æ˜¯ä½ æƒ³å‘é€æ•°æ®çš„<code>socket</code>ï¼Œ<code>buf</code>æ˜¯ä¿å­˜æ•°æ®çš„ç¼“å†²åŒºï¼ˆbufferï¼‰ï¼Œ<code>len</code>æŒ‡å‘ä¸€ä¸ª<code>int</code>ç±»å‹çš„å˜é‡ï¼Œè¿™ä¸ªå˜é‡è®°å½•äº†ç¼“å†²åŒºå‰©ä½™æ•°æ®çš„å¤§å°ã€‚</p><p><code>send()</code>å¼‚å¸¸æ—¶ä¼šè¿”å›<code>-1</code>ï¼Œå¹¶ä¸”æœ€ç»ˆå®é™…å‘é€çš„å­—èŠ‚æ•°é‡ä¿å­˜åœ¨äº†<code>len</code>å˜é‡ä¸­ã€‚<code>sendall()</code>ä¼šç«­å°½å…¨åŠ›å‘é€ä½ æ‰€æœ‰çš„æ•°æ®ï¼Œé™¤éå‘ç”Ÿäº†é”™è¯¯ä¼šå¯¼è‡´ç«‹å³è¿”å›ï¼Œå¦åˆ™<code>len</code>çš„å€¼ä¸€å®šå°±æ˜¯ä½ æƒ³å‘é€çš„æ•°æ®çš„é•¿åº¦ã€‚</p><p>ä¸ºäº†å®Œæ•´æ€§ï¼Œç»™ä¸€ä¸ªä½¿ç”¨<code>sendall()</code>å‡½æ•°çš„ä¾‹å­ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Beej!&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> len<span class="token punctuation">;</span>

len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sendall</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;sendall&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;We only sent %d bytes because of the error!\n&quot;</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“éƒ¨åˆ†æ•°æ®åŒ…åˆ°è¾¾æ—¶ï¼Œæ¥æ”¶å™¨ç«¯ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p><p>å¦‚æœæ•°æ®åŒ…æ˜¯å¯å˜é•¿åº¦çš„ï¼Œæ¥æ”¶æ–¹å¦‚ä½•çŸ¥é“ä¸€ä¸ªæ•°æ®åŒ…ä½•æ—¶ç»“æŸï¼Œå¦ä¸€ä¸ªä½•æ—¶å¼€å§‹ï¼Ÿ</p><p>ç°å®ä¸–ç•Œçš„æƒ…æ™¯ç™¾å‡ºå¾€å¾€æœ€è®©æˆ‘ä»¬å¤´ç–¼ã€‚ä½ å¿…é¡»å¾—ä½¿ç”¨å°è£…ï¼ˆå¿˜è®°è¿™ä¸ªæ¦‚å¿µçš„è¯<a href="https://www.chanmufeng.com/posts/network-programming/%E6%BC%AB%E8%B0%88%E7%BD%91%E7%BB%9C.html" target="_blank" rel="noopener noreferrer">ç‚¹æˆ‘<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼‰æ¥è§£å†³è¿™ä¸ªé—®é¢˜å–½ã€‚</p><p>ä¸‹æ–‡è§ï¼</p><h3 id="_8-5-serialization-å¦‚ä½•å°è£…æ•°æ®" tabindex="-1"><a class="header-anchor" href="#_8-5-serialization-å¦‚ä½•å°è£…æ•°æ®" aria-hidden="true">#</a> 8.5. Serialization-å¦‚ä½•å°è£…æ•°æ®ï¼Ÿ</h3><p>ä½ å¯èƒ½å·²ç»å‘ç°äº†ï¼Œåœ¨ç½‘ç»œä¸­ä¼ é€’å­—ç¬¦ä¸²ä¿¡æ¯æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ï¼Œä½†æ˜¯å¦‚æœä½ æƒ³ä¼ é€’åƒintæˆ–è€…floatç±»å‹çš„äºŒè¿›åˆ¶æ•°æ®æ€ä¹ˆåŠå‘¢ï¼Ÿä½ æœ‰å‡ ä¸ªé€‰æ‹©ï¼š</p><ol><li>ä½¿ç”¨è¯¸å¦‚ <code>sprintf()</code>ä¹‹ç±»çš„å‡½æ•°å°†æ•°å­—è½¬æ¢ä¸ºæ–‡æœ¬ç±»å‹ï¼Œç„¶åæŠŠæ–‡æœ¬å‘é€å‡ºå»ã€‚æ¥æ”¶æ–¹å¯ä»¥ä½¿ç”¨strtol()ç­‰å‡½æ•°å°†æ–‡æœ¬è½¬æ¢å›æ•°å­—ã€‚</li><li>ç›´æ¥ä»¥åŸå§‹æ•°æ®è¿›è¡Œä¼ é€ï¼Œå°†æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆä¼ ç»™send()ã€‚</li><li>å°†æ•°å­—ç¼–ç ï¼ˆencodeï¼‰ä¸ºå¯ç§»æ¤çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ¥å—è€…å°†å…¶è§£ç ï¼ˆdecodeï¼‰ã€‚</li></ol><p>çœ‹äº†æœ¬æ–‡çš„æ ‡é¢˜ä½ å°±çŸ¥é“äº†ï¼Œæˆ‘ä»¬å°†é€‰æ‹©ç¬¬3ç§ã€‚</p><blockquote><p>åœ¨å¼€å§‹æˆ‘ä»¬æ¿€æƒ…æ¾æ¹ƒçš„æ—…ç¨‹ä¹‹å‰ï¼Œæˆ‘åº”è¯¥å‘Šè¯‰ä½ å…¶å®æœ‰ç°æˆçš„å‡½æ•°åº“å¯ä»¥å¸®åŠ©ä½ åšè¿™ä»¶äº‹æƒ…ï¼Œå¦‚æœä½ è¦ä»å¤´å®ç°ä¸€ä¸ªå…·æœ‰å¯ç§»æ¤æ€§å¹¶ä¸”æ²¡æœ‰bugçš„è¿™ç§åº“å¯å°±å¤ªéš¾äº†ã€‚</p></blockquote><p>å®é™…ä¸Šï¼Œä¸Šé¢3ç§æ–¹æ³•å„æœ‰åˆ©å¼Šï¼Œä½†æ˜¯æˆ‘æ›´å€¾å‘äºç¬¬3ç§ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆèŠä¸€èŠä¸¤å¤–ä¸¤ç§æ–¹æ³•çš„ä¼˜ç¼ºç‚¹ã€‚</p><p>ç¬¬ä¸€ç§ï¼Œå‘é€ä¹‹å‰å…ˆå°†æ•°å­—è½¬æ¢ä¸ºæ–‡æœ¬ï¼Œä¼˜ç‚¹æ˜¯å¾ˆå®¹æ˜“æ‰“å°å’Œè¯»å–æ¥è‡ªç½‘ç»œçš„æ•°æ®ã€‚æœ‰æ—¶å€™é€‚åˆäººç±»é˜…è¯»çš„ä¼ è¾“åè®®æ¯”è¾ƒé€‚åˆäºå¸¦å®½ä¸æ•æ„Ÿï¼ˆnon-bandwidth-intensiveï¼‰çš„æƒ…å†µï¼Œæ¯”å¦‚<a href="https://en.wikipedia.org/wiki/Internet_Relay_Chat" target="_blank" rel="noopener noreferrer">Internet Relay Chatï¼ˆIRCï¼‰<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚ç¼ºç‚¹å°±æ˜¯æ•°æ®è½¬æ¢é€Ÿåº¦æ…¢ï¼Œå¹¶ä¸”éœ€è¦æ¯”åŸæœ¬çš„æ•°å­—å½¢å¼ä½¿ç”¨æ›´å¤šçš„ç©ºé—´ã€‚</p><p>ç¬¬äºŒç§æ–¹æ³•ç›¸å½“ç®€å•ï¼Œä½†æ˜¯æå…·å±é™©ï¼å› ä¸ºè¿™ç§æ–¹æ³•ä¸å…·å¤‡å¯ç§»æ¤æ€§ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">double</span> d <span class="token operator">=</span> <span class="token number">3490.15926535</span><span class="token punctuation">;</span>
    
<span class="token function">send</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>d<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> d<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* ä¸å…·å¤‡å¯ç§»æ¤æ€§ï¼! */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥æ”¶æ–¹æ¥å—éœ€è¦è¿™æ ·ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">double</span> d<span class="token punctuation">;</span>

<span class="token function">recv</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>d<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> d<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* ä¸å…·å¤‡å¯ç§»æ¤æ€§ï¼! */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-6-æ•°æ®å°è£…" tabindex="-1"><a class="header-anchor" href="#_8-6-æ•°æ®å°è£…" aria-hidden="true">#</a> 8.6. æ•°æ®å°è£…</h3><h3 id="_8-7-å¹¿æ’­æ•°æ®åŒ…-å¤§å£°è¯´ã€Œhello-worldã€" tabindex="-1"><a class="header-anchor" href="#_8-7-å¹¿æ’­æ•°æ®åŒ…-å¤§å£°è¯´ã€Œhello-worldã€" aria-hidden="true">#</a> 8.7. å¹¿æ’­æ•°æ®åŒ…-å¤§å£°è¯´ã€ŒHelloï¼ŒWorldã€</h3><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»è®¨è®ºäº†æ€ä¹ˆä»ä¸€å°ä¸»æœºå‘é€æ•°æ®åˆ°å¦ä¸€å°ä¸»æœºã€‚ä½†æ˜¯ï¼Œå¦‚æœæœ‰è¿™ç§å¯èƒ½ï¼Œä½ è‚¯å®šæƒ³åŒæ—¶æŠŠæ•°æ®å‘é€ç»™å¤šå°ä¸»æœºã€‚</p><p>ç”¨<code>UDP</code>ï¼ˆåªèƒ½ç”¨<code>UDP</code>ï¼Œ<code>TCP</code>ä¸è¡Œï¼‰å’Œæ ‡å‡†çš„IPv4ï¼Œå¯ä»¥é€šè¿‡ä¸€ç§å«åšå¹¿æ’­ï¼ˆ<em>broadcasting</em>ï¼‰çš„æœºåˆ¶æ¥å®ç°ã€‚IPv6ä¸æ”¯æŒå¹¿æ’­ï¼Œä½ å¾—ç”¨ä¸€ç§æ›´é«˜çº§çš„æŠ€æœ¯â€”â€”å¤šæ’­ï¼ˆ<em>multicasting</em>ï¼‰æ¥å®ç°ã€‚è¿™ä¸ªæŠ€æœ¯æˆ‘ä»¬è¿™æ¬¡ä¸ä¼šè®²ï¼Œæ¯•ç«Ÿæˆ‘ä»¬ç°åœ¨è¿˜åœç•™åœ¨IPv4çš„32ä½é˜¶æ®µå‘¢ï¼Œå°±ä¸å¼‚æƒ³å¤©å¼€äº†ã€‚</p><p>Waitï¼ä½ åˆ«æºœèµ°ï¼Œè‡ªå·±å·æ‘¸å¼€å§‹å¹¿æ’­ï¼Œæˆ‘è¿˜æ²¡å¼€å§‹ä»‹ç»å‘¢ã€‚ä½ å¿…é¡»è®¾ç½®å¥—æ¥å­—é€‰é¡¹<code>SO_BROADCAST</code>ï¼Œç„¶åæ‰èƒ½åœ¨ç½‘ç»œä¸Šå‘é€å¹¿æ’­æ•°æ®åŒ…ï¼Œè¿™å°±å¥½æ¯”æ˜¯åœ¨å¯¼å¼¹å‘å°„å¼€å…³ä¸Šç›–çš„ä¸€ä¸ªå°å¡‘æ–™ç½©ï¼Œä½ çš„ä¸€æ ¹æŒ‡å¤´å°±å¯ä»¥æ§åˆ¶æ‰€æœ‰ï¼</p><p>ä½†æ˜¯ï¼Œè¯´çœŸçš„ï¼Œä½¿ç”¨å¹¿æ’­æ•°æ®åŒ…æœ‰ä¸€ä¸ªå±é™©ï¼Œå› ä¸ºæ¯ä¸ªæ”¶åˆ°å¹¿æ’­åŒ…çš„ç³»ç»Ÿéƒ½è¦æ‹¨å¼€ä¸€å±‚å±‚åƒæ´‹è‘±çš®ä¸€æ ·çš„å°è£…ï¼Œç›´åˆ°ç³»ç»ŸçŸ¥é“è¿™ä¸ªèµ„æ–™æ˜¯è¦å‘é€åˆ°å“ªä¸ª port ä¸ºæ­¢ï¼Œç„¶åç³»ç»Ÿä¼šå¼€å§‹å¤„ç†è¿™ä¸ªæ•°æ®æˆ–è€…å°†å…¶ä¸¢å¼ƒã€‚</p><p>æ— è®ºæ€æ ·ï¼Œæ¥æ”¶å¹¿æ’­æ•°æ®åŒ…çš„æ¯å°æœºå™¨éƒ½è¦åšå¾ˆå¤šå·¥ä½œï¼Œè€Œä¸”å› ä¸ºå®ƒä»¬éƒ½åœ¨æœ¬åœ°ç½‘ç»œä¸Šï¼Œæ‰€ä»¥å¯èƒ½ä¼šæœ‰å¾ˆå¤šæœºå™¨åšå¾ˆå¤šä¸å¿…è¦çš„å·¥ä½œã€‚</p><p>ç°åœ¨ï¼Œæœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ã€‚ã€‚</p><p>ç­‰ä¸€ä¸‹ï¼ŒçœŸçš„æœ‰å¾ˆå¤šæ–¹æ³•å—ï¼Ÿ</p><p>é‚£æ˜¯ä»€ä¹ˆè¡¨æƒ…é˜¿ï¼Ÿè®©æˆ‘å‘Šè¯‰ä½ å§ï¼Œå‘é€å¹¿æ’­åŒ…çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œæ‰€ä»¥é‡ç‚¹å°±æ˜¯ï¼šä½ è¯¥å¦‚ä½•æŒ‡å®šå¹¿æ’­æ•°æ®çš„ç›®åœ°åœ°å€ï¼Ÿ</p><p>æœ‰ä¸¤ç§å¸¸ç”¨çš„æ–¹æ³•ï¼š</p><ol><li>å°†æ•°æ®å‘é€åˆ°æŒ‡å®šå­ç½‘çš„å¹¿æ’­åœ°å€ï¼Œå°±æ˜¯æŠŠå­ç½‘ï¼ˆ subnet&#39;s networkï¼‰çš„ä¸»æœºï¼ˆ hostï¼‰éƒ¨åˆ†å…¨éƒ¨å¡«<code> 1</code>ã€‚ä¾‹å¦‚ï¼Œæˆ‘çš„ç½‘ç»œæ˜¯<code>192.168.1.0</code>ï¼Œæˆ‘çš„å­ç½‘æ©ç æ˜¯<code>255.255.255.0</code>ï¼Œæ‰€ä»¥åœ°å€çš„æœ€åä¸€ä¸ªå­—èŠ‚æ˜¯æˆ‘çš„ä¸»æœºå·ï¼ˆå› ä¸ºæ ¹æ®ç½‘ç»œæ©ç ï¼Œå‰3ä¸ªå­—èŠ‚æ˜¯ç½‘ç»œå·ï¼‰ï¼Œæ‰€ä»¥æˆ‘çš„å¹¿æ’­åœ°å€æ˜¯<code>192.168.1.255</code>ã€‚åœ¨Unixä¸‹ï¼Œ<code>ifconfig</code>ä¼šå‘Šè¯‰ä½ è¿™äº›ä¿¡æ¯çš„ã€‚ä½ å¯ä»¥å°†è¿™ç§ç±»å‹çš„å¹¿æ’­æ•°æ®åŒ…å‘é€åˆ°è¿œç¨‹ç½‘ç»œå’Œæœ¬åœ°ç½‘ç»œï¼Œä½†ä½ ä¼šé¢ä¸´æ•°æ®åŒ…è¢«ç›®æ ‡è·¯ç”±å™¨ä¸¢å¼ƒçš„é£é™©ã€‚ï¼ˆå¦‚æœä»–ä»¬ä¸æ”¾å¼ƒå®ƒï¼Œé‚£è¿™äº›å¹¿æ’­æ•°æ®å¯èƒ½ä¼šæ·¹æ²¡ä»–ä»¬çš„å±€åŸŸç½‘ã€‚ï¼‰</li><li>å°†æ•°æ®å‘é€åˆ°â€œå…¨å±€ï¼ˆglobalï¼‰â€å¹¿æ’­åœ°å€ã€‚è¿™æ˜¯<code>255.255.255.255</code>ï¼Œå³INADDR_BROADCASTã€‚è®¸å¤šæœºå™¨ä¼šè‡ªåŠ¨å°†å…¶ä¸æ‚¨çš„ç½‘ç»œå·ç ã€ŒæŒ‰ä½ä¸ã€ï¼Œä»¥å°†å…¶è½¬æ¢ä¸ºç½‘ç»œå¹¿æ’­åœ°å€ï¼Œä½†æœ‰äº›æœºå™¨å´ä¸ä¼šã€‚å…·æœ‰è®½åˆºæ„å‘³çš„æ˜¯ï¼Œè·¯ç”±å™¨ä¸ä¼šæŠŠè¿™ç§ç±»å‹çš„å¹¿æ’­æ•°æ®åŒ…ä»ä½ çš„æœ¬åœ°ç½‘ç»œè½¬å‘å‡ºå»ã€‚</li></ol><p>æ‰€ä»¥å¦‚æœä½ æƒ³è¦å°†æ•°æ®é€åˆ°å¹¿æ’­åœ°å€ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è®¾ç½® <code>SO_BROADCAST</code> socket é€‰é¡¹æ—¶ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿå¥½ï¼Œæˆ‘ä»¬ç”¨ä¹‹å‰çš„ <a href="https://www.chanmufeng.com/posts/network-programming/Datagram-Sockets.html" target="_blank" rel="noopener noreferrer">talker ä¸ listener<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> æ¥ç‚’ä¸ªå†·é¥­ï¼Œç„¶åçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ã€‚</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ talker <span class="token number">192.168</span>.1.2 foo
sent <span class="token number">3</span> bytes to <span class="token number">192.168</span>.1.2
$ talker <span class="token number">192.168</span>.1.255 foo
sendto: Permission denied
$ talker <span class="token number">255.255</span>.255.255 foo
sendto: Permission denied
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚ä½ æ‰€è§ï¼Œæ•°æ®å‘é€å¾—å¹¶ä¸é¡ºåˆ©......å› ä¸ºæˆ‘ä»¬æ²¡æœ‰è®¾ç½®<code>SO_BROADCAST</code>è¿™ä¸ªsocketé€‰é¡¹ï¼Œè®¾ç½®ä¸€ä¸‹ï¼Œç„¶åä½ å°±å¯ä»¥ç”¨<code>sendto()</code>å°†æ•°æ®å‘é€åˆ°ä»»ä½•ä½ æƒ³å‘é€çš„åœ°æ–¹å»äº†ã€‚</p><p>äº‹å®ä¸Šï¼Œè¿™æ˜¯<code>UDP</code>åº”ç”¨ç¨‹åºå¯ä»¥å¹¿æ’­å’Œä¸èƒ½å¹¿æ’­çš„å”¯ä¸€åŒºåˆ«ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ”¹é€ ä¸€ä¸‹ä¹‹å‰çš„<code>talker</code>ç¨‹åºï¼Œæ·»åŠ ä¸€ä¸ªè®¾ç½®<code>SO_BROADCAST</code>å¥—æ¥å­—é€‰é¡¹çš„éƒ¨åˆ†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
** broadcaster.c -- a datagram &quot;client&quot; like talker.c, except
**                  this one can broadcast
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SERVERPORT</span> <span class="token expression"><span class="token number">4950</span>	</span><span class="token comment">// the port users will be connecting to</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> their_addr<span class="token punctuation">;</span> <span class="token comment">// connector&#39;s address information</span>
	<span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token operator">*</span>he<span class="token punctuation">;</span>
	<span class="token keyword">int</span> numbytes<span class="token punctuation">;</span>
	<span class="token keyword">int</span> broadcast <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">//char broadcast = &#39;1&#39;; // if that doesn&#39;t work, try this</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;usage: broadcaster hostname message\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>he<span class="token operator">=</span><span class="token function">gethostbyname</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// get the host info</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;gethostbyname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// this call is what allows broadcast packets to be sent:</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_BROADCAST<span class="token punctuation">,</span> <span class="token operator">&amp;</span>broadcast<span class="token punctuation">,</span>
		<span class="token keyword">sizeof</span> broadcast<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;setsockopt (SO_BROADCAST)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	their_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>	 <span class="token comment">// host byte order</span>
	their_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>SERVERPORT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// short, network byte order</span>
	their_addr<span class="token punctuation">.</span>sin_addr <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token operator">*</span><span class="token punctuation">)</span>he<span class="token operator">-&gt;</span>h_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>their_addr<span class="token punctuation">.</span>sin_zero<span class="token punctuation">,</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> their_addr<span class="token punctuation">.</span>sin_zero<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numbytes<span class="token operator">=</span><span class="token function">sendto</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
			 <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>their_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> their_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;sendto&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sent %d bytes to %s\n&quot;</span><span class="token punctuation">,</span> numbytes<span class="token punctuation">,</span>
		<span class="token function">inet_ntoa</span><span class="token punctuation">(</span>their_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªå’Œä¸€èˆ¬çš„UDP Client/Serveræœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ</p><p>é™¤äº†Clientå¯ä»¥å‘é€å¹¿æ’­åŒ…ï¼Œæ²¡æœ‰ä¸åŒï¼</p><p>æ‰€ä»¥ä½ èµ¶ç´§æ‰“å¼€ä¸€ä¸ªå‘½ä»¤çª—å£ï¼Œè¿è¡Œä¸€ä¸‹ä¹‹å‰çš„UDP listenerç¨‹åºï¼Œå¦ä¸€ä¸ªçª—å£ä¸­è¿è¡Œ <code>broadcaster</code> ç¨‹åºï¼Œä¹‹å‰å¤±è´¥çš„æ“ä½œç°åœ¨å°±å¯ä»¥é¡ºåˆ©æ‰§è¡Œäº†ã€‚</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ broadcaster <span class="token number">192.168</span>.1.2 foo
sent <span class="token number">3</span> bytes to <span class="token number">192.168</span>.1.2
$ broadcaster <span class="token number">192.168</span>.1.255 foo
sent <span class="token number">3</span> bytes to <span class="token number">192.168</span>.1.255
$ broadcaster <span class="token number">255.255</span>.255.255 foo
sent <span class="token number">3</span> bytes to <span class="token number">255.255</span>.255.255
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-å¸¸è§é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#_9-å¸¸è§é—®é¢˜" aria-hidden="true">#</a> 9. å¸¸è§é—®é¢˜</h2><p><strong>1. æˆ‘ä»å“ªè·å–è¿™äº›å¤´æ–‡ä»¶èµ„æ–™ï¼Ÿ</strong></p><p>å¦‚æœä½ çš„ç³»ç»Ÿä¸­æ²¡æœ‰è‡ªå¸¦è¿™äº›æ–‡ä»¶ï¼Œæˆ–è®¸ä½ æ ¹æœ¬å°±ä¸éœ€è¦ä»–ä»¬ã€‚ä½ å¾—çœ‹ä¸€ä¸‹ä½ å¹³å°çš„ä½¿ç”¨æ‰‹å†Œã€‚</p><p>å¯¹äº†ï¼Œå¦‚æœä½ æ˜¯ä¸ºWindowså¼€å‘ç¨‹åºï¼Œä½ åªéœ€è¦<code>\#include &lt;winsock.h&gt;</code>ã€‚</p><p><strong>2. bind()æŠ¥â€œAddress already in useâ€å¼‚å¸¸æ€ä¹ˆåŠï¼Ÿ</strong></p><p>ä½ å¿…é¡»å¯¹æ­£åœ¨ç›‘å¬çš„socketä½¿ç”¨<code>setsockopt()</code>å‡½æ•°ï¼Œå¹¶è®¾ç½® <code>SO_REUSEADDR</code> é€‰é¡¹ã€‚çœ‹ä¸€ä¸‹<code>bind()</code>ç« èŠ‚å’Œ<code>select()</code>ç« èŠ‚ä¸­çš„ä¾‹å­ï¼Œä½ å°±æ˜ç™½äº†ã€‚</p><p><strong>3. æˆ‘è¯¥å¦‚ä½•è·å–åˆ°ç³»ç»Ÿä¸­å·²ç»æ‰“å¼€çš„socketåˆ—è¡¨ï¼Ÿ</strong></p><p>ä½¿ç”¨<code>netstat</code>å‘½ä»¤ã€‚ä½¿ç”¨ç»†èŠ‚ä½ éœ€è¦å‚è€ƒmanæ‰‹å†Œï¼Œä¸è¿‡ä½ åªè¦è¾“å…¥ä¸‹åˆ—æŒ‡ä»¤å°±èƒ½è·å–åˆ°ä¸€äº›ä¸é”™çš„ä¿¡æ¯ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">netstat</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>4. æˆ‘è¯¥å¦‚ä½•æŸ¥çœ‹è·¯ç”±è¡¨ï¼ˆrouting tableï¼‰ï¼Ÿ</strong></p><p>æ‰§è¡Œ<code>route</code>å‘½ä»¤ï¼ˆå¤šæ•°çš„Linuxç³»ç»Ÿæ˜¯åœ¨<code>/sbin</code>ä¸‹ï¼‰ï¼Œæˆ–è€…<code>netstat -r</code>æŒ‡ä»¤ã€‚</p><p><strong>5. å¦‚æœæˆ‘åªæœ‰ä¸€å°ç”µè„‘ï¼Œæˆ‘è¯¥æ€ä¹ˆè¿è¡ŒClient/Serverç¨‹åºï¼Ÿæˆ‘éœ€è¦è¿æ¥å¤–ç½‘å—ï¼Ÿ</strong></p><p>å¹¸è¿çš„äº‹ï¼Œæ‰€æœ‰ç³»ç»Ÿéƒ½æœ‰ä¸€ä¸ªå›ç¯ï¼ˆloopbackï¼‰è™šæ‹Ÿç½‘ç»œâ€œè®¾å¤‡â€ï¼Œè¿™ä¸ªè®¾å¤‡ä½äºå†…æ ¸ä¸­ï¼Œå¹¶å‡è£…è‡ªå·±æ˜¯ä¸ªç½‘å¡ï¼ˆè¿™å®¶ä¼™å°±æ˜¯<code>ifconfig</code>ä¸­åˆ—å‡ºçš„â€œ<code>lo</code>â€ï¼‰ã€‚</p><p><img src="http://qiniu.chanmufeng.com/2022-10-24-100623.png" alt="image-20221024180623943" loading="lazy"></p><p>å‡è®¾ä½ ç™»é™†ä¸€å°åä¸ºâ€œgoatâ€çš„è®¾å¤‡ï¼Œå¹¶åœ¨ä¸€ä¸ªçª—å£ä¸­è¿è¡Œäº†Clientç¨‹åºï¼Œåœ¨å¦ä¸€ä¸ªçª—å£ä¸­è¿è¡Œäº†Serverç«¯ç¨‹åºã€‚æˆ–è€…ä½ ä¹Ÿå¯ä»¥åœ¨åå°è¿è¡ŒServerç¨‹åºï¼ˆç”¨<code>server &amp;</code>ï¼‰ï¼Œåœ¨å¦ä¸€ä¸ªçª—å£ä¸­è¿è¡ŒClientç¨‹åºã€‚</p><p><code>loopbackè®¾å¤‡</code>çš„ç”¨å¤„å°±æ˜¯ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>client goat</code> æˆ–è€… <code>client localhost</code> ï¼ˆå› ä¸ºâ€œ<code>localhost</code>â€å·²ç»åœ¨ä½ çš„<code>/etc/hosts</code>ä¸­å®šä¹‰å¥½äº†ï¼‰ï¼Œè¿™æ ·ä½ å°±å¯ä»¥è®©clientåœ¨æ²¡æœ‰ç½‘ç»œçš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥ä¸serveré€šä¿¡ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼Œä¸éœ€è¦æ”¹å˜ä»»ä½•ä»£ç ï¼Œå°±å¯ä»¥è®©ä½ çš„ç¨‹åºåœ¨æ²¡æœ‰ç½‘ç»œçš„å•æœºä¸Šè¿è¡Œï¼</p><p><strong>6. å¦‚æœè¿œç¨‹æ–­å¼€äº†è¿æ¥ï¼Œæˆ‘è¯¥æ€ä¹ˆçŸ¥é“å‘¢ï¼Ÿ</strong></p><p>ä½ å¯ä»¥åˆ†è¾¨ï¼Œå› ä¸º<code>recv()</code>ä¼šè¿”å›<code>0</code>ã€‚</p><p><strong>7. æˆ‘è‡ªå·±æ€ä¹ˆå®ç°â€œpingâ€è¿™ä¸ªå°å·¥å…·ï¼Ÿå•¥æ˜¯ICMPï¼Ÿæˆ‘ä»å“ªå„¿èƒ½å­¦åˆ°æ›´å¤šå…³äºraw scoketå’ŒSOCK_RAWçš„çŸ¥è¯†ï¼Ÿ</strong></p><p>ä½ å¯¹<code>raw socket</code>çš„å…¨éƒ¨ç–‘é—®éƒ½å¯ä»¥åœ¨ <a href="https://beej.us/guide/bgnet/html/#books" target="_blank" rel="noopener noreferrer">W. Richard Stevensâ€™ UNIX Network Programming books<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>è¿™æœ¬ä¹¦ä¸­æ‰¾åˆ°ç­”æ¡ˆã€‚åœ¨Stevensâ€™ UNIX Network Programmingæºä»£ç çš„<code>ping</code>å­ç›®å½•ä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ°<a href="http://www.unpbook.com/src.html" target="_blank" rel="noopener noreferrer">pingçš„æºç <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚</p><p><strong>8. æˆ‘è¯¥å¦‚ä½•æ”¹å˜æˆ–ç¼©çŸ­è°ƒç”¨connect()çš„è¿‡æœŸæ—¶é—´ï¼Ÿ</strong></p><p>è¿™ä¸ªé—®é¢˜ W. Richard Stevens å·²ç»å›ç­”äº†ï¼Œæˆ‘ä»¬å°±ä¸ç‹—å°¾ç»­è²‚äº†ã€‚ä½ å¯ä»¥å‚è€ƒUNIX Network Programmingæºä»£ç ä¸­çš„ <a href="http://www.unpbook.com/src.html" target="_blank" rel="noopener noreferrer"><code>lib/connect_nonb.c</code> <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚</p><p>å…¶è¦ç‚¹æ˜¯ï¼Œä½¿ç”¨<code>socket()</code>åˆ›å»ºä¸€ä¸ªsocket descriptorï¼Œå°†å…¶è®¾ç½®ä¸º<code>non-blocking</code>ï¼Œè°ƒç”¨<code>connect()</code>ï¼Œå¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œ<code>connect()</code>å°†ç«‹å³è¿”å›<code>-1</code>ï¼Œ<code>errno</code>å°†è®¾ç½®ä¸º<code>EINPROGRESS</code>ã€‚ç„¶åï¼Œä½ å¯ä»¥è°ƒç”¨<code>select()</code>ï¼Œå¹¶åœ¨<code>read</code>å’Œ<code>write</code>é›†åˆä¸­ä¼ é€’socket descriptorã€‚å¦‚æœæ²¡æœ‰è¶…æ—¶ï¼Œåˆ™è¡¨ç¤º<code>connect()</code>è°ƒç”¨å·²å®Œæˆã€‚æ­¤æ—¶ï¼Œä½ å¿…é¡»ä½¿ç”¨<code>getsockopt()</code>è®¾ç½®<code>SO_ERROR</code>é€‰é¡¹ï¼Œä»¥è·å–<code>connect()</code>è°ƒç”¨çš„è¿”å›å€¼ï¼Œå¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œè¯¥å€¼åº”è¯¥ä¸º<code>0</code>ã€‚</p><p>æœ€åï¼Œåœ¨ä½ å¼€å§‹é€šè¿‡socketä¼ è¾“æ•°æ®ä¹‹å‰ï¼Œä½ å¯èƒ½å§œå†å°†å…¶è®¾ç½®ä¸º<code>blocking</code>ã€‚</p><p>è¿™æ ·åšæœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯è®©ä½ çš„ç¨‹åºåœ¨<code>connecting</code>(è¿æ¥æœŸé—´)ä¹Ÿå¯ä»¥åšåˆ«çš„äº‹æƒ…ã€‚æ¯”å¦‚ï¼šä½ å¯ä»¥å°†<code>timeout</code>è®¾ç½®ä¸º500msï¼Œå¹¶åœ¨æ¯æ¬¡<code>timeout</code>æ—¶æ›´æ–°å±å¹•ä¸Šçš„æç¤ºä¿¡æ¯ï¼Œç„¶åå†æ¬¡è°ƒç”¨<code>select()</code>ã€‚å½“ä½ è°ƒç”¨<code>select()</code>å¹¶è¶…æ—¶ï¼ˆä¾‹å¦‚ï¼Œè¾¾åˆ°20æ¬¡ï¼‰æ—¶ï¼Œä½ å°±çŸ¥é“æ˜¯æ—¶å€™æ”¾å¼ƒè¿™ä¸ªè¿æ¥äº†ã€‚</p><p>å¼ºçƒˆå»ºè®®ä½ çœ‹çœ‹Stevensçš„æºç ï¼Œæ‰¾ä¸ªå¥½ä¾‹å­ç ”ç©¶ä¸€ä¸‹ã€‚</p><p><strong>9. æˆ‘è¯¥æ€ä¹ˆå†™Windowsç½‘ç»œç¨‹åºï¼Ÿ</strong></p><p>é¦–å…ˆï¼Œå¸è½½Windowsï¼Œç„¶åè£…ä¸€ä¸ªLinuxæˆ–è€…BSDã€‚ã€‚ã€‚ã€‚å“ˆå“ˆå“ˆå“ˆï¼Œå¼€ä¸ªç©ç¬‘ã€‚</p><p>ç»™ä½ ä¸ªé“¾æ¥ï¼Œä½ çœ‹ä¸€ä¸‹<a href="https://beej.us/guide/bgnet/html/#windows" target="_blank" rel="noopener noreferrer">section on building for Windows<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ã€‚</p><p><strong>10. æˆ‘è¯¥å¦‚ä½•åœ¨Solaris/SunOSä¸Šç¼–è¯‘ç¨‹åºï¼Ÿæˆ‘è¿›è¡Œç¼–è¯‘çš„æ—¶å€™æ€»æŠ¥linker error</strong></p><p>é“¾æ¥å™¨é”™è¯¯å‘ç”Ÿæ˜¯å› ä¸º Sun ç³»ç»Ÿä¸ä¼šåœ¨å¥—æ¥å­—åº“ä¸­è‡ªåŠ¨ç¼–è¯‘ã€‚å‚è€ƒä¸€ä¸‹<a href="https://beej.us/guide/bgnet/html/#solaris" target="_blank" rel="noopener noreferrer">è¿™ç¯‡æ–‡ç« <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œå…¶ä¸­äºå¦‚ä½•å¤„ç†è¿™ä¸ªé—®é¢˜çš„èŒƒä¾‹ã€‚</p><h2 id="_10-manæ‰‹å†Œ" tabindex="-1"><a class="header-anchor" href="#_10-manæ‰‹å†Œ" aria-hidden="true">#</a> 10. manæ‰‹å†Œ</h2><h3 id="_10-1-accept" tabindex="-1"><a class="header-anchor" href="#_10-1-accept" aria-hidden="true">#</a> 10.1. accept()</h3><p>æ¥å—ä¾¦å¬å¥—æ¥å­—ä¸Šä¼ å…¥çš„è¿æ¥ã€‚</p><h4 id="_10-1-1-å‡½æ•°åŸå‹" tabindex="-1"><a class="header-anchor" href="#_10-1-1-å‡½æ•°åŸå‹" aria-hidden="true">#</a> 10.1.1. å‡½æ•°åŸå‹</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-1-2-è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#_10-1-2-è¯´æ˜" aria-hidden="true">#</a> 10.1.2. è¯´æ˜</h4><p>ä¸€æ—¦ä½ æ‹¿åˆ°äº† SOCK_STREAM ç±»å‹çš„socketï¼Œ å¹¶å°† socket è®¾å®šå¥½å¯ä»¥ç”¨ä¾†ç›‘å¬ï¼ˆ listen()ï¼‰ è¿›å…¥çš„è¿æ¥ï¼Œç„¶åä½ å°±èƒ½è°ƒç”¨ accept() è·å¾—ä¸€ä¸ªæ–°çš„ socket descriptorï¼Œä¾¿äºä¸åç»­æ–°è¿æ¥ client çš„é€šä¿¡ã€‚</p><p>åŸæœ¬è¢«ç›‘å¬çš„socketä»ç„¶ä¼šè¢«ä¿ç•™ï¼Œå½“æœ‰æ–°çš„è¿æ¥è¿›æ¥æ—¶ï¼Œé€šè¿‡è°ƒç”¨accept()è·å–è¿™ä¸ªæ–°è¿æ¥ã€‚ä¸»è¦çš„å‚æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>sï¼šlisten()ä¸­çš„socket descriptorã€‚</li><li>addrï¼šè¿™é‡Œå†™å…¥è¿æ¥åˆ°ä½ è¿™é‡Œçš„clientçš„åœ°å€ã€‚</li><li>addrlenï¼šè¿™é‡Œä¼šå¡«å…¥addrå‚æ•°ä¸­ä¼ å›çš„æ•°æ®çš„å¤§å°ã€‚å‡è®¾ä½ å¾—åˆ°äº†ä¸€ä¸ªstructsockaddr_inï¼Œä½ å¯ä»¥å®‰å…¨åœ°å¿½ç•¥å®ƒï¼Œå› ä¸ºè¿™æ˜¯ä½ ä¸ºaddrä¼ å…¥çš„ç±»å‹ã€‚</li></ul><p>accept() é€šå¸¸ä¼šé˜»å¡ï¼Œè€Œä½ å¯ä»¥ä½¿ç”¨ select() äº‹å…ˆå–å¾— listen ä¸­çš„ socket descriptor çŠ¶æ€ï¼Œæ£€æŸ¥ socket æ˜¯å¦å·²ç»å¯è¯»ï¼ˆready to readï¼‰ã€‚è‹¥å·²ç»å¯è¯»ï¼Œåˆ™è¡¨ç¤ºæœ‰æ–°çš„è¿æ¥æ­£åœ¨ç­‰å¾…è¢« accept()ï¼å¦ä¸€ä¸ªæ–¹å¼æ˜¯å°† listen ä¸­çš„ socket ä½¿ç”¨ fcntl() è®¾ç½® O_NONBLOCK é€‰é¡¹ï¼Œç„¶å listen ä¸­çš„ socket descriptor å°±ä¸ä¼šé€ æˆ blockï¼Œè€Œæ˜¯è¿”å› -1ï¼Œå¹¶å°† errno è®¾ç½®ä¸º EWOULDBLOCKã€‚</p><p>å¦‚æœaccept()è¿”å›æˆåŠŸï¼Œå…¶è¿”å›å€¼æ˜¯ç”±å†…æ ¸ç”Ÿæˆçš„ä¸€ä¸ªå…¨æ–°çš„æè¿°ç¬¦ï¼Œä»£è¡¨ä¸æ‰€è¿”å›å®¢æˆ·ç«¯çš„TCPè¿æ¥ã€‚accept()çš„ç¬¬ä¸€ä¸ªå‚æ•°æˆä¸ºç›‘å¬å¥—æ¥å­—ï¼Œç§°è¿”å›å€¼ä¸ºå·²è¿æ¥å¥—æ¥å­—ã€‚åŒºåˆ†ä¸¤ä¸ªå¥—æ¥å­—å¾ˆé‡è¦ï¼Œä¸€ä¸ªæœåŠ¡å™¨é€šå¸¸åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…åˆ›å»ºä¸€ä¸ªç›‘å¬å¥—æ¥å­—ã€‚ç”± accept() è¿”å›çš„ socket descriptor æ˜¯å¦‚å‡åŒ…æ¢çš„ socket descriptorï¼Œå¼€å¯å¹¶å’Œè¿œç¨‹ä¸»æœºå»ºç«‹è¿æ¥ï¼Œå¦‚æœä½ è¦æ–­å¼€å’Œ client çš„è¿æ¥ï¼Œå¿…é¡»ä½¿ç”¨ close()ã€‚</p><h4 id="_10-1-3-è¿”å›å€¼" tabindex="-1"><a class="header-anchor" href="#_10-1-3-è¿”å›å€¼" aria-hidden="true">#</a> 10.1.3. è¿”å›å€¼</h4><p>accept() è¿”å›æ–°è¿æ¥çš„ socket descriptorï¼Œå‘ç”Ÿå¼‚å¸¸æ—¶è¿”å› -1ï¼Œå¹¶å°† errno è®¾ç½®ä¸ºåˆé€‚çš„å€¼ã€‚</p><h4 id="_10-1-4-ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#_10-1-4-ä¾‹å­" aria-hidden="true">#</a> 10.1.4. ä¾‹å­</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> their_addr<span class="token punctuation">;</span>
<span class="token class-name">socklen_t</span> addr_size<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> new_fd<span class="token punctuation">;</span>

<span class="token comment">// first, load up address structs with getaddrinfo():</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>  <span class="token comment">// use IPv4 or IPv6, whichever</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span>     <span class="token comment">// fill in my IP for me</span>

<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> MYPORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make a socket, bind it, and listen on it:</span>

sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> BACKLOG<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// now accept an incoming connection:</span>

addr_size <span class="token operator">=</span> <span class="token keyword">sizeof</span> their_addr<span class="token punctuation">;</span>
new_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>their_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ready to communicate on socket descriptor new_fd!</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-1-5-å‚é˜…" tabindex="-1"><a class="header-anchor" href="#_10-1-5-å‚é˜…" aria-hidden="true">#</a> 10.1.5. å‚é˜…</h4><p><a href="https://beej.us/guide/bgnet/html/#socketman" target="_blank" rel="noopener noreferrer"><code>socket()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#getaddrinfoman" target="_blank" rel="noopener noreferrer"><code>getaddrinfo()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#listenman" target="_blank" rel="noopener noreferrer"><code>listen()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#sockaddr_inman" target="_blank" rel="noopener noreferrer"><code>struct sockaddr_in</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_10-2-bind" tabindex="-1"><a class="header-anchor" href="#_10-2-bind" aria-hidden="true">#</a> 10.2. bind()</h3><p>å°†socketä¸IPåœ°å€å’Œç«¯å£å·å…³è”ã€‚</p><h4 id="_10-2-1-å‡½æ•°åŸå‹" tabindex="-1"><a class="header-anchor" href="#_10-2-1-å‡½æ•°åŸå‹" aria-hidden="true">#</a> 10.2.1. å‡½æ•°åŸå‹</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>my_addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-2-2-è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#_10-2-2-è¯´æ˜" aria-hidden="true">#</a> 10.2.2. è¯´æ˜</h4><p>å½“è¿œç¨‹è®¡ç®—æœºæƒ³è¦è¿æ¥åˆ°ä½ çš„æœåŠ¡å™¨ç¨‹åºæ—¶ï¼Œå®ƒéœ€è¦ä¸¤æ¡ä¿¡æ¯ï¼š<strong>IPåœ°å€</strong>å’Œ<strong>ç«¯å£å·</strong>ã€‚<code>bind()</code>è°ƒç”¨å°±æ˜¯å¸®ä½ åšè¿™ä»¶äº‹æƒ…ã€‚</p><p>ç«¯å£å·æ˜¯å†…æ ¸ç”¨æ¥ç¡®è®¤å°†æ”¶åˆ°çš„æ•°æ®åŒ…äº¤ç»™å“ªä¸ªå…·ä½“è¿›ç¨‹çš„<code>socket descriptor</code>çš„ä¾æ®ã€‚</p><blockquote><p>é€šå¸¸åœ¨å†™æœåŠ¡ç«¯ç¨‹åºçš„æ—¶å€™æˆ‘ä»¬æ‰éœ€è¦è¿›è¡Œå…³è”ï¼Œå®¢æˆ·ç«¯ç¨‹åºä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ç»‘å®šç«¯å£ï¼Œç›´æ¥<code>connect()</code>å°±å¥½äº†ã€‚</p></blockquote><p>é¦–å…ˆï¼Œè°ƒç”¨<code>getaddrinfo()</code>åŠ è½½ä¸€ä¸ªåŒ…å«ç›®æ ‡åœ°å€å’Œç«¯å£ä¿¡æ¯çš„ç»“æ„<code>sockaddr</code>ï¼Œç„¶åè°ƒç”¨<code>socket()</code>å¾—åˆ°<code>socket descriptor</code>ï¼Œç„¶åå°†<code>socket</code>å’Œåœ°å€ä¼ é€’åˆ°<code>bind()</code>ä¸­ï¼ŒIPåœ°å€å’Œç«¯å£å°±ä¼šç¥å¥‡åœ°è¢«ç»‘å®šåˆ°socketä¸Šï¼</p><p>å¦‚æœä½ ä¸çŸ¥é“ä½ çš„IPåœ°å€ï¼Œæˆ–è€…ä½ çŸ¥é“ä½ çš„æœºå™¨ä¸Šåªæœ‰ä¸€ä¸ªIPåœ°å€ï¼Œæˆ–è€…ä½ ä¸åœ¨ä¹ä½¿ç”¨æœºå™¨çš„å“ªä¸€ä¸ªIPåœ°å€çš„è¯ï¼Œä½ å¯ä»¥ç®€å•åœ°å°†æç¤ºå‚æ•°ä¸­çš„<code>AI_PASSIVE</code>æ ‡è¯†ä¼ é€’ç»™<code>getaddrinfo()</code>ã€‚è¿™å…¶å®æ˜¯ç”¨ä¸€ä¸ªç‰¹æ®Šå€¼å¡«å……<code>struct sockaddr</code>çš„IPåœ°å€éƒ¨åˆ†ï¼Œè¯¥å€¼å‘Šè¯‰<code>bind()</code>å®ƒåº”è¯¥è‡ªåŠ¨å¡«å……è¯¥ä¸»æœºçš„IPåœ°å€ã€‚</p><p>ä»€ä¹ˆä»€ä¹ˆï¼Ÿä½ æƒ³çŸ¥é“åœ¨<code>struct sockaddr</code>çš„IPåœ°å€ä¸­åŠ è½½äº†ä»€ä¹ˆç‰¹æ®Šå€¼ï¼Œä½¿å…¶è‡ªåŠ¨ç”¨å½“å‰ä¸»æœºçš„IPå¡«å……åœ°å€ï¼Ÿæˆ‘ä¼šå‘Šè¯‰ä½ ï¼Œä½†è¯·è®°ä½ï¼Œè¿™åªæœ‰åœ¨ä½ æ‰‹åŠ¨å¡«å†™<code>struct sockaddr</code>çš„æ—¶å€™æ‰ä¼šè¿™æ ·ï¼›å¦åˆ™ä¹–ä¹–ç…§æˆ‘ä¸Šè¾¹è¯´çš„ï¼Œä½¿ç”¨<code>getaddrinfo()</code>çš„è¿”å›ç»“æœã€‚</p><p>åœ¨IPv4ä¸­ï¼Œ<code>struct sockaddr_in</code> ç»“æ„çš„ <code>sin_addr.s_addr</code> å­—æ®µè¢«è®¾ç½®æˆäº†<code>INADDR_ANY</code>ã€‚åœ¨IPv6ä¸­ï¼Œ<code>struct sockaddr_in6</code>ç»“æ„çš„<code>sin6_addr</code>å­—æ®µè¢«èµ‹å€¼æˆå…¨å±€å˜é‡<code>in6addr_any</code>ã€‚æˆ–è€…ï¼Œå¦‚æœä½ å£°æ˜äº†ä¸€ä¸ªæ–°çš„ <code>struct in6_addr</code>ï¼Œä½ å¯ä»¥å°†å…¶åˆå§‹åŒ–ä¸º<code>IN6ADDR_ANY_INIT</code>ã€‚</p><p>æœ€åï¼Œ<code>addrlen</code>å‚æ•°åº”è¯¥è®¾ç½®ä¸º <code>sizeof my_addr</code>ã€‚</p><h4 id="_10-2-3-è¿”å›å€¼" tabindex="-1"><a class="header-anchor" href="#_10-2-3-è¿”å›å€¼" aria-hidden="true">#</a> 10.2.3. è¿”å›å€¼</h4><p>æˆåŠŸè¿”å›<code>0</code>ï¼Œå‘ç”Ÿå¼‚å¸¸æ—¶è¿”å›<code> -1</code>ï¼Œå¹¶å°† <code>errno</code> è®¾ç½®ä¸ºåˆé€‚çš„å€¼ã€‚</p><h4 id="_10-2-4-ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#_10-2-4-ä¾‹å­" aria-hidden="true">#</a> 10.2.4. ä¾‹å­</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// modern way of doing things with getaddrinfo()</span>

<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>

<span class="token comment">// first, load up address structs with getaddrinfo():</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>  <span class="token comment">// use IPv4 or IPv6, whichever</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span>     <span class="token comment">// fill in my IP for me</span>

<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;3490&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make a socket:</span>
<span class="token comment">// (you should actually walk the &quot;res&quot; linked list and error-check!)</span>

sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// bind it to the port we passed in to getaddrinfo():</span>

<span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// example of packing a struct by hand, IPv4</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> myaddr<span class="token punctuation">;</span>
<span class="token keyword">int</span> s<span class="token punctuation">;</span>

myaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
myaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">3490</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// you can specify an IP address:</span>
<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">&quot;63.161.169.137&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>myaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// or you can let it automatically select one:</span>
myaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>

s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bind</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>myaddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> myaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-2-5-å‚é˜…" tabindex="-1"><a class="header-anchor" href="#_10-2-5-å‚é˜…" aria-hidden="true">#</a> 10.2.5. å‚é˜…</h4><p><a href="https://beej.us/guide/bgnet/html/#getaddrinfoman" target="_blank" rel="noopener noreferrer"><code>getaddrinfo()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#socketman" target="_blank" rel="noopener noreferrer"><code>socket()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#sockaddr_inman" target="_blank" rel="noopener noreferrer"><code>struct sockaddr_in</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#sockaddr_inman" target="_blank" rel="noopener noreferrer"><code>struct in_addr</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_10-3-connect" tabindex="-1"><a class="header-anchor" href="#_10-3-connect" aria-hidden="true">#</a> 10.3. connect()</h3><p>å°†ä½ æœ¬åœ°çš„socketè¿æ¥åˆ°æœåŠ¡å™¨ã€‚</p><h4 id="_10-3-1-å‡½æ•°åŸå‹" tabindex="-1"><a class="header-anchor" href="#_10-3-1-å‡½æ•°åŸå‹" aria-hidden="true">#</a> 10.3.1. å‡½æ•°åŸå‹</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>serv_addr<span class="token punctuation">,</span>
            <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-3-2-è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#_10-3-2-è¯´æ˜" aria-hidden="true">#</a> 10.3.2. è¯´æ˜</h4><p>å½“ä½ è°ƒç”¨<code>socket()</code>å¾—åˆ°ä¸€ä¸ªsocket descriptorä¹‹åï¼Œä½ å¯ä»¥ä½¿ç”¨<code>connect()</code>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨è¿æ¥è¿™ä¸ªsocketåˆ°è¿œç¨‹æœåŠ¡å™¨ã€‚ä½ éœ€è¦åšçš„å°±æ˜¯æŠŠsocket descriptorå’ŒæœåŠ¡ç«¯åœ°å€ä¼ é€’ç»™<code>connect()</code>ã€‚å¯¹äº†ï¼Œè¿˜æœ‰åœ°å€çš„é•¿åº¦ï¼Œä¹Ÿå¾—é€šè¿‡å‚æ•°çš„å½¢å¼ä¼ é€’ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥é€šè¿‡è°ƒç”¨<code>getaddrinfo()</code>æ¥è·å–è¿™äº›ä¿¡æ¯ï¼Œä½†æ˜¯å¦‚æœä½ éè¦æ‰‹åŠ¨è£…å¡«<code>struct sockaddr</code>ä¹Ÿä¸æ˜¯ä¸è¡Œã€‚</p><p>å¦‚æœä½ æ²¡æœ‰å¯¹socket descriptorè°ƒç”¨<code>bind() </code>æ–¹æ³•ï¼Œå®ƒä¼šå’Œä½ çš„IPåœ°å€ä»¥åŠéšæœºç«¯å£å·è¿›è¡Œç»‘å®šã€‚</p><p>å¦‚æœä½ ä¸æ˜¯Serverç«¯ç¨‹åºï¼Œè¿™ç§è‡ªåŠ¨æœºåˆ¶æ˜¯æŒºå¥½çš„ï¼Œå› ä¸ºä½ æ ¹æœ¬å°±ä¸åœ¨ä¹ä½ ç”¨çš„æ˜¯å•¥ç«¯å£å·ï¼Œä½ åªéœ€è¦åœ¨ä¹è¿œç¨‹ç«¯å£å·æ˜¯ä»€ä¹ˆï¼Œå¹¶æŠŠå®ƒæ”¾åœ¨<code>serv_addr</code>å‚æ•°ä¸­å°±è¡Œäº†ã€‚å¦‚æœä½ å®åœ¨æƒ³ç»‘å®šåˆ°æŸä¸ªç‰¹å®šIPåœ°å€å’Œç‰¹å®šç«¯å£å·ä¸Šï¼Œä½ ä¹Ÿå¯ä»¥ç”¨<code>bind()</code>å‡½æ•°è¿›è¡Œè®¾ç½®ï¼Œä½†å±å®æ²¡æœ‰å¿…è¦ã€‚</p><p>ä¸€æ—¦<code>connect()</code>å®Œæˆï¼Œä½ å°±å¯ä»¥éšå¿ƒæ‰€ä»¥åœ°ä½¿ç”¨ <code>send()</code> å’Œ <code>recv()</code>å¤„ç†æ•°æ®äº†ã€‚</p><p>è®°ä½ï¼šå¦‚æœä½ <code>connect()</code>çš„æ˜¯è¿œç¨‹çš„ <code>SOCK_DGRAM</code> UDP socketï¼Œåªè¦ä½ æƒ³ï¼Œ <code>send()</code> ã€ <code>recv()</code>å’Œ <code>sendto()</code> ã€ <code>recvfrom()</code>ä½ éƒ½å¯ä»¥ç”¨ã€‚</p><h4 id="_10-3-3-è¿”å›å€¼" tabindex="-1"><a class="header-anchor" href="#_10-3-3-è¿”å›å€¼" aria-hidden="true">#</a> 10.3.3. è¿”å›å€¼</h4><p>æˆåŠŸè¿”å›<code>0</code>ï¼Œå‘ç”Ÿå¼‚å¸¸æ—¶è¿”å›<code> -1</code>ï¼Œå¹¶å°† <code>errno</code> è®¾ç½®ä¸ºåˆé€‚çš„å€¼ã€‚</p><h4 id="_10-3-4-ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#_10-3-4-ä¾‹å­" aria-hidden="true">#</a> 10.3.4. ä¾‹å­</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// connect to www.example.com port 80 (http)</span>

<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>

<span class="token comment">// first, load up address structs with getaddrinfo():</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>  <span class="token comment">// use IPv4 or IPv6, whichever</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>

<span class="token comment">// we could put &quot;80&quot; instead on &quot;http&quot; on the next line:</span>
<span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">&quot;www.example.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make a socket:</span>

sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// connect it to the address and port we passed in to getaddrinfo():</span>

<span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-3-5-å‚é˜…" tabindex="-1"><a class="header-anchor" href="#_10-3-5-å‚é˜…" aria-hidden="true">#</a> 10.3.5. å‚é˜…</h4><p><a href="https://beej.us/guide/bgnet/html/#socketman" target="_blank" rel="noopener noreferrer"><code>socket()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#bindman" target="_blank" rel="noopener noreferrer"><code>bind()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_10-4-close" tabindex="-1"><a class="header-anchor" href="#_10-4-close" aria-hidden="true">#</a> 10.4. close()</h3><p>å…³é—­socket descriptorã€‚</p><h4 id="_10-4-1-å‡½æ•°åŸå‹" tabindex="-1"><a class="header-anchor" href="#_10-4-1-å‡½æ•°åŸå‹" aria-hidden="true">#</a> 10.4.1. å‡½æ•°åŸå‹</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
    
<span class="token keyword">int</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-4-2-è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#_10-4-2-è¯´æ˜" aria-hidden="true">#</a> 10.4.2. è¯´æ˜</h4><p>å½“ä½ å®Œæˆäº†å¯¹åŒ…å«ä½ æ— æ•°å¥‡æ€å¦™æƒ³çš„socketçš„ä½¿ç”¨ï¼Œå¹¶ä¸”ä½ ä¸æƒ³å†<code>send()</code>æˆ–<code>recv()</code>ï¼Œåˆæˆ–è€…ä»»ä½•å…¶ä»–äº‹æƒ…ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>close()</code>ï¼Œsocketå°†è¢«æ°¸ä¹…é‡Šæ”¾ã€‚</p><p>è¿œç¨‹ä¸»æœºå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼åˆ¤æ–­ä½ æ˜¯å¦è¿›è¡Œäº†<code>close()</code>ã€‚</p><ol><li>å¦‚æœè¿œç¨‹ä¸»æœºè°ƒç”¨äº†<code>recv()</code>ï¼Œè¿”å›å€¼ä¼šæ˜¯0ï¼›</li><li>å¦‚æœè¿œç¨‹ä¸»æœºè°ƒç”¨äº†<code>send()</code>ï¼Œå®ƒå°†ä¼šæ”¶åˆ°ä¸€ä¸ª <code>SIGPIPE</code> ä¿¡å·ï¼Œå¹¶ä¸”<code>send()</code>çš„è¿”å›å€¼ä¸º<code>-1</code>ï¼Œ<code>errno</code>å€¼ä¹Ÿä¼šè¢«è®¾ç½®ä¸º <code>EPIPE</code>ã€‚</li></ol><blockquote><p><strong>Windowsä½¿ç”¨è€…é¡»çŸ¥ï¼š</strong></p><p>å…³é—­çš„æ–¹æ³•ä¸º<code>closesocket()</code>ï¼Œè€Œä¸æ˜¯<code>close()</code>ã€‚å¦‚æœä½ è¯•å›¾åœ¨socket descriptorä¸Šä½¿ç”¨<code>close()</code>ï¼ŒWindowså¯èƒ½ä¼šè·Ÿä½ é—¹åˆ«æ‰­ã€‚ã€‚ã€‚ä½ ä¼šå¾ˆè‹¦æ¼ã€‚</p></blockquote><h4 id="_10-4-3-è¿”å›å€¼" tabindex="-1"><a class="header-anchor" href="#_10-4-3-è¿”å›å€¼" aria-hidden="true">#</a> 10.4.3. è¿”å›å€¼</h4><p>æˆåŠŸè¿”å›<code>0</code>ï¼Œå‘ç”Ÿå¼‚å¸¸æ—¶è¿”å›<code> -1</code>ï¼Œå¹¶å°† <code>errno</code> è®¾ç½®ä¸ºåˆé€‚çš„å€¼ã€‚</p><h4 id="_10-4-4-ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#_10-4-4-ä¾‹å­" aria-hidden="true">#</a> 10.4.4. ä¾‹å­</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token comment">// a whole lotta stuff...*BRRRONNNN!*</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token function">close</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// not much to it, really.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-4-5-å‚é˜…" tabindex="-1"><a class="header-anchor" href="#_10-4-5-å‚é˜…" aria-hidden="true">#</a> 10.4.5. å‚é˜…</h4><p><a href="https://beej.us/guide/bgnet/html/#socketman" target="_blank" rel="noopener noreferrer"><code>socket()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#shutdownman" target="_blank" rel="noopener noreferrer"><code>shutdown()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_10-5-getaddrinfo-freeaddrinfo-gai-strerror" tabindex="-1"><a class="header-anchor" href="#_10-5-getaddrinfo-freeaddrinfo-gai-strerror" aria-hidden="true">#</a> 10.5. getaddrinfo(), freeaddrinfo(), gai_strerror()</h3><p>è·å–æœ‰å…³host nameï¼ˆä¸»æœºåï¼‰ä»¥åŠserviceï¼ˆæœåŠ¡ï¼‰ä¿¡æ¯ï¼Œå¹¶å°†ç»“æœä¿å­˜åœ¨<code>struct sockaddr</code>ç»“æ„ä¸­ã€‚</p><h4 id="_10-5-1-å‡½æ•°åŸå‹" tabindex="-1"><a class="header-anchor" href="#_10-5-1-å‡½æ•°åŸå‹" aria-hidden="true">#</a> 10.5.1. å‡½æ•°åŸå‹</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nodename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>servname<span class="token punctuation">,</span>
                <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>hints<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>ai<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">gai_strerror</span><span class="token punctuation">(</span><span class="token keyword">int</span> ecode<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span>     ai_flags<span class="token punctuation">;</span>          <span class="token comment">// AI_PASSIVE, AI_CANONNAME, ...</span>
  <span class="token keyword">int</span>     ai_family<span class="token punctuation">;</span>         <span class="token comment">// AF_xxx</span>
  <span class="token keyword">int</span>     ai_socktype<span class="token punctuation">;</span>       <span class="token comment">// SOCK_xxx</span>
  <span class="token keyword">int</span>     ai_protocol<span class="token punctuation">;</span>       <span class="token comment">// 0 (auto) or IPPROTO_TCP, IPPROTO_UDP </span>

  <span class="token class-name">socklen_t</span>  ai_addrlen<span class="token punctuation">;</span>     <span class="token comment">// length of ai_addr</span>
  <span class="token keyword">char</span>   <span class="token operator">*</span>ai_canonname<span class="token punctuation">;</span>      <span class="token comment">// canonical name for nodename</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span>  <span class="token operator">*</span>ai_addr<span class="token punctuation">;</span> <span class="token comment">// binary address</span>
  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span>  <span class="token operator">*</span>ai_next<span class="token punctuation">;</span> <span class="token comment">// next structure in linked list</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-5-2-è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#_10-5-2-è¯´æ˜" aria-hidden="true">#</a> 10.5.2. è¯´æ˜</h4><p><code>getaddrinfo()</code>æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å‡½æ•°ï¼Œå®ƒä¼šè¿”å›ç‰¹å®šä¸»æœºåçš„ç›¸å…³ä¿¡æ¯ï¼ˆä¾‹å¦‚å…¶IPåœ°å€ï¼‰ï¼Œå¹¶æŠŠä¿¡æ¯ä¿å­˜åœ¨ä¸€ä¸ª<code>struct sockaddr</code>ç»“æ„ä¸­ï¼Œè‡ªåŠ¨ä¸ºä½ å¤„ç†ç»†èŠ‚ï¼ˆæ¯”å¦‚åœ°å€æ˜¯IPv4è¿˜æ˜¯IPv6ï¼‰ã€‚</p><p>æœ‰äº†è¿™ä¸ªå‡½æ•°ï¼ŒåŸæœ¬çš„ <code>gethostbyname()</code> å’Œ <code>getservbyname()</code>ä¹Ÿå°±å¯å°±å¯ä»¥é€€å‡ºæ±Ÿæ¹–äº†ã€‚</p><p>æ¥ä¸‹æ¥çš„æè¿°å¯èƒ½ä¼šè®©ä½ æœ›è€Œç”Ÿç•ï¼Œä½†æ˜¯åˆ«æ‹…å¿ƒï¼Œè¿™ä¸ªå‡½æ•°ç”¨èµ·æ¥è´¼ç®€å•ã€‚ä½ å¯ä»¥å…ˆè·³è¿‡ä¸‹é¢çš„æè¿°ç›´æ¥çœ‹ä¸€ä¸‹ä¾‹å­ï¼Œå¢å¼ºä¸€ä¸‹ä½ çš„ä¿¡å¿ƒã€‚</p><p><code>nodename</code>å‚æ•°ä¸­ä¿å­˜çš„å°±æ˜¯host nameï¼ˆä¸»æœºåï¼‰ã€‚ä¸»æœºåå¯ä»¥æ˜¯åŸŸåï¼Œæ¯”å¦‚â€œ<a href="http://www.chanmufeng.com" target="_blank" rel="noopener noreferrer">www.chanmufeng.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>â€ï¼Œä¹Ÿå¯ä»¥æ˜¯IPv4æˆ–è€…IPv6åœ°å€ï¼ˆä»¥å­—ç¬¦ä¸²å½¢å¼ä¼ é€’ï¼‰ã€‚å¦‚æœä½ ç”¨äº†<code>AI_PASSIVE</code>é€‰é¡¹ï¼Œè¿™ä¸ªå‚æ•°ä½ ä¹Ÿå¯ä»¥è®¾ç½®ä¸º<code>NULL</code>ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚</p><p><code>servname</code>é€šå¸¸å°±æ˜¯ç«¯å£å·ï¼Œæ¯”å¦‚ä½ å¯ä»¥ä»¥å­—ç¬¦ä¸²æ ¼å¼ä¼ é€’â€œ<code>80</code>â€ï¼›ä¹Ÿå¯ä»¥æ˜¯æœåŠ¡åï¼Œæ¯”å¦‚â€œ<code>http</code>â€ã€â€œ<code>tftp</code>â€ã€æˆ–è€…â€œ<code>smtp</code>â€ã€â€œ<code>pop</code>â€ç­‰ã€‚ä¼—æ‰€å‘¨çŸ¥çš„æœåŠ¡åå¯ä»¥åœ¨ <a href="https://www.iana.org/assignments/port-numbers" target="_blank" rel="noopener noreferrer">IANA Port List<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><a href="https://beej.us/guide/bgnet/html/#fn48" target="_blank" rel="noopener noreferrer">48<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ä¸­æ‰¾åˆ°ï¼Œä½ æœ¬åœ°çš„<code>/etc/services</code>æ–‡ä»¶ä¸­ä¹Ÿæœ‰è¿™äº›ä¿¡æ¯ã€‚</p><p>ç„¶åå°±æ˜¯æ ¸å¿ƒå‚æ•°â€”â€”<code>hints</code>ã€‚åœ¨ä½¿ç”¨<code>addrinfo</code>ä¹‹å‰ï¼Œä½ å¿…é¡»å…ˆç”¨<code>memset()</code>å°†æ•´ä¸ªç»“æ„æ•°æ®æ¸…ç©ºã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è®²è®²<code>addrinfo</code>ä¸­çš„å­—æ®µã€‚</p><p><code>ai_flags</code>æœ‰å¾ˆå¤šä¸ªå€™é€‰é¡¹ï¼Œä½†æ˜¯é‡è¦ä¹Ÿå°±å‡ ä¸ªã€‚ï¼ˆå¦‚æœè¦åŒæ—¶ä½¿ç”¨å¤šä¸ªåé€‰é¡¹ï¼Œå¯ä»¥ä½¿ç”¨<code>ï½œ</code>è¿ç®—ç¬¦å¯¹ä»–ä»¬è¿›è¡ŒæŒ‰ä½æˆ–è¿ç®—ï¼‰ã€‚æŸ¥çœ‹manæ‰‹å†Œè·å–å®Œæ•´çš„æ ‡è¯†åˆ—è¡¨ã€‚</p><p><code>AI_CANONNAME</code> ä¼šä»¤<code>res</code>çš„ <code>ai_canonname</code> å¡«å……ä¸ºä¸»æœºçš„canonical(real) nameï¼ˆè§„èŒƒåï¼Œæˆ–è€…æˆä¸ºçœŸåï¼‰ã€‚</p><p><code>AI_PASSIVE</code> ä¼šä»¤<code>res</code>çš„IPåœ°å€è¢«è®¾ç½®ä¸º <code>INADDR_ANY</code> (IPv4) æˆ– <code>in6addr_any</code> (IPv6)ï¼›è¿™è®©ä¹‹ååœ¨è°ƒç”¨<code>bind()</code>æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨ä½¿ç”¨å½“å‰ä¸»æœºçš„IPåœ°å€æ¥å¡«å……<code>struct sockaddr</code>çš„IPåœ°å€ã€‚è¿™åœ¨ä½ å†™Serverä»£ç ä¸”ä¸æƒ³å†™æ­»IPåœ°å€æ—¶éå¸¸å¥½ç”¨ã€‚</p><p>å¦‚æœä½ ä½¿ç”¨äº† <code>AI_PASSIVE</code>æ ‡è¯†ï¼Œä½ å°±å¯ä»¥å°†<code>nodename</code>å­—æ®µè®¾ç½®ä¸º<code>NULL</code>äº†ï¼ˆå› ä¸º<code>bind()</code>åœ¨ä¹‹åä¼šè‡ªåŠ¨ç»™ä½ å¡«ä¸Šï¼‰ã€‚</p><p>æ¥ç€èŠå‚æ•°ã€‚</p><p>ä½ åº”è¯¥ä¼šæƒ³å°† <code>ai_family</code> è®¾ç½®ä¸º<code>AF_UNSPEC</code>ï¼Œè¿™æ · <code>getaddrinfo() </code>å°±èƒ½åŒæ—¶åº”ä»˜IPv4å’ŒIPv6äº†ã€‚å½“ç„¶å–½ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨ AF_INET æˆ– AF_INET6 æ¥è‡ªå·±æŒ‡å®šä½¿ç”¨IPv4è¿˜æ˜¯IPv6.</p><p>å¦å¤–ï¼Œsocktypeåº”è¯¥è¢«è®¾ç½®ä¸º <code>SOCK_STREAM</code> æˆ– <code>SOCK_DGRAM</code>ï¼Œå…·ä½“å–å†³äºä½ æƒ³ä½¿ç”¨é‚£ç§socketã€‚</p><p>æœ€åï¼Œä½ å¯ä»¥å°† <code>ai_protocol</code> è®¾ç½®ä¸º<code>0</code>ï¼Œè®©å…¶è‡ªåŠ¨é€‰æ‹©ä½ çš„protocol typeã€‚</p><p>åšäº†è¿™ä¹ˆå¤šï¼Œç»ˆäºå¯ä»¥è°ƒç”¨<code>getaddrinfo()</code>äº†ã€‚</p><p>äº‹æƒ…å˜å¾—æœ‰è¶£äº†ã€‚<code>res</code>ä¼šæŒ‡å‘<code>struct addrinfo</code>çš„ä¸€ä¸ªé“¾æ¥åˆ—è¡¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿™ä¸ªé“¾è¡¨æ¥è·å¾—å…¨éƒ¨çš„åœ°å€ä¿¡æ¯ï¼ˆç¬¦åˆä½ é€šè¿‡<code>hints</code>æŒ‡å®šçš„addressç±»å‹ï¼‰ã€‚</p><p>ä½†æ˜¯ä½ å¯èƒ½ä¼šè·å–åˆ°ä¸€äº›å› ä¸ºæŸäº›åŸå› è€Œæ— æ•ˆçš„addressï¼Œå› æ­¤Linuxçš„manæ‰‹å†Œæä¾›çš„æ–¹æ³•æ˜¯å¾ªç¯è¯»å–é“¾è¡¨ï¼Œç„¶åè¿›è¡Œè°ƒç”¨<code>socket()</code>ã€<code>connect()</code>ï¼ˆå¦‚æœServerç«¯ç¨‹åºä½¿ç”¨äº†<code>AI_PASSIVE</code>ï¼Œé‚£å°±æ˜¯<code>bind()</code>ï¼‰ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚</p><p>æœ€åï¼Œå½“ä½ å¤„ç†å®Œé“¾è¡¨ä¹‹åï¼Œä½ éœ€è¦è°ƒç”¨<code>freeaddrinfo()</code>æ¥é‡Šæ”¾å†…å­˜ï¼Œé¿å…å†…å­˜å‡ºç°æ³„æ¼ã€‚</p><h4 id="_10-5-3-è¿”å›å€¼" tabindex="-1"><a class="header-anchor" href="#_10-5-3-è¿”å›å€¼" aria-hidden="true">#</a> 10.5.3. è¿”å›å€¼</h4><p>æˆåŠŸè¿”å›<code>0</code>ï¼Œå¼‚å¸¸è¿”å›<code>é0</code>ã€‚å¦‚æœè¿”å›çš„æ˜¯<code>é0</code>ï¼Œä½ å¯ä»¥è°ƒç”¨<code>gai_strerror() </code>è·å–ä¸€ä¸ªæ–‡å­—ç‰ˆæœ¬çš„é”™è¯¯ä¿¡æ¯ã€‚</p><h4 id="_10-5-4-ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#_10-5-4-ä¾‹å­" aria-hidden="true">#</a> 10.5.4. ä¾‹å­</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// code for a client connecting to a server</span>
<span class="token comment">// namely a stream socket to www.example.com on port 80 (http)</span>
<span class="token comment">// either IPv4 or IPv6</span>

<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>  
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>servinfo<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
<span class="token keyword">int</span> rv<span class="token punctuation">;</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span> <span class="token comment">// use AF_INET6 to force IPv6</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rv <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">&quot;www.example.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// loop through all the results and connect to the first we can</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> servinfo<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span>
            p<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;connect&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// if we get here, we must have connected successfully</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// looped off the end of the list with no connection</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;failed to connect\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// all done with this structure</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// code for a server waiting for connections</span>
<span class="token comment">// namely a stream socket on port 3490, on this host&#39;s IP</span>
<span class="token comment">// either IPv4 or IPv6.</span>

<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>  
<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints<span class="token punctuation">,</span> <span class="token operator">*</span>servinfo<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
<span class="token keyword">int</span> rv<span class="token punctuation">;</span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span> <span class="token comment">// use AF_INET6 to force IPv6</span>
hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_PASSIVE<span class="token punctuation">;</span> <span class="token comment">// use my IP address</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rv <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;3490&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;getaddrinfo: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// loop through all the results and bind to the first we can</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> servinfo<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span>
            p<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;bind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// if we get here, we must have connected successfully</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// looped off the end of the list with no successful bind</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;failed to bind socket\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>servinfo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// all done with this structure</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-5-5-å‚é˜…" tabindex="-1"><a class="header-anchor" href="#_10-5-5-å‚é˜…" aria-hidden="true">#</a> 10.5.5. å‚é˜…</h4><p><a href="https://beej.us/guide/bgnet/html/#gethostbynameman" target="_blank" rel="noopener noreferrer"><code>gethostbyname()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#getnameinfoman" target="_blank" rel="noopener noreferrer"><code>getnameinfo()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_10-6-gethostname" tabindex="-1"><a class="header-anchor" href="#_10-6-gethostname" aria-hidden="true">#</a> 10.6. gethostname()</h3><p>è¿”å›ç³»ç»Ÿä¸»æœºåç§°</p><h4 id="_10-6-1-å‡½æ•°åŸå‹" tabindex="-1"><a class="header-anchor" href="#_10-6-1-å‡½æ•°åŸå‹" aria-hidden="true">#</a> 10.6.1. å‡½æ•°åŸå‹</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">gethostname</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-6-2-æè¿°" tabindex="-1"><a class="header-anchor" href="#_10-6-2-æè¿°" aria-hidden="true">#</a> 10.6.2. æè¿°</h4><p>ä½ çš„ç³»ç»Ÿæœ‰ä¸ªåå­—ï¼Œæ‰€æœ‰ç³»ç»Ÿéƒ½æœ‰ã€‚è¿™æ˜¯ä¸€ä¸ªæ¯”æˆ‘ä»¬ä¸€ç›´åœ¨è°ˆè®ºçš„å…¶ä»–ç½‘ç»œå†…å®¹ç¨å¾®æ›´Unixyçš„ä¸œè¥¿ï¼Œä½†å®ƒä»ç„¶æœ‰å®ƒçš„ç”¨é€”ã€‚</p><p>ä¾‹å¦‚ï¼Œä½ å¯ä»¥è·å–ä½ çš„ä¸»æœºåï¼Œç„¶åè°ƒç”¨gethostbyname()æ¥æŸ¥æ‰¾ä½ çš„IPåœ°å€ã€‚</p><p>name å‚æ•°åº”è¯¥æŒ‡å‘ä¸€ä¸ªä¿å­˜ä¸»æœºåç§°çš„ç¼“å†²åŒºï¼Œè€Œ len æ˜¯è¯¥ç¼“å†²åŒºçš„å¤§å°ï¼Œä»¥ byte ä¸ºå•ä½ã€‚gethostname() ä¸ä¼šè¦†ç›–ç¼“å†²åŒºçš„ç»“å°¾ï¼ˆå¯èƒ½ä¼šè¿”å›é”™è¯¯ï¼Œæˆ–è€…åªæ˜¯å•çº¯åœæ­¢å†™å…¥ï¼‰ï¼Œè€Œä¸”å¦‚æœç¼“å†²åŒºæœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œå®ƒè¿˜ä¼šä¿ç•™å­—ä¸²çš„ NUL-ç»“å°¾ã€‚</p><h4 id="_10-6-3-è¿”å›å€¼" tabindex="-1"><a class="header-anchor" href="#_10-6-3-è¿”å›å€¼" aria-hidden="true">#</a> 10.6.3. è¿”å›å€¼</h4><p>æˆåŠŸè¿”å›<code>0</code>ï¼Œå‘ç”Ÿå¼‚å¸¸æ—¶è¿”å›<code> -1</code>ï¼Œå¹¶å°† <code>errno</code> è®¾ç½®ä¸ºåˆé€‚çš„å€¼ã€‚</p><h4 id="_10-6-4-ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#_10-6-4-ä¾‹å­" aria-hidden="true">#</a> 10.6.4. ä¾‹å­</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">char</span> hostname<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token function">gethostname</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;My hostname: %s\n&quot;</span><span class="token punctuation">,</span> hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-6-5-å‚é˜…" tabindex="-1"><a class="header-anchor" href="#_10-6-5-å‚é˜…" aria-hidden="true">#</a> 10.6.5. å‚é˜…</h4><p><a href="https://beej.us/guide/bgnet/html/#gethostbynameman" target="_blank" rel="noopener noreferrer"><code>gethostbyname()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_10-7-gethostbyname-gethostbyaddr" tabindex="-1"><a class="header-anchor" href="#_10-7-gethostbyname-gethostbyaddr" aria-hidden="true">#</a> 10.7. gethostbyname(), gethostbyaddr()</h3><p>æ ¹æ®ä¸»æœºåè·å–IPåœ°å€ï¼Œæˆ–è€…ç›¸åã€‚</p><h4 id="_10-7-1-å‡½æ•°åŸå‹" tabindex="-1"><a class="header-anchor" href="#_10-7-1-å‡½æ•°åŸå‹" aria-hidden="true">#</a> 10.7.1. å‡½æ•°åŸå‹</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token operator">*</span><span class="token function">gethostbyname</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// DEPRECATED!</span>
<span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token operator">*</span><span class="token function">gethostbyaddr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-7-2-è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#_10-7-2-è¯´æ˜" aria-hidden="true">#</a> 10.7.2. è¯´æ˜</h4><blockquote><p>è¯·æ³¨æ„ï¼šè¿™ä¸¤ä¸ªå‡½æ•°å·²ç»ç”± getaddrinfo() ä¸ getnameinfo() å–è€Œä»£ä¹‹ï¼å®é™…ä¸Šï¼Œgethostbyname() æ— æ³•åœ¨ IPv6 ä¸­æ­£å¸¸è¿è¡Œã€‚</p></blockquote><p>è¿™äº›å‡½æ•°å¯ä»¥è½¬æ¢ host name ä¸ IP addresseã€‚ä¾‹å¦‚ï¼šä½ å¯ä»¥ç”¨ <code>gethostbyname()</code> å–å¾—å…¶ IP addressï¼Œå¹¶å‚¨å­˜åœ¨ <code>struct in_addr</code>ã€‚</p><p>åä¹‹ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ª <code>struct in_addr</code> æˆ– <code>struct in6_addr</code>ï¼Œä½ å¯ä»¥ç”¨ <code>gethostbyaddr()</code>å¾—åˆ° hostnameã€‚<code>gethostbyaddr() </code>ä¸ IPv6 ç›¸å®¹ï¼Œä½†æ˜¯ä½ æœ€å¥½ä½¿ç”¨æ–°çš„ <code>getnameinfo()</code> ä»£æ›¿å®ƒã€‚</p><p>ï¼ˆå¦‚æœä½ æœ‰ä¸€ä¸ªç‚¹åˆ†åè¿›åˆ¶æ ¼å¼çš„IPåœ°å€ï¼Œä½ æƒ³è¦æŸ¥è¯¢å®ƒçš„ hostnameï¼Œä½ åœ¨ä½¿ç”¨ <code>getaddrinfo()</code> æ—¶æœ€å¥½è¦æ­é…<code> AI_CANONNAME</code> æ ‡è¯†ï¼‰ã€‚</p><p><code>gethostbyname()</code> æ¥æ”¶ä¸€ä¸ªç±»ä¼¼ &quot;<a href="http://www.chanmufeng.com" target="_blank" rel="noopener noreferrer">www.chanmufeng.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>&quot; çš„å­—ä¸²ï¼Œç„¶åä¼ å›ä¸€ä¸ª <code>struct hostent</code>ï¼Œé‡Œé¢åŒ…å«äº†è¶…å¤šçš„æ•°æ®ï¼ŒåŒ…æ‹¬äº† IP addressï¼ˆå…¶å®ƒçš„ä¿¡æ¯åŒ…æ‹¬å®˜æ–¹çš„ host nameã€ä¸€è¿ä¸²çš„åˆ«åã€åœ°å€ç±»å‹ã€åœ°å€é•¿åº¦ã€ä»¥åŠåœ°å€åˆ—è¡¨ã€‚è¿™æ˜¯ä¸ªé€šç”¨çš„èµ„æ–™ç»“æ„ï¼Œåœ¨ç‰¹å®šçš„ç”¨é€”ä¸Šä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆæ–¹ä¾¿ï¼‰ã€‚</p><p>åœ¨<code>gethostbyaddr()</code>ä»£å…¥ä¸€ä¸ª <code>struct in_addr </code>æˆ– <code>struct in6_addr</code>ï¼Œç„¶åå°±ä¼šè¿”å›ç»™ä½ ä¸€ä¸ªç›¸å¯¹åº”çš„ host nameï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œå®ƒçš„ä½œç”¨å’Œ <code>gethostbyname() </code>æ­£å¥½ç›¸åã€‚è‡³äºå‚æ•°ï¼Œ<code>addr </code>æ˜¯ä¸€ä¸ª <code>char*</code>ï¼Œä½ å®é™…ä¸Šæƒ³è¦ç”¨ä¸€ä¸ªæŒ‡å‘<code> struct in_addr</code> çš„æŒ‡é’ˆï¼›<code>len </code>åº”è¯¥è¢«è®¾ç½®æˆ <code>sizeof(struct in_addr)</code>ï¼Œè€Œ <code>type</code> åº”ä¸º <code>AF_INET</code>ã€‚</p><p>æ‰€ä»¥è¿™ä¸ª <code>struct hostent</code> ä¼šè¿”å›ä»€ä¹ˆå‘¢ï¼Ÿå®ƒæœ‰è®¸å¤šå­—æ®µï¼ŒåŒ…å« host çš„ç›¸å…³æ•°æ®ã€‚</p><table><thead><tr><th>å­—æ®µ</th><th>æè¿°</th></tr></thead><tbody><tr><td>char *h_name</td><td>ä¸»æœºçš„è§„èŒƒï¼ˆofficialã€canonicalï¼‰åå­—</td></tr><tr><td>char **h_aliases</td><td>å¯ä»¥ä½¿ç”¨æ•°ç»„è®¿é—®çš„åˆ«ååˆ—è¡¨ï¼Œæœ€åä¸€ä¸ªå…ƒç´ ä¸ºNULL</td></tr><tr><td>int h_addrtype</td><td>ç»“æœçš„åœ°å€ç±»å‹ï¼Œå‡ºäºæˆ‘ä»¬çš„ç›®çš„ï¼Œå®ƒå®é™…ä¸Šåº”è¯¥æ˜¯AF_INETã€‚</td></tr><tr><td>int length</td><td>ä»¥å­—èŠ‚ä¸ºå•ä½çš„åœ°å€é•¿åº¦ï¼Œå¯¹äºIPï¼ˆç‰ˆæœ¬4ï¼‰åœ°å€ä¸º4ã€‚</td></tr><tr><td>char **h_addr_list</td><td>æ­¤ä¸»æœºçš„IPåœ°å€åˆ—è¡¨ã€‚è™½ç„¶è¿™æ˜¯ä¸€ä¸ªchar**ï¼Œä½†å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªä¼ªè£…çš„structin_addr *sæ•°ç»„ã€‚æœ€åä¸€ä¸ªæ•°ç»„å…ƒç´ ä¸ºNULLã€‚</td></tr><tr><td>h_addr</td><td>h_addr_list[0]çš„å¸¸ç”¨åˆ«åã€‚å¦‚æœä½ åªæ˜¯æƒ³è¦æ­¤ä¸»æœºçš„ä»»ä½•æ—§IPåœ°å€ï¼ˆæ˜¯çš„ï¼Œå®ƒä»¬å¯ä»¥æœ‰å¤šä¸ªï¼‰ï¼Œè¯·ä½¿ç”¨æ­¤å­—æ®µã€‚</td></tr></tbody></table><h4 id="_10-7-3-è¿”å›å€¼" tabindex="-1"><a class="header-anchor" href="#_10-7-3-è¿”å›å€¼" aria-hidden="true">#</a> 10.7.3. è¿”å›å€¼</h4><p>æˆåŠŸæ—¶è¿”å›æŒ‡å‘<code>struct hostent</code>ç»“æœçš„æŒ‡é’ˆï¼Œé”™è¯¯æ—¶è¿”å› <code>NULL</code>ã€‚</p><p>å’Œä¹‹å‰ä»‹ç»è¿‡çš„å…¶ä»–å‡½æ•°ä¸åŒï¼Œå½“å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå®ƒä¸è®¾ç½®<code>errno</code>å˜é‡ï¼Œè€Œæ˜¯å°†å…¨å±€æ•´æ•°å˜é‡<code>h_errno</code>è®¾ç½®ä¸ºåœ¨å¤´æ–‡ä»¶<code>&lt;netdb.h&gt;</code>ä¸­å®šä¹‰çš„å¸¸å€¼ã€‚</p><h4 id="_10-7-4-ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#_10-7-4-ä¾‹å­" aria-hidden="true">#</a> 10.7.4. ä¾‹å­</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// THIS IS A DEPRECATED METHOD OF GETTING HOST NAMES</span>
<span class="token comment">// use getaddrinfo() instead!</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token operator">*</span>he<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token operator">*</span><span class="token operator">*</span>addr_list<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;usage: ghbn hostname\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>he <span class="token operator">=</span> <span class="token function">gethostbyname</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// get the host info</span>
        <span class="token function">herror</span><span class="token punctuation">(</span><span class="token string">&quot;gethostbyname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// print information about this host:</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Official name is: %s\n&quot;</span><span class="token punctuation">,</span> he<span class="token operator">-&gt;</span>h_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;    IP addresses: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addr_list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>he<span class="token operator">-&gt;</span>h_addr_list<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> addr_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s &quot;</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span><span class="token operator">*</span>addr_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// THIS HAS BEEN SUPERCEDED</span>
<span class="token comment">// use getnameinfo() instead!</span>

<span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token operator">*</span>he<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">in_addr</span> ipv4addr<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> ipv6addr<span class="token punctuation">;</span>

<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">&quot;192.0.2.34&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ipv4addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
he <span class="token operator">=</span> <span class="token function">gethostbyaddr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ipv4addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> ipv4addr<span class="token punctuation">,</span> AF_INET<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Host name: %s\n&quot;</span><span class="token punctuation">,</span> he<span class="token operator">-&gt;</span>h_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> <span class="token string">&quot;2001:db8:63b3:1::beef&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ipv6addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
he <span class="token operator">=</span> <span class="token function">gethostbyaddr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ipv6addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> ipv6addr<span class="token punctuation">,</span> AF_INET6<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Host name: %s\n&quot;</span><span class="token punctuation">,</span> he<span class="token operator">-&gt;</span>h_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-7-5-å‚è§" tabindex="-1"><a class="header-anchor" href="#_10-7-5-å‚è§" aria-hidden="true">#</a> 10.7.5. å‚è§</h4><p><a href="https://beej.us/guide/bgnet/html/#getaddrinfoman" target="_blank" rel="noopener noreferrer"><code>getaddrinfo()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#getnameinfoman" target="_blank" rel="noopener noreferrer"><code>getnameinfo()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#gethostnameman" target="_blank" rel="noopener noreferrer"><code>gethostname()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#errnoman" target="_blank" rel="noopener noreferrer"><code>errno</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#perrorman" target="_blank" rel="noopener noreferrer"><code>perror()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#perrorman" target="_blank" rel="noopener noreferrer"><code>strerror()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://beej.us/guide/bgnet/html/#sockaddr_inman" target="_blank" rel="noopener noreferrer"><code>struct in_addr</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_10-8-getnameinfo" tabindex="-1"><a class="header-anchor" href="#_10-8-getnameinfo" aria-hidden="true">#</a> 10.8. getnameinfo()</h3><p>ç”± struct sockaddr æä¾›çš„ä¿¡æ¯æŸ¥è¯¢ä¸»æœºåç§°ï¼ˆhost nameï¼‰ä»¥åŠæœåŠ¡åï¼ˆservice nameï¼‰ã€‚</p><h4 id="_10-8-1-å‡½æ•°åŸå‹" tabindex="-1"><a class="header-anchor" href="#_10-8-1-å‡½æ•°åŸå‹" aria-hidden="true">#</a> 10.8.1. å‡½æ•°åŸå‹</h4><h3 id="_10-9-shutdown" tabindex="-1"><a class="header-anchor" href="#_10-9-shutdown" aria-hidden="true">#</a> 10.9. shutdown()</h3><p>åœæ­¢å¯¹socketç»§ç»­ä¼ é€ä¸æ¥å—ã€‚</p><h4 id="_10-9-1-å‡½æ•°åŸå‹" tabindex="-1"><a class="header-anchor" href="#_10-9-1-å‡½æ•°åŸå‹" aria-hidden="true">#</a> 10.9.1. å‡½æ•°åŸå‹</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
    
<span class="token keyword">int</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> how<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-9-2-è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#_10-9-2-è¯´æ˜" aria-hidden="true">#</a> 10.9.2. è¯´æ˜</h4><p>å¦‚æœæˆ‘ä¸éœ€è¦å†å¯¹ socket è¿›è¡Œ<code>send()</code>äº†ï¼Œä½†æ˜¯æˆ‘ä»ç„¶æƒ³è¦<code>recv() </code>socket çš„æ•°æ®ï¼Œåä¹‹äº¦ç„¶ï¼Œé‚£æˆ‘è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p><p>å½“ä½ ä½¿ç”¨ <code>close()</code> å…³é—­ socket descriptor æ—¶ï¼Œå®ƒä¼šå°† socket çš„ä¼ é€ä¸æ¥æ”¶ä¸¤ç«¯éƒ½å…³é—­ï¼Œå¹¶ä¸”é‡Šæ”¾ socket descriptorã€‚è‹¥ä½ åªæƒ³è¦å…³é—­å…¶ä¸­ä¸€ç«¯ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨ <code>shutdown() </code>è¿™ä¸ªå‡½æ•°ã€‚</p><p>åœ¨è¿™äº›å‚æ•°ä¸­ï¼Œ<code>s </code>æ˜¾ç„¶æ˜¯ä½ æƒ³è¦è¿›è¡ŒåŠ¨ä½œçš„ socketï¼Œè€Œè¦è¿›è¡Œä»€ä¹ˆæ ·çš„åŠ¨ä½œï¼Œåˆ™è¦ç”± <code>how</code> å‚æ•°æŒ‡å®šã€‚å¯ä»¥ä½¿ç”¨ <code>SHUT_RD</code> æ¥å…³é—­æ¥æ”¶ï¼Œ<code>SHUT_WR</code> ä»¥å…³é—­ä¼ é€ï¼Œæˆ–è€… <code>SHUT_RDWR</code> å°†æ”¶é€åŠŸèƒ½éƒ½å…³é—­ã€‚</p><ul><li><p>SHUT_RD</p><p>å…³é—­è¿æ¥çš„è¯»åŠŸèƒ½ï¼Œsocketä¸­ä¸å†æœ‰æ•°æ®å¯ä»¥è¢«æ¥å—ï¼Œè€Œä¸”socketæ¥æ”¶ç¼“å†²åŒºä¸­çš„å…ˆæœ‰æ•°æ®éƒ½è¢«ä¸¢å¼ƒã€‚è¿›ç¨‹ä¸èƒ½å†å¯¹è¿™æ ·çš„socketè°ƒç”¨ä»»ä½•è¯»å‡½æ•°ã€‚</p></li><li><p>SHUT_WR</p><p>å…³é—­è¿æ¥çš„å†™åŠŸèƒ½ã€‚å½“å‰ç•™åœ¨socketå‘é€ç¼“å†²åŒºä¸­çš„æ•°æ®å°†è¢«å‘é€æ‰ï¼Œåé¢è·Ÿç€TCPçš„æ­£å¸¸è¿æ¥ç»ˆæ­¢åºåˆ—ã€‚è¿›ç¨‹ä¸èƒ½å†å¯¹è¿™æ ·çš„socketè°ƒç”¨ä»»ä½•å†™å‡½æ•°ã€‚</p></li><li><p>SHUT_RDWR</p><p>è¿æ¥çš„è¯»åŠŸèƒ½å’Œå†™åŠŸèƒ½éƒ½è¢«å…³é—­ï¼Œè¿™ç­‰äºè°ƒç”¨<code>shutdown</code>ä¸¤æ¬¡ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨æŒ‡å®š<code>SHUT_RD</code>ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨æŒ‡å®š<code>SHUT_WR</code>ã€‚</p></li></ul><p><code>shutdown() </code>ç”¨æ¥å…³é—­è¿æ¥ï¼Œè€Œä¸æ˜¯socketï¼Œä¸ç®¡è°ƒç”¨å¤šå°‘æ¬¡<code>shutdown()</code>ï¼Œsocketä¾ç„¶å­˜åœ¨ï¼Œå› ä¸º <code>shutdown() </code>å¹¶æ²¡æœ‰é‡Šæ”¾ socket descriptorï¼Œæ‰€ä»¥å³ä½¿ socket å·²ç»æ•´ä¸ª shutdown äº†ï¼Œæœ€ç»ˆä»ç„¶å¾—é€è¿‡ <code>close() </code>å…³é—­ socketã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>close()</code>ä¼šç«‹å³å‘ç½‘ç»œä¸­å‘é€<code>FIN</code>åŒ…ï¼Œä¸ç®¡è¾“å‡ºç¼“å†²åŒºä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®ï¼Œè€Œ<code>shutdown() </code>ä¼šç­‰è¾“å‡ºç¼“å†²åŒºä¸­çš„æ•°æ®ä¼ è¾“å®Œæ¯•å†å‘é€<code>FIN</code>åŒ…ã€‚ä¹Ÿå°±æ„å‘³ç€ï¼Œè°ƒç”¨<code> close()</code>å°†ä¸¢å¤±è¾“å‡ºç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œè€Œè°ƒç”¨ <code>shutdown() </code>ä¸ä¼šã€‚</p><p>è¿™ä¸ªå‡½æ•°ç”¨çš„å¹¶ä¸å¸¸ç”¨ã€‚</p><h4 id="_10-9-3-è¿”å›å€¼" tabindex="-1"><a class="header-anchor" href="#_10-9-3-è¿”å›å€¼" aria-hidden="true">#</a> 10.9.3. è¿”å›å€¼</h4><p>æˆåŠŸè¿”å›<code>0</code>ï¼Œå‘ç”Ÿå¼‚å¸¸æ—¶è¿”å›<code> -1</code>ï¼Œå¹¶å°† <code>errno</code> è®¾ç½®ä¸ºåˆé€‚çš„å€¼ã€‚</p><h4 id="_10-9-4-ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#_10-9-4-ä¾‹å­" aria-hidden="true">#</a> 10.9.4. ä¾‹å­</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...do some send()s and stuff in here...</span>

<span class="token comment">// and now that we&#39;re done, don&#39;t allow any more sends()s:</span>
<span class="token function">shutdown</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> SHUT_WR<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-9-5-å‚é˜…" tabindex="-1"><a class="header-anchor" href="#_10-9-5-å‚é˜…" aria-hidden="true">#</a> 10.9.5. å‚é˜…</h4><p><a href="https://beej.us/guide/bgnet/html/#closeman" target="_blank" rel="noopener noreferrer"><code>close()</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="_11-æ›´å¤šèµ„æ–™" tabindex="-1"><a class="header-anchor" href="#_11-æ›´å¤šèµ„æ–™" aria-hidden="true">#</a> 11. æ›´å¤šèµ„æ–™</h2><h2 id="_12-åè®°" tabindex="-1"><a class="header-anchor" href="#_12-åè®°" aria-hidden="true">#</a> 12. åè®°</h2></div><!----><footer class="page-meta"><!----><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><span class="info">2022/11/2 01:18:52</span></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: zhaoxaolong@163.com">chanmufeng</span><!--]--><!--]--></div></footer><!----><div class="giscus-wrapper input-top" style="display:block;"><div style="text-align:center">Loading...</div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"><a href='https://beian.miit.gov.cn/'>é²ICPå¤‡20023913å·</a></div><div class="copyright">Copyright Â© 2023 è‰æ²é£</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.ec803d45.js" defer></script>
  </body>
</html>
