<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.49" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://www.chanmufeng.com/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html"><meta property="og:site_name" content="蝉沐风"><meta property="og:title" content="动态代理模式"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-08-03T06:14:46.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:tag" content="设计模式"><meta property="article:tag" content="动态代理"><meta property="article:published_time" content="2022-01-21T00:00:00.000Z"><meta property="article:modified_time" content="2022-08-03T06:14:46.000Z"><script>
                var _hmt = _hmt || [];
                (function() {
                  var hm = document.createElement("script");
                  hm.src = "https://hm.baidu.com/hm.js?dfa689801ccd10bd283b50ea146430f3";
                  var s = document.getElementsByTagName("script")[0]; 
                  s.parentNode.insertBefore(hm, s);
                })();
            </script><title>动态代理模式 | 蝉沐风</title><meta name="description" content="Chanmufeng's Personal Website">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.0fa25434.css">
    <link rel="modulepreload" href="/assets/app.339ecc68.js"><link rel="modulepreload" href="/assets/动态代理模式.html.5eede20a.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/assets/动态代理模式.html.88a1d2f4.js"><link rel="prefetch" href="/assets/index.html.c61b2d3b.js"><link rel="prefetch" href="/assets/home.html.4311fb4f.js"><link rel="prefetch" href="/assets/index.html.bc679553.js"><link rel="prefetch" href="/assets/index.html.42b16337.js"><link rel="prefetch" href="/assets/disable.html.a298796c.js"><link rel="prefetch" href="/assets/encrypt.html.04234872.js"><link rel="prefetch" href="/assets/markdown.html.c40cf8e1.js"><link rel="prefetch" href="/assets/JVM到底该学习些什么.html.e9d886cf.js"><link rel="prefetch" href="/assets/index.html.12f06cef.js"><link rel="prefetch" href="/assets/用「闪电侠」解释一下进程和线程.html.9c93b056.js"><link rel="prefetch" href="/assets/缓存一致性与内存屏障.html.ea729c1a.js"><link rel="prefetch" href="/assets/index.html.b013c8f1.js"><link rel="prefetch" href="/assets/单例模式.html.c3742e12.js"><link rel="prefetch" href="/assets/工厂模式.html.024b81e1.js"><link rel="prefetch" href="/assets/静态代理模式.html.7bbcf6f5.js"><link rel="prefetch" href="/assets/依赖倒置原则.html.56bde280.js"><link rel="prefetch" href="/assets/开闭原则.html.d45ce1b8.js"><link rel="prefetch" href="/assets/Google搜索为什么不能无限分页？.html.5b88d232.js"><link rel="prefetch" href="/assets/index.html.abd3d401.js"><link rel="prefetch" href="/assets/m1芯片电脑安装cerebro.html.0120f768.js"><link rel="prefetch" href="/assets/MySQL与Redis的数据一致性.html.82c6466a.js"><link rel="prefetch" href="/assets/MySQL优化的5个维度.html.8a427fc5.js"><link rel="prefetch" href="/assets/MySQL索引的正确使用姿势.html.4af40097.js"><link rel="prefetch" href="/assets/index.html.c8eb6a41.js"><link rel="prefetch" href="/assets/一条SELECT语句是如何执行的.html.90adc54b.js"><link rel="prefetch" href="/assets/一条Update语句是如何执行的.html.8736dea8.js"><link rel="prefetch" href="/assets/为什么MySQL的主键查询这么快.html.69305ec3.js"><link rel="prefetch" href="/assets/为什么不建议你使用SELECT_.html.6d1125c0.js"><link rel="prefetch" href="/assets/事务的隔离性与MVCC.html.a4ad4ac5.js"><link rel="prefetch" href="/assets/从根儿上理解索引.html.bc24d795.js"><link rel="prefetch" href="/assets/index.html.9d93e6d0.js"><link rel="prefetch" href="/assets/Redis持久化——AOF.html.7724b8e2.js"><link rel="prefetch" href="/assets/Redis持久化——RDB.html.51c46751.js"><link rel="prefetch" href="/assets/鸡肋的Redis事务.html.bf1172f2.js"><link rel="prefetch" href="/assets/404.html.4285bac5.js"><link rel="prefetch" href="/assets/index.html.6717b2b6.js"><link rel="prefetch" href="/assets/index.html.5eae9e3f.js"><link rel="prefetch" href="/assets/index.html.85231e1c.js"><link rel="prefetch" href="/assets/index.html.07ef0efd.js"><link rel="prefetch" href="/assets/index.html.e5d6f701.js"><link rel="prefetch" href="/assets/index.html.accaa64c.js"><link rel="prefetch" href="/assets/index.html.9a9f30d6.js"><link rel="prefetch" href="/assets/index.html.68e6d714.js"><link rel="prefetch" href="/assets/index.html.b032f382.js"><link rel="prefetch" href="/assets/index.html.bc540566.js"><link rel="prefetch" href="/assets/index.html.e68eec84.js"><link rel="prefetch" href="/assets/index.html.5e63234c.js"><link rel="prefetch" href="/assets/index.html.a1ffa21c.js"><link rel="prefetch" href="/assets/index.html.3e9b5a53.js"><link rel="prefetch" href="/assets/index.html.7b661157.js"><link rel="prefetch" href="/assets/index.html.843e0dc5.js"><link rel="prefetch" href="/assets/index.html.cd04393b.js"><link rel="prefetch" href="/assets/index.html.a46272a6.js"><link rel="prefetch" href="/assets/index.html.da976a01.js"><link rel="prefetch" href="/assets/index.html.c3c92e66.js"><link rel="prefetch" href="/assets/index.html.799762a8.js"><link rel="prefetch" href="/assets/index.html.5c810edd.js"><link rel="prefetch" href="/assets/index.html.6a1f2c2a.js"><link rel="prefetch" href="/assets/index.html.a61ab275.js"><link rel="prefetch" href="/assets/index.html.91d708f1.js"><link rel="prefetch" href="/assets/index.html.2b208795.js"><link rel="prefetch" href="/assets/index.html.970ad9a6.js"><link rel="prefetch" href="/assets/index.html.18750c91.js"><link rel="prefetch" href="/assets/index.html.5832ab43.js"><link rel="prefetch" href="/assets/index.html.46963a2e.js"><link rel="prefetch" href="/assets/index.html.d8d0f261.js"><link rel="prefetch" href="/assets/index.html.656424fd.js"><link rel="prefetch" href="/assets/index.html.740f6c3e.js"><link rel="prefetch" href="/assets/index.html.75361b30.js"><link rel="prefetch" href="/assets/index.html.77d7aba9.js"><link rel="prefetch" href="/assets/index.html.c6475c4b.js"><link rel="prefetch" href="/assets/index.html.4f4df111.js"><link rel="prefetch" href="/assets/index.html.2ef7b821.js"><link rel="prefetch" href="/assets/index.html.0dc0a64e.js"><link rel="prefetch" href="/assets/index.html.a8e5dab4.js"><link rel="prefetch" href="/assets/index.html.8dbe4bd2.js"><link rel="prefetch" href="/assets/index.html.72d090a7.js"><link rel="prefetch" href="/assets/index.html.f0f01938.js"><link rel="prefetch" href="/assets/index.html.899ba14c.js"><link rel="prefetch" href="/assets/index.html.1aac5a85.js"><link rel="prefetch" href="/assets/index.html.79aed47e.js"><link rel="prefetch" href="/assets/index.html.d40b22a3.js"><link rel="prefetch" href="/assets/index.html.786262e5.js"><link rel="prefetch" href="/assets/home.html.bdedd309.js"><link rel="prefetch" href="/assets/index.html.6413c7d8.js"><link rel="prefetch" href="/assets/index.html.beafb033.js"><link rel="prefetch" href="/assets/disable.html.1975a832.js"><link rel="prefetch" href="/assets/encrypt.html.7788d258.js"><link rel="prefetch" href="/assets/markdown.html.3c4a850b.js"><link rel="prefetch" href="/assets/JVM到底该学习些什么.html.78f31ada.js"><link rel="prefetch" href="/assets/index.html.eeda26c1.js"><link rel="prefetch" href="/assets/用「闪电侠」解释一下进程和线程.html.7dc8bc28.js"><link rel="prefetch" href="/assets/缓存一致性与内存屏障.html.4e011d1e.js"><link rel="prefetch" href="/assets/index.html.35c71f11.js"><link rel="prefetch" href="/assets/单例模式.html.8c4ee2e0.js"><link rel="prefetch" href="/assets/工厂模式.html.f8a50f9e.js"><link rel="prefetch" href="/assets/静态代理模式.html.08c61da1.js"><link rel="prefetch" href="/assets/依赖倒置原则.html.6c310a5b.js"><link rel="prefetch" href="/assets/开闭原则.html.b6515c13.js"><link rel="prefetch" href="/assets/Google搜索为什么不能无限分页？.html.be8065da.js"><link rel="prefetch" href="/assets/index.html.914fc13a.js"><link rel="prefetch" href="/assets/m1芯片电脑安装cerebro.html.7d7b0fa2.js"><link rel="prefetch" href="/assets/MySQL与Redis的数据一致性.html.6c737175.js"><link rel="prefetch" href="/assets/MySQL优化的5个维度.html.a8b8e9d1.js"><link rel="prefetch" href="/assets/MySQL索引的正确使用姿势.html.ae86807d.js"><link rel="prefetch" href="/assets/index.html.c89c8d1b.js"><link rel="prefetch" href="/assets/一条SELECT语句是如何执行的.html.e0784a65.js"><link rel="prefetch" href="/assets/一条Update语句是如何执行的.html.363a84b4.js"><link rel="prefetch" href="/assets/为什么MySQL的主键查询这么快.html.ea4e5b62.js"><link rel="prefetch" href="/assets/为什么不建议你使用SELECT_.html.d0c93381.js"><link rel="prefetch" href="/assets/事务的隔离性与MVCC.html.a23f470e.js"><link rel="prefetch" href="/assets/从根儿上理解索引.html.259717c6.js"><link rel="prefetch" href="/assets/index.html.1e5d41c6.js"><link rel="prefetch" href="/assets/Redis持久化——AOF.html.4229c02c.js"><link rel="prefetch" href="/assets/Redis持久化——RDB.html.50789e17.js"><link rel="prefetch" href="/assets/鸡肋的Redis事务.html.40e37acc.js"><link rel="prefetch" href="/assets/404.html.b9e60af1.js"><link rel="prefetch" href="/assets/index.html.259acecf.js"><link rel="prefetch" href="/assets/index.html.e54bfb5a.js"><link rel="prefetch" href="/assets/index.html.5546c7d1.js"><link rel="prefetch" href="/assets/index.html.ba15a4fc.js"><link rel="prefetch" href="/assets/index.html.459b1ee9.js"><link rel="prefetch" href="/assets/index.html.8121d483.js"><link rel="prefetch" href="/assets/index.html.ae10f2d4.js"><link rel="prefetch" href="/assets/index.html.83a611ee.js"><link rel="prefetch" href="/assets/index.html.069d0eed.js"><link rel="prefetch" href="/assets/index.html.3c747fb7.js"><link rel="prefetch" href="/assets/index.html.b18adbbe.js"><link rel="prefetch" href="/assets/index.html.86519a58.js"><link rel="prefetch" href="/assets/index.html.1b0f1e9a.js"><link rel="prefetch" href="/assets/index.html.47c42de3.js"><link rel="prefetch" href="/assets/index.html.05147056.js"><link rel="prefetch" href="/assets/index.html.10d23c04.js"><link rel="prefetch" href="/assets/index.html.7aefd0d8.js"><link rel="prefetch" href="/assets/index.html.359012f1.js"><link rel="prefetch" href="/assets/index.html.4a005e7a.js"><link rel="prefetch" href="/assets/index.html.bca2b4a7.js"><link rel="prefetch" href="/assets/index.html.708363fa.js"><link rel="prefetch" href="/assets/index.html.58507180.js"><link rel="prefetch" href="/assets/index.html.a0b52418.js"><link rel="prefetch" href="/assets/index.html.bfdf867b.js"><link rel="prefetch" href="/assets/index.html.6ff9f2a2.js"><link rel="prefetch" href="/assets/index.html.58ce19f3.js"><link rel="prefetch" href="/assets/index.html.5a29da3d.js"><link rel="prefetch" href="/assets/index.html.b33e75ba.js"><link rel="prefetch" href="/assets/index.html.7579b8da.js"><link rel="prefetch" href="/assets/index.html.f4a6923b.js"><link rel="prefetch" href="/assets/index.html.faaae0bf.js"><link rel="prefetch" href="/assets/index.html.e0857c23.js"><link rel="prefetch" href="/assets/index.html.bfcff961.js"><link rel="prefetch" href="/assets/index.html.31aaad1a.js"><link rel="prefetch" href="/assets/index.html.e8eb9b09.js"><link rel="prefetch" href="/assets/index.html.0c4ea5d5.js"><link rel="prefetch" href="/assets/index.html.9f9fd8a6.js"><link rel="prefetch" href="/assets/index.html.04509029.js"><link rel="prefetch" href="/assets/index.html.01dfeda4.js"><link rel="prefetch" href="/assets/index.html.9b404de2.js"><link rel="prefetch" href="/assets/index.html.ffb2cbd3.js"><link rel="prefetch" href="/assets/index.html.9ad0d506.js"><link rel="prefetch" href="/assets/index.html.5d4473d8.js"><link rel="prefetch" href="/assets/index.html.4f3e3073.js"><link rel="prefetch" href="/assets/index.html.20553c3d.js"><link rel="prefetch" href="/assets/index.html.8cd991e4.js"><link rel="prefetch" href="/assets/index.html.adb1d74d.js"><link rel="prefetch" href="/assets/404.6cddb59b.js"><link rel="prefetch" href="/assets/Layout.69d61024.js"><link rel="prefetch" href="/assets/Slide.2b66780c.js"><link rel="prefetch" href="/assets/Blog.fa083321.js"><link rel="prefetch" href="/assets/giscus.8fe73ced.js"><link rel="prefetch" href="/assets/auto.esm.2565cd3a.js"><link rel="prefetch" href="/assets/index.d8a59108.js"><link rel="prefetch" href="/assets/index.1842ee54.js"><link rel="prefetch" href="/assets/mermaid.esm.min.ee1e0284.js"><link rel="prefetch" href="/assets/highlight.esm.d982e650.js"><link rel="prefetch" href="/assets/markdown.esm.832a189d.js"><link rel="prefetch" href="/assets/math.esm.a3f84b6f.js"><link rel="prefetch" href="/assets/notes.esm.3c361cb7.js"><link rel="prefetch" href="/assets/reveal.esm.b96f05d8.js"><link rel="prefetch" href="/assets/search.esm.80da4a02.js"><link rel="prefetch" href="/assets/zoom.esm.8514a202.js"><link rel="prefetch" href="/assets/photoswipe.esm.218074cd.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/" class="brand"><img class="logo" src="https://img-blog.csdnimg.cn/d16e11af2edb4972833f88083d2f0375.png" alt="蝉沐风"><!----><span class="site-name hide-in-pad">蝉沐风</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="主页"><span class="icon iconfont icon-home"></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="技术博文"><span class="title"><span class="icon iconfont icon-edit"></span>技术博文</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>内功心法</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/basic/design-pattern/" class="nav-link active" aria-label="设计模式"><span class="icon iconfont icon-edit"></span>设计模式<!----></a></li><li class="dropdown-subitem"><a href="/posts/basic/design-principle/%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99.html" class="nav-link" aria-label="设计原则"><span class="icon iconfont icon-edit"></span>设计原则<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>存储篇</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/storage/MySQL" class="nav-link" aria-label="MySQL"><span class="icon iconfont icon-mysql"></span>MySQL<!----></a></li><li class="dropdown-subitem"><a href="/posts/storage/Redis" class="nav-link" aria-label="Redis"><span class="icon iconfont icon-workingDirectory"></span>Redis<!----></a></li><li class="dropdown-subitem"><a href="/posts/storage/ElasticSearch" class="nav-link" aria-label="ElasticSearch"><span class="icon iconfont icon-edit"></span>ElasticSearch<!----></a></li></ul></li><li class="dropdown-item"><a href="/posts/concurrency" class="nav-link" aria-label="并发篇"><span class="icon iconfont icon-edit"></span>并发篇<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="https://space.bilibili.com/519360358" rel="noopener noreferrer" target="_blank" aria-label="bilibili" class="nav-link"><span class="icon iconfont icon-actions"></span>bilibili<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!----></div><div class="navbar-right"><!----><!----><!----><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><p class="sidebar-heading active"><span class="icon iconfont icon-guide"></span><span class="title">设计模式</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/posts/basic/design-pattern/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F.html" class="nav-link sidebar-link sidebar-page" aria-label="单例模式"><span class="icon iconfont icon-creative"></span>单例模式<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/posts/basic/design-pattern/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F.html" class="nav-link sidebar-link sidebar-page" aria-label="工厂模式——猫粮公司的演进"><span class="icon iconfont icon-creative"></span>工厂模式——猫粮公司的演进<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/posts/basic/design-pattern/%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html" class="nav-link sidebar-link sidebar-page" aria-label="静态代理——时间都去哪儿了"><span class="icon iconfont icon-creative"></span>静态代理——时间都去哪儿了<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="动态代理模式"><span class="icon iconfont icon-creative"></span>动态代理模式<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html#捉襟见肘的静态代理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="捉襟见肘的静态代理"><!---->捉襟见肘的静态代理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html#动态代理的诞生" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="动态代理的诞生"><!---->动态代理的诞生<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html#v1-0——先动态编译一段源码吧" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="v1.0——先动态编译一段源码吧"><!---->v1.0——先动态编译一段源码吧<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html#v2-0——为实现了任意接口的类做日志代理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="v2.0——为实现了任意接口的类做日志代理"><!---->v2.0——为实现了任意接口的类做日志代理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html#v3-0——为实现了任意接口的类做任意代理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="v3.0——为实现了任意接口的类做任意代理"><!---->v3.0——为实现了任意接口的类做任意代理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html#v4-0——终于完成对jdk动态代理的模拟" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="v4.0——终于完成对JDK动态代理的模拟"><!---->v4.0——终于完成对JDK动态代理的模拟<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html#后记" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="后记"><!---->后记<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><p class="sidebar-heading"><span class="icon iconfont icon-guide"></span><span class="title">设计原则</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/posts/basic/design-principle/%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99.html" class="nav-link sidebar-link sidebar-page" aria-label="开闭原则"><span class="icon iconfont icon-creative"></span>开闭原则<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/posts/basic/design-principle/%E4%BE%9D%E8%B5%96%E5%80%92%E7%BD%AE%E5%8E%9F%E5%88%99.html" class="nav-link sidebar-link sidebar-page" aria-label="依赖倒置原则"><span class="icon iconfont icon-creative"></span>依赖倒置原则<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><span class="icon iconfont icon-creative"></span>动态代理模式</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down" localizeddate="2022年1月21日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://www.chanmufeng.com" target="_blank" rel="noopener noreferrer">蝉沐风</a></span><span property="author" content="蝉沐风"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022年1月21日</span><meta property="datePublished" content="2022-01-21T00:00:00.000Z"></span><span class="category-info" aria-label="分类🌈" data-balloon-pos="down" localizeddate="2022年1月21日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><ul class="categories-wrapper"><li class="category category2 clickable" role="navigation">设计模式</li><meta property="articleSection" content="设计模式"></ul></span><span aria-label="标签🏷" data-balloon-pos="down" localizeddate="2022年1月21日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><ul class="tags-wrapper"><li class="tag tag2 clickable" role="navigation">设计模式</li><li class="tag tag4 clickable" role="navigation">动态代理</li></ul><meta property="keywords" content="设计模式,动态代理"></span><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down" localizeddate="2022年1月21日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 27 分钟</span><meta property="timeRequired" content="PT27M"></span><!----><span class="words-info" aria-label="字数🔠" data-balloon-pos="down" localizeddate="2022年1月21日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 8023 字</span><meta property="wordCount" content="8023"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html#捉襟见肘的静态代理" class="router-link-active router-link-exact-active toc-link level2">捉襟见肘的静态代理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html#动态代理的诞生" class="router-link-active router-link-exact-active toc-link level2">动态代理的诞生</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html#v1-0——先动态编译一段源码吧" class="router-link-active router-link-exact-active toc-link level3">v1.0——先动态编译一段源码吧</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html#v2-0——为实现了任意接口的类做日志代理" class="router-link-active router-link-exact-active toc-link level3">v2.0——为实现了任意接口的类做日志代理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html#v3-0——为实现了任意接口的类做任意代理" class="router-link-active router-link-exact-active toc-link level3">v3.0——为实现了任意接口的类做任意代理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html#v4-0——终于完成对jdk动态代理的模拟" class="router-link-active router-link-exact-active toc-link level3">v4.0——终于完成对JDK动态代理的模拟</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/basic/design-pattern/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html#后记" class="router-link-active router-link-exact-active toc-link level2">后记</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><p>虽然学会了<a href="https://mp.weixin.qq.com/s?__biz=MzI1MDU0MTc2MQ==&amp;mid=2247484008&amp;idx=1&amp;sn=a69b9fd62b29e0e6bdfccfc00f614e33&amp;chksm=e981e1c6def668d03374bb51108e480a70eb39bb1a0f6b9dd967fd13a7d14834d35bade414fd#rd" target="_blank" rel="noopener noreferrer">静态代理<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，但是招财这几天仍然是有些闷闷不乐，因为始终没有想出<a href="https://mp.weixin.qq.com/s?__biz=MzI1MDU0MTc2MQ==&amp;mid=2247484008&amp;idx=1&amp;sn=a69b9fd62b29e0e6bdfccfc00f614e33&amp;chksm=e981e1c6def668d03374bb51108e480a70eb39bb1a0f6b9dd967fd13a7d14834d35bade414fd#rd" target="_blank" rel="noopener noreferrer">上次<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>陀螺留给自己的问题的解决思路。</p><blockquote><p>如何为<strong>任意对象</strong>的<strong>任意方法</strong>前后添加同一个处理逻辑？</p></blockquote><p>手动为每一个对象的每一个方法中添加同一段代码逻辑是不可能的，这辈子都不可能的。「懒」是科技进步的重要动力！</p><p>思考未果，招财终于要求助陀螺了。</p><h2 id="捉襟见肘的静态代理" tabindex="-1"><a class="header-anchor" href="#捉襟见肘的静态代理" aria-hidden="true">#</a> 捉襟见肘的静态代理</h2><p>“师傅，你上次留给我的问题我没想通。这种需求的现实意义在哪儿呢？”招财开门见山。</p><p>陀螺说：“如果真的能在任意方法前后添加自己的逻辑，那作用可就太大了！你可以在逻辑运行之前先校验操作权限；你也可以在逻辑运行之前先开始一个事务，在逻辑完成之后提交或回滚事务。这种功能怎么用完全取决于你的想象力。”</p><p>“真没想到居然有这么大的作用！那么该怎么实现呢？”</p><p>“你觉得静态代理能不能解决这个问题？”陀螺反问道。</p><p>招财回答说：“可以倒是可以，我们可以为每个类针对每一种逻辑编写一个静态代理，但是问题就在这，如果被代理的类很多，代理逻辑也很多，就会造成类爆炸的局面啊。”</p><p>“我觉得静态代理更适合为某些特定的接口实现代理，而且代理对象必须显式地创建。”招财继续补充道。</p><p>陀螺：“你说的没错，问题就在于静态代理需要显式地创建代理对象，那如果我们能够动态生成代理对象，而这个生成过程用户完全无感知，这个问题是不是就可以解决了呢？”</p><p>“真的有这种方法吗？”招财的眼睛里都发着光。</p><p>“这就是动态代理了。这件事情确实很难，我们需要一点点地来完成这件事情，跟上我的思路，保证能让你彻底理解动态代理！”陀螺自信地对招财说。</p><h2 id="动态代理的诞生" tabindex="-1"><a class="header-anchor" href="#动态代理的诞生" aria-hidden="true">#</a> 动态代理的诞生</h2><p>“首先回忆一下静态代理中你编写的日志代理。”说着，陀螺给出了代码。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//代码1-1</span>
<span class="token keyword">package</span> <span class="token namespace">designPattern<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>dynamicProxy<span class="token punctuation">.</span>v1</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">designPattern<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>dynamicProxy<span class="token punctuation">.</span></span><span class="token class-name">Payable</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SiShiDaDaoLogProxy</span> <span class="token keyword">implements</span> <span class="token class-name">Payable</span> <span class="token punctuation">{</span>

    <span class="token comment">//被代理对象</span>
    <span class="token keyword">private</span> <span class="token class-name">Payable</span> payable<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SiShiDaDaoLogProxy</span><span class="token punctuation">(</span><span class="token class-name">Payable</span> payable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>payable <span class="token operator">=</span> payable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;打印日志1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        payable<span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;打印日志2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>“这个代码你应该已经非常熟悉了吧。”陀螺问招财。</p><p>“是啊，<code>payable</code>是被代理对象，<code>SiShiDaDaoLogProxy</code>是生成的代理类，代理对象实现了<code>Payable</code>接口，在重写<code>pay()</code>方法的时候进行了逻辑增强，但是本质上仍然调用的是被代理对象的方法。”招财回答得很流利。</p><p>陀螺点了点头，“很好，假设现在我们通过某种方式获得了上面的源码，现在我们的目标是要动态生成这个代理对象。”</p><p>“动态生成？我只知道一开始学习Java的时候，通常会先写一个<code>HelloWorld.java</code>源文件，然后利用<code>javac</code>工具编译成<code>HelloWorld.class</code>文件，你说的动态生成和这个有关系吗？”招财问道。</p><p>“原理是类似的，我们需要把上面的<code>SiShiDaDaoLogProxy</code>写入到磁盘中生成<code>.java</code>文件，然后利用JDK提供的编译工具转为<code>.class</code>文件，再通过类加载器将<code>.class</code>文件加载到JVM中，最后我们通过反射就能获得<code>SiShiDaDaoLogProxy</code>实例对象了。”</p><p>“这......这涉及到的知识点也太多了！JDK提供的编译工具我甚至都没有听过，类加载的知识也几乎已经忘光了，也就反射总在框架中遇到，多少还有点印象。师傅，我是不是得先补一补这些知识点啊？”招财有点绝望地问。</p><p>&quot;你这种想法是很多初学者的通病，学一个知识点的时候总是不自觉地把其他相关知识点也学了一遍，最后忘了自己一开始的学习目的是什么，本末倒置。记住，要先掌握脉络，再学细节！&quot;陀螺正色道。</p><p>陀螺看着招财还是有点不自信，继续说道：“别担心，要不是碰到这个动态代理，JDK自带的编译器恐怕你这辈子也用不上了，所以你只要知道它的作用是什么即可，代码都不需要看懂。至于类加载机制，你要理解我们需要一个类加载器来加载上一步得到的<code>.class</code>文件到JVM虚拟机中，这样才能生成实例对象，了解这些就够了。至于反射，你确实应该掌握，好在它本身非常简单，跟着我的思路就能理解了。”</p><p>陀螺的话让招财安心了许多，重新打起了精神。</p><h3 id="v1-0——先动态编译一段源码吧" tabindex="-1"><a class="header-anchor" href="#v1-0——先动态编译一段源码吧" aria-hidden="true">#</a> v1.0——先动态编译一段源码吧</h3><p>“我们先创建一个类<code>Proxy</code>，在里面定义一个<code>newProxyInstance</code>的静态方法，该方法返回一个<code>Object</code>对象，这个对象就是我们最终生成的代理对象。”说罢，陀螺给出了代码。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> chanmufeng
 * <span class="token keyword">@description</span> 动态代理v1
 * <span class="token keyword">@date</span> 2022/1/10
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token punctuation">{</span>

    <span class="token comment">//定义换行符</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ln <span class="token operator">=</span> <span class="token string">&quot;\r\n&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            
            <span class="token doc-comment comment">/** 1.生成源代码 **/</span>
            <span class="token class-name">String</span> src <span class="token operator">=</span> <span class="token function">generateSrc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token doc-comment comment">/** 2.将源码写入磁盘，生成.java文件 **/</span>
            <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token function">createJavaFile</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token doc-comment comment">/** 3.将生成的.java文件编译成.class文件 **/</span>
            <span class="token function">compile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token doc-comment comment">/** 4.类加载器将.class文件加载到JVM **/</span>
            <span class="token class-name">Class</span> proxyClass <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;SiShiDaDaoLogProxy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token doc-comment comment">/** 5.利用反射实例化对象 **/</span>
            <span class="token class-name">Constructor</span> proxyConstructor <span class="token operator">=</span> proxyClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token class-name">Payable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Payable</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Payable</span><span class="token punctuation">)</span> proxyConstructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SiShiDaDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">return</span> p<span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>“为了方便你理解，我把每个步骤的代码分别作了封装，步骤2和步骤3你只需要理解他们的含义就行了，具体的代码不是研究的重点。这两个步骤的代码在接下来的讲述中几乎不会发生变化，因此接来的讲述我会用<code>createJavaFile</code>和<code>compile</code>来分别代替两个步骤，不会再给出具体代码。”陀螺对招财解释道。</p><p>“如此一来，客户只需要调用<code>Proxy.newProxyInstance(ClassLoader classLoader)</code>就能得到<code>SiShiDaDaoLogProxy</code>对象实例了是吧。”招财问。</p><p>“没错。”</p><p>“可是，我看到<code>newProxyInstance</code>方法有个参数，需要传一个<code>ClassLoader</code>，这个参数是什么意思？”招财有点不解地问。</p><p>“还记得我们需要一个类加载器来加载步骤3生成的<code>.class</code>文件到JVM中吗？这个参数就是类加载器的一个实例，提供这个参数是让客户可以灵活地选择不同的类加载器来完成这个操作。”</p><p>招财撅了噘嘴，“我不理解这个参数提供的必要性，你直接默认一个类加载器不是更好吗？我觉得大部分的用户都不知道这个参数该传什么值吧。”</p><p>“别急，之后你就会知道我设计这个参数的意图了。为了让你知道怎么传这个参数，我自定义了一个类加载器，这个操作其实并不难。”</p><p>“还有第5步，我也不是很懂。”招财继续追问。</p><p>“别急，先看一下我们目前为止的所有代码，然后解释给你听。”</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">designPattern<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>dynamicProxy</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 蝉沐风
 * <span class="token keyword">@description</span> 支付接口
 * <span class="token keyword">@date</span> 2022/1/10
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Payable</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 支付接口
     */</span>
    <span class="token keyword">void</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">designPattern<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>dynamicProxy</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 蝉沐风
 * <span class="token keyword">@description</span> 「四十大盗」金融公司提供的第三方接口，实现了支付接口
 * <span class="token keyword">@date</span> 2022/1/10
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SiShiDaDao</span> <span class="token keyword">implements</span> <span class="token class-name">Payable</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;「四十大盗」支付接口调用中......&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//模拟方法调用延时</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 蝉沐风
 * <span class="token keyword">@description</span> 动态代理v1
 * <span class="token keyword">@date</span> 2022/1/10
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token punctuation">{</span>

    <span class="token comment">//定义换行符</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ln <span class="token operator">=</span> <span class="token string">&quot;\r\n&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token doc-comment comment">/** 1.生成源代码 **/</span>
            <span class="token class-name">String</span> src <span class="token operator">=</span> <span class="token function">generateSrc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token doc-comment comment">/** 2.将源码写入磁盘，生成.java文件 **/</span>
            <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token function">createJavaFile</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token doc-comment comment">/** 3.将生成的.java文件编译成.class文件 **/</span>
            <span class="token function">compile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token doc-comment comment">/** 4.类加载器将.class文件加载到JVM **/</span>
            <span class="token class-name">Class</span> proxyClass <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;SiShiDaDaoLogProxy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token doc-comment comment">/** 5.利用反射实例化对象 **/</span>
            <span class="token class-name">Constructor</span> proxyConstructor <span class="token operator">=</span> proxyClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token class-name">Payable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Payable</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Payable</span><span class="token punctuation">)</span> proxyConstructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SiShiDaDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> p<span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">generateSrc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;package designPattern.proxy.dynamicProxy.v1;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;import designPattern.proxy.dynamicProxy.Payable;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;public class SiShiDaDaoLogProxy implements Payable { &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    private Payable payable;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    public SiShiDaDaoLogProxy(Payable payable) {&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;        this.payable = payable;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    @Override&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    public void pay() {&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;        System.out.println(\&quot;打印日志1\&quot;);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;        payable.pay();&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;        System.out.println(\&quot;打印日志2\&quot;);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">File</span> <span class="token function">createJavaFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> filePath <span class="token operator">=</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filePath <span class="token operator">+</span> <span class="token string">&quot;SiShiDaDaoLogProxy.java&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileWriter</span> fw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fw<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fw<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> file<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">JavaCompiler</span> compiler <span class="token operator">=</span> <span class="token class-name">ToolProvider</span><span class="token punctuation">.</span><span class="token function">getSystemJavaCompiler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StandardJavaFileManager</span> manager <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">getStandardFileManager</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterable</span> iterable <span class="token operator">=</span> manager<span class="token punctuation">.</span><span class="token function">getJavaFileObjects</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JavaCompiler<span class="token punctuation">.</span>CompilationTask</span> task <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> manager<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> iterable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        manager<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 蝉沐风
 * <span class="token keyword">@description</span> 自定义类加载器
 * <span class="token keyword">@date</span> 2022/1/10
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">File</span> classPathFile<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> classPath <span class="token operator">=</span> <span class="token class-name">MyClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>classPathFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>classPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token class-name">MyClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>classPathFile <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">File</span> classFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>classPathFile<span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;\\.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>classFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">FileInputStream</span> in <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">ByteArrayOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>classFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buff <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> out<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> out<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>“我再啰嗦一遍目前为止我们做的事情。”陀螺耐心地解释。</p><ol><li><p>我们通过<code>generateSrc</code>方法得到了<code>SiShiDaDaoLogProxy</code>类的源码，这个源码就是一开始给你看的静态代理的代码（重点）</p></li><li><p>将源码文件写入磁盘，生成<code>SiShiDaDaoLogProxy.java</code>文件（不是重点）</p></li><li><p>利用JDK提供的编译工具，将<code>SiShiDaDaoLogProxy.java</code>编译成<code>SiShiDaDaoLogProxy.class</code>文件（不是重点）</p></li><li><p>使用自定义的类加载器（<code>MyClassLoader</code>）将<code>SiShiDaDaoLogProxy.class</code>加载到内存（不是重点）</p></li><li><p>使用反射，得到<code>SiShiDaDaoLogProxy</code>的实例对象（重点）</p></li></ol><p>“你会发现，<code>generateSrc</code>生成的源码只有一个有参的构造函数，因此第5步需要通过反射获取这个有参的构造函数对象，并传入<code>new SiShiDaDao()</code>进行实例化，效果和下面的代码是一样的。”</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">SiShiDaDaoLogProxy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SiShiDaDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>“这个我懂了，”招财点点头，“但是你说在第2步和第3步分别生成了两个文件，这两个文件保存在哪里了呢？”</p><p>“这就是动态代理的奇妙之处了！它自动给你生成了源码文件和字节码文件，对此你却毫无感知。你甚至都<strong>不需要知道自动生成的类的名字是什么</strong>。这里我也不会告诉你文件保存在哪里了，因为这个问题并不重要，之后你自己运行代码看看就知道了。”陀螺解释说，“我们现在运行一下客户端程序，看看有什么结果吧。”</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 蝉沐风
 * <span class="token keyword">@description</span> 调用客户端
 * <span class="token keyword">@date</span> 2022/1/10
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Payable</span> payable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Payable</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        payable<span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行结果如下 <img src="https://cdn.nlark.com/yuque/0/2022/png/8387282/1641870959933-4502d18c-3a5d-4b3a-a667-c4f6287cb232.png#clientId=u72946ed2-080c-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=86&amp;id=ucdf5b501&amp;margin=[object Object]&amp;name=image.png&amp;originHeight=172&amp;originWidth=796&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=30166&amp;status=done&amp;style=none&amp;taskId=ua9831850-3c89-4db9-b09c-10d2f20a3f7&amp;title=&amp;width=398" alt="image.png" loading="lazy"> 看见陀螺兴奋的样子，招财有点为难，因为她不明白折腾了这么久，最终得到的竟是和之前静态代理一样的运行效果。</p><p>吾爱吾师，吾更爱真理！</p><p>招财鼓起勇气，问道：“这个结果和静态代理的运行结果没有差别，不是吗？”</p><p>陀螺从招财委婉的话里听出了她的困惑，“结果虽然一样，但是实现机制却发生了翻天覆地的变化。你有没有发现，我们没有手写任何的代理类。之前静态代理还需要手写<code>SiShiDaDaoLogProxy</code>，我们完全是自动生成的。”</p><p>“你说的这一点我理解了。但是目前自动生成的都是写死的代码，也就是说目前只能为<code>SiShiDaDao</code>这个类中的<code>pay()</code>方法做代理，效果还差得远呢。”</p><p>“你说得没错，接下来我们就稍微改进一下，这个阶段我们的目标是，要得到一个对象，这个对象可以<strong>代理实现了任意接口的类</strong>，从而被代理类中的<strong>每一个方法</strong>前后都会添加我们的日志逻辑。”</p><h3 id="v2-0——为实现了任意接口的类做日志代理" tabindex="-1"><a class="header-anchor" href="#v2-0——为实现了任意接口的类做日志代理" aria-hidden="true">#</a> v2.0——为实现了任意接口的类做日志代理</h3><p>陀螺问招财，“如果你是设计者，站在使用者的角度让你来设计这个接口，你会怎么设计？”</p><p>招财思考了一番，“<code>newProxyInstance</code>方法里应该添加另一个参数，用来指代被代理对象实现的接口，意思就是我要得到实现了这个接口的类的代理对象。”</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> chanmufeng
 * <span class="token keyword">@description</span> 动态代理v2
 * <span class="token keyword">@date</span> 2022/1/10
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token punctuation">{</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">,</span> <span class="token class-name">Class</span> intfce<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>“很好。这样一来，我们就不能在<code>generateSrc</code>方法中将生成的类的实现关系写死，需要一点变化。看下图，所有用红色线框圈出来的部分都是需要动态修改的，而且更麻烦的一点是，我们还需要动态生成这个接口中声明的所有的方法，包括方法的参数和返回值信息。”</p><p><img src="https://cdn.nlark.com/yuque/0/2022/png/8387282/1641902597708-fceed55c-9d12-4ebe-a546-45ec4cb4f350.png#clientId=uf133888f-2a17-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=584&amp;id=u967ada4d&amp;margin=[object Object]&amp;name=image.png&amp;originHeight=1168&amp;originWidth=1610&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=199883&amp;status=done&amp;style=none&amp;taskId=u8ff9876f-f130-46ed-8328-56fd3468f8d&amp;title=&amp;width=805" alt="image.png" loading="lazy"></p><p>“我想，这一定又离不开反射吧。”招财无奈地说道。</p><p>“是的，重点体会思想。别担心，这些代码很容易理解，但是需要你多看几遍。接下来我们来实现新的<code>generateSrc</code>方法。”陀螺继续说道，“但是下面的代码可能会让你有点不适，因为通过拼接字符串的方式获取源码，可读性很差。但是先体会思想，之后我会让你看到最终动态生成的源码内容，你也就明白了下面的代码究竟做了什么。”</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">generateSrc</span><span class="token punctuation">(</span><span class="token class-name">Class</span> intfce<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//获取接口所在包名</span>
        <span class="token class-name">String</span> packageName <span class="token operator">=</span> intfce<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> intfce<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;package designPattern.proxy.dynamicProxy.v2;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;import &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;public class $Proxy0 implements &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>intfce<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; { &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    private &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>intfce<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; obj;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    public $Proxy0(&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>intfce<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; obj) {&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;        this.obj = obj;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">generateMethodsSrc</span><span class="token punctuation">(</span>intfce<span class="token punctuation">)</span><span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">StringBuilder</span> <span class="token function">generateMethodsSrc</span><span class="token punctuation">(</span><span class="token class-name">Class</span> intfce<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> m <span class="token operator">:</span> intfce<span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    @Override&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StringBuilder</span> paramNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StringBuilder</span> paramValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StringBuilder</span> paramClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> params<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Class</span> clazz <span class="token operator">=</span> params<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> type <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> paramName <span class="token operator">=</span> <span class="token function">toLowerFirstCase</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
                paramNames<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>type <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> paramName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                paramValues<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>paramName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                paramClasses<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> params<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    paramNames<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    paramValues<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    paramClasses<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    public &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>paramNames<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;){&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>

            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;        System.out.println(\&quot;打印日志1\&quot;);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;        obj.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>paramValues<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;        System.out.println(\&quot;打印日志2\&quot;);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> sb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">toLowerFirstCase</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chars <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">32</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>chars<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">,</span> <span class="token class-name">Class</span> intfce<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token doc-comment comment">/** 1.生成源代码 **/</span>
            <span class="token class-name">String</span> src <span class="token operator">=</span> <span class="token function">generateSrc</span><span class="token punctuation">(</span>intfce<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token doc-comment comment">/** 2.将源码写入磁盘，生成.java文件 **/</span>
            <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token function">createJavaFile</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token doc-comment comment">/** 3.将生成的.java文件编译成.class文件 **/</span>
            <span class="token function">compile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token doc-comment comment">/** 4.类加载器将.class文件加载到JVM **/</span>
            <span class="token class-name">Class</span> proxyClass <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;$Proxy0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Constructor</span> proxyConstructor <span class="token operator">=</span> proxyClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>intfce<span class="token punctuation">)</span><span class="token punctuation">;</span>
            file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Payable</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Payable</span><span class="token punctuation">)</span> proxyConstructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SiShiDaDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> p<span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时客户端调用</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Payable</span> payable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Payable</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Payable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        payable<span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行结果如下</p><p><img src="https://cdn.nlark.com/yuque/0/2022/png/8387282/1642114623204-7320110b-b523-44ae-a7ce-d356ad94a6d5.png#clientId=u3726bb9b-6ea8-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=124&amp;id=udabde366&amp;margin=[object Object]&amp;name=image.png&amp;originHeight=248&amp;originWidth=1280&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=33904&amp;status=done&amp;style=none&amp;taskId=u3071fbf6-057f-49b4-9412-483cd2e4fb0&amp;title=&amp;width=640" alt="image.png" loading="lazy"> 动态生成的代码如下</p><blockquote><p>注：代码为动态生成的原始内容，未经IDE格式化</p></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">designPattern<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>dynamicProxy<span class="token punctuation">.</span>v2</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">designPattern<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>dynamicProxy<span class="token punctuation">.</span></span><span class="token class-name">Payable</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> $<span class="token class-name">Proxy0</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">designPattern<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>dynamicProxy<span class="token punctuation">.</span></span>Payable</span> <span class="token punctuation">{</span> 
    <span class="token keyword">private</span> <span class="token class-name">Payable</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">public</span> $<span class="token class-name">Proxy0</span><span class="token punctuation">(</span><span class="token class-name">Payable</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;打印日志1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj<span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;打印日志2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>陀螺解释说：“虽然<code>generateSrc</code>方法<strong>看起来</strong>很麻烦，但是生成的最终结果却很容易理解，就是生成一个实现了某个接口的类，并在重写接口所有方法的过程前后添加了日志逻辑。”</p><p>“逻辑我理解了，只不过对<code>generateSrc</code>的代码还有点晕。我就暂时先不理会<code>generateSrc</code>的细节了，先把握整体思路。我有两个问题，首先，我看到自动生成的类名由<code>SiShiDaDaoLogProxy</code>变成了<code>$Proxy0</code>，这是为什么？”招财抛出了第一个问题。</p><p>“好眼力。在代理对象生成的过程中你会发现，我们从始至终都没有用到过这个类的名字，所以名字叫什么其实无所谓。此外，动态代理根据我们传入参数的不同会返回不同的代理对象，所以我干脆就起了一个中性一点的名字<code>Proxy0</code>。至于为什么用<code>$</code>开头，因为JDK有个规范，在ClassPath下只要是<code>$</code>开头的<code>.class</code>文件，一般都是自动生成的，我只是遵照了一下这个规范罢了。”</p><p>“第二个问题，目前这个版本的功能是要得到实现了任意接口的类的代理，并且当客户端传入的接口对象是<code>Payable.class</code>时，也得到了我们期望的运行结果。但是我认为这只是恰好传入的参数是<code>Payable.class</code>罢了，如果传入的其他接口类，比如<code>Comparable.class</code>，我不认为客户端能调用成功，因为<code>newProxyInstance</code>方法进行对象实例化时传递的参数是<code>new SiShiDaDao()</code>。”招财指了指代码。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 参数被写死了</span>
<span class="token class-name">Payable</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Payable</span><span class="token punctuation">)</span> proxyConstructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SiShiDaDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>“而当参数是<code>Comparable.class</code>的时候，我们需要传入的应该是实现了<code>Comparable</code>接口的对象实例。我说的对不，师傅。”招财幸灾乐祸地问。</p><p>招财的成长让陀螺大感吃惊，笑了笑说：“你说的没错，如果传入的参数不是<code>Payable.class</code>，虽然能够生成我们期望的代码，但是没办法运行，原因正如你刚才所说。不仅如此，目前自动生成的代理类只能添加固定的日志逻辑，我们希望这个逻辑能让用户自己定义。”</p><p>“所以，第3个版本要来了吧。”招财摩拳擦掌，已经迫不及待地听陀螺继续讲下去了。</p><p>“没错！”</p><h3 id="v3-0——为实现了任意接口的类做任意代理" tabindex="-1"><a class="header-anchor" href="#v3-0——为实现了任意接口的类做任意代理" aria-hidden="true">#</a> v3.0——为实现了任意接口的类做任意代理</h3><p>“想让用户可以自定义逻辑，那么在调用<code>newProxyInstance</code>方法的时候自然应该多一个参数。很显然，每个用户传入的逻辑都不一样，但是参数却只有一个，你想到了什么？”陀螺问招财。</p><p>“多态。这个参数应该是个接口或者高度抽象的类，用户去实现接口或重写方法来编写自己的逻辑。”</p><p>“说得没错，这里我们就用接口来实现。我把这个接口命名为<code>InvocationHandler</code>，并在里边定义一个方法<code>invoke</code>，用户必须重写这个方法来编写自己的逻辑。”</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>

    <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>“我们的<code>newProxyInstance</code>方法的声明也就变为了这样。”</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 蝉沐风
 * <span class="token keyword">@description</span> 动态代理v3
 * <span class="token keyword">@date</span> 2022/1/14
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token punctuation">{</span>
	
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">,</span> <span class="token class-name">Class</span> intfce<span class="token punctuation">,</span> <span class="token class-name">InvocationHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>“接下来我们需要确定<code>invoke</code>方法中的参数，”陀螺继续说道，“因为我们要在方法前后添加逻辑，所以用户实现<code>InvocationHandler</code>接口并重写<code>invoke</code>方法时，其中的代码结构应该是这个样子。”说罢，陀螺给出了代码。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogInvocationHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">// 方法调用之前的逻辑处理</span>
        <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//在此进行实际方法调用</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// 方法调用之后的逻辑处理</span>
        <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;打印日志1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;打印日志2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>陀螺接着说：“我们需要在<code>before</code>和<code>after</code>方法中间调用某个方法，可以传入<code>Method</code>对象，这样就可以利用反射来调用这个方法了，因此<code>invoke</code>方法中至少应该包含<code>Method</code>对象和方法的参数，像这样<code>invoke(Method m, Object[] args)</code>。”</p><p>招财提出了一个问题：“但是反射调用方法的时候还需要知道调用的是哪个对象的方法，这个参数该怎么得到呢？”</p><p>陀螺回答道：“这个好办，我们可以在实现<code>InvocationHandler</code>的时候，创建一个构造器，通过构造函数的方式传入被代理对象，如此一来代码就变成了这样。”</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogInvocationHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>

    <span class="token comment">// 被代理对象</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> target<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">LogInvocationHandler</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Method</span> m<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> res <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;打印日志1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;打印日志2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>看到这里，招财已经两眼放光了，大叫：“我知道了！现在我们重写的<code>invoke</code>方法中其实已经包含了最完整的逻辑，而且这个对象也会作为参数被传入到<code>newProxyInstance</code>方法中，也就是说，在之后自动生成的代理对象中只要调用<code>LogInvocationHandler</code>实例对象的<code>invoke</code>方法，然后把<code> Method</code>参数和<code>Object[]</code>参数传入就可以了！”</p><p>看着招财兴奋的样子，陀螺也忍不住乐起来，“哈哈哈，没错！你已经说出了动态代理的核心思想了。现在抛开<code>newProxyInstance</code>函数内部的实现细节，客户端该怎么调用我们已经完成的封装？”</p><p>“首先我们需要创建一个被代理对象，这里就以<code>SiShiDaDao</code>的实例对象为例吧；其次，实现<code>InvocationHandler</code>接口重写<code>invoke</code>方法，创建自己的逻辑；再次，调用<code>Proxy.newProxyInstance</code>方法，得到代理对象；最后调用代理对象的目标方法就可以了。”招财回答得很流利。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 创建被代理对象</span>
        <span class="token class-name">SiShiDaDao</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SiShiDaDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 实现自己的逻辑</span>
        <span class="token class-name">InvocationHandler</span> logHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogInvocationHandler</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 得到代理对象</span>
        <span class="token class-name">Payable</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Payable</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Payable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> logHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 调用代理对象目标方法</span>
        proxy<span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>“我写的代码没错吧师傅。”招财一脸得意，“接下来是不是可以看看<code>newProxyInstance</code>方法的实现细节了？”</p><p>陀螺摆摆手，“别急！在了解<code>newProxyInstance</code>的细节之前，你需要先明白<code>newProxyInstance</code>自动生成的源码应该是什么样子，你试着写一下，就用你刚刚写的客户端调用的参数。”</p><p>招财想了一下，给出了自己的代码。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> $<span class="token class-name">Proxy0</span> <span class="token keyword">implements</span> <span class="token class-name">Payable</span> <span class="token punctuation">{</span> 
    
    <span class="token keyword">private</span> <span class="token class-name">InvocationHandler</span> h<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> $<span class="token class-name">Proxy0</span><span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span> h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>h <span class="token operator">=</span> h<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        
        <span class="token class-name">Method</span> m <span class="token operator">=</span> <span class="token class-name">Payable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;pay&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>h<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>&quot;嗯嗯，&quot;陀螺点点头，“大致的思路是对的，但是有几点小问题。”</p><p>“您说说看。”</p><p>“第一，<code>Payable</code>应该写成全限定类名<code>designPattern.proxy.dynamicProxy.Payable</code>，这样无论传入什么接口类型，编译的时候都不会有问题。”</p><p>“第二，在获取<code>Method</code>的时候，你是传入方法名来进行获取的，这不够。因为可能存在方法重载的情况，就是方法名相同但是方法参数不同。因此更好的做法是同时根据方法名和方法参数来获取<code>Method</code>对象。”</p><p>“第三，<code>pay()</code>方法没有捕获异常，因为<code>$Proxy0</code>中的所有方法都用到了反射，需要进行异常捕获。”</p><p>“那注意了这三点，是不是我就可以实现<code>newProxyInstance</code>细节了？”招财迫不及待地问。</p><p>“没错，你现在已经完全有能力实现了，只不过需要加亿点点细节！”</p><p>“亿点点？？？？”</p><p>陀螺说：“因为<code>Payable</code>接口中声明的方法<code>pay()</code>很简单，既没有返回值，也没有方法参数，所以需要在实现细节中考虑到有返回值和方法参数的情况。但是细节对你来说已经不重要了，因为你听懂了原理就已经掌握了动态代理的精髓，我直接给你看代码吧！”</p><blockquote><p>代码可能引起不适，可以直接跳过，或者访问<a href="https://github.com/chanmufeng/JavaMeta" target="_blank" rel="noopener noreferrer">github<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>获取完整代码，自己跑一下效果更佳</p></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 蝉沐风
 * <span class="token keyword">@description</span> 动态代理v3
 * <span class="token keyword">@date</span> 2022/1/14
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token punctuation">{</span>

    <span class="token comment">//定义换行符</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ln <span class="token operator">=</span> <span class="token string">&quot;\r\n&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">,</span> <span class="token class-name">Class</span> intfce<span class="token punctuation">,</span> <span class="token class-name">InvocationHandler</span> h<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token doc-comment comment">/** 1.生成源代码 **/</span>
            <span class="token class-name">String</span> src <span class="token operator">=</span> <span class="token function">generateSrc</span><span class="token punctuation">(</span>intfce<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token doc-comment comment">/** 2.将源码写入磁盘，生成.java文件 **/</span>
            <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token function">createJavaFile</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token doc-comment comment">/** 3.将生成的.java文件编译成.class文件 **/</span>
            <span class="token function">compile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token doc-comment comment">/** 4.类加载器将.class文件加载到JVM **/</span>
            <span class="token class-name">Class</span> proxyClass <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;$Proxy0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Constructor</span> proxyConstructor <span class="token operator">=</span> proxyClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> proxyConstructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">generateSrc</span><span class="token punctuation">(</span><span class="token class-name">Class</span> intfce<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//获取接口所在包名</span>
        <span class="token class-name">String</span> packageName <span class="token operator">=</span> intfce<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> intfce<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;package designPattern.proxy.dynamicProxy.v3;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;import &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;import java.lang.reflect.*;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;public class $Proxy0 implements &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>intfce<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; { &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    private InvocationHandler h;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    public $Proxy0(InvocationHandler h) {&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;        this.h = h;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">generateMethodsSrc</span><span class="token punctuation">(</span>intfce<span class="token punctuation">)</span><span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">StringBuilder</span> <span class="token function">generateMethodsSrc</span><span class="token punctuation">(</span><span class="token class-name">Class</span> intfce<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> m <span class="token operator">:</span> intfce<span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    @Override&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StringBuilder</span> paramNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StringBuilder</span> paramValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StringBuilder</span> paramClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> params<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Class</span> clazz <span class="token operator">=</span> params<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> type <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> paramName <span class="token operator">=</span> <span class="token function">toLowerFirstCase</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
                paramNames<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>type <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> paramName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                paramValues<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>paramName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                paramClasses<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> params<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    paramNames<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    paramValues<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    paramClasses<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    public &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>paramNames<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;){&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;        try{&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;            Method m = &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>intfce<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;.class.getMethod(&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\&quot;&quot;</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;new Class[]{&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>paramClasses<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;});&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">hasReturnValue</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;            return &quot;</span> <span class="token operator">:</span> <span class="token string">&quot;            &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">getReturnCode</span><span class="token punctuation">(</span><span class="token string">&quot;this.h.invoke(m,new Object[]{&quot;</span> <span class="token operator">+</span> paramValues <span class="token operator">+</span> <span class="token string">&quot;})&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>

            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">getReturnEmptyCode</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;        }catch(Throwable e){}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;    }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> sb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&gt;</span></span> mappings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getReturnEmptyCode</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> returnClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mappings<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>returnClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;return 0;&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>returnClass <span class="token operator">==</span> <span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;return null;&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">hasReturnValue</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> clazz <span class="token operator">!=</span> <span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getReturnCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> returnClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mappings<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>returnClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;((&quot;</span> <span class="token operator">+</span> mappings<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>returnClass<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span> <span class="token operator">+</span> code <span class="token operator">+</span> <span class="token string">&quot;).&quot;</span> <span class="token operator">+</span> returnClass<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;Value()&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">toLowerFirstCase</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chars <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">32</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>chars<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">File</span> <span class="token function">createJavaFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> filePath <span class="token operator">=</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filePath <span class="token operator">+</span> <span class="token string">&quot;$Proxy0.java&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileWriter</span> fw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fw<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fw<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> file<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">JavaCompiler</span> compiler <span class="token operator">=</span> <span class="token class-name">ToolProvider</span><span class="token punctuation">.</span><span class="token function">getSystemJavaCompiler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StandardJavaFileManager</span> manager <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">getStandardFileManager</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterable</span> iterable <span class="token operator">=</span> manager<span class="token punctuation">.</span><span class="token function">getJavaFileObjects</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JavaCompiler<span class="token punctuation">.</span>CompilationTask</span> task <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> manager<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> iterable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        manager<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注：虽然代码处理了方法返回值和参数的问题，但是还有很多细节未完善，比如会重写接口中的所有的方法，包括<code>static</code>和<code>private</code>方法，这显然是不对的</p><p>大家只需理解精神即可，这里的细枝末节对我们并不重要</p></blockquote><p>“现在，我们终于可以在实现了<strong>任意接口</strong>的<strong>任意对象</strong>的<strong>任意方法</strong>的前后添加自己的逻辑了！”招财兴奋的喊道。</p><p>陀螺笑了笑：“恭喜你，到此为止，你已经完全掌握了最难的设计模式——动态代理。现在你会发现，我们费尽心思设计的<code>Proxy</code>类和<code>InvocationHandler</code>接口再也不需要变动了。”</p><p>“是啊，那我们可以把这个功能封装起来，然后在我们的项目里用动态代理了。”招财有点激动。</p><p>“虽然花了我们不少精力，但是得承认，我们目前完成的功能是不完善的。好在JDK为我们封装了动态代理，其实我们一步步做的所有工作都是在模拟JDK提供的动态代理，包括接口和方法的名称，都和JDK的动态代理一模一样。但是在某一些参数上，我们和JDK的动态代理有一点差别。”</p><p>“哪些参数有区别？”招财问道。</p><p>“我们设计的<code>newProxyInstance</code>方法和JDK的稍微有点区别，JDK的第二个参数是个数组，不过这无关紧要，你只要知道这一点就行。”</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 我们设计的</span>
<span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">,</span>
                        <span class="token class-name">Class</span> intfce<span class="token punctuation">,</span>
                        <span class="token class-name">InvocationHandler</span> h<span class="token punctuation">)</span>


<span class="token comment">// JDK提供的</span>
<span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> 
                        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">,</span>
                        <span class="token class-name">InvocationHandler</span> h<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>陀螺继续说道：“还有一个参数比较重要，但是我们在当前版本中并没有给出。甚至很多程序喵对JDK中的这个参数的存在意义都搞不清楚。”</p><p>这可彻底激发了招财的好奇心，“这个参数是什么啊？”</p><p>陀螺明没有直接回答招财，反而问道：“招财啊，我们目前实现的动态代理有什么优点？有什么缺点呢？”</p><p>招财不明所以，但是师傅既然问了，总得回答，“优点是，使用者可以不需要在意<code>newProxyInstance</code>的实现细节，只需要实现<code>InvocationHandler</code>接口，在<code>invoke</code>方法里添加自己的逻辑，然后按照步骤就可以创造出自己的代理对象；硬要说缺点的话，那就是只能在最后才能获得代理对象，自己在<code>invoke</code>方法中定义逻辑的时候对代理对象毫无操作权限。”</p><p>陀螺赞许的点点头，“说到点子上了！虽然大部分使用者都不会直接在<code>invoke</code>中使用代理对象，但是为了功能的完善性，JDK提供了这个参数。接下来，我们稍微修改一下我们的代码，非常简单。”</p><h3 id="v4-0——终于完成对jdk动态代理的模拟" tabindex="-1"><a class="header-anchor" href="#v4-0——终于完成对jdk动态代理的模拟" aria-hidden="true">#</a> v4.0——终于完成对JDK动态代理的模拟</h3><p>陀螺解释说：“问题在于我们需要把生成的代理对象传到<code>invoke</code>方法中，很显然应该在<code>newProxyInstance</code>方法中做点文章。在自动生成代码的时候做一点改变，将<code>this</code>对象传入<code>invoke</code>方法。”</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token class-name">Method</span> m <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">designPattern<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>dynamicProxy<span class="token punctuation">.</span></span>Payable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;pay&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>h<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>“这样的话<code>invoke</code>方法的声明也需要改变一下，改成<code>invoke(Object proxy, Method m, Object[] args)</code> �，对吧？”招财补充道。</p><p>“没错，这样在重写<code>invoke</code>方法的时候，用户就可以获取到代理对象<code>proxy</code>，针对代理对象进行一系列操作就可以了。到此为止，我们完成了对JDK动态代理的模拟。”</p><h2 id="后记" tabindex="-1"><a class="header-anchor" href="#后记" aria-hidden="true">#</a> 后记</h2><p>招财好奇地问：“师傅，JDK也和我们似的，通过拼接字符串来得到代理对象的源码，然后再编译吗？”</p><p>陀螺哈哈大笑，“要真是这样，JDK未免也太low了吧。JDK官方提供了Class字节码的规范，只要你知道这个规范，你可以直接按照这个规范编写字节码文件，从而跳过先生成<code>.java</code>，然后动态编译成<code>.class</code>的过程。JDK动态代理就是在运行期生成字节码，直接写Class字节码文件的，这样效率比较高。”</p><p>“师傅，你一开始就规定了必须使用接口来使用动态代理，是不是也和JDK的实现有关系啊。难道还有不是利用接口来实现动态代理的方式不成？”招财又又又一次抛出了问题。</p><p>陀螺对自己的弟子是又爱又恨，“你这家伙还真是敏锐，除了JDK动态之外还有CGLib动态代理，前者通过接口实现，后者通过继承实现，但是别想让我继续给你讲CGLib了，讲完JDK动态代理我半条命都快没了。下次吧！”</p><blockquote><p>PS：蝉沐风也实在不想让陀螺回答下去了，毕竟他写这篇文章快两个周了......</p></blockquote><blockquote><p>强烈建议下载源码自己动手跑一下，关于动态代理的所有版本源码见<a href="https://github.com/chanmufeng/JavaMeta/tree/main/code/designPattern/proxy/dynamicProxy" target="_blank" rel="noopener noreferrer">github<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><p><img src="https://cdn.nlark.com/yuque/0/2022/png/8387282/1642661287293-2748530c-d6cd-4fd6-bb30-825c52cb98d7.png#clientId=uac3272b7-3e0d-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=381&amp;id=u58d0f0dc&amp;margin=[object Object]&amp;name=image.png&amp;originHeight=762&amp;originWidth=351&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=54946&amp;status=done&amp;style=none&amp;taskId=udd903944-85ef-4fbd-9aa9-d71a1c75c9d&amp;title=&amp;width=175.5" alt="image.png" loading="lazy"></p></div><!----><footer class="page-meta"><!----><div class="meta-item update-time"><span class="label">上次编辑于: </span><span class="info">2022/8/3 06:14:46</span></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: zhaoxaolong@163.com">chanmufeng</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/posts/basic/design-pattern/%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.html" class="nav-link prev" aria-label="静态代理——时间都去哪儿了"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><span class="icon iconfont icon-creative"></span>静态代理——时间都去哪儿了</div></a><!----></nav><div class="giscus-wrapper input-top" style="display:block;"><div style="text-align:center">Loading...</div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"><a href='https://beian.miit.gov.cn/'>鲁ICP备20023913号</a></div><div class="copyright">Copyright © 2022 蝉沐风</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.339ecc68.js" defer></script>
  </body>
</html>
