---
title: IPv4与IPv6
index: false
category:
- socket
# 设置写作时间
date: 2022-10-02
# 一个页面可以有多个标签
tag:
- socket编程
---

远在「卧龙凤雏」成为贬义词之前，就有一个很棒的网络路由系统（ network routing system）了，称为**互联网通信协议第四版**（ Internet Protocol Version 4），又称为 IPv4。它的地址由4个字节组成，通常被写作**点分十进制**的形式，即四个字节被分开用十进制写出，中间用点分隔，比如：`192.0.2.111`。

你大概率见过不少IPv4的地址了。

实际上，在撰写本文之前，几乎整个互联网的各个网站都还用的是IPv4。

人们用IPv4用的很开心，一切都是如此美好。直到一个叫 Vint Cerf 的老头儿提出了警告，说是IPv4的地址即将耗尽。

> 除了警告每个人即将到来的IPv4危机，[Vint Cerf](https://en.wikipedia.org/wiki/Vint_Cerf) 本身还是鼎鼎大名的“Internet之父”，我实在是没有什么资格评判他的判断。

IPv4地址耗尽？这怎么可能呢？32-bit的IPv4有几十亿个IP地址呢，我们真的有几十亿台电脑在用吗？

是的。

一开始在电脑数量还不多的时候，大家也是认为这个数量已经足够了，几十亿已经算是一个天文数字了。甚至当时还很慷慨地分给某些大型组织几百万个IP地址给他们使用（比如Xerox、MIT、Ford、HP、IBM、GE、AT&T 及某个名为 Apple 的小公司，等等）。

事实上，要不是我们用了一些小手段（NAT转换等），IPv4早就被用尽了。

我们现在生活于每个人、每台电脑、每部计算器、每个电话、每部停车计时收费器，甚至是每个玩具小狗（没什么不可能的）都有一个IP地址的时代。

于是乎，128-bit的IPv6诞生了。

Vint Cerf 或许是不朽的，可是谁也架不住在每次地址不够用而研发下一代Internet协议的时候，他老人家出来嘟囔一句：“我早就说过了吧...。。。”

所以，我们应该怎么堵住他的嘴？

我们需要更多的地址，不只是需要两倍以上的地址、也不止几十亿倍、更不止于千兆倍，而是需要79✖️百万✖️十亿✖️兆倍以上的可用地址！我们终将见识到。

你可能会说：“真的吗？这个数字大的让我有点不可置信。”

32-bit和128-bit听起来差得并不算太多，只是多了96个bit而已。但是需要注意的是，这里说的可是等比数列，32 bits可以表示$2^{32}$ 个数字，128 bits可以表示$2^{128}$（大约340个兆兆兆）个数字，大到我都不知道怎么读。。。。。。这么说吧，这个数字相当于宇宙中的每颗星星都能拥有一百万个 IPv4 地址。

忘记点分十进制的IPv4的写法吧，现在我们有了16进制表示法，每两个字节之间用`:`分隔，类似这样：

```
2001:0db8:c9d2:aee5:73e3:934a:a5ae:9551
```

还没完呢！大多时候，IP地址里边会有很多个0，你可以将它们压缩到两个冒号之间，而且可以省略每个字节对开头的0。例如，这些地址对中的每一对都是等价的：

```
2001:0db8:c9d2:0012:0000:0000:0000:0051
2001:db8:c9d2:12::51
    
2001:0db8:ab00:0000:0000:0000:0000:0000
2001:db8:ab00::
    
0000:0000:0000:0000:0000:0000:0000:0001
::1
```

地址 `::1` 是個 loopback（本地回环）地址，相当于 IPv4 中的`127.0.0.1`。

最后，你可能会碰到 IPv6 与 IPv4 兼容的模式。你如果愿意，你可以将 IPv4地址 `192.0.2.33` 用 IPv6 形式表示：`::ffff:192.0.2.33`。

事实上，IPv6的创建者们已经肆无忌惮地保留了万亿计的地址以供备用，这真是太有趣了，但坦白地讲，我们有这么多地址，谁在意呢？

## 子网

现代的互联网是基于`TCP/IP`的思路来设计的，说得通俗点就是互联网由许许多多的小子网组成，子网中的设备用集线器进行连接，子网之间通过路由器进行互联，如下图：

![image-20221003120038276](http://qiniu.chanmufeng.com/2022-10-03-040038.png)

为了更好地管理IP地址（其实也是践行上面这个思路），IP地址本身被分成了两部分，分别是网络号和主机号。

更具体地，互联网诞生之初，IP地址曾经被分成了`A`、`B`、`C`、`D`、`E` 5类，很多计算机网络的书介绍IP地址的时候也是以这个分类开始的。

但是这个划分依然是一个历史概念，实际使用中已经没有任何意义！因此关于这部分知识的讲述都可以直接忽略。

取而代之的是在1993年，因特网工程任务组IETF又提出了**无分类编址**（CIDR）的方法来解决IPv4地址紧缺的问题，当然了，同时启动的还有彻底解决IP地址耗尽问题的IPv6项目。

在互联网中，每个设备都会被分配一个IP地址（其实被分配IP地址的是设备上的网卡，如果一台设备有多个网卡，自然就会有多个IP地址），这个地址就相当于“XX路XX号”，其中“路”就相当于网络号，“号”就相当于主机号，两者合起来就是IP地址啦！

因此，理论上我们应该能通过IP地址识别出主机处于的子网号，以及子网下的主机号。

IPv4的IP地址由`32`个bit组成，按照每`8`个比特（1字节）为一组分成4组，但是仅凭这一串数字根本无法区分哪部分是网络号，哪部分是主机号。

因此需要某些附加信息。这个附加信息就是**子网掩码**。

子网掩码的格式是一串与IP地址长度相同的`32`比特数字，左边是一串连续的`1`，右边剩下的都是`0`。其中为`1`的那一部分表示的是网络号，剩下为`0`的一部分表示的是主机号。子网掩码表示网络号与主机号之间的边界，正规的表示方式如下所示：

![image-20221003210009224](http://qiniu.chanmufeng.com/2022-10-03-130009.png)

一种最简单的表示方法是，把`1`的部分的比特数用十进制的方式写在IP地址的右侧，比如：

```
182.92.193.45/24
```

## 端口号
